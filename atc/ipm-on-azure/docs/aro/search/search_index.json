{"config":{"lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Azure Red Hat OpenShift for IBM Product Master [DRAFT] This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 10:58:31 PM EDT Introduction This document details the steps required to automate the build of a secure, private Azure Red Hat OpenShift v4.x (ARO) infrastructure for IBM Product Master v12.x. The procedure to install IBM Product Master is an accompanying document. Azure Microsoft Azure is a comprehensive cloud computing service managed by Microsoft. It provides software as a service (SaaS), platform as a service (PaaS), and infrastructure as a service (IaaS). OpenShift Container Platform Red Hat's OpenShift Container Platform (OCP) is a hybrid cloud, enterprise Kubernetes application platform. It is a platform as a service (Paas) built on Red Hat Enterprise Linux (RHEL), with Docker containers managed by Kubernetes. Azure Red Hat OpenShift Azure Red Hat OpenShift (ARO) is a fully managed offering of Red Hat OpenShift running in Microsoft Azure. This service is jointly managed and supported by both Microsoft and Red Hat. For more details, see the Azure Red Hat OpenShift Service documentation. IBM Product Master IBM Product Master (IPM) provides trusted Product Information Management (PIM) and collaborative Master Data Management (MDM) capabilities. It creates an accurate and up-to-date repository of product and service information that can be used throughout organizations for strategic business initiatives Reference(s): https://www.openshift.com/blog/introducing-azure-red-hat-openshift-on-openshift-4 https://docs.openshift.com/aro/4/architecture/architecture.html https://azure.microsoft.com/ https://www.openshift.com/ https://www.docker.com/ https://kubernetes.io/ https://docs.microsoft.com/en-us/azure/openshift/openshift-faq https://docs.microsoft.com/en-us/azure/openshift/support-lifecycle https://www.ibm.com/products/product-master Usage This document provides a step-by-step approach. Each step is dependent upon the successful completion of previous steps. The steps are structured and all follow this same pattern. Description Many steps will have a detailed description that will provide additional context. In the interest of brevity, not all steps will have detailed descriptions. Reference(s) Most steps will have relevant, linked references. All references given are to supporting documentation. Command(s) These are the bash commands that must be run. The expectation is that they will be copy/paste. For that reason, the majority of commands rely on pre-set environment variables. The environment variables provide for portability, flexibility, and a consistent experience. If there are problems running any commands then it's most likely the environment variables are incorrect. Example Output When there is output from a command, the example output will be given. Please compare the outputs to ensure consistency. It may be helpful. 1 - Azure Tenant A tenant is Microsoft's representation of an organization. It is a dedicated instance of Azure Active Directory (AAD) that is received when creating a new relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before Azure Red Hat OpenShift (ARO) can be installed, Microsoft accounts must exist and have appropriate access to an AAD tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. Note If you are the Global Administrator of an existing tenant, go to step 2. Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant 1.1 - Create Microsoft Account Reference(s): https://support.microsoft.com/en-us/help/4558219/microsoft-account-what-is https://en.wikipedia.org/wiki/Microsoft_account 1.2 - Create Global Administrator The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Add and manage domains Assign the Global Administrator role to other users Reset passwords for all users Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide 1.3 - Verify Admin Center Access The Microsoft 365 admin center simplifies management of Microsoft 365 services. The admin center provides a tailored experience based on the the role of the logged in user. It is the common entry point for all Microsoft administrators. https://admin.microsoft.com/ Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide 1.4 - Verify AAD License The Azure Active Directory license can be verified by visiting the Directory Overview section on the Azure Portal. https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis 2 - Azure Subscription An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required during the installation of ARO. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators. Reference(s): https://docs.microsoft.com/en-us/microsoft-365/enterprise/subscriptions-licenses-accounts-and-tenants-for-microsoft-cloud-offerings?view=o365-worldwide 2.1 - Create Azure Subscription An Azure subscription may be purchased directly from Microsoft through the Azure website, through a Microsoft representative, or as part of a managed service from a Microsoft Partner. The Microsoft account that purchases the Azure subscription will automtically be assigned the Owner role. Additional Owners may be added later. To learn more about the Azure purchase options, visit this link. https://azure.microsoft.com/en-us/pricing/purchase-options/ Reference(s): https://azure.microsoft.com/ 3 - Operating System The ARO build procedures in this document depend upon a GNU/Linux Operating System (OS) and related tools. Special care has been taken to ensure the commands given will work on any GNU/Linux distribution. As of this writing, they have been successfully tested on Fedora 31+, Debian 9+, and Ubuntu 18+. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+ GNU bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep GNU wget Google Chrome or Firefox OpenSSL Reference(s): https://www.gnu.org/gnu/linux-and-gnu 3.1 - Verify Operating System The purpose of this step is to verify the Operating System is GNU/Linux and the dependent tools used in this document are installed. Reference(s): https://man7.org/linux/man-pages/man2/uname.2.html https://en.wikipedia.org/wiki/Uname Command(s): uname -a Example Output: Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux 3.2 - Verify GNU bash Reference(s): https://www.man7.org/linux/man-pages/man1/bash.1.html https://en.wikipedia.org/wiki/Bash_(Unix_shell) https://www.gnu.org/software/bash/ Command(s): bash --version Example Output: GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. 3.3 - Verify GNU awk Reference(s): https://man7.org/linux/man-pages/man1/awk.1p.html https://en.wikipedia.org/wiki/AWK https://www.gnu.org/software/gawk/ Command(s): awk --version Example Output: GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/. 3.4 - Verify GNU coreutils Reference(s): https://www.gnu.org/software/coreutils/ https://en.wikipedia.org/wiki/GNU_Core_Utilities Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering. 3.5 - Verify GNU grep Reference(s): https://man7.org/linux/man-pages/man1/grep.1.html https://en.wikipedia.org/wiki/Grep https://www.gnu.org/software/grep/ Command(s): egrep --version Example Output: grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. 3.6 - Verify GNU wget Reference(s): https://man7.org/linux/man-pages/man1/wget.1.html https://en.wikipedia.org/wiki/Wget https://www.gnu.org/software/wget/ Command(s): wget --version Example Output: GNU Wget 1.20.3 built on linux-gnu. -cares +digest +gpgme +https +ipv6 +iri +large-file +metalink +nls +ntlm +opie +psl +ssl/gnutls Wgetrc: /etc/wgetrc (system) Locale: /usr/share/locale Compile: gcc -DHAVE_CONFIG_H -DSYSTEM_WGETRC=\"/etc/wgetrc\" -DLOCALEDIR=\"/usr/share/locale\" -I. -I../lib -I../lib -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection Link: gcc -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lmetalink -lpcre2-8 -luuid -lidn2 -lnettle -lgnutls -lz -lpsl -L/usr/lib64 -lgpgme ftp-opie.o gnutls.o http-ntlm.o ../lib/libgnu.a Copyright (C) 2015 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://www.gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Originally written by Hrvoje Niksic <hniksic@xemacs.org>. Please send bug reports and questions to <bug-wget@gnu.org>. 3.7 - Verify Browser Either Google Chrome or Firefox is needed for a few steps. Other browsers will probably work, too, though haven't been tested. Reference(s): https://www.mozilla.org/ https://www.google.com/chrome/ Command(s): firefox --version google-chrome --version Example Output: Mozilla Firefox 80.0 Google Chrome 85.0.4183.83 3.8 - Verify OpenSSL Reference(s): https://www.openssl.org/ Command(s): openssl version Example Output: OpenSSL 1.1.1g FIPS 21 Apr 2020 4 - Environment Variables Important This document depends heavily on the bash shell. There are required bash environment variables that are necessary to execute most steps in this document. The environment variables must be exported prior to running the Command(s). Warning Subsequent steps in this document will not work unless the bash shell environment is properly setup. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html 4.1 - Unset Environment Variables Note Unsetting the ARO environment variables can help prevent issues when, or if they have changed in the configuration file. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done Example Output: unset ARO unset ARO_ADMINISTRATORS_GROUP_NAME unset ARO_APPLICATION_NAME unset ARO_CLUSTER_DOMAIN_NAME unset ARO_CLUSTER_NAME unset ARO_CLUSTER_VISIBILITY_API unset ARO_CLUSTER_VISIBILITY_INGRESS unset ARO_CLUSTER_VM_MASTER_SIZE unset ARO_CLUSTER_VM_WORKER_COUNT unset ARO_CLUSTER_VM_WORKER_DISK_GB unset ARO_CLUSTER_VM_WORKER_SIZE unset ARO_DOMAIN_NAME unset ARO_LOCATION_NAME unset ARO_REDHAT_PULL_SECRET_DIR unset ARO_REDHAT_PULL_SECRET_FILE unset ARO_RESOURCE_GROUP_NAME unset ARO_SERVICE_PRINCIPAL_NAME unset ARO_SERVICE_PRINCIPAL_PASSWORD unset ARO_SUBNET_AGW_CIDR unset ARO_SUBNET_AGW_NAME unset ARO_SUBNET_AGW_NSG_NAME unset ARO_SUBNET_DB_CIDR unset ARO_SUBNET_DB_NAME unset ARO_SUBNET_DB_NSG_NAME unset ARO_SUBNET_DMZ_CIDR unset ARO_SUBNET_DMZ_NAME unset ARO_SUBNET_DMZ_NSG_NAME unset ARO_SUBNET_MASTER_CIDR unset ARO_SUBNET_MASTER_NAME unset ARO_SUBNET_MASTER_NSG_NAME unset ARO_SUBNET_POD_CIDR unset ARO_SUBNET_SERVICE_CIDR unset ARO_SUBNET_TRUSTED_CIDR unset ARO_SUBNET_TRUSTED_NAME unset ARO_SUBNET_TRUSTED_NSG_NAME unset ARO_SUBNET_VGW_CIDR unset ARO_SUBNET_VGW_NAME unset ARO_SUBNET_VGW_POOL_CIDR unset ARO_SUBNET_VGW_POOL_NAME unset ARO_SUBNET_VGW_POOL_NSG_NAME unset ARO_SUBNET_WORKER_CIDR unset ARO_SUBNET_WORKER_NAME unset ARO_SUBNET_WORKER_NSG_NAME unset ARO_SUBSCRIPTION_ID unset ARO_SUBSCRIPTION_NAME unset ARO_TENANT_ID unset ARO_TENANT_NAME unset ARO_VGW_NAME unset ARO_VGW_PKI_BITS unset ARO_VGW_PKI_CLIENT unset ARO_VGW_PKI_CLIENT_CRT_FILE unset ARO_VGW_PKI_CLIENT_EXT_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_CLIENT_NAME unset ARO_VGW_PKI_CLIENT_PFX_FILE unset ARO_VGW_PKI_CLIENT_REQ_FILE unset ARO_VGW_PKI_CLIENT_SERIAL_FILE unset ARO_VGW_PKI_DIR unset ARO_VGW_PKI_ROOT_CA_SERIAL_FILE unset ARO_VGW_PKI_ROOT_CRT_FILE unset ARO_VGW_PKI_ROOT_CRT_NAME unset ARO_VGW_PKI_ROOT_KEY_FILE unset ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_ROOT_KEY_NAME unset ARO_VGW_PUBLIC_ADDRESS_NAME unset ARO_VGW_REDUNDANCY unset ARO_VGW_SKU unset ARO_VGW_TYPE unset ARO_VM_JUMP_ADMIN_NAME unset ARO_VM_JUMP_IMAGE_MARKETPLACE unset ARO_VM_JUMP_IMAGE_URN unset ARO_VM_JUMP_NAME unset ARO_VM_JUMP_PUBLIC_ADDRESS_NAME unset ARO_VM_JUMP_SIZE unset ARO_VNET_CIDR unset ARO_VNET_NAME 4.2 - Set Environment Variables The following bash shell environment variables are required. They are reused for multiple steps. It is recommended that the environment variables be maintained in a configuration file, i.e. ipm.env Maintaining a configuration file will make them easier to use and update. Important Before proceeding, please take your time ensuring the environment variable values are correct. These are example values that must be changed. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): cat \"ipm.env\" && source \"ipm.env\" Example Output: # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done' 4.3 - Verify Environment Variables Ensure the ARO variables are avaialble in the bash shell environment that you're working in. Reference(s): https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=ipm ARO_ADMINISTRATORS_GROUP_NAME=OpenShift Administrators ARO_APPLICATION_NAME=ipm-app ARO_CLUSTER_DOMAIN_NAME=ipm.mitaei.net ARO_CLUSTER_NAME=ipm-cluster ARO_CLUSTER_VISIBILITY_API=Private ARO_CLUSTER_VISIBILITY_INGRESS=Private ARO_CLUSTER_VM_MASTER_SIZE=Standard_D8s_v3 ARO_CLUSTER_VM_WORKER_COUNT=3 ARO_CLUSTER_VM_WORKER_DISK_GB=128 ARO_CLUSTER_VM_WORKER_SIZE=Standard_D8s_v3 ARO_DOMAIN_NAME=mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SERVICE_PRINCIPAL_NAME=http://ipm-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBNET_AGW_CIDR=10.10.11.0/24 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_CIDR=10.10.12.0/24 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_POD_CIDR=10.12.0.0/14 ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_CIDR=10.10.10.0/24 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 ARO_SUBNET_VGW_POOL_NAME=ipm-vnet-vpn-pool-subnet ARO_SUBNET_VGW_POOL_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_CIDR=10.10.0.0/16 ARO_VNET_NAME=ipm-vnet 5 - Required Directories This documentation provides commands that create files. To better organize the output files, the directories must exist or be created. Command(s): env | egrep \"ARO.*DIR\" | sort -V Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki 5.1 - Create Required Directories Reference(s): https://man7.org/linux/man-pages/man1/mkdir.1.html Command(s): mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: + success does not produce any output 5.2 - Verify Required Directories Reference(s): https://man7.org/linux/man-pages/man1/ls.1.html Command(s): ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: drwxrws---+ 2 jtingiris mit 24 Sep 26 22:34 /home/jtingiris/prj/mit/aei/pki drwxrws---+ 2 jtingiris mit 4096 Sep 26 11:51 /home/jtingiris/prj/mit/aei/secrets 6 - Azure CLI The Azure CLI is a Command Line Interface (CLI) used to create and manage Azure resources. The Azure CLI works with all Azure services. It is designed to more quickly work with Azure, with an emphasis on automation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest Command(s): which az Example Output: /usr/bin/az 6.1 - Install Azure CLI The Azure CLI is available to install on Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. Note To install the Azure CLI, please follow the link in the Reference(s) section. Reference(s): https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Command(s): az --version Example Output: azure-cli 2.12.0 core 2.12.0 telemetry 1.0.6 Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Your CLI is up-to-date. Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy 6.2 - Subscription Owner Login The Azure Subscription Owner must perform the remaining steps in this documentation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Command(s): az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net 6.3 - Verify Azure Tenant One way to verify the Azure Tenant is to obtain the Tenant ID with az. Another way is to login to the Azure AAD portal. The Tenant ID must match what is in the environment configuration file. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_show https://aad.portal.azure.com/ Command(s): az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi Example Output: [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ] 6.4 - Set Default Subscription Set the default subscription that the ARO resources will be installed in. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_set Command(s): az account set -s \"${ARO_SUBSCRIPTION_NAME}\" Example Output: + success does not produce any output 6.5 - Verify Default Subscription The Azure CLI Default Subscription will be used to provision all ARO resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Command(s): az account list --query '[?isDefault == `true`]' Example Output: [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ] 7 - Subscription Owners There should be at least two (2) Subscription Owners. This step is optional, but recommended. It will use the ${ARO_SUBSCRIPTION_OWNERS} environment value and ensure all User Principal Names (UPNs) are added as Subscription Owners. Reference(s): https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner 7.1 - Create Subscription Owners Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create Command(s): for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"name\": \"c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"principalId\": \"52f7dd5d-ad08-4b40-878f-40686c51c24e\", \"principalName\": \"christy.walsh@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"name\": \"0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } 7.2 - Verify Subscription Owners Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Principal Role Scope -------------------------- ------ --------------------------------------------------- christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 8 - Subscription Details Uze az to verify Azure Subscription details. The subscription may also be manually verified via the Azure Portal Subscription blade. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest Command(s): env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" Example Output: ARO_LOCATION_NAME=eastus ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_SUBSCRIPTION_OWNERS=christy.walsh@mitaei.net joseph.tingiris@mitaei.net ARO_VERIFY_QUOTA_NAMES=Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs 8.1 - Verify Subscription Name Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade Command(s): az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi Example Output: Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ] 8.2 - Verify Subscription ID Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show Command(s): az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi Example Output: [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ] 8.3 - Verify Subscription Location Note Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable location for the installation. The location name will be used throughout this document. Reference(s): https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Command(s): az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi Example Output: Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US 8.4 - Verify Subscription Limits An ARO cluster uses several Microsoft Azure components. It requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. The Azure subscription and service limits, quotas, and constraints may be insufficient to install ARO. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. It is wise to check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. ARO minimum limits are required for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html Command(s): if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi Example Output: + success does not produce any output 8.5 - Verify Subscription Quotas Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner must do this step. Important To increase the quota limits, a support case must be opened with Microsoft. They will communicate directly to the person who requested the increase. An increase in the VM series quotas will automatically increase the total regional vCPU limit by the same amount. Links to Microsoft's directions on how to request a quota increase are provided in the Reference(s) section. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Verify subscription quotas for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests Command(s): for ARO_VERIFY_QUOTA_NAME in \"${ARO_VERIFY_QUOTA_NAMES[@]}\"; do echo \"ARO_VERIFY_QUOTA_NAME=${ARO_VERIFY_QUOTA_NAME}\"; done; unset ARO_VERIFY_QUOTA_NAMES Example Output: ARO_VERIFY_QUOTA_NAME=Standard DSv3 Family vCPUs ARO_VERIFY_QUOTA_NAME=Standard Dv2 Family vCPUs 9 - OpenShift Administrators Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities. The details for how to use az to create users, groups, and add the necessary subscription roles is described below. Command(s): env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" Example Output: ARO_DOMAIN_NAME=mitaei.net ARO_ADMINISTRATORS=openshift-admin@mitaei.net arun.babu@mitaei.net joseph.tingiris@mitaei.net sivaprasad.k@mitaei.net 9.1 - Create Administrators This is a good time for the Global Administrator to create Microsoft accounts for the OpenShift Administrators. Ideally, the OpenShift Administrators would also have the Global Administrator role for the tenant. However, this is not always possible. If you are the Global Administrator then please take note that the OpenShift Administrators must have Microsoft accounts in the tenant , and their Microsoft accounts must have at least the Contributor and User Access Administrator roles for the Azure Subscription in which ARO is to be deployed. Creating users may be done with az , via the AAD portal, or [https://admin.microsoft.com]. Important The openshift-admin user created is an example and should not be used. We strongly recommend using real names and individual accounts, not ficticous names or group accounts. Command(s): az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login Example Output: { \"accountEnabled\": true, \"ageGroup\": null, \"assignedLicenses\": [], \"assignedPlans\": [], \"city\": null, \"companyName\": null, \"consentProvidedForMinor\": null, \"country\": null, \"createdDateTime\": null, \"creationType\": null, \"deletionTimestamp\": null, \"department\": null, \"dirSyncEnabled\": null, \"displayName\": \"openshift-admin@mitaei.net\", \"employeeId\": null, \"facsimileTelephoneNumber\": null, \"givenName\": null, \"immutableId\": null, \"isCompromised\": null, \"jobTitle\": null, \"lastDirSyncTime\": null, \"legalAgeGroupClassification\": null, \"mail\": null, \"mailNickname\": \"openshift-admin\", \"mobile\": null, \"objectId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"objectType\": \"User\", \"odata.metadata\": \"https://graph.windows.net/25fe96e7-85ec-4e6a-b93f-779b16ff751d/$metadata#directoryObjects/@Element\", \"odata.type\": \"Microsoft.DirectoryServices.User\", \"onPremisesDistinguishedName\": null, \"onPremisesSecurityIdentifier\": null, \"otherMails\": [], \"passwordPolicies\": null, \"passwordProfile\": { \"enforceChangePasswordPolicy\": false, \"forceChangePasswordNextLogin\": true, \"password\": null }, \"physicalDeliveryOfficeName\": null, \"postalCode\": null, \"preferredLanguage\": null, \"provisionedPlans\": [], \"provisioningErrors\": [], \"proxyAddresses\": [], \"refreshTokensValidFromDateTime\": \"2020-09-27T02:58:50.8444883Z\", \"showInAddressList\": null, \"signInNames\": [], \"sipProxyAddress\": null, \"state\": null, \"streetAddress\": null, \"surname\": null, \"telephoneNumber\": null, \"thumbnailPhoto@odata.mediaEditLink\": \"directoryObjects/95ccd40a-9c98-4d4f-9846-eaed016e3ef9/Microsoft.DirectoryServices.User/thumbnailPhoto\", \"usageLocation\": null, \"userIdentities\": [], \"userPrincipalName\": \"openshift-admin@mitaei.net\", \"userState\": null, \"userStateChangedOn\": null, \"userType\": \"Member\" } 9.2 - Verify Administrators Verify the OpenShift Administrator accounts listed in ${ARO_ADMINISTRATORS} exist. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done Example Output: [ { \"userPrincipalName\": \"openshift-admin@mitaei.net\" }, { \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\" } ] [ { \"userPrincipalName\": \"arun.babu@mitaei.net\" }, { \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\" } ] [ { \"userPrincipalName\": \"joseph.tingiris@mitaei.net\" }, { \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\" } ] [ { \"userPrincipalName\": \"sivaprasad.k@mitaei.net\" }, { \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\" } ] 9.3 - Create Administrator Roles The Contributor and User Access Administrator subscription roles are required to administer ARO. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/00c1ec40-d6b3-40b0-b784-41c9ab6250f5\", \"name\": \"00c1ec40-d6b3-40b0-b784-41c9ab6250f5\", \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/e25a7a15-d599-4cb7-8593-c34c6d31b448\", \"name\": \"e25a7a15-d599-4cb7-8593-c34c6d31b448\", \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/8f458612-ca5f-4ff2-832a-d00e700975b0\", \"name\": \"8f458612-ca5f-4ff2-832a-d00e700975b0\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/7f1ba7da-c858-489f-a988-39123faa181f\", \"name\": \"7f1ba7da-c858-489f-a988-39123faa181f\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/6f98e077-c161-453d-a903-b00acb9bd5f2\", \"name\": \"6f98e077-c161-453d-a903-b00acb9bd5f2\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"name\": \"91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/1bf7b433-935b-4160-a634-43bd291739c8\", \"name\": \"1bf7b433-935b-4160-a634-43bd291739c8\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"name\": \"13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } 9.4 - Verify Administrator Roles Verify all ${ARO_ADMINISTRATORS} have the Contributor and User Access Administrator subscription roles. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done Example Output: Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- openshift-admin@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 openshift-admin@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 10 - Resource Providers Make sure you are logged in to Azure via az az login and have the Contributor or Owner role. Warning These steps will fail with only the User Access Administrator role. An unauthorized message will be received. These steps will fail without the --wait flag. Dependent providers are automatically registered and they must be registered first. Reference(s): https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types Command(s): echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" Example Output: ARO_RESOURCE_PROVIDERS=Microsoft.Compute Microsoft.RedHatOpenShift Microsoft.Storage 10.1 - Register Provider Microsoft.Compute Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Compute --wait Example Output: + success does not produce any output 10.2 - Verify Provider Microsoft.Compute Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Compute --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered 10.3 - Register Provider Microsoft.RedHatOpenShift Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.RedHatOpenShift --wait Example Output: + success does not produce any output 10.4 - Verify Provider Microsoft.RedHatOpenShift Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.RedHatOpenShift --output table Example Output: Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered 10.5 - Register Provider Microsoft.Storage Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Storage --wait Example Output: + success does not produce any output 10.6 - Verify Provider Microsoft.Storage Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Storage --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered 11 - Resource Group An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest Command(s): env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' Example Output: ARO_LOCATION_NAME=eastus ARO_RESOURCE_GROUP_NAME=ipm-eastus 11.1 - Create Resource Group Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Command(s): az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } 11.2 - Verify Resource Group Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Command(s): az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } 12 - Virtual Network An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Command(s): env | grep ^ARO_VNET | sort -V Example Output: ARO_VNET_CIDR=10.10.0.0/16 ARO_VNET_NAME=ipm-vnet 12.1 - Create Virtual Network In addition to the VNet CIDR, to be able to route to the Service & POD CIDRs then include them as address prefixes too. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_CIDR} ${ARO_SUBNET_SERVICE_CIDR} ${ARO_SUBNET_POD_CIDR} Example Output: { \"newVNet\": { \"addressSpace\": { \"addressPrefixes\": [ \"10.10.0.0/16\", \"10.11.0.0/16\", \"10.12.0.0/14\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"3fe1740b-d54f-4543-bd34-eb70a25c3285\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"e6da571b-7213-4fa5-ad7b-9164be85e48a\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] } } 12.2 - Verify Virtual Network Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Command(s): az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: { \"addressSpace\": { \"addressPrefixes\": [ \"10.10.0.0/16\", \"10.11.0.0/16\", \"10.12.0.0/14\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"3fe1740b-d54f-4543-bd34-eb70a25c3285\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"e6da571b-7213-4fa5-ad7b-9164be85e48a\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] } 13 - OpenShift Subnets Before installing, Azure Red Hat OpenShift clusters require manually creating a virtual network with two empty subnets for the master and worker VMs. Additionally, the Pod & Service subnets will automatically assigned during the installation. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Important Pod and Service Network CIDRs are configurable. Workers and masters must be in different subnets. Workers and masters virtual network subnets should be minimum /27. Pod CIDR should be minimum /18 in size. The pod network is non-routable IPs, and is only used inside the OpenShift SDN. Each node is allocated /23 subnet (512 IPs) for its pods. This value cannot be changed. You cannot attach a pod to multiple networks. Note In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher_ ; Please see the references in this section for more details. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-create https://docs.microsoft.com/en-us/azure/openshift/concepts-networking https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://docs.openshift.com/aro/4/networking/understanding-networking.html https://tools.ietf.org/html/rfc1918 Command(s): env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V Example Output: ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg 13.1 - Verify OpenShift Cluster Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_show Command(s): az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --output table 2> /dev/null; if [ $? -eq 0 ]; then echo \"ERROR! ARO cluster ${ARO_CLUSTER_NAME} exists; do not recreate the master or worker subnets\"; fi Example Output: + success does not produce any output 13.2 - Create Master Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --address-prefixes ${ARO_SUBNET_MASTER_CIDR} --service-endpoints Microsoft.ContainerRegistry Example Output: { \"addressPrefix\": \"10.10.0.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"a4a4f3f3-7031-4349-a4db-918e078ca7ad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-master-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 13.3 - Disable Master Subnet Private Link Service This is required to be able to connect and manage the cluster. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_update https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet update --name ${ARO_SUBNET_MASTER_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --disable-private-link-service-network-policies true Example Output: { \"addressPrefix\": \"10.10.0.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"9611966b-4097-4d4f-bc93-b42cc963488a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-master-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Disabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 13.4 - Verify Master Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.0.0/23 ipm-vnet-master-subnet Enabled Disabled Succeeded ipm-eastus 13.5 - Create Worker Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --address-prefixes ${ARO_SUBNET_WORKER_CIDR} --service-endpoints Microsoft.ContainerRegistry Example Output: { \"addressPrefix\": \"10.10.2.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"5ab0e900-d3cf-4f86-a3d8-c447f29eb66c\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-worker-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 13.6 - Verify Worker Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.2.0/23 ipm-vnet-worker-subnet Enabled Enabled Succeeded ipm-eastus 14 - Network Security Groups An Azure Network Security Group (NSG) filters network traffic to and from Azure resources in an Azure virtual network. An NSG contains security rules that allow/deny network traffic to/from several types of Azure resources. Note The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Command(s): env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg 14.1 - Create Network Security Groups Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_create Command(s): az network nsg create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} Example Output: { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-agw-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"be4701a3-7c2d-492a-a689-adc40198cba7\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-db-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"a58d572b-dfba-4a3e-b95e-a7c131b01f62\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-dmz-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"ed09e48f-c160-4d63-ad0c-a6df53b6e9eb\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-trusted-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"b415518e-9aa4-447c-abbe-80ebea22c62b\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } 14.2 - Verify Network Security Groups Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_show Command(s): az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo Example Output: Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-agw-subnet-nsg Succeeded ipm-eastus be4701a3-7c2d-492a-a689-adc40198cba7 Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ---------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-db-subnet-nsg Succeeded ipm-eastus a58d572b-dfba-4a3e-b95e-a7c131b01f62 Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-dmz-subnet-nsg Succeeded ipm-eastus ed09e48f-c160-4d63-ad0c-a6df53b6e9eb Location Name ProvisioningState ResourceGroup ResourceGuid ---------- --------------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-trusted-subnet-nsg Succeeded ipm-eastus b415518e-9aa4-447c-abbe-80ebea22c62b 15 - Network Security Group Rules Network Security Group (NSG) Rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows an NSG to be stateful. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Command(s): env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg 15.1 - Create DMZ NSG Rule (AllowSSH) To be able to access the Jump Server (jumpbox) via the Internet, without a VPN setup, tcp port 22 must be opened for ssh. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_create Command(s): az network nsg rule create --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow Example Output: { \"access\": \"Allow\", \"description\": null, \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"22\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"fafcaf82-35be-48e1-9461-561a4b71e119\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/securityRules/AllowSSH\", \"name\": \"AllowSSH\", \"priority\": 1000, \"protocol\": \"Tcp\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/securityRules\" } 15.2 - Verify DMZ NSG Rules Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_show Command(s): az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table Example Output: Protocol SourcePortRange DestinationPortRange SourceAddressPrefix DestinationAddressPrefix Access Priority Direction ProvisioningState Name ResourceGroup ---------- ----------------- ---------------------- --------------------- -------------------------- -------- ---------- ----------- ------------------- -------- --------------- Tcp * 22 * * Allow 1000 Inbound Succeeded AllowSSH ipm-eastus 16 - Related Subnets IBM Product Manager requires related subnets for supplementary virtual machines, to host applications such as DB2. These subnets should be within the same resource group and VNet range previously defined. The network numbers should be IPv4 RFC1918 compliant and prefixed. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Command(s): env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_CIDR=10.10.11.0/24 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_CIDR=10.10.12.0/24 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_POD_CIDR=10.12.0.0/14 ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg 16.1 - Create Application Gateway Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --address-prefixes ${ARO_SUBNET_AGW_CIDR} --network-security-group=${ARO_SUBNET_AGW_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.11.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"e4ad09d4-d5f7-4a42-872f-8821dcd23248\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-agw-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-agw-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 16.2 - Verify Application Gateway Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.11.0/24 ipm-vnet-agw-subnet Enabled Enabled Succeeded ipm-eastus 16.3 - Create Database Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --address-prefixes ${ARO_SUBNET_DB_CIDR} --network-security-group=${ARO_SUBNET_DB_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.12.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"2aa8c48d-8c85-4eee-98ff-19d5a5f9e6dd\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-db-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-db-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 16.4 - Verify Database Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------ -------------------------------- ----------------------------------- ------------------- --------------- 10.10.12.0/24 ipm-vnet-db-subnet Enabled Enabled Succeeded ipm-eastus 16.5 - Create DMZ Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --address-prefixes ${ARO_SUBNET_DMZ_CIDR} --network-security-group=${ARO_SUBNET_DMZ_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.13.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"026bbc03-cf38-45c8-b813-6283fe479fcc\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-dmz-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-dmz-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 16.6 - Verify DMZ Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.13.0/24 ipm-vnet-dmz-subnet Enabled Enabled Succeeded ipm-eastus 16.7 - Create Trusted Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --address-prefixes ${ARO_SUBNET_TRUSTED_CIDR} --network-security-group ${ARO_SUBNET_TRUSTED_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.14.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"40b5794b-9c55-4230-8f97-84ccda8b94e1\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-trusted-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-trusted-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 16.8 - Verify Trusted Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.14.0/24 ipm-vnet-trusted-subnet Enabled Enabled Succeeded ipm-eastus 17 - Jump Server VM A jump server, jump host, or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example of a jump server is a host in a DMZ. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet. It will be allowed to communicate with the other internal subnets. The NSGs may be further tune to allow specific access, as it will be done for the ARO master subnet when ARO is installed. Note The jumpbox should be created prior to the VPN Gateway, so that there is at least one machine available for connectivity testing from two different security zones: Public (Internet) and Private (RFC1918). Reference(s): https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-cli-complete https://en.wikipedia.org/wiki/Jump_server https://en.wikipedia.org/wiki/DMZ Command(s): env | egrep ARO.*JUMP | sort -V Example Output: ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms 17.1 - Create Jump Server Address Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-create Command(s): az network public-ip create --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"Basic\" --allocation-method \"Dynamic\" Example Output: { \"publicIp\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"db3f0454-61e8-4b8d-840e-694b71e697a2\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"3ea50ce6-bb5b-41fe-94f6-9d95e8103cbe\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null } } 17.2 - Verify Jump Server Address Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"db3f0454-61e8-4b8d-840e-694b71e697a2\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"3ea50ce6-bb5b-41fe-94f6-9d95e8103cbe\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null } 17.3 - Create Jump Server NIC Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_create Command(s): az network nic create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --vnet-name ${ARO_VNET_NAME} --subnet ${ARO_SUBNET_DMZ_NAME} --public-ip-address ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --network-security-group ${ARO_SUBNET_DMZ_NSG_NAME} Example Output: { \"NewNIC\": { \"dnsSettings\": { \"appliedDnsServers\": [], \"dnsServers\": [], \"internalDnsNameLabel\": null, \"internalDomainNameSuffix\": \"dnl3vzqtoksu5ll1sfsl3bperc.bx.internal.cloudapp.net\", \"internalFqdn\": null }, \"dscpConfiguration\": null, \"enableAcceleratedNetworking\": false, \"enableIpForwarding\": false, \"etag\": \"W/\\\"f1db4270-6f99-494b-bae8-c4077bb8c482\\\"\", \"hostedWorkloads\": [], \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic\", \"ipConfigurations\": [ { \"applicationGatewayBackendAddressPools\": null, \"applicationSecurityGroups\": null, \"etag\": \"W/\\\"f1db4270-6f99-494b-bae8-c4077bb8c482\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic/ipConfigurations/ipconfig1\", \"loadBalancerBackendAddressPools\": null, \"loadBalancerInboundNatRules\": null, \"name\": \"ipconfig1\", \"primary\": true, \"privateIpAddress\": \"10.10.13.4\", \"privateIpAddressVersion\": \"IPv4\", \"privateIpAllocationMethod\": \"Dynamic\", \"privateLinkConnectionProperties\": null, \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": null, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": null, \"location\": null, \"name\": null, \"provisioningState\": null, \"publicIpAddressVersion\": null, \"publicIpAllocationMethod\": null, \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"sku\": null, \"tags\": null, \"type\": null, \"zones\": null }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"addressPrefix\": null, \"addressPrefixes\": null, \"delegations\": null, \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-dmz-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": null, \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": null, \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": null, \"provisioningState\": null, \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null }, \"type\": \"Microsoft.Network/networkInterfaces/ipConfigurations\", \"virtualNetworkTaps\": null } ], \"location\": \"eastus\", \"macAddress\": null, \"name\": \"ipm-vm-jumpbox-nic\", \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"primary\": null, \"privateEndpoint\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"16debdd3-c550-4941-8c5c-729ed79686e7\", \"tags\": null, \"tapConfigurations\": [], \"type\": \"Microsoft.Network/networkInterfaces\", \"virtualMachine\": null } } 17.4 - Verify Jump Server NIC A network interface enables an Azure Virtual Machine to communicate with internet, Azure, and on-premises resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_show https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface Command(s): az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table Example Output: EnableAcceleratedNetworking EnableIpForwarding Location Name ProvisioningState ResourceGroup ResourceGuid ----------------------------- -------------------- ---------- ------------------ ------------------- --------------- ------------------------------------ False False eastus ipm-vm-jumpbox-nic Succeeded ipm-eastus 16debdd3-c550-4941-8c5c-729ed79686e7 17.5 - Create Jump Server AS An Availability Set (AS) helps spread VMs across fault domains and update domains. It's best practice to use availability sets for VMs, to make it easier to expand in the future. Fault domains define a grouping of virtual machines that share a common power source and network switch. By default, the virtual machines that are configured within the availability set are separated across up to three fault domains. A hardware issue in one of these fault domains does not affect the VM. Update domains indicate groups of virtual machines and underlying physical hardware that can be rebooted at the same time. During planned maintenance, the order in which update domains are rebooted might not be sequential, but only one update domain is rebooted at a time. Azure automatically distributes VMs across the fault and update domains when placing them in an availability set. For more information, see managing the availability of VMs. Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create https://docs.microsoft.com/en-us/azure/virtual-machines/linux/manage-availability Command(s): az vm availability-set create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/availabilitySets/ipm-vm-jumpbox-as\", \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-as\", \"platformFaultDomainCount\": 2, \"platformUpdateDomainCount\": 5, \"proximityPlacementGroup\": null, \"resourceGroup\": \"ipm-eastus\", \"sku\": { \"capacity\": null, \"name\": \"Aligned\", \"tier\": null }, \"statuses\": null, \"tags\": {}, \"type\": \"Microsoft.Compute/availabilitySets\", \"virtualMachines\": [] } 17.6 - Verify Jump Server AS Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_show Command(s): az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table Example Output: Location Name PlatformFaultDomainCount PlatformUpdateDomainCount ResourceGroup ---------- ----------------- -------------------------- --------------------------- --------------- eastus ipm-vm-jumpbox-as 2 5 ipm-eastus 17.7 - Accept Jump Server Image URN Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_accept https://docs.microsoft.com/en-us/azure/virtual-machines/windows/cli-ps-findimage Command(s): az vm image terms accept --urn ${ARO_VM_JUMP_IMAGE_URN} Example Output: { \"accepted\": true, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.MarketplaceOrdering/offerTypes/Microsoft.MarketplaceOrdering/offertypes/publishers/cognosys/offers/docker-ce-with-centos-8-0-free/plans/docker-ce-with-centos-8-0-free/agreements/current\", \"licenseTextLink\": \"https://storelegalterms.blob.core.windows.net/legalterms/3E5ED_legalterms_COGNOSYS%253a24DOCKER%253a2DCE%253a2DWITH%253a2DCENTOS%253a2D8%253a2D0%253a2DFREE%253a24DOCKER%253a2DCE%253a2DWITH%253a2DCENTOS%253a2D8%253a2D0%253a2DFREE%253a24T622IBUBKL6J3MHL5NUAWG2XNZ5H5FVSJGLCOC54LB63AGIONYH5CDZVDEYDONEFK2NHKCZROAP7ZU5PLZHXJ5ZNBFEUCBOWWMC4DSY.txt\", \"name\": \"docker-ce-with-centos-8-0-free\", \"plan\": \"docker-ce-with-centos-8-0-free\", \"privacyPolicyLink\": \"http://www.cogno-sys.com/cognosys-technologies-partners/privacy-policy/\", \"product\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"retrieveDatetime\": \"2020-09-27T03:03:24.6212864Z\", \"signature\": \"7TK6WC7YUSEVPL5URUWHBHRILKUK5JO6RZ5WSTOPBEKJ6QQTKWXNX5F627R4U3FMPQQTPDJIXNOJZEPSFH324RLHXNMZ3MSEOCJ7ZII\", \"type\": \"Microsoft.MarketplaceOrdering/offertypes\" } 17.8 - Verify Jump Server Image URN Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_show https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cognosys.docker-ce-with-centos-8-0-free?tab=Overview Command(s): az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Example Output: Accepted Name Plan Product Publisher ---------- ------------------------------ ------------------------------ ------------------------------ ----------- True docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free cognosys 17.9 - Create Jump Server VM An Azure Virtual Machines (VM) is one of several types of on-demand, scalable computing resources that Azure offers. An Azure VM gives you the flexibility of virtualization without having to buy and maintain the physical hardware that runs it. However, you still need to maintain the VM by performing tasks, such as configuring, patching, and installing the software that runs on it. Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_create https://docs.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-manage-vm https://docs.microsoft.com/en-us/azure/virtual-machines/linux/ Command(s): az vm create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --location ${ARO_LOCATION_NAME} --availability-set ${ARO_VM_JUMP_NAME}-as --nics ${ARO_VM_JUMP_NAME}-nic --image ${ARO_VM_JUMP_IMAGE_URN} --admin-username ${ARO_VM_JUMP_ADMIN_NAME} --size ${ARO_VM_JUMP_SIZE} --generate-ssh-keys Example Output: { \"fqdns\": \"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/virtualMachines/ipm-vm-jumpbox\", \"location\": \"eastus\", \"macAddress\": \"00-0D-3A-9E-B0-AB\", \"powerState\": \"VM running\", \"privateIpAddress\": \"10.10.13.4\", \"publicIpAddress\": \"40.88.33.248\", \"resourceGroup\": \"ipm-eastus\", \"zones\": \"\" } 17.10 - Verify Jump Server VM Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Command(s): az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} Example Output: 40.88.33.248 { \"additionalCapabilities\": null, \"availabilitySet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/availabilitySets/IPM-VM-JUMPBOX-AS\", \"resourceGroup\": \"ipm-eastus\" }, \"billingProfile\": null, \"diagnosticsProfile\": null, \"evictionPolicy\": null, \"extensionsTimeBudget\": null, \"hardwareProfile\": { \"vmSize\": \"Standard_B1ms\" }, \"host\": null, \"hostGroup\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/virtualMachines/ipm-vm-jumpbox\", \"identity\": null, \"instanceView\": null, \"licenseType\": null, \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox\", \"networkProfile\": { \"networkInterfaces\": [ { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic\", \"primary\": true, \"resourceGroup\": \"ipm-eastus\" } ] }, \"osProfile\": { \"adminPassword\": null, \"adminUsername\": \"ipm-vm-jumpbox-admin\", \"allowExtensionOperations\": true, \"computerName\": \"ipm-vm-jumpbox\", \"customData\": null, \"linuxConfiguration\": { \"disablePasswordAuthentication\": true, \"patchSettings\": { \"patchMode\": \"ImageDefault\" }, \"provisionVmAgent\": true, \"ssh\": { \"publicKeys\": [ { \"keyData\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDec9G5K26hxFj+Ha0gQChwhSW4fT6mlZrb0066h+moGMJKMJ2YiHMaNMUULFT8SkJch4KYjQfqgJE8YnSGRHPzmUWwF/v7AwcozIlwralduUdYNIScDnzaFCBa55pLQwCWIN7zXFCdtEG935XwaV+A+tOgokiGvGXMAUj/Dz0A5ClIhbD/i3dr2AFKuuSwMGpFc1EqZDh72ZsYTcDaZT5hhPPUCUyTqOfEJuWQYeE3DAuA1EoI2tmBQWNl2S1jtdHa/69BBAmA6t0MZXuMKpk0udzQjw/d6b64hKYHDDlfxaTEBnt1Vbd8Rv5bxJSI1y2QgCutRZwVa/dt1X71fwpAq4yr0H8JCrabKrIumgqyZ6VQyCTVu3AXZ3E/yMQmJhLK2RvPHrHp8DedZ3su62zvU9aUACyd6b89R6S4eYOmIE+nNG/M/yqS2Ru3GPUalsQXE5/auCsg6rPetxMNoEbZz5qTfJUfq3Xx61WQuLrAsyvEiIiM5rrgA/FhYbthxKKacYr0b6oi6HQW6KQ3JnPMm/QF2UxDxoNOG+NHi2UBfgiXLEHZQ3YnkS4QkB9aCK4YJyOJ5I/34gAGcUIPQ8nkUSky7btjsQlHNB6pHPI+8Xd2SntRmfgBwJwOUS+LqjK4OCCpkqUTSopXQ8vL8L/e2gw+8QIdTYe47/P0IG5zVQ== jtingiris@jt\\n\", \"path\": \"/home/ipm-vm-jumpbox-admin/.ssh/authorized_keys\" } ] } }, \"requireGuestProvisionSignal\": true, \"secrets\": [], \"windowsConfiguration\": null }, \"plan\": { \"name\": \"docker-ce-with-centos-8-0-free\", \"product\": \"docker-ce-with-centos-8-0-free\", \"promotionCode\": null, \"publisher\": \"cognosys\" }, \"priority\": null, \"provisioningState\": \"Succeeded\", \"proximityPlacementGroup\": null, \"resourceGroup\": \"ipm-eastus\", \"resources\": null, \"securityProfile\": null, \"storageProfile\": { \"dataDisks\": [], \"imageReference\": { \"exactVersion\": \"1.2019.0710\", \"id\": null, \"offer\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"sku\": \"docker-ce-with-centos-8-0-free\", \"version\": \"1.2019.0710\" }, \"osDisk\": { \"caching\": \"ReadWrite\", \"createOption\": \"FromImage\", \"diffDiskSettings\": null, \"diskSizeGb\": 30, \"encryptionSettings\": null, \"image\": null, \"managedDisk\": { \"diskEncryptionSet\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/IPM-EASTUS/providers/Microsoft.Compute/disks/ipm-vm-jumpbox_OsDisk_1_30aa79f1b3f44738b4fffb0818c1f500\", \"resourceGroup\": \"IPM-EASTUS\", \"storageAccountType\": \"Premium_LRS\" }, \"name\": \"ipm-vm-jumpbox_OsDisk_1_30aa79f1b3f44738b4fffb0818c1f500\", \"osType\": \"Linux\", \"vhd\": null, \"writeAcceleratorEnabled\": null } }, \"tags\": {}, \"type\": \"Microsoft.Compute/virtualMachines\", \"virtualMachineScaleSet\": null, \"vmId\": \"c6af84ea-fe96-4e23-a3ff-11770109f080\", \"zones\": null } 17.11 - Login to Jump Server VM Reference(s): https://man7.org/linux/man-pages/man1/ssh.1.html Command(s): export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\" Example Output: 40.88.33.248 18 - VPN Gateway A Virtual Private Network (VPN) Gateway is needed to connect to a private ARO cluster. It is a specific type of gateway that is used to send encrypted traffic between an Azure VNet and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. Reference(s): https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://docs.microsoft.com/en-us/azure/vpn-gateway/create-routebased-vpn-gateway-cli Command(s): env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V Example Output: ARO_SUBNET_VGW_CIDR=10.10.10.0/24 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 ARO_SUBNET_VGW_POOL_NAME=ipm-vnet-vpn-pool-subnet ARO_SUBNET_VGW_POOL_NSG_NAME=GatewaySubnet-nsg ARO_VGW_NAME=ipm-vpn ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased 18.1 - Create VPN Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-create https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsub Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --address-prefixes ${ARO_SUBNET_VGW_CIDR} Example Output: { \"addressPrefix\": \"10.10.10.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"5719d87d-ccc4-4683-9638-12f7508a1950\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"GatewaySubnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 18.2 - Verify VPN Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.10.0/24 GatewaySubnet Enabled Enabled Succeeded ipm-eastus 18.3 - Create VPN Address The VPN Gateway requires a Public IP Address. Zone-redundant VPN gateways and zonal gateways both rely on the Azure public IP resource Standard SKU. The configuration of the Azure public IP resource determines whether the gateway that you deploy is zone-redundant, or zonal. If you create a public IP resource with a Basic SKU, the gateway will not have any zone redundancy, and the gateway resources will be regional. Note The public-ip --sku and --allocation-method may differ, depending on the needs of the VPN Gateway. Refer to the Reference(s) for details. A Redundant VPN Gateway is being created in this example. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-create https://docs.microsoft.com/en-us/azure/virtual-network/public-ip-addresses Command(s): az network public-ip create --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"${VPN_IP_SKU}\" --allocation-method \"${VPN_IP_ALLOCATION_METHOD}\" ${VPN_IP_ZONE} Example Output: { \"publicIp\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"c516d2ba-28fa-4259-a9fd-8e0220e9d7d9\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": \"20.55.32.58\", \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vpn-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Static\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"8a54cef2-c31d-4b8d-ae52-b1dbbf9d6802\", \"sku\": { \"name\": \"Standard\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": [ \"1\" ] } } 18.4 - Verify VPN Address Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: Name ResourceGroup Location Zones Address AddressVersion AllocationMethod IdleTimeoutInMinutes ProvisioningState ----------------- --------------- ---------- ------- ----------- ---------------- ------------------ ---------------------- ------------------- ipm-vpn-public-ip ipm-eastus eastus 1 20.55.32.58 IPv4 Static 4 Succeeded 18.5 - Create VPN Gateway There are two types of Azure VPN Gateways, the Classic and Resource Manager deployment models. Each virtual network can have only one VPN gateway. Note Creating a virtual network gateway can take up to 45 minutes to complete. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_create Command(s): az network vnet-gateway create --name ${ARO_VGW_NAME} --location ${ARO_LOCATION_NAME} --public-ip-address ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet ${ARO_VNET_NAME} --gateway-type VPN --sku ${ARO_VGW_SKU} --vpn-type ${ARO_VGW_TYPE} --address-prefixes ${ARO_SUBNET_VGW_POOL_CIDR} Example Output: { \"vnetGateway\": { \"activeActive\": false, \"bgpSettings\": { \"asn\": 65515, \"bgpPeeringAddress\": \"10.10.10.254\", \"bgpPeeringAddresses\": [ { \"customBgpIpAddresses\": [], \"defaultBgpIpAddresses\": [ \"10.10.10.254\" ], \"ipconfigurationId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"tunnelIpAddresses\": [ \"20.55.32.58\" ] } ], \"peerWeight\": 0 }, \"customRoutes\": null, \"enableBgp\": false, \"enableDnsForwarding\": null, \"enablePrivateIpAddress\": false, \"etag\": \"W/\\\"e794796d-23a5-40ea-b5d3-391b68595bfb\\\"\", \"gatewayDefaultSite\": null, \"gatewayType\": \"Vpn\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn\", \"inboundDnsForwardingEndpoint\": null, \"ipConfigurations\": [ { \"etag\": \"W/\\\"e794796d-23a5-40ea-b5d3-391b68595bfb\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"name\": \"vnetGatewayConfig0\", \"privateIpAddress\": null, \"privateIpAllocationMethod\": \"Dynamic\", \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"resourceGroup\": \"ipm-eastus\" }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"resourceGroup\": \"ipm-eastus\" }, \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\" } ], \"location\": \"eastus\", \"name\": \"ipm-vpn\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"20c26bff-2dad-4a88-8418-06ca4fa257af\", \"sku\": { \"capacity\": 2, \"name\": \"VpnGw1AZ\", \"tier\": \"VpnGw1AZ\" }, \"tags\": null, \"type\": \"Microsoft.Network/virtualNetworkGateways\", \"vpnClientConfiguration\": { \"aadAudience\": null, \"aadIssuer\": null, \"aadTenant\": null, \"radiusServerAddress\": null, \"radiusServerSecret\": null, \"radiusServers\": [], \"vpnClientAddressPool\": { \"addressPrefixes\": [ \"172.16.13.0/24\" ] }, \"vpnClientConnectionHealth\": { \"totalEgressBytesTransferred\": 0, \"totalIngressBytesTransferred\": 0, \"vpnClientConnectionsCount\": 0 }, \"vpnClientIpsecPolicies\": [], \"vpnClientProtocols\": [ \"IkeV2\", \"OpenVPN\" ], \"vpnClientRevokedCertificates\": [], \"vpnClientRootCertificates\": [] }, \"vpnGatewayGeneration\": \"Generation1\", \"vpnType\": \"RouteBased\" } } 18.6 - Verify VPN Gateway Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: ActiveActive EnableBgp EnablePrivateIpAddress GatewayType Location Name ProvisioningState ResourceGroup ResourceGuid VpnGatewayGeneration VpnType -------------- ----------- ------------------------ ------------- ---------- ------- ------------------- --------------- ------------------------------------ ---------------------- ---------- False False False Vpn eastus ipm-vpn Succeeded ipm-eastus 20c26bff-2dad-4a88-8418-06ca4fa257af Generation1 RouteBased 19 - VPN Gateway PKI An Azure VPN Gateway supports using a Public Key Infrastructure (PKI) for Certificate Authentication. With VPN Gateway Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. This series of steps establishes a private Certificate Authority (CA) by creating a Root Key & Certificate. The Certificate Data wil be uploaded to the Azure VPN Gateway, so that VPN Clients Certificates will be authenticated. To be valid for authentication, the VPN Client Certificates must be signed by the Root Certificate. Note VPN Client Certificates will be created later. Reference(s): https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://en.wikipedia.org/wiki/Public_key_infrastructure https://en.wikipedia.org/wiki/Root_certificate Command(s): env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V Example Output: ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key 19.1 - Create Root Key Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-genrsa.html Command(s): openssl genrsa -aes256 -out ${ARO_VGW_PKI_ROOT_KEY_FILE} -passout env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 Example Output: Generating RSA private key, 2048 bit long modulus (2 primes) ..+++++ .................+++++ e is 65537 (0x010001) 19.2 - Verify Root Key Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 Example Output: + success does not produce any output 19.3 - Create Root Certificate This step creates a root certificate that is valid for 10 years (3650 days). Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -x509 -sha256 -new -key \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -out \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -days 3650 -subj /CN=\"${ARO_VGW_NAME}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 # 10 years Example Output: + success does not produce any output 19.4 - Verify Root Certificate Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 Example Output: Certificate: Data: Version: 3 (0x2) Serial Number: 0c:bf:8d:e4:7e:9c:40:ab:ba:39:b9:42:98:7f:80:a4:5e:36:a7:3e Signature Algorithm: sha256WithRSAEncryption Issuer: CN = ipm-vpn Validity Not Before: Sep 27 03:28:52 2020 GMT Not After : Sep 25 03:28:52 2030 GMT Subject: CN = ipm-vpn Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:b3:82:e0:16:56:56:9b:c4:81:c4:a9:4d:67:b6: 3e:b4:1c:7c:38:2b:e8:f0:c0:23:5d:d2:d8:71:dc: 57:fb:e6:50:c8:f5:71:99:d0:36:b4:23:f2:4b:90: 1d:0a:7c:f3:0d:6f:81:2a:1d:07:81:65:19:45:de: e2:dc:a0:c8:c1:ad:61:b7:a5:a5:e4:78:68:03:ef: 07:59:f5:de:ff:ce:4b:5c:fc:f3:0a:45:89:90:28: 0d:49:c2:40:95:40:57:7e:5c:ac:f7:9c:ce:67:7d: f6:71:35:f9:85:dc:82:ad:9c:d5:af:0a:43:4e:e3: 61:d6:79:90:c0:02:55:37:ca:55:1a:26:ba:cf:05: 1f:c5:86:44:1a:54:d5:07:ba:38:b0:ca:5d:42:31: 3b:84:56:70:5b:f1:d4:39:17:be:8d:dc:25:cf:79: f9:fc:9d:61:59:46:fa:47:59:9a:bb:a3:20:4d:d7: c1:09:2b:4c:92:ae:2b:c4:f5:e0:3d:18:52:21:59: f3:6c:e0:51:3a:85:eb:de:5d:9d:2b:ed:e5:58:ef: 5a:39:c4:5f:80:41:00:c3:9f:fc:a9:f5:3c:ec:fe: 65:44:c4:5a:e6:5f:79:7a:fd:50:bf:c4:14:ef:12: 13:89:77:c9:5a:3f:52:10:4f:83:31:43:bc:3e:94: a8:33 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Authority Key Identifier: keyid:07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Basic Constraints: critical CA:TRUE Signature Algorithm: sha256WithRSAEncryption 97:dc:d1:bd:95:37:2c:97:e7:76:9b:bc:9d:e4:5d:d7:73:6e: 81:93:e4:87:02:77:ec:19:de:d4:c1:d4:d8:2b:32:6d:e3:89: fb:97:36:b6:01:62:8c:cf:e6:bd:ce:52:c1:03:c3:60:de:3f: 5b:da:4f:fd:6c:cd:0b:47:65:af:4e:e2:d1:07:84:6c:50:6a: f8:e4:41:3b:ce:ae:f8:b2:66:68:b0:ed:32:04:f2:2f:8d:98: 29:84:16:e7:a3:c4:ea:60:37:b6:0b:db:04:2a:d6:94:a4:aa: 80:eb:2d:14:ad:25:1e:3e:7d:1b:7a:72:1a:06:44:f8:e6:51: 02:3a:cf:36:6b:4b:d5:b4:6b:ee:1f:88:49:1a:22:06:39:ba: 3a:71:19:fa:34:e2:a9:c0:08:3e:25:91:64:1c:74:24:1a:4b: 06:3b:24:5e:62:89:6c:54:f3:b9:15:5b:5f:70:d6:d6:19:a1: eb:a3:52:db:35:53:cb:0b:6b:39:59:5a:23:d5:ed:ca:fc:44: 71:93:a7:66:7c:51:4d:4e:0f:f5:15:57:de:a1:09:2f:e6:23: 76:00:bf:68:d7:bd:7b:69:83:b5:0d:e8:bb:a1:fb:01:18:bf: 7e:39:30:94:02:27:29:ac:c9:f3:18:a2:50:55:e4:58:94:29: f6:1f:d4:24 19.5 - Verify Root Moduli Warning Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed until they match. Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum Example Output: md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key = 4103146f0ffed8dfb840bfd8f79963af - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt = 4103146f0ffed8dfb840bfd8f79963af - 19.6 - Create Root Data The VPN Gateway requires knowledge of the Root Data. The Public certificate data must be uploaded to Azure in a specific format. In a previous step, the root certificate was created in the Privacy Enhanced Mail (PEM) format. PEM is the most common format for X.509 certificates. A PEM file is a text file containing one or more items, encoded in base64 ASCII, and identified by plain-text headers and footers PEM, an example: -----BEGIN CERTIFICATE----- DATA -----END CERTIFICATE----- DER files do NOT contain plain text headers . DER is a binary format for data structures described by ASN.1. Important The Azure VPN Gateway requires the Root Public certificate data use the Distinguished Encoding Rules (DER) format, encoded as base64 ASCII. The conversion from PEM to base64 DER is done by OpenSSL, in the Command(s). Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/root-cert?view=azure-cli-latest#az_network_vnet_gateway_root_cert_create https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail https://en.wikipedia.org/wiki/X.690#DER_encoding https://en.wikipedia.org/wiki/ASN.1 Command(s): az network vnet-gateway root-cert create --gateway-name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --name \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" --public-cert-data \"$(openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -outform der | base64 -w0)\" Example Output: { \"activeActive\": false, \"bgpSettings\": { \"asn\": 65515, \"bgpPeeringAddress\": \"10.10.10.254\", \"bgpPeeringAddresses\": [ { \"customBgpIpAddresses\": [], \"defaultBgpIpAddresses\": [ \"10.10.10.254\" ], \"ipconfigurationId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"tunnelIpAddresses\": [ \"20.55.32.58\" ] } ], \"peerWeight\": 0 }, \"customRoutes\": null, \"enableBgp\": false, \"enableDnsForwarding\": null, \"enablePrivateIpAddress\": false, \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"gatewayDefaultSite\": null, \"gatewayType\": \"Vpn\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn\", \"inboundDnsForwardingEndpoint\": null, \"ipConfigurations\": [ { \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"name\": \"vnetGatewayConfig0\", \"privateIpAddress\": null, \"privateIpAllocationMethod\": \"Dynamic\", \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"resourceGroup\": \"ipm-eastus\" }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"resourceGroup\": \"ipm-eastus\" }, \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\" } ], \"location\": \"eastus\", \"name\": \"ipm-vpn\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"20c26bff-2dad-4a88-8418-06ca4fa257af\", \"sku\": { \"capacity\": 2, \"name\": \"VpnGw1AZ\", \"tier\": \"VpnGw1AZ\" }, \"tags\": null, \"type\": \"Microsoft.Network/virtualNetworkGateways\", \"vpnClientConfiguration\": { \"aadAudience\": null, \"aadIssuer\": null, \"aadTenant\": null, \"radiusServerAddress\": null, \"radiusServerSecret\": null, \"radiusServers\": [], \"vpnClientAddressPool\": { \"addressPrefixes\": [ \"172.16.13.0/24\" ] }, \"vpnClientConnectionHealth\": { \"totalEgressBytesTransferred\": 0, \"totalIngressBytesTransferred\": 0, \"vpnClientConnectionsCount\": 0 }, \"vpnClientIpsecPolicies\": [], \"vpnClientProtocols\": [ \"IkeV2\", \"OpenVPN\" ], \"vpnClientRevokedCertificates\": [], \"vpnClientRootCertificates\": [ { \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/vpnClientRootCertificates/ipm-vpn-root.crt\", \"name\": \"ipm-vpn-root.crt\", \"provisioningState\": \"Succeeded\", \"publicCertData\": \"MIIDBTCCAe2gAwIBAgIUDL+N5H6cQKu6OblCmH+ApF42pz4wDQYJKoZIhvcNAQELBQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzI4NTJaFw0zMDA5MjUwMzI4NTJaMBIxEDAOBgNVBAMMB2lwbS12cG4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCzguAWVlabxIHEqU1ntj60HHw4K+jwwCNd0thx3Ff75lDI9XGZ0Da0I/JLkB0KfPMNb4EqHQeBZRlF3uLcoMjBrWG3paXkeGgD7wdZ9d7/zktc/PMKRYmQKA1JwkCVQFd+XKz3nM5nffZxNfmF3IKtnNWvCkNO42HWeZDAAlU3ylUaJrrPBR/FhkQaVNUHujiwyl1CMTuEVnBb8dQ5F76N3CXPefn8nWFZRvpHWZq7oyBN18EJK0ySrivE9eA9GFIhWfNs4FE6heveXZ0r7eVY71o5xF+AQQDDn/yp9Tzs/mVExFrmX3l6/VC/xBTvEhOJd8laP1IQT4MxQ7w+lKgzAgMBAAGjUzBRMB0GA1UdDgQWBBQH9gH+kGBq5556lD9irqEcbH9BWjAfBgNVHSMEGDAWgBQH9gH+kGBq5556lD9irqEcbH9BWjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCX3NG9lTcsl+d2m7yd5F3Xc26Bk+SHAnfsGd7UwdTYKzJt44n7lza2AWKMz+a9zlLBA8Ng3j9b2k/9bM0LR2WvTuLRB4RsUGr45EE7zq74smZosO0yBPIvjZgphBbno8TqYDe2C9sEKtaUpKqA6y0UrSUePn0benIaBkT45lECOs82a0vVtGvuH4hJGiIGObo6cRn6NOKpwAg+JZFkHHQkGksGOyReYolsVPO5FVtfcNbWGaHro1LbNVPLC2s5WVoj1e3K/ERxk6dmfFFNTg/1FVfeoQkv5iN2AL9o1717aYO1Dei7ofsBGL9+OTCUAicprMnzGKJQVeRYlCn2H9Qk\", \"resourceGroup\": \"ipm-eastus\", \"type\": \"Microsoft.Network/virtualNetworkGateways/vpnClientRootCertificates\" } ] }, \"vpnGatewayGeneration\": \"Generation1\", \"vpnType\": \"RouteBased\" } 19.7 - Verify Root Data Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi Example Output: found ipm-vpn root certificate name = ipm-vpn-root.crt verified ipm-vpn-root.crt exists as a root certificate name for ipm-vpn 20 - Client Certificates VPN Clients must present an X.509 version 3 certificate when connecting. Each user should have their own bundle of certificate files. This step outlines a procedure to create them with OpenSSL v1.1.1. It will need to be re-run for everyone who requires connectivity. The Azure VPN Gateway supports both IKEv2 (ipsec) and OpenVPN (ssl) client connections. Various VPN client software support these technologies. It is most convenient to distribute a PKCS#12 file to the user, so they can connect to the VPN Gateway and access the private Azure Red Hat OpenShift cluster. In cryptography, PKCS #12 defines an archive file format for storing many cryptography objects as a single file. PKCS#12 evolved from Microsoft's Personal Information Exchange (PFX) standard and is used to exchange public and private objects. It is commonly used to bundle a private key with its X.509 certificate or to bundle all the members of a chain of trust. The terms PKCS #12 (pkcs12) and PFX (pfx) are often used interchangeably. Successful execution of the commands in this step depends upon the previously created VPN Gateway Root Certificate files and exported environment variables. Successful completion of the following steps will produce six (6) files, in this order: VPN Client Key (.key) VPN Client Certificate Request (.req) VPN Client Certificate Extensions (.ext) VPN Client Certificate (.crt) VPN Client Certificate Serial (.serial) VPN Client Certificate Bundle (.pfx) The resulting PFX file is should be given to the user. 20.1 - Set VPN Client Environment Variables These environment variables should be exported each time a new set of client certificate files are created. Important These are example values that must be changed for your installation. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' Example Output: + success does not produce any output 20.2 - Verify VPN Client Environment Variables Reference(s): https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html Command(s): ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE Example Output: ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! 20.3 - Create VPN Client Key Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-genrsa.html Command(s): openssl genrsa -aes256 -out \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passout env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 Example Output: Generating RSA private key, 2048 bit long modulus (2 primes) .........................................+++++ ...........+++++ e is 65537 (0x010001) + success does not produce any output 20.4 - Verify VPN Client Key Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 Example Output: + success does not produce any output 20.5 - Create Client Certificate Request Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -new -out \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -key \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -subj /CN=\"${ARO_VGW_PKI_CLIENT_NAME}\" 2>&1 Example Output: + success does not produce any output 20.6 - Verify Client Certificate Request Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 Example Output: Certificate Request: Data: Version: 1 (0x0) Subject: CN = ipm-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:a8:dd:23:26:4e:ae:34:53:2a:f7:ed:52:b1:52: 80:eb:75:0d:76:d5:53:11:f2:f4:e9:a0:1b:2f:da: 7a:ee:63:c0:f1:d2:0d:8a:11:2a:7b:4c:11:7b:66: 04:3e:2a:2f:57:87:74:12:1e:fa:c8:ef:bb:69:76: 9d:a6:e4:8f:30:1f:6f:a3:dd:64:cd:b5:f8:ca:6c: 3e:ff:01:93:c8:ff:e4:e1:8a:63:7b:0c:ff:a0:73: d3:60:ad:53:29:46:b8:17:69:3d:17:06:40:b4:44: df:77:fc:7b:44:1e:4c:0e:02:fb:42:4e:a8:ab:55: 21:68:d0:45:7d:f3:5f:81:74:9a:8b:28:08:bd:d5: 8c:84:42:26:bc:fb:a4:c7:e9:2a:17:f6:b8:b2:2d: 44:34:ca:f1:f1:74:dc:16:3f:48:f7:93:3e:fd:21: a4:35:c1:bb:c6:0c:29:a5:6a:a4:ee:34:b4:e2:22: 23:c9:fa:63:16:2a:83:72:20:27:38:aa:56:a8:9f: 50:37:e8:a2:f8:8c:98:d7:6c:60:44:b7:76:95:65: 42:a5:bc:e3:49:bd:74:d2:59:8c:c4:35:eb:bd:ec: 86:97:f6:17:ab:76:a3:1a:ab:19:c3:cd:85:74:5a: 42:32:ff:2c:51:f3:34:9d:46:3f:97:ad:b8:b0:01: c1:c9 Exponent: 65537 (0x10001) Attributes: a0:00 Signature Algorithm: sha256WithRSAEncryption 6b:ec:e9:52:ef:76:ad:c6:49:ad:ed:19:83:ab:01:4c:0c:b5: b6:3c:e0:47:c4:89:af:79:99:fa:69:c9:32:b0:35:97:99:05: c6:ca:60:1d:1a:05:ba:30:9c:b3:8f:f5:8b:a3:ce:c7:af:4c: af:98:d0:82:1d:ca:ec:a3:18:f9:05:d1:e7:79:90:5a:77:f1: b2:4a:41:a2:43:48:d8:52:c2:4d:8b:f6:0f:26:8c:ef:ad:a7: 9c:14:49:b9:9f:ec:20:42:33:ea:12:78:0c:e9:98:a1:e7:bb: 81:b6:44:de:df:f3:63:b8:b6:ac:91:6a:5c:3d:5b:1b:a8:69: cf:d7:4e:21:5a:47:91:7f:e9:e1:6b:5b:ef:29:ee:75:dd:55: 81:ad:df:d7:4c:4c:77:e3:cf:8a:5c:ae:ec:c3:71:fc:b6:ce: f7:17:8a:1a:be:7e:a6:2f:85:a0:d5:16:eb:09:5e:7b:09:e9: a1:0e:d7:a2:55:a9:98:41:69:65:c3:70:ce:3d:04:ea:95:08: 39:a3:ff:c5:41:b2:8f:a9:fe:1b:ae:e5:df:0e:61:5f:90:2c: 35:d2:bb:41:e1:84:7a:54:e0:3d:c7:9d:1e:f5:15:37:a2:a7: 2a:d7:09:5f:4c:ec:e7:33:c7:34:0e:6b:b3:4f:e1:6e:7d:e3: d3:32:40:8d 20.7 - Create Client Certificate Extensions A Root Certificate Authority (CA) uses extensions to issue a certificate only for a specific purpose. Certificate Extensions were introduced in X.509 version 3 (X509v3). The Azure VPN Gateway requires specific Certificate Extensions on VPN Client certificates. More specificially, a VPN Client certificate must have the TLS Web Client Authentication (clientAuth) extended key usage (eku) extension. Additionally, X509v3 Subject Alternative Name (subjectAltName) must always be used per RFC 5280. This step creates a certificate extension file that OpenSSL will read when creating the certificate, and apply the proper extensions. Reference(s): https://tools.ietf.org/html/rfc5280 Command(s): echo \"authorityKeyIdentifier=keyid,issuer\" > \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"basicConstraints=CA:FALSE\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"extendedKeyUsage=clientAuth\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"subjectAltName=DNS:${ARO_VGW_PKI_CLIENT_NAME}\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: + success does not produce any output + success does not produce any output + success does not produce any output + success does not produce any output 20.8 - Verify Client Certificate Extensions Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: authorityKeyIdentifier=keyid,issuer extendedKeyUsage=clientAuth 20.9 - Create Client Certificate Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -req -sha256 -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -CAkey \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -CA \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE -days 1095 -CAcreateserial -CAserial \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 2>&1 Example Output: Signature ok subject=CN = ipm-vpn-client-example Getting CA Private Key 20.10 - Verify Client Certificate Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 Example Output: Certificate: Data: Version: 3 (0x2) Serial Number: 24:ac:31:61:b3:c2:b6:a2:51:50:cb:f3:7f:36:c5:7b:fa:f0:77:d3 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = ipm-vpn Validity Not Before: Sep 27 03:31:32 2020 GMT Not After : Sep 27 03:31:32 2023 GMT Subject: CN = ipm-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:a8:dd:23:26:4e:ae:34:53:2a:f7:ed:52:b1:52: 80:eb:75:0d:76:d5:53:11:f2:f4:e9:a0:1b:2f:da: 7a:ee:63:c0:f1:d2:0d:8a:11:2a:7b:4c:11:7b:66: 04:3e:2a:2f:57:87:74:12:1e:fa:c8:ef:bb:69:76: 9d:a6:e4:8f:30:1f:6f:a3:dd:64:cd:b5:f8:ca:6c: 3e:ff:01:93:c8:ff:e4:e1:8a:63:7b:0c:ff:a0:73: d3:60:ad:53:29:46:b8:17:69:3d:17:06:40:b4:44: df:77:fc:7b:44:1e:4c:0e:02:fb:42:4e:a8:ab:55: 21:68:d0:45:7d:f3:5f:81:74:9a:8b:28:08:bd:d5: 8c:84:42:26:bc:fb:a4:c7:e9:2a:17:f6:b8:b2:2d: 44:34:ca:f1:f1:74:dc:16:3f:48:f7:93:3e:fd:21: a4:35:c1:bb:c6:0c:29:a5:6a:a4:ee:34:b4:e2:22: 23:c9:fa:63:16:2a:83:72:20:27:38:aa:56:a8:9f: 50:37:e8:a2:f8:8c:98:d7:6c:60:44:b7:76:95:65: 42:a5:bc:e3:49:bd:74:d2:59:8c:c4:35:eb:bd:ec: 86:97:f6:17:ab:76:a3:1a:ab:19:c3:cd:85:74:5a: 42:32:ff:2c:51:f3:34:9d:46:3f:97:ad:b8:b0:01: c1:c9 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Authority Key Identifier: keyid:07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Basic Constraints: CA:FALSE X509v3 Extended Key Usage: TLS Web Client Authentication X509v3 Subject Alternative Name: DNS:ipm-vpn-client-example Signature Algorithm: sha256WithRSAEncryption 5a:8d:83:db:fe:c6:54:a7:9a:db:dc:6e:56:25:6c:79:1c:f0: 26:55:6c:41:3f:00:86:d8:12:96:6e:d7:0f:f0:67:7e:1f:08: 7a:f4:f4:0b:07:92:60:3b:df:5d:26:95:1b:b8:5f:18:19:01: e0:d1:d7:ed:5f:52:21:33:ef:c3:70:ab:86:34:2a:71:25:8c: ae:4c:c9:76:92:a6:c0:f4:c5:06:5f:b7:e1:8c:4a:2d:86:4f: a1:79:8d:94:2c:60:e9:a9:ab:69:b4:01:34:0b:99:63:ab:3f: 57:6c:49:9f:ed:d5:ed:0f:41:d8:af:2b:14:63:ae:b8:16:59: 93:06:35:b1:43:81:7c:c4:68:d2:08:48:ec:36:19:71:a9:ac: c9:c1:70:f5:6d:14:fd:6d:15:e2:d1:fb:86:b6:91:86:e9:3b: 1e:00:41:16:f3:95:49:98:86:30:7c:64:06:49:d1:27:94:b7: 5f:64:ce:46:5d:91:16:74:93:d4:c7:9c:ec:0f:a4:2e:32:80: 43:88:ee:12:33:2c:51:d9:a2:7e:cc:ff:b2:2f:c6:87:30:37: 89:bc:e7:ee:6b:8a:74:6f:e4:69:60:32:54:b3:ea:03:ef:a3: 37:ea:57:7f:fc:05:ef:ae:ce:cd:53:ea:4b:f9:95:b4:22:39: f5:75:01:d9 20.11 - Verify Client Moduli Warning Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed until they match. Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_REQ_FILE} = \"; openssl req -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" | md5sum Example Output: md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key = 1ec497f88cbce7449554078dce627bb4 - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt = 1ec497f88cbce7449554078dce627bb4 - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req = 1ec497f88cbce7449554078dce627bb4 - 20.12 - Create VPN Client PFX Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl pkcs12 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -inkey \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -passout pass: -certfile \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -export 2>&1 Example Output: + success does not produce any output 20.13 - Verify VPN Client PFX Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1 Example Output: Bag Attributes localKeyID: A0 FD 44 81 5B C9 B3 66 B8 F6 3E 4E 76 98 7E 26 32 7A D1 4B subject=CN = ipm-vpn-client-example issuer=CN = ipm-vpn -----BEGIN CERTIFICATE----- MIIDJzCCAg+gAwIBAgIUJKwxYbPCtqJRUMvzfzbFe/rwd9MwDQYJKoZIhvcNAQEL BQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzMxMzJaFw0yMzA5Mjcw MzMxMzJaMCExHzAdBgNVBAMMFmlwbS12cG4tY2xpZW50LWV4YW1wbGUwggEiMA0G CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCo3SMmTq40Uyr37VKxUoDrdQ121VMR 8vTpoBsv2nruY8Dx0g2KESp7TBF7ZgQ+Ki9Xh3QSHvrI77tpdp2m5I8wH2+j3WTN tfjKbD7/AZPI/+ThimN7DP+gc9NgrVMpRrgXaT0XBkC0RN93/HtEHkwOAvtCTqir VSFo0EV981+BdJqLKAi91YyEQia8+6TH6SoX9riyLUQ0yvHxdNwWP0j3kz79IaQ1 wbvGDCmlaqTuNLTiIiPJ+mMWKoNyICc4qlaon1A36KL4jJjXbGBEt3aVZUKlvONJ vXTSWYzENeu97IaX9herdqMaqxnDzYV0WkIy/yxR8zSdRj+XrbiwAcHJAgMBAAGj ZjBkMB8GA1UdIwQYMBaAFAf2Af6QYGrnnnqUP2KuoRxsf0FaMAkGA1UdEwQCMAAw EwYDVR0lBAwwCgYIKwYBBQUHAwIwIQYDVR0RBBowGIIWaXBtLXZwbi1jbGllbnQt ZXhhbXBsZTANBgkqhkiG9w0BAQsFAAOCAQEAWo2D2/7GVKea29xuViVseRzwJlVs QT8AhtgSlm7XD/Bnfh8IevT0CweSYDvfXSaVG7hfGBkB4NHX7V9SITPvw3CrhjQq cSWMrkzJdpKmwPTFBl+34YxKLYZPoXmNlCxg6amrabQBNAuZY6s/V2xJn+3V7Q9B 2K8rFGOuuBZZkwY1sUOBfMRo0ghI7DYZcamsycFw9W0U/W0V4tH7hraRhuk7HgBB FvOVSZiGMHxkBknRJ5S3X2TORl2RFnST1Mec7A+kLjKAQ4juEjMsUdmifsz/si/G hzA3ibzn7muKdG/kaWAyVLPqA++jN+pXf/wF767OzVPqS/mVtCI59XUB2Q== -----END CERTIFICATE----- Bag Attributes: <No Attributes> subject=CN = ipm-vpn issuer=CN = ipm-vpn -----BEGIN CERTIFICATE----- MIIDBTCCAe2gAwIBAgIUDL+N5H6cQKu6OblCmH+ApF42pz4wDQYJKoZIhvcNAQEL BQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzI4NTJaFw0zMDA5MjUw MzI4NTJaMBIxEDAOBgNVBAMMB2lwbS12cG4wggEiMA0GCSqGSIb3DQEBAQUAA4IB DwAwggEKAoIBAQCzguAWVlabxIHEqU1ntj60HHw4K+jwwCNd0thx3Ff75lDI9XGZ 0Da0I/JLkB0KfPMNb4EqHQeBZRlF3uLcoMjBrWG3paXkeGgD7wdZ9d7/zktc/PMK RYmQKA1JwkCVQFd+XKz3nM5nffZxNfmF3IKtnNWvCkNO42HWeZDAAlU3ylUaJrrP BR/FhkQaVNUHujiwyl1CMTuEVnBb8dQ5F76N3CXPefn8nWFZRvpHWZq7oyBN18EJ K0ySrivE9eA9GFIhWfNs4FE6heveXZ0r7eVY71o5xF+AQQDDn/yp9Tzs/mVExFrm X3l6/VC/xBTvEhOJd8laP1IQT4MxQ7w+lKgzAgMBAAGjUzBRMB0GA1UdDgQWBBQH 9gH+kGBq5556lD9irqEcbH9BWjAfBgNVHSMEGDAWgBQH9gH+kGBq5556lD9irqEc bH9BWjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCX3NG9lTcs l+d2m7yd5F3Xc26Bk+SHAnfsGd7UwdTYKzJt44n7lza2AWKMz+a9zlLBA8Ng3j9b 2k/9bM0LR2WvTuLRB4RsUGr45EE7zq74smZosO0yBPIvjZgphBbno8TqYDe2C9sE KtaUpKqA6y0UrSUePn0benIaBkT45lECOs82a0vVtGvuH4hJGiIGObo6cRn6NOKp wAg+JZFkHHQkGksGOyReYolsVPO5FVtfcNbWGaHro1LbNVPLC2s5WVoj1e3K/ERx k6dmfFFNTg/1FVfeoQkv5iN2AL9o1717aYO1Dei7ofsBGL9+OTCUAicprMnzGKJQ VeRYlCn2H9Qk -----END CERTIFICATE----- 21 - VPN Client Please follow Microsoft's instructions for installing the VPN Client for your operating system. Tip Commands for using az and wget are given below. Reference(s): https://en.wikipedia.org/wiki/X.509 https://en.wikipedia.org/wiki/PKCS_12 https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-vpn-client-install-azure-cert https://www.openssl.org/ Command(s): env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V Example Output: ARO_KEY=ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key 21.1 - Verify VPN Client URL Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/vpn-client?view=azure-cli-latest#az_network_vnet_gateway_vpn_client_generate Command(s): export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" Example Output: + success does not produce any output ARO_VGW_CONFIGURATION_URL=\"https://nfvprodsuppbl.blob.core.windows.net/vpnprofileimmutable/cf9d0077-d7e7-4c7f-aae7-7f15cc7d58d8/vpnprofile/c55a6b34-3e2f-4747-b19f-6c8ff8c5d22a/vpnclientconfiguration.zip?sv=2018-03-28&sr=b&sig=lt%2FYNiNekY3VCic3qMxtz772%2FyX30OuSiUD0NBZewU0%3D&st=2020-09-27T03%3A26%3A39Z&se=2020-09-27T04%3A26%3A39Z&sp=r&fileExtension=.zip\" 21.2 - Download VPN Client The necessary VPN Client Configuration files may be downloaded via the Azure porta or with the following commands. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/vpn-client?view=azure-cli-latest#az_network_vnet_gateway_vpn_client_generate Command(s): eval wget \"${ARO_VGW_CONFIGURATION_URL}\" -O \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 2>&1 Example Output: --2020-09-26 23:31:47-- https://nfvprodsuppbl.blob.core.windows.net/vpnprofileimmutable/cf9d0077-d7e7-4c7f-aae7-7f15cc7d58d8/vpnprofile/c55a6b34-3e2f-4747-b19f-6c8ff8c5d22a/vpnclientconfiguration.zip?sv=2018-03-28&sr=b&sig=lt%2FYNiNekY3VCic3qMxtz772%2FyX30OuSiUD0NBZewU0%3D&st=2020-09-27T03%3A26%3A39Z&se=2020-09-27T04%3A26%3A39Z&sp=r&fileExtension=.zip Resolving nfvprodsuppbl.blob.core.windows.net (nfvprodsuppbl.blob.core.windows.net)... 52.239.153.36 Connecting to nfvprodsuppbl.blob.core.windows.net (nfvprodsuppbl.blob.core.windows.net)|52.239.153.36|:443... connected. HTTP request sent, awaiting response... 200 OK Length: 303372 (296K) [application/octet-stream] Saving to: \u2018/home/jtingiris/prj/mit/aei/pki/ipm-vpn.zip\u2019 0K .......... .......... .......... .......... .......... 16% 1.01M 0s 50K .......... .......... .......... .......... .......... 33% 1.90M 0s 100K .......... .......... .......... .......... .......... 50% 92.1M 0s 150K .......... .......... .......... .......... .......... 67% 1.95M 0s 200K .......... .......... .......... .......... .......... 84% 50.7M 0s 250K .......... .......... .......... .......... ...... 100% 16.2M=0.1s 2020-09-26 23:31:47 (2.80 MB/s) - \u2018/home/jtingiris/prj/mit/aei/pki/ipm-vpn.zip\u2019 saved [303372/303372] 21.3 - Distribute VPN Client & PFX 22 - Obtain Pull Secrets Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries. 22.1 - Obtain Red Hat Pull Secret A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. To obtain a Red Hat pull secret, go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned Note This step must be done manually, via a web browser. It is optional though recommended. Important Make sure to update ${ARO_REDHAT_PULL_SECRET_FILE} with the path where the pull secret was saved. Reference(s): https://access.redhat.com/solutions/4844461 22.2 - Verify Red Hat Pull Secret Command(s): ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: -rw-rw----. 1 jtingiris mit 2835 Sep 12 10:26 /home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt 23 - Azure Red Hat OpenShift Reference(s): https://azure.microsoft.com/en-us/services/openshift/ https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest Command(s): env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V Example Output: ARO_CLUSTER_DOMAIN_NAME=ipm.mitaei.net ARO_CLUSTER_NAME=ipm-cluster ARO_CLUSTER_VISIBILITY_API=Private ARO_CLUSTER_VISIBILITY_INGRESS=Private ARO_CLUSTER_VM_MASTER_SIZE=Standard_D8s_v3 ARO_CLUSTER_VM_WORKER_COUNT=3 ARO_CLUSTER_VM_WORKER_DISK_GB=128 ARO_CLUSTER_VM_WORKER_SIZE=Standard_D8s_v3 ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_VNET_NAME=ipm-vnet 23.1 - Create ARO Cluster This can take up to an hour. Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_create https://docs.openshift.com/container-platform/4.4/installing/installing_azure/installing-azure-network-customizations.html#modifying-nwoperator-config-startup_installing-azure-network-customizations Command(s): az aro create --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --name \"${ARO_CLUSTER_NAME}\" --master-subnet \"${ARO_SUBNET_MASTER_NAME}\" --master-vm-size \"${ARO_CLUSTER_VM_MASTER_SIZE}\" --worker-subnet \"${ARO_SUBNET_WORKER_NAME}\" --worker-count ${ARO_CLUSTER_VM_WORKER_COUNT} --worker-vm-size \"${ARO_CLUSTER_VM_WORKER_SIZE}\" --worker-vm-disk-size-gb ${ARO_CLUSTER_VM_WORKER_DISK_GB} --apiserver-visibility \"${ARO_CLUSTER_VISIBILITY_INGRESS}\" --ingress-visibility \"${ARO_CLUSTER_VISIBILITY_API}\" --pod-cidr \"${ARO_SUBNET_POD_CIDR}\" --service-cidr \"${ARO_SUBNET_SERVICE_CIDR}\" --vnet \"${ARO_VNET_NAME}\" --pull-secret @\"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: { \"apiserverProfile\": { \"ip\": \"10.10.0.4\", \"url\": \"https://api.my4zz953.eastus.aroapp.io:6443/\", \"visibility\": \"Private\" }, \"clusterProfile\": { \"domain\": \"my4zz953\", \"pullSecret\": null, \"resourceGroupId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-my4zz953\", \"version\": \"4.4.17\" }, \"consoleProfile\": { \"url\": \"https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/\" }, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.RedHatOpenShift/openShiftClusters/ipm-cluster\", \"ingressProfiles\": [ { \"ip\": \"10.10.2.4\", \"name\": \"default\", \"visibility\": \"Private\" } ], \"location\": \"eastus\", \"masterProfile\": { \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, \"name\": \"ipm-cluster\", \"networkProfile\": { \"podCidr\": \"10.12.0.0/14\", \"serviceCidr\": \"10.11.0.0/16\" }, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"servicePrincipalProfile\": { \"clientId\": \"de8651b4-5479-47c4-8be4-0081ee8ae5d6\", \"clientSecret\": null }, \"tags\": null, \"type\": \"Microsoft.RedHatOpenShift/openShiftClusters\", \"workerProfiles\": [ { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus1\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus2\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus3\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" } ] } 23.2 - Verify ARO Cluster Command(s): az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" Example Output: https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/ { \"apiserverProfile\": { \"ip\": \"10.10.0.4\", \"url\": \"https://api.my4zz953.eastus.aroapp.io:6443/\", \"visibility\": \"Private\" }, \"clusterProfile\": { \"domain\": \"my4zz953\", \"pullSecret\": null, \"resourceGroupId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-my4zz953\", \"version\": \"4.4.17\" }, \"consoleProfile\": { \"url\": \"https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/\" }, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.RedHatOpenShift/openShiftClusters/ipm-cluster\", \"ingressProfiles\": [ { \"ip\": \"10.10.2.4\", \"name\": \"default\", \"visibility\": \"Private\" } ], \"location\": \"eastus\", \"masterProfile\": { \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, \"name\": \"ipm-cluster\", \"networkProfile\": { \"podCidr\": \"10.12.0.0/14\", \"serviceCidr\": \"10.11.0.0/16\" }, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"servicePrincipalProfile\": { \"clientId\": \"de8651b4-5479-47c4-8be4-0081ee8ae5d6\", \"clientSecret\": null }, \"tags\": null, \"type\": \"Microsoft.RedHatOpenShift/openShiftClusters\", \"workerProfiles\": [ { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus1\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus2\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus3\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" } ] } { \"kubeadminPassword\": \"TSx2J-LY56j-KznE7-SzIU3\", \"kubeadminUsername\": \"kubeadmin\" } 24 - OpenShift CLI The OpenShift CLI client oc simplifies working with Kubernetes and OpenShift clusters, offering a number of advantages over kubectl such as easy login, kube config file management, and access to developer tools. The kubectl binary is included for when strict Kubernetes compliance is necessary. Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_list_credentials https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_show https://cloud.redhat.com/openshift/install/azure/installer-provisioned https://docs.openshift.com/container-platform/4.4/cli_reference/openshift_cli/getting-started-cli.html 24.1 - Install OpenShift CLI Download the latest archive for Azure Red Hat OpenShift from here: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz After extracting the archive, move the oc and kubectl binaries to a location in the PATH, such as /usr/local/bin . To start a session with the OpenShift cluster, login. oc login [API_URL] Reference(s): https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz Command(s): wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -O /tmp/openshift-client-linux.tar.gz 2>&1 cd /tmp tar zxvf openshift-client-linux.tar.gz mv -f oc /usr/local/bin mv -f kubectl /usr/local/in Example Output: README.md oc kubectl 24.2 - Verify OpenShift CLI Command(s): oc version kubectl version Example Output: Client Version: 4.5.11 Client Version: version.Info{Major:\"1\", Minor:\"18\", GitVersion:\"v1.18.2-0-g52c56ce\", GitCommit:\"d7f3ccf9a5bdc96ba92e31526cf014b3de4c46aa\", GitTreeState:\"clean\", BuildDate:\"2020-09-11T23:48:53Z\", GoVersion:\"go1.13.4\", Compiler:\"gc\", Platform:\"linux/amd64\"} 25 - OpenShift Authentication TODO","title":"Index"},{"location":"#azure-red-hat-openshift-for-ibm-product-master","text":"","title":"Azure Red Hat OpenShift for IBM Product Master"},{"location":"#draft","text":"This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 10:58:31 PM EDT","title":"[DRAFT]"},{"location":"#introduction","text":"This document details the steps required to automate the build of a secure, private Azure Red Hat OpenShift v4.x (ARO) infrastructure for IBM Product Master v12.x. The procedure to install IBM Product Master is an accompanying document.","title":"Introduction"},{"location":"#azure","text":"Microsoft Azure is a comprehensive cloud computing service managed by Microsoft. It provides software as a service (SaaS), platform as a service (PaaS), and infrastructure as a service (IaaS).","title":"Azure"},{"location":"#openshift-container-platform","text":"Red Hat's OpenShift Container Platform (OCP) is a hybrid cloud, enterprise Kubernetes application platform. It is a platform as a service (Paas) built on Red Hat Enterprise Linux (RHEL), with Docker containers managed by Kubernetes.","title":"OpenShift Container Platform"},{"location":"#azure-red-hat-openshift","text":"Azure Red Hat OpenShift (ARO) is a fully managed offering of Red Hat OpenShift running in Microsoft Azure. This service is jointly managed and supported by both Microsoft and Red Hat. For more details, see the Azure Red Hat OpenShift Service documentation.","title":"Azure Red Hat OpenShift"},{"location":"#ibm-product-master","text":"IBM Product Master (IPM) provides trusted Product Information Management (PIM) and collaborative Master Data Management (MDM) capabilities. It creates an accurate and up-to-date repository of product and service information that can be used throughout organizations for strategic business initiatives Reference(s): https://www.openshift.com/blog/introducing-azure-red-hat-openshift-on-openshift-4 https://docs.openshift.com/aro/4/architecture/architecture.html https://azure.microsoft.com/ https://www.openshift.com/ https://www.docker.com/ https://kubernetes.io/ https://docs.microsoft.com/en-us/azure/openshift/openshift-faq https://docs.microsoft.com/en-us/azure/openshift/support-lifecycle https://www.ibm.com/products/product-master","title":"IBM Product Master"},{"location":"#usage","text":"This document provides a step-by-step approach. Each step is dependent upon the successful completion of previous steps. The steps are structured and all follow this same pattern.","title":"Usage"},{"location":"#description","text":"Many steps will have a detailed description that will provide additional context. In the interest of brevity, not all steps will have detailed descriptions.","title":"Description"},{"location":"#references","text":"Most steps will have relevant, linked references. All references given are to supporting documentation.","title":"Reference(s)"},{"location":"#commands","text":"These are the bash commands that must be run. The expectation is that they will be copy/paste. For that reason, the majority of commands rely on pre-set environment variables. The environment variables provide for portability, flexibility, and a consistent experience. If there are problems running any commands then it's most likely the environment variables are incorrect.","title":"Command(s)"},{"location":"#example-output","text":"When there is output from a command, the example output will be given. Please compare the outputs to ensure consistency. It may be helpful.","title":"Example Output"},{"location":"#1-azure-tenant","text":"A tenant is Microsoft's representation of an organization. It is a dedicated instance of Azure Active Directory (AAD) that is received when creating a new relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before Azure Red Hat OpenShift (ARO) can be installed, Microsoft accounts must exist and have appropriate access to an AAD tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. Note If you are the Global Administrator of an existing tenant, go to step 2. Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant","title":"1 - Azure Tenant"},{"location":"#11-create-microsoft-account","text":"Reference(s): https://support.microsoft.com/en-us/help/4558219/microsoft-account-what-is https://en.wikipedia.org/wiki/Microsoft_account","title":"1.1 - Create Microsoft Account"},{"location":"#12-create-global-administrator","text":"The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Add and manage domains Assign the Global Administrator role to other users Reset passwords for all users Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide","title":"1.2 - Create Global Administrator"},{"location":"#13-verify-admin-center-access","text":"The Microsoft 365 admin center simplifies management of Microsoft 365 services. The admin center provides a tailored experience based on the the role of the logged in user. It is the common entry point for all Microsoft administrators. https://admin.microsoft.com/ Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide","title":"1.3 - Verify Admin Center Access"},{"location":"#14-verify-aad-license","text":"The Azure Active Directory license can be verified by visiting the Directory Overview section on the Azure Portal. https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis","title":"1.4 - Verify AAD License"},{"location":"#2-azure-subscription","text":"An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required during the installation of ARO. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators. Reference(s): https://docs.microsoft.com/en-us/microsoft-365/enterprise/subscriptions-licenses-accounts-and-tenants-for-microsoft-cloud-offerings?view=o365-worldwide","title":"2 - Azure Subscription"},{"location":"#21-create-azure-subscription","text":"An Azure subscription may be purchased directly from Microsoft through the Azure website, through a Microsoft representative, or as part of a managed service from a Microsoft Partner. The Microsoft account that purchases the Azure subscription will automtically be assigned the Owner role. Additional Owners may be added later. To learn more about the Azure purchase options, visit this link. https://azure.microsoft.com/en-us/pricing/purchase-options/ Reference(s): https://azure.microsoft.com/","title":"2.1 - Create Azure Subscription"},{"location":"#3-operating-system","text":"The ARO build procedures in this document depend upon a GNU/Linux Operating System (OS) and related tools. Special care has been taken to ensure the commands given will work on any GNU/Linux distribution. As of this writing, they have been successfully tested on Fedora 31+, Debian 9+, and Ubuntu 18+. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+ GNU bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep GNU wget Google Chrome or Firefox OpenSSL Reference(s): https://www.gnu.org/gnu/linux-and-gnu","title":"3 - Operating System"},{"location":"#31-verify-operating-system","text":"The purpose of this step is to verify the Operating System is GNU/Linux and the dependent tools used in this document are installed. Reference(s): https://man7.org/linux/man-pages/man2/uname.2.html https://en.wikipedia.org/wiki/Uname Command(s): uname -a Example Output: Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux","title":"3.1 - Verify Operating System"},{"location":"#32-verify-gnu-bash","text":"Reference(s): https://www.man7.org/linux/man-pages/man1/bash.1.html https://en.wikipedia.org/wiki/Bash_(Unix_shell) https://www.gnu.org/software/bash/ Command(s): bash --version Example Output: GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law.","title":"3.2 - Verify GNU bash"},{"location":"#33-verify-gnu-awk","text":"Reference(s): https://man7.org/linux/man-pages/man1/awk.1p.html https://en.wikipedia.org/wiki/AWK https://www.gnu.org/software/gawk/ Command(s): awk --version Example Output: GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/.","title":"3.3 - Verify GNU awk"},{"location":"#34-verify-gnu-coreutils","text":"Reference(s): https://www.gnu.org/software/coreutils/ https://en.wikipedia.org/wiki/GNU_Core_Utilities Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering.","title":"3.4 - Verify GNU coreutils"},{"location":"#35-verify-gnu-grep","text":"Reference(s): https://man7.org/linux/man-pages/man1/grep.1.html https://en.wikipedia.org/wiki/Grep https://www.gnu.org/software/grep/ Command(s): egrep --version Example Output: grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>.","title":"3.5 - Verify GNU grep"},{"location":"#36-verify-gnu-wget","text":"Reference(s): https://man7.org/linux/man-pages/man1/wget.1.html https://en.wikipedia.org/wiki/Wget https://www.gnu.org/software/wget/ Command(s): wget --version Example Output: GNU Wget 1.20.3 built on linux-gnu. -cares +digest +gpgme +https +ipv6 +iri +large-file +metalink +nls +ntlm +opie +psl +ssl/gnutls Wgetrc: /etc/wgetrc (system) Locale: /usr/share/locale Compile: gcc -DHAVE_CONFIG_H -DSYSTEM_WGETRC=\"/etc/wgetrc\" -DLOCALEDIR=\"/usr/share/locale\" -I. -I../lib -I../lib -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection Link: gcc -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lmetalink -lpcre2-8 -luuid -lidn2 -lnettle -lgnutls -lz -lpsl -L/usr/lib64 -lgpgme ftp-opie.o gnutls.o http-ntlm.o ../lib/libgnu.a Copyright (C) 2015 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://www.gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Originally written by Hrvoje Niksic <hniksic@xemacs.org>. Please send bug reports and questions to <bug-wget@gnu.org>.","title":"3.6 - Verify GNU wget"},{"location":"#37-verify-browser","text":"Either Google Chrome or Firefox is needed for a few steps. Other browsers will probably work, too, though haven't been tested. Reference(s): https://www.mozilla.org/ https://www.google.com/chrome/ Command(s): firefox --version google-chrome --version Example Output: Mozilla Firefox 80.0 Google Chrome 85.0.4183.83","title":"3.7 - Verify Browser"},{"location":"#38-verify-openssl","text":"Reference(s): https://www.openssl.org/ Command(s): openssl version Example Output: OpenSSL 1.1.1g FIPS 21 Apr 2020","title":"3.8 - Verify OpenSSL"},{"location":"#4-environment-variables","text":"Important This document depends heavily on the bash shell. There are required bash environment variables that are necessary to execute most steps in this document. The environment variables must be exported prior to running the Command(s). Warning Subsequent steps in this document will not work unless the bash shell environment is properly setup. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html","title":"4 - Environment Variables"},{"location":"#41-unset-environment-variables","text":"Note Unsetting the ARO environment variables can help prevent issues when, or if they have changed in the configuration file. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done Example Output: unset ARO unset ARO_ADMINISTRATORS_GROUP_NAME unset ARO_APPLICATION_NAME unset ARO_CLUSTER_DOMAIN_NAME unset ARO_CLUSTER_NAME unset ARO_CLUSTER_VISIBILITY_API unset ARO_CLUSTER_VISIBILITY_INGRESS unset ARO_CLUSTER_VM_MASTER_SIZE unset ARO_CLUSTER_VM_WORKER_COUNT unset ARO_CLUSTER_VM_WORKER_DISK_GB unset ARO_CLUSTER_VM_WORKER_SIZE unset ARO_DOMAIN_NAME unset ARO_LOCATION_NAME unset ARO_REDHAT_PULL_SECRET_DIR unset ARO_REDHAT_PULL_SECRET_FILE unset ARO_RESOURCE_GROUP_NAME unset ARO_SERVICE_PRINCIPAL_NAME unset ARO_SERVICE_PRINCIPAL_PASSWORD unset ARO_SUBNET_AGW_CIDR unset ARO_SUBNET_AGW_NAME unset ARO_SUBNET_AGW_NSG_NAME unset ARO_SUBNET_DB_CIDR unset ARO_SUBNET_DB_NAME unset ARO_SUBNET_DB_NSG_NAME unset ARO_SUBNET_DMZ_CIDR unset ARO_SUBNET_DMZ_NAME unset ARO_SUBNET_DMZ_NSG_NAME unset ARO_SUBNET_MASTER_CIDR unset ARO_SUBNET_MASTER_NAME unset ARO_SUBNET_MASTER_NSG_NAME unset ARO_SUBNET_POD_CIDR unset ARO_SUBNET_SERVICE_CIDR unset ARO_SUBNET_TRUSTED_CIDR unset ARO_SUBNET_TRUSTED_NAME unset ARO_SUBNET_TRUSTED_NSG_NAME unset ARO_SUBNET_VGW_CIDR unset ARO_SUBNET_VGW_NAME unset ARO_SUBNET_VGW_POOL_CIDR unset ARO_SUBNET_VGW_POOL_NAME unset ARO_SUBNET_VGW_POOL_NSG_NAME unset ARO_SUBNET_WORKER_CIDR unset ARO_SUBNET_WORKER_NAME unset ARO_SUBNET_WORKER_NSG_NAME unset ARO_SUBSCRIPTION_ID unset ARO_SUBSCRIPTION_NAME unset ARO_TENANT_ID unset ARO_TENANT_NAME unset ARO_VGW_NAME unset ARO_VGW_PKI_BITS unset ARO_VGW_PKI_CLIENT unset ARO_VGW_PKI_CLIENT_CRT_FILE unset ARO_VGW_PKI_CLIENT_EXT_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_CLIENT_NAME unset ARO_VGW_PKI_CLIENT_PFX_FILE unset ARO_VGW_PKI_CLIENT_REQ_FILE unset ARO_VGW_PKI_CLIENT_SERIAL_FILE unset ARO_VGW_PKI_DIR unset ARO_VGW_PKI_ROOT_CA_SERIAL_FILE unset ARO_VGW_PKI_ROOT_CRT_FILE unset ARO_VGW_PKI_ROOT_CRT_NAME unset ARO_VGW_PKI_ROOT_KEY_FILE unset ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_ROOT_KEY_NAME unset ARO_VGW_PUBLIC_ADDRESS_NAME unset ARO_VGW_REDUNDANCY unset ARO_VGW_SKU unset ARO_VGW_TYPE unset ARO_VM_JUMP_ADMIN_NAME unset ARO_VM_JUMP_IMAGE_MARKETPLACE unset ARO_VM_JUMP_IMAGE_URN unset ARO_VM_JUMP_NAME unset ARO_VM_JUMP_PUBLIC_ADDRESS_NAME unset ARO_VM_JUMP_SIZE unset ARO_VNET_CIDR unset ARO_VNET_NAME","title":"4.1 - Unset Environment Variables"},{"location":"#42-set-environment-variables","text":"The following bash shell environment variables are required. They are reused for multiple steps. It is recommended that the environment variables be maintained in a configuration file, i.e. ipm.env Maintaining a configuration file will make them easier to use and update. Important Before proceeding, please take your time ensuring the environment variable values are correct. These are example values that must be changed. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): cat \"ipm.env\" && source \"ipm.env\" Example Output: # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done'","title":"4.2 - Set Environment Variables"},{"location":"#43-verify-environment-variables","text":"Ensure the ARO variables are avaialble in the bash shell environment that you're working in. Reference(s): https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=ipm ARO_ADMINISTRATORS_GROUP_NAME=OpenShift Administrators ARO_APPLICATION_NAME=ipm-app ARO_CLUSTER_DOMAIN_NAME=ipm.mitaei.net ARO_CLUSTER_NAME=ipm-cluster ARO_CLUSTER_VISIBILITY_API=Private ARO_CLUSTER_VISIBILITY_INGRESS=Private ARO_CLUSTER_VM_MASTER_SIZE=Standard_D8s_v3 ARO_CLUSTER_VM_WORKER_COUNT=3 ARO_CLUSTER_VM_WORKER_DISK_GB=128 ARO_CLUSTER_VM_WORKER_SIZE=Standard_D8s_v3 ARO_DOMAIN_NAME=mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SERVICE_PRINCIPAL_NAME=http://ipm-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBNET_AGW_CIDR=10.10.11.0/24 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_CIDR=10.10.12.0/24 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_POD_CIDR=10.12.0.0/14 ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_CIDR=10.10.10.0/24 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 ARO_SUBNET_VGW_POOL_NAME=ipm-vnet-vpn-pool-subnet ARO_SUBNET_VGW_POOL_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_CIDR=10.10.0.0/16 ARO_VNET_NAME=ipm-vnet","title":"4.3 - Verify Environment Variables"},{"location":"#5-required-directories","text":"This documentation provides commands that create files. To better organize the output files, the directories must exist or be created. Command(s): env | egrep \"ARO.*DIR\" | sort -V Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki","title":"5 - Required Directories"},{"location":"#51-create-required-directories","text":"Reference(s): https://man7.org/linux/man-pages/man1/mkdir.1.html Command(s): mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: + success does not produce any output","title":"5.1 - Create Required Directories"},{"location":"#52-verify-required-directories","text":"Reference(s): https://man7.org/linux/man-pages/man1/ls.1.html Command(s): ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: drwxrws---+ 2 jtingiris mit 24 Sep 26 22:34 /home/jtingiris/prj/mit/aei/pki drwxrws---+ 2 jtingiris mit 4096 Sep 26 11:51 /home/jtingiris/prj/mit/aei/secrets","title":"5.2 - Verify Required Directories"},{"location":"#6-azure-cli","text":"The Azure CLI is a Command Line Interface (CLI) used to create and manage Azure resources. The Azure CLI works with all Azure services. It is designed to more quickly work with Azure, with an emphasis on automation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest Command(s): which az Example Output: /usr/bin/az","title":"6 - Azure CLI"},{"location":"#61-install-azure-cli","text":"The Azure CLI is available to install on Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. Note To install the Azure CLI, please follow the link in the Reference(s) section. Reference(s): https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Command(s): az --version Example Output: azure-cli 2.12.0 core 2.12.0 telemetry 1.0.6 Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Your CLI is up-to-date. Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy","title":"6.1 - Install Azure CLI"},{"location":"#62-subscription-owner-login","text":"The Azure Subscription Owner must perform the remaining steps in this documentation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Command(s): az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net","title":"6.2 - Subscription Owner Login"},{"location":"#63-verify-azure-tenant","text":"One way to verify the Azure Tenant is to obtain the Tenant ID with az. Another way is to login to the Azure AAD portal. The Tenant ID must match what is in the environment configuration file. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_show https://aad.portal.azure.com/ Command(s): az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi Example Output: [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ]","title":"6.3 - Verify Azure Tenant"},{"location":"#64-set-default-subscription","text":"Set the default subscription that the ARO resources will be installed in. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_set Command(s): az account set -s \"${ARO_SUBSCRIPTION_NAME}\" Example Output: + success does not produce any output","title":"6.4 - Set Default Subscription"},{"location":"#65-verify-default-subscription","text":"The Azure CLI Default Subscription will be used to provision all ARO resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Command(s): az account list --query '[?isDefault == `true`]' Example Output: [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ]","title":"6.5 - Verify Default Subscription"},{"location":"#7-subscription-owners","text":"There should be at least two (2) Subscription Owners. This step is optional, but recommended. It will use the ${ARO_SUBSCRIPTION_OWNERS} environment value and ensure all User Principal Names (UPNs) are added as Subscription Owners. Reference(s): https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner","title":"7 - Subscription Owners"},{"location":"#71-create-subscription-owners","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create Command(s): for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"name\": \"c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"principalId\": \"52f7dd5d-ad08-4b40-878f-40686c51c24e\", \"principalName\": \"christy.walsh@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"name\": \"0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" }","title":"7.1 - Create Subscription Owners"},{"location":"#72-verify-subscription-owners","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Principal Role Scope -------------------------- ------ --------------------------------------------------- christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"7.2 - Verify Subscription Owners"},{"location":"#8-subscription-details","text":"Uze az to verify Azure Subscription details. The subscription may also be manually verified via the Azure Portal Subscription blade. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest Command(s): env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" Example Output: ARO_LOCATION_NAME=eastus ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_SUBSCRIPTION_OWNERS=christy.walsh@mitaei.net joseph.tingiris@mitaei.net ARO_VERIFY_QUOTA_NAMES=Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs","title":"8 - Subscription Details"},{"location":"#81-verify-subscription-name","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade Command(s): az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi Example Output: Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ]","title":"8.1 - Verify Subscription Name"},{"location":"#82-verify-subscription-id","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show Command(s): az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi Example Output: [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ]","title":"8.2 - Verify Subscription ID"},{"location":"#83-verify-subscription-location","text":"Note Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable location for the installation. The location name will be used throughout this document. Reference(s): https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Command(s): az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi Example Output: Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US","title":"8.3 - Verify Subscription Location"},{"location":"#84-verify-subscription-limits","text":"An ARO cluster uses several Microsoft Azure components. It requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. The Azure subscription and service limits, quotas, and constraints may be insufficient to install ARO. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. It is wise to check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. ARO minimum limits are required for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html Command(s): if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi Example Output: + success does not produce any output","title":"8.4 - Verify Subscription Limits"},{"location":"#85-verify-subscription-quotas","text":"Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner must do this step. Important To increase the quota limits, a support case must be opened with Microsoft. They will communicate directly to the person who requested the increase. An increase in the VM series quotas will automatically increase the total regional vCPU limit by the same amount. Links to Microsoft's directions on how to request a quota increase are provided in the Reference(s) section. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Verify subscription quotas for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests Command(s): for ARO_VERIFY_QUOTA_NAME in \"${ARO_VERIFY_QUOTA_NAMES[@]}\"; do echo \"ARO_VERIFY_QUOTA_NAME=${ARO_VERIFY_QUOTA_NAME}\"; done; unset ARO_VERIFY_QUOTA_NAMES Example Output: ARO_VERIFY_QUOTA_NAME=Standard DSv3 Family vCPUs ARO_VERIFY_QUOTA_NAME=Standard Dv2 Family vCPUs","title":"8.5 - Verify Subscription Quotas"},{"location":"#9-openshift-administrators","text":"Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities. The details for how to use az to create users, groups, and add the necessary subscription roles is described below. Command(s): env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" Example Output: ARO_DOMAIN_NAME=mitaei.net ARO_ADMINISTRATORS=openshift-admin@mitaei.net arun.babu@mitaei.net joseph.tingiris@mitaei.net sivaprasad.k@mitaei.net","title":"9 - OpenShift Administrators"},{"location":"#91-create-administrators","text":"This is a good time for the Global Administrator to create Microsoft accounts for the OpenShift Administrators. Ideally, the OpenShift Administrators would also have the Global Administrator role for the tenant. However, this is not always possible. If you are the Global Administrator then please take note that the OpenShift Administrators must have Microsoft accounts in the tenant , and their Microsoft accounts must have at least the Contributor and User Access Administrator roles for the Azure Subscription in which ARO is to be deployed. Creating users may be done with az , via the AAD portal, or [https://admin.microsoft.com]. Important The openshift-admin user created is an example and should not be used. We strongly recommend using real names and individual accounts, not ficticous names or group accounts. Command(s): az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login Example Output: { \"accountEnabled\": true, \"ageGroup\": null, \"assignedLicenses\": [], \"assignedPlans\": [], \"city\": null, \"companyName\": null, \"consentProvidedForMinor\": null, \"country\": null, \"createdDateTime\": null, \"creationType\": null, \"deletionTimestamp\": null, \"department\": null, \"dirSyncEnabled\": null, \"displayName\": \"openshift-admin@mitaei.net\", \"employeeId\": null, \"facsimileTelephoneNumber\": null, \"givenName\": null, \"immutableId\": null, \"isCompromised\": null, \"jobTitle\": null, \"lastDirSyncTime\": null, \"legalAgeGroupClassification\": null, \"mail\": null, \"mailNickname\": \"openshift-admin\", \"mobile\": null, \"objectId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"objectType\": \"User\", \"odata.metadata\": \"https://graph.windows.net/25fe96e7-85ec-4e6a-b93f-779b16ff751d/$metadata#directoryObjects/@Element\", \"odata.type\": \"Microsoft.DirectoryServices.User\", \"onPremisesDistinguishedName\": null, \"onPremisesSecurityIdentifier\": null, \"otherMails\": [], \"passwordPolicies\": null, \"passwordProfile\": { \"enforceChangePasswordPolicy\": false, \"forceChangePasswordNextLogin\": true, \"password\": null }, \"physicalDeliveryOfficeName\": null, \"postalCode\": null, \"preferredLanguage\": null, \"provisionedPlans\": [], \"provisioningErrors\": [], \"proxyAddresses\": [], \"refreshTokensValidFromDateTime\": \"2020-09-27T02:58:50.8444883Z\", \"showInAddressList\": null, \"signInNames\": [], \"sipProxyAddress\": null, \"state\": null, \"streetAddress\": null, \"surname\": null, \"telephoneNumber\": null, \"thumbnailPhoto@odata.mediaEditLink\": \"directoryObjects/95ccd40a-9c98-4d4f-9846-eaed016e3ef9/Microsoft.DirectoryServices.User/thumbnailPhoto\", \"usageLocation\": null, \"userIdentities\": [], \"userPrincipalName\": \"openshift-admin@mitaei.net\", \"userState\": null, \"userStateChangedOn\": null, \"userType\": \"Member\" }","title":"9.1 - Create Administrators"},{"location":"#92-verify-administrators","text":"Verify the OpenShift Administrator accounts listed in ${ARO_ADMINISTRATORS} exist. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done Example Output: [ { \"userPrincipalName\": \"openshift-admin@mitaei.net\" }, { \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\" } ] [ { \"userPrincipalName\": \"arun.babu@mitaei.net\" }, { \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\" } ] [ { \"userPrincipalName\": \"joseph.tingiris@mitaei.net\" }, { \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\" } ] [ { \"userPrincipalName\": \"sivaprasad.k@mitaei.net\" }, { \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\" } ]","title":"9.2 - Verify Administrators"},{"location":"#93-create-administrator-roles","text":"The Contributor and User Access Administrator subscription roles are required to administer ARO. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/00c1ec40-d6b3-40b0-b784-41c9ab6250f5\", \"name\": \"00c1ec40-d6b3-40b0-b784-41c9ab6250f5\", \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/e25a7a15-d599-4cb7-8593-c34c6d31b448\", \"name\": \"e25a7a15-d599-4cb7-8593-c34c6d31b448\", \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/8f458612-ca5f-4ff2-832a-d00e700975b0\", \"name\": \"8f458612-ca5f-4ff2-832a-d00e700975b0\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/7f1ba7da-c858-489f-a988-39123faa181f\", \"name\": \"7f1ba7da-c858-489f-a988-39123faa181f\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/6f98e077-c161-453d-a903-b00acb9bd5f2\", \"name\": \"6f98e077-c161-453d-a903-b00acb9bd5f2\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"name\": \"91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/1bf7b433-935b-4160-a634-43bd291739c8\", \"name\": \"1bf7b433-935b-4160-a634-43bd291739c8\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"name\": \"13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" }","title":"9.3 - Create Administrator Roles"},{"location":"#94-verify-administrator-roles","text":"Verify all ${ARO_ADMINISTRATORS} have the Contributor and User Access Administrator subscription roles. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done Example Output: Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- openshift-admin@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 openshift-admin@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"9.4 - Verify Administrator Roles"},{"location":"#10-resource-providers","text":"Make sure you are logged in to Azure via az az login and have the Contributor or Owner role. Warning These steps will fail with only the User Access Administrator role. An unauthorized message will be received. These steps will fail without the --wait flag. Dependent providers are automatically registered and they must be registered first. Reference(s): https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types Command(s): echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" Example Output: ARO_RESOURCE_PROVIDERS=Microsoft.Compute Microsoft.RedHatOpenShift Microsoft.Storage","title":"10 - Resource Providers"},{"location":"#101-register-provider-microsoftcompute","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Compute --wait Example Output: + success does not produce any output","title":"10.1 - Register Provider Microsoft.Compute"},{"location":"#102-verify-provider-microsoftcompute","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Compute --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered","title":"10.2 - Verify Provider Microsoft.Compute"},{"location":"#103-register-provider-microsoftredhatopenshift","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.RedHatOpenShift --wait Example Output: + success does not produce any output","title":"10.3 - Register Provider Microsoft.RedHatOpenShift"},{"location":"#104-verify-provider-microsoftredhatopenshift","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.RedHatOpenShift --output table Example Output: Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered","title":"10.4 - Verify Provider Microsoft.RedHatOpenShift"},{"location":"#105-register-provider-microsoftstorage","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Storage --wait Example Output: + success does not produce any output","title":"10.5 - Register Provider Microsoft.Storage"},{"location":"#106-verify-provider-microsoftstorage","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Storage --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered","title":"10.6 - Verify Provider Microsoft.Storage"},{"location":"#11-resource-group","text":"An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest Command(s): env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' Example Output: ARO_LOCATION_NAME=eastus ARO_RESOURCE_GROUP_NAME=ipm-eastus","title":"11 - Resource Group"},{"location":"#111-create-resource-group","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Command(s): az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"11.1 - Create Resource Group"},{"location":"#112-verify-resource-group","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Command(s): az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"11.2 - Verify Resource Group"},{"location":"#12-virtual-network","text":"An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Command(s): env | grep ^ARO_VNET | sort -V Example Output: ARO_VNET_CIDR=10.10.0.0/16 ARO_VNET_NAME=ipm-vnet","title":"12 - Virtual Network"},{"location":"#121-create-virtual-network","text":"In addition to the VNet CIDR, to be able to route to the Service & POD CIDRs then include them as address prefixes too. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_CIDR} ${ARO_SUBNET_SERVICE_CIDR} ${ARO_SUBNET_POD_CIDR} Example Output: { \"newVNet\": { \"addressSpace\": { \"addressPrefixes\": [ \"10.10.0.0/16\", \"10.11.0.0/16\", \"10.12.0.0/14\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"3fe1740b-d54f-4543-bd34-eb70a25c3285\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"e6da571b-7213-4fa5-ad7b-9164be85e48a\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] } }","title":"12.1 - Create Virtual Network"},{"location":"#122-verify-virtual-network","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Command(s): az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: { \"addressSpace\": { \"addressPrefixes\": [ \"10.10.0.0/16\", \"10.11.0.0/16\", \"10.12.0.0/14\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"3fe1740b-d54f-4543-bd34-eb70a25c3285\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"e6da571b-7213-4fa5-ad7b-9164be85e48a\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] }","title":"12.2 - Verify Virtual Network"},{"location":"#13-openshift-subnets","text":"Before installing, Azure Red Hat OpenShift clusters require manually creating a virtual network with two empty subnets for the master and worker VMs. Additionally, the Pod & Service subnets will automatically assigned during the installation. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Important Pod and Service Network CIDRs are configurable. Workers and masters must be in different subnets. Workers and masters virtual network subnets should be minimum /27. Pod CIDR should be minimum /18 in size. The pod network is non-routable IPs, and is only used inside the OpenShift SDN. Each node is allocated /23 subnet (512 IPs) for its pods. This value cannot be changed. You cannot attach a pod to multiple networks. Note In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher_ ; Please see the references in this section for more details. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-create https://docs.microsoft.com/en-us/azure/openshift/concepts-networking https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://docs.openshift.com/aro/4/networking/understanding-networking.html https://tools.ietf.org/html/rfc1918 Command(s): env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V Example Output: ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg","title":"13 - OpenShift Subnets"},{"location":"#131-verify-openshift-cluster","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_show Command(s): az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --output table 2> /dev/null; if [ $? -eq 0 ]; then echo \"ERROR! ARO cluster ${ARO_CLUSTER_NAME} exists; do not recreate the master or worker subnets\"; fi Example Output: + success does not produce any output","title":"13.1 - Verify OpenShift Cluster"},{"location":"#132-create-master-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --address-prefixes ${ARO_SUBNET_MASTER_CIDR} --service-endpoints Microsoft.ContainerRegistry Example Output: { \"addressPrefix\": \"10.10.0.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"a4a4f3f3-7031-4349-a4db-918e078ca7ad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-master-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"13.2 - Create Master Subnet"},{"location":"#133-disable-master-subnet-private-link-service","text":"This is required to be able to connect and manage the cluster. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_update https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet update --name ${ARO_SUBNET_MASTER_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --disable-private-link-service-network-policies true Example Output: { \"addressPrefix\": \"10.10.0.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"9611966b-4097-4d4f-bc93-b42cc963488a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-master-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Disabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"13.3 - Disable Master Subnet Private Link Service"},{"location":"#134-verify-master-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.0.0/23 ipm-vnet-master-subnet Enabled Disabled Succeeded ipm-eastus","title":"13.4 - Verify Master Subnet"},{"location":"#135-create-worker-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --address-prefixes ${ARO_SUBNET_WORKER_CIDR} --service-endpoints Microsoft.ContainerRegistry Example Output: { \"addressPrefix\": \"10.10.2.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"5ab0e900-d3cf-4f86-a3d8-c447f29eb66c\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-worker-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"13.5 - Create Worker Subnet"},{"location":"#136-verify-worker-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.2.0/23 ipm-vnet-worker-subnet Enabled Enabled Succeeded ipm-eastus","title":"13.6 - Verify Worker Subnet"},{"location":"#14-network-security-groups","text":"An Azure Network Security Group (NSG) filters network traffic to and from Azure resources in an Azure virtual network. An NSG contains security rules that allow/deny network traffic to/from several types of Azure resources. Note The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Command(s): env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg","title":"14 - Network Security Groups"},{"location":"#141-create-network-security-groups","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_create Command(s): az network nsg create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} Example Output: { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-agw-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"be4701a3-7c2d-492a-a689-adc40198cba7\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-db-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"a58d572b-dfba-4a3e-b95e-a7c131b01f62\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-dmz-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"ed09e48f-c160-4d63-ad0c-a6df53b6e9eb\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-trusted-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"b415518e-9aa4-447c-abbe-80ebea22c62b\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } }","title":"14.1 - Create Network Security Groups"},{"location":"#142-verify-network-security-groups","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_show Command(s): az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo Example Output: Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-agw-subnet-nsg Succeeded ipm-eastus be4701a3-7c2d-492a-a689-adc40198cba7 Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ---------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-db-subnet-nsg Succeeded ipm-eastus a58d572b-dfba-4a3e-b95e-a7c131b01f62 Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-dmz-subnet-nsg Succeeded ipm-eastus ed09e48f-c160-4d63-ad0c-a6df53b6e9eb Location Name ProvisioningState ResourceGroup ResourceGuid ---------- --------------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-trusted-subnet-nsg Succeeded ipm-eastus b415518e-9aa4-447c-abbe-80ebea22c62b","title":"14.2 - Verify Network Security Groups"},{"location":"#15-network-security-group-rules","text":"Network Security Group (NSG) Rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows an NSG to be stateful. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Command(s): env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg","title":"15 - Network Security Group Rules"},{"location":"#151-create-dmz-nsg-rule-allowssh","text":"To be able to access the Jump Server (jumpbox) via the Internet, without a VPN setup, tcp port 22 must be opened for ssh. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_create Command(s): az network nsg rule create --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow Example Output: { \"access\": \"Allow\", \"description\": null, \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"22\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"fafcaf82-35be-48e1-9461-561a4b71e119\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/securityRules/AllowSSH\", \"name\": \"AllowSSH\", \"priority\": 1000, \"protocol\": \"Tcp\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/securityRules\" }","title":"15.1 - Create DMZ NSG Rule (AllowSSH)"},{"location":"#152-verify-dmz-nsg-rules","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_show Command(s): az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table Example Output: Protocol SourcePortRange DestinationPortRange SourceAddressPrefix DestinationAddressPrefix Access Priority Direction ProvisioningState Name ResourceGroup ---------- ----------------- ---------------------- --------------------- -------------------------- -------- ---------- ----------- ------------------- -------- --------------- Tcp * 22 * * Allow 1000 Inbound Succeeded AllowSSH ipm-eastus","title":"15.2 - Verify DMZ NSG Rules"},{"location":"#16-related-subnets","text":"IBM Product Manager requires related subnets for supplementary virtual machines, to host applications such as DB2. These subnets should be within the same resource group and VNet range previously defined. The network numbers should be IPv4 RFC1918 compliant and prefixed. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Command(s): env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_CIDR=10.10.11.0/24 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_CIDR=10.10.12.0/24 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_POD_CIDR=10.12.0.0/14 ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg","title":"16 - Related Subnets"},{"location":"#161-create-application-gateway-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --address-prefixes ${ARO_SUBNET_AGW_CIDR} --network-security-group=${ARO_SUBNET_AGW_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.11.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"e4ad09d4-d5f7-4a42-872f-8821dcd23248\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-agw-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-agw-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"16.1 - Create Application Gateway Subnet"},{"location":"#162-verify-application-gateway-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.11.0/24 ipm-vnet-agw-subnet Enabled Enabled Succeeded ipm-eastus","title":"16.2 - Verify Application Gateway Subnet"},{"location":"#163-create-database-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --address-prefixes ${ARO_SUBNET_DB_CIDR} --network-security-group=${ARO_SUBNET_DB_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.12.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"2aa8c48d-8c85-4eee-98ff-19d5a5f9e6dd\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-db-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-db-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"16.3 - Create Database Subnet"},{"location":"#164-verify-database-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------ -------------------------------- ----------------------------------- ------------------- --------------- 10.10.12.0/24 ipm-vnet-db-subnet Enabled Enabled Succeeded ipm-eastus","title":"16.4 - Verify Database Subnet"},{"location":"#165-create-dmz-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --address-prefixes ${ARO_SUBNET_DMZ_CIDR} --network-security-group=${ARO_SUBNET_DMZ_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.13.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"026bbc03-cf38-45c8-b813-6283fe479fcc\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-dmz-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-dmz-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"16.5 - Create DMZ Subnet"},{"location":"#166-verify-dmz-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.13.0/24 ipm-vnet-dmz-subnet Enabled Enabled Succeeded ipm-eastus","title":"16.6 - Verify DMZ Subnet"},{"location":"#167-create-trusted-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --address-prefixes ${ARO_SUBNET_TRUSTED_CIDR} --network-security-group ${ARO_SUBNET_TRUSTED_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.14.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"40b5794b-9c55-4230-8f97-84ccda8b94e1\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-trusted-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-trusted-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"16.7 - Create Trusted Subnet"},{"location":"#168-verify-trusted-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.14.0/24 ipm-vnet-trusted-subnet Enabled Enabled Succeeded ipm-eastus","title":"16.8 - Verify Trusted Subnet"},{"location":"#17-jump-server-vm","text":"A jump server, jump host, or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example of a jump server is a host in a DMZ. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet. It will be allowed to communicate with the other internal subnets. The NSGs may be further tune to allow specific access, as it will be done for the ARO master subnet when ARO is installed. Note The jumpbox should be created prior to the VPN Gateway, so that there is at least one machine available for connectivity testing from two different security zones: Public (Internet) and Private (RFC1918). Reference(s): https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-cli-complete https://en.wikipedia.org/wiki/Jump_server https://en.wikipedia.org/wiki/DMZ Command(s): env | egrep ARO.*JUMP | sort -V Example Output: ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms","title":"17 - Jump Server VM"},{"location":"#171-create-jump-server-address","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-create Command(s): az network public-ip create --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"Basic\" --allocation-method \"Dynamic\" Example Output: { \"publicIp\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"db3f0454-61e8-4b8d-840e-694b71e697a2\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"3ea50ce6-bb5b-41fe-94f6-9d95e8103cbe\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null } }","title":"17.1 - Create Jump Server Address"},{"location":"#172-verify-jump-server-address","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"db3f0454-61e8-4b8d-840e-694b71e697a2\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"3ea50ce6-bb5b-41fe-94f6-9d95e8103cbe\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null }","title":"17.2 - Verify Jump Server Address"},{"location":"#173-create-jump-server-nic","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_create Command(s): az network nic create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --vnet-name ${ARO_VNET_NAME} --subnet ${ARO_SUBNET_DMZ_NAME} --public-ip-address ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --network-security-group ${ARO_SUBNET_DMZ_NSG_NAME} Example Output: { \"NewNIC\": { \"dnsSettings\": { \"appliedDnsServers\": [], \"dnsServers\": [], \"internalDnsNameLabel\": null, \"internalDomainNameSuffix\": \"dnl3vzqtoksu5ll1sfsl3bperc.bx.internal.cloudapp.net\", \"internalFqdn\": null }, \"dscpConfiguration\": null, \"enableAcceleratedNetworking\": false, \"enableIpForwarding\": false, \"etag\": \"W/\\\"f1db4270-6f99-494b-bae8-c4077bb8c482\\\"\", \"hostedWorkloads\": [], \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic\", \"ipConfigurations\": [ { \"applicationGatewayBackendAddressPools\": null, \"applicationSecurityGroups\": null, \"etag\": \"W/\\\"f1db4270-6f99-494b-bae8-c4077bb8c482\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic/ipConfigurations/ipconfig1\", \"loadBalancerBackendAddressPools\": null, \"loadBalancerInboundNatRules\": null, \"name\": \"ipconfig1\", \"primary\": true, \"privateIpAddress\": \"10.10.13.4\", \"privateIpAddressVersion\": \"IPv4\", \"privateIpAllocationMethod\": \"Dynamic\", \"privateLinkConnectionProperties\": null, \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": null, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": null, \"location\": null, \"name\": null, \"provisioningState\": null, \"publicIpAddressVersion\": null, \"publicIpAllocationMethod\": null, \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"sku\": null, \"tags\": null, \"type\": null, \"zones\": null }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"addressPrefix\": null, \"addressPrefixes\": null, \"delegations\": null, \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-dmz-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": null, \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": null, \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": null, \"provisioningState\": null, \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null }, \"type\": \"Microsoft.Network/networkInterfaces/ipConfigurations\", \"virtualNetworkTaps\": null } ], \"location\": \"eastus\", \"macAddress\": null, \"name\": \"ipm-vm-jumpbox-nic\", \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"primary\": null, \"privateEndpoint\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"16debdd3-c550-4941-8c5c-729ed79686e7\", \"tags\": null, \"tapConfigurations\": [], \"type\": \"Microsoft.Network/networkInterfaces\", \"virtualMachine\": null } }","title":"17.3 - Create Jump Server NIC"},{"location":"#174-verify-jump-server-nic","text":"A network interface enables an Azure Virtual Machine to communicate with internet, Azure, and on-premises resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_show https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface Command(s): az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table Example Output: EnableAcceleratedNetworking EnableIpForwarding Location Name ProvisioningState ResourceGroup ResourceGuid ----------------------------- -------------------- ---------- ------------------ ------------------- --------------- ------------------------------------ False False eastus ipm-vm-jumpbox-nic Succeeded ipm-eastus 16debdd3-c550-4941-8c5c-729ed79686e7","title":"17.4 - Verify Jump Server NIC"},{"location":"#175-create-jump-server-as","text":"An Availability Set (AS) helps spread VMs across fault domains and update domains. It's best practice to use availability sets for VMs, to make it easier to expand in the future. Fault domains define a grouping of virtual machines that share a common power source and network switch. By default, the virtual machines that are configured within the availability set are separated across up to three fault domains. A hardware issue in one of these fault domains does not affect the VM. Update domains indicate groups of virtual machines and underlying physical hardware that can be rebooted at the same time. During planned maintenance, the order in which update domains are rebooted might not be sequential, but only one update domain is rebooted at a time. Azure automatically distributes VMs across the fault and update domains when placing them in an availability set. For more information, see managing the availability of VMs. Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create https://docs.microsoft.com/en-us/azure/virtual-machines/linux/manage-availability Command(s): az vm availability-set create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/availabilitySets/ipm-vm-jumpbox-as\", \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-as\", \"platformFaultDomainCount\": 2, \"platformUpdateDomainCount\": 5, \"proximityPlacementGroup\": null, \"resourceGroup\": \"ipm-eastus\", \"sku\": { \"capacity\": null, \"name\": \"Aligned\", \"tier\": null }, \"statuses\": null, \"tags\": {}, \"type\": \"Microsoft.Compute/availabilitySets\", \"virtualMachines\": [] }","title":"17.5 - Create Jump Server AS"},{"location":"#176-verify-jump-server-as","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_show Command(s): az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table Example Output: Location Name PlatformFaultDomainCount PlatformUpdateDomainCount ResourceGroup ---------- ----------------- -------------------------- --------------------------- --------------- eastus ipm-vm-jumpbox-as 2 5 ipm-eastus","title":"17.6 - Verify Jump Server AS"},{"location":"#177-accept-jump-server-image-urn","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_accept https://docs.microsoft.com/en-us/azure/virtual-machines/windows/cli-ps-findimage Command(s): az vm image terms accept --urn ${ARO_VM_JUMP_IMAGE_URN} Example Output: { \"accepted\": true, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.MarketplaceOrdering/offerTypes/Microsoft.MarketplaceOrdering/offertypes/publishers/cognosys/offers/docker-ce-with-centos-8-0-free/plans/docker-ce-with-centos-8-0-free/agreements/current\", \"licenseTextLink\": \"https://storelegalterms.blob.core.windows.net/legalterms/3E5ED_legalterms_COGNOSYS%253a24DOCKER%253a2DCE%253a2DWITH%253a2DCENTOS%253a2D8%253a2D0%253a2DFREE%253a24DOCKER%253a2DCE%253a2DWITH%253a2DCENTOS%253a2D8%253a2D0%253a2DFREE%253a24T622IBUBKL6J3MHL5NUAWG2XNZ5H5FVSJGLCOC54LB63AGIONYH5CDZVDEYDONEFK2NHKCZROAP7ZU5PLZHXJ5ZNBFEUCBOWWMC4DSY.txt\", \"name\": \"docker-ce-with-centos-8-0-free\", \"plan\": \"docker-ce-with-centos-8-0-free\", \"privacyPolicyLink\": \"http://www.cogno-sys.com/cognosys-technologies-partners/privacy-policy/\", \"product\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"retrieveDatetime\": \"2020-09-27T03:03:24.6212864Z\", \"signature\": \"7TK6WC7YUSEVPL5URUWHBHRILKUK5JO6RZ5WSTOPBEKJ6QQTKWXNX5F627R4U3FMPQQTPDJIXNOJZEPSFH324RLHXNMZ3MSEOCJ7ZII\", \"type\": \"Microsoft.MarketplaceOrdering/offertypes\" }","title":"17.7 - Accept Jump Server Image URN"},{"location":"#178-verify-jump-server-image-urn","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_show https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cognosys.docker-ce-with-centos-8-0-free?tab=Overview Command(s): az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Example Output: Accepted Name Plan Product Publisher ---------- ------------------------------ ------------------------------ ------------------------------ ----------- True docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free cognosys","title":"17.8 - Verify Jump Server Image URN"},{"location":"#179-create-jump-server-vm","text":"An Azure Virtual Machines (VM) is one of several types of on-demand, scalable computing resources that Azure offers. An Azure VM gives you the flexibility of virtualization without having to buy and maintain the physical hardware that runs it. However, you still need to maintain the VM by performing tasks, such as configuring, patching, and installing the software that runs on it. Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_create https://docs.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-manage-vm https://docs.microsoft.com/en-us/azure/virtual-machines/linux/ Command(s): az vm create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --location ${ARO_LOCATION_NAME} --availability-set ${ARO_VM_JUMP_NAME}-as --nics ${ARO_VM_JUMP_NAME}-nic --image ${ARO_VM_JUMP_IMAGE_URN} --admin-username ${ARO_VM_JUMP_ADMIN_NAME} --size ${ARO_VM_JUMP_SIZE} --generate-ssh-keys Example Output: { \"fqdns\": \"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/virtualMachines/ipm-vm-jumpbox\", \"location\": \"eastus\", \"macAddress\": \"00-0D-3A-9E-B0-AB\", \"powerState\": \"VM running\", \"privateIpAddress\": \"10.10.13.4\", \"publicIpAddress\": \"40.88.33.248\", \"resourceGroup\": \"ipm-eastus\", \"zones\": \"\" }","title":"17.9 - Create Jump Server VM"},{"location":"#1710-verify-jump-server-vm","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Command(s): az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} Example Output: 40.88.33.248 { \"additionalCapabilities\": null, \"availabilitySet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/availabilitySets/IPM-VM-JUMPBOX-AS\", \"resourceGroup\": \"ipm-eastus\" }, \"billingProfile\": null, \"diagnosticsProfile\": null, \"evictionPolicy\": null, \"extensionsTimeBudget\": null, \"hardwareProfile\": { \"vmSize\": \"Standard_B1ms\" }, \"host\": null, \"hostGroup\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/virtualMachines/ipm-vm-jumpbox\", \"identity\": null, \"instanceView\": null, \"licenseType\": null, \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox\", \"networkProfile\": { \"networkInterfaces\": [ { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic\", \"primary\": true, \"resourceGroup\": \"ipm-eastus\" } ] }, \"osProfile\": { \"adminPassword\": null, \"adminUsername\": \"ipm-vm-jumpbox-admin\", \"allowExtensionOperations\": true, \"computerName\": \"ipm-vm-jumpbox\", \"customData\": null, \"linuxConfiguration\": { \"disablePasswordAuthentication\": true, \"patchSettings\": { \"patchMode\": \"ImageDefault\" }, \"provisionVmAgent\": true, \"ssh\": { \"publicKeys\": [ { \"keyData\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDec9G5K26hxFj+Ha0gQChwhSW4fT6mlZrb0066h+moGMJKMJ2YiHMaNMUULFT8SkJch4KYjQfqgJE8YnSGRHPzmUWwF/v7AwcozIlwralduUdYNIScDnzaFCBa55pLQwCWIN7zXFCdtEG935XwaV+A+tOgokiGvGXMAUj/Dz0A5ClIhbD/i3dr2AFKuuSwMGpFc1EqZDh72ZsYTcDaZT5hhPPUCUyTqOfEJuWQYeE3DAuA1EoI2tmBQWNl2S1jtdHa/69BBAmA6t0MZXuMKpk0udzQjw/d6b64hKYHDDlfxaTEBnt1Vbd8Rv5bxJSI1y2QgCutRZwVa/dt1X71fwpAq4yr0H8JCrabKrIumgqyZ6VQyCTVu3AXZ3E/yMQmJhLK2RvPHrHp8DedZ3su62zvU9aUACyd6b89R6S4eYOmIE+nNG/M/yqS2Ru3GPUalsQXE5/auCsg6rPetxMNoEbZz5qTfJUfq3Xx61WQuLrAsyvEiIiM5rrgA/FhYbthxKKacYr0b6oi6HQW6KQ3JnPMm/QF2UxDxoNOG+NHi2UBfgiXLEHZQ3YnkS4QkB9aCK4YJyOJ5I/34gAGcUIPQ8nkUSky7btjsQlHNB6pHPI+8Xd2SntRmfgBwJwOUS+LqjK4OCCpkqUTSopXQ8vL8L/e2gw+8QIdTYe47/P0IG5zVQ== jtingiris@jt\\n\", \"path\": \"/home/ipm-vm-jumpbox-admin/.ssh/authorized_keys\" } ] } }, \"requireGuestProvisionSignal\": true, \"secrets\": [], \"windowsConfiguration\": null }, \"plan\": { \"name\": \"docker-ce-with-centos-8-0-free\", \"product\": \"docker-ce-with-centos-8-0-free\", \"promotionCode\": null, \"publisher\": \"cognosys\" }, \"priority\": null, \"provisioningState\": \"Succeeded\", \"proximityPlacementGroup\": null, \"resourceGroup\": \"ipm-eastus\", \"resources\": null, \"securityProfile\": null, \"storageProfile\": { \"dataDisks\": [], \"imageReference\": { \"exactVersion\": \"1.2019.0710\", \"id\": null, \"offer\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"sku\": \"docker-ce-with-centos-8-0-free\", \"version\": \"1.2019.0710\" }, \"osDisk\": { \"caching\": \"ReadWrite\", \"createOption\": \"FromImage\", \"diffDiskSettings\": null, \"diskSizeGb\": 30, \"encryptionSettings\": null, \"image\": null, \"managedDisk\": { \"diskEncryptionSet\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/IPM-EASTUS/providers/Microsoft.Compute/disks/ipm-vm-jumpbox_OsDisk_1_30aa79f1b3f44738b4fffb0818c1f500\", \"resourceGroup\": \"IPM-EASTUS\", \"storageAccountType\": \"Premium_LRS\" }, \"name\": \"ipm-vm-jumpbox_OsDisk_1_30aa79f1b3f44738b4fffb0818c1f500\", \"osType\": \"Linux\", \"vhd\": null, \"writeAcceleratorEnabled\": null } }, \"tags\": {}, \"type\": \"Microsoft.Compute/virtualMachines\", \"virtualMachineScaleSet\": null, \"vmId\": \"c6af84ea-fe96-4e23-a3ff-11770109f080\", \"zones\": null }","title":"17.10 - Verify Jump Server VM"},{"location":"#1711-login-to-jump-server-vm","text":"Reference(s): https://man7.org/linux/man-pages/man1/ssh.1.html Command(s): export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\" Example Output: 40.88.33.248","title":"17.11 - Login to Jump Server VM"},{"location":"#18-vpn-gateway","text":"A Virtual Private Network (VPN) Gateway is needed to connect to a private ARO cluster. It is a specific type of gateway that is used to send encrypted traffic between an Azure VNet and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. Reference(s): https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://docs.microsoft.com/en-us/azure/vpn-gateway/create-routebased-vpn-gateway-cli Command(s): env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V Example Output: ARO_SUBNET_VGW_CIDR=10.10.10.0/24 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 ARO_SUBNET_VGW_POOL_NAME=ipm-vnet-vpn-pool-subnet ARO_SUBNET_VGW_POOL_NSG_NAME=GatewaySubnet-nsg ARO_VGW_NAME=ipm-vpn ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased","title":"18 - VPN Gateway"},{"location":"#181-create-vpn-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-create https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsub Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --address-prefixes ${ARO_SUBNET_VGW_CIDR} Example Output: { \"addressPrefix\": \"10.10.10.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"5719d87d-ccc4-4683-9638-12f7508a1950\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"GatewaySubnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"18.1 - Create VPN Subnet"},{"location":"#182-verify-vpn-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.10.0/24 GatewaySubnet Enabled Enabled Succeeded ipm-eastus","title":"18.2 - Verify VPN Subnet"},{"location":"#183-create-vpn-address","text":"The VPN Gateway requires a Public IP Address. Zone-redundant VPN gateways and zonal gateways both rely on the Azure public IP resource Standard SKU. The configuration of the Azure public IP resource determines whether the gateway that you deploy is zone-redundant, or zonal. If you create a public IP resource with a Basic SKU, the gateway will not have any zone redundancy, and the gateway resources will be regional. Note The public-ip --sku and --allocation-method may differ, depending on the needs of the VPN Gateway. Refer to the Reference(s) for details. A Redundant VPN Gateway is being created in this example. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-create https://docs.microsoft.com/en-us/azure/virtual-network/public-ip-addresses Command(s): az network public-ip create --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"${VPN_IP_SKU}\" --allocation-method \"${VPN_IP_ALLOCATION_METHOD}\" ${VPN_IP_ZONE} Example Output: { \"publicIp\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"c516d2ba-28fa-4259-a9fd-8e0220e9d7d9\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": \"20.55.32.58\", \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vpn-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Static\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"8a54cef2-c31d-4b8d-ae52-b1dbbf9d6802\", \"sku\": { \"name\": \"Standard\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": [ \"1\" ] } }","title":"18.3 - Create VPN Address"},{"location":"#184-verify-vpn-address","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: Name ResourceGroup Location Zones Address AddressVersion AllocationMethod IdleTimeoutInMinutes ProvisioningState ----------------- --------------- ---------- ------- ----------- ---------------- ------------------ ---------------------- ------------------- ipm-vpn-public-ip ipm-eastus eastus 1 20.55.32.58 IPv4 Static 4 Succeeded","title":"18.4 - Verify VPN Address"},{"location":"#185-create-vpn-gateway","text":"There are two types of Azure VPN Gateways, the Classic and Resource Manager deployment models. Each virtual network can have only one VPN gateway. Note Creating a virtual network gateway can take up to 45 minutes to complete. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_create Command(s): az network vnet-gateway create --name ${ARO_VGW_NAME} --location ${ARO_LOCATION_NAME} --public-ip-address ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet ${ARO_VNET_NAME} --gateway-type VPN --sku ${ARO_VGW_SKU} --vpn-type ${ARO_VGW_TYPE} --address-prefixes ${ARO_SUBNET_VGW_POOL_CIDR} Example Output: { \"vnetGateway\": { \"activeActive\": false, \"bgpSettings\": { \"asn\": 65515, \"bgpPeeringAddress\": \"10.10.10.254\", \"bgpPeeringAddresses\": [ { \"customBgpIpAddresses\": [], \"defaultBgpIpAddresses\": [ \"10.10.10.254\" ], \"ipconfigurationId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"tunnelIpAddresses\": [ \"20.55.32.58\" ] } ], \"peerWeight\": 0 }, \"customRoutes\": null, \"enableBgp\": false, \"enableDnsForwarding\": null, \"enablePrivateIpAddress\": false, \"etag\": \"W/\\\"e794796d-23a5-40ea-b5d3-391b68595bfb\\\"\", \"gatewayDefaultSite\": null, \"gatewayType\": \"Vpn\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn\", \"inboundDnsForwardingEndpoint\": null, \"ipConfigurations\": [ { \"etag\": \"W/\\\"e794796d-23a5-40ea-b5d3-391b68595bfb\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"name\": \"vnetGatewayConfig0\", \"privateIpAddress\": null, \"privateIpAllocationMethod\": \"Dynamic\", \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"resourceGroup\": \"ipm-eastus\" }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"resourceGroup\": \"ipm-eastus\" }, \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\" } ], \"location\": \"eastus\", \"name\": \"ipm-vpn\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"20c26bff-2dad-4a88-8418-06ca4fa257af\", \"sku\": { \"capacity\": 2, \"name\": \"VpnGw1AZ\", \"tier\": \"VpnGw1AZ\" }, \"tags\": null, \"type\": \"Microsoft.Network/virtualNetworkGateways\", \"vpnClientConfiguration\": { \"aadAudience\": null, \"aadIssuer\": null, \"aadTenant\": null, \"radiusServerAddress\": null, \"radiusServerSecret\": null, \"radiusServers\": [], \"vpnClientAddressPool\": { \"addressPrefixes\": [ \"172.16.13.0/24\" ] }, \"vpnClientConnectionHealth\": { \"totalEgressBytesTransferred\": 0, \"totalIngressBytesTransferred\": 0, \"vpnClientConnectionsCount\": 0 }, \"vpnClientIpsecPolicies\": [], \"vpnClientProtocols\": [ \"IkeV2\", \"OpenVPN\" ], \"vpnClientRevokedCertificates\": [], \"vpnClientRootCertificates\": [] }, \"vpnGatewayGeneration\": \"Generation1\", \"vpnType\": \"RouteBased\" } }","title":"18.5 - Create VPN Gateway"},{"location":"#186-verify-vpn-gateway","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: ActiveActive EnableBgp EnablePrivateIpAddress GatewayType Location Name ProvisioningState ResourceGroup ResourceGuid VpnGatewayGeneration VpnType -------------- ----------- ------------------------ ------------- ---------- ------- ------------------- --------------- ------------------------------------ ---------------------- ---------- False False False Vpn eastus ipm-vpn Succeeded ipm-eastus 20c26bff-2dad-4a88-8418-06ca4fa257af Generation1 RouteBased","title":"18.6 - Verify VPN Gateway"},{"location":"#19-vpn-gateway-pki","text":"An Azure VPN Gateway supports using a Public Key Infrastructure (PKI) for Certificate Authentication. With VPN Gateway Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. This series of steps establishes a private Certificate Authority (CA) by creating a Root Key & Certificate. The Certificate Data wil be uploaded to the Azure VPN Gateway, so that VPN Clients Certificates will be authenticated. To be valid for authentication, the VPN Client Certificates must be signed by the Root Certificate. Note VPN Client Certificates will be created later. Reference(s): https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://en.wikipedia.org/wiki/Public_key_infrastructure https://en.wikipedia.org/wiki/Root_certificate Command(s): env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V Example Output: ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key","title":"19 - VPN Gateway PKI"},{"location":"#191-create-root-key","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-genrsa.html Command(s): openssl genrsa -aes256 -out ${ARO_VGW_PKI_ROOT_KEY_FILE} -passout env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 Example Output: Generating RSA private key, 2048 bit long modulus (2 primes) ..+++++ .................+++++ e is 65537 (0x010001)","title":"19.1 - Create Root Key"},{"location":"#192-verify-root-key","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 Example Output: + success does not produce any output","title":"19.2 - Verify Root Key"},{"location":"#193-create-root-certificate","text":"This step creates a root certificate that is valid for 10 years (3650 days). Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -x509 -sha256 -new -key \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -out \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -days 3650 -subj /CN=\"${ARO_VGW_NAME}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 # 10 years Example Output: + success does not produce any output","title":"19.3 - Create Root Certificate"},{"location":"#194-verify-root-certificate","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 Example Output: Certificate: Data: Version: 3 (0x2) Serial Number: 0c:bf:8d:e4:7e:9c:40:ab:ba:39:b9:42:98:7f:80:a4:5e:36:a7:3e Signature Algorithm: sha256WithRSAEncryption Issuer: CN = ipm-vpn Validity Not Before: Sep 27 03:28:52 2020 GMT Not After : Sep 25 03:28:52 2030 GMT Subject: CN = ipm-vpn Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:b3:82:e0:16:56:56:9b:c4:81:c4:a9:4d:67:b6: 3e:b4:1c:7c:38:2b:e8:f0:c0:23:5d:d2:d8:71:dc: 57:fb:e6:50:c8:f5:71:99:d0:36:b4:23:f2:4b:90: 1d:0a:7c:f3:0d:6f:81:2a:1d:07:81:65:19:45:de: e2:dc:a0:c8:c1:ad:61:b7:a5:a5:e4:78:68:03:ef: 07:59:f5:de:ff:ce:4b:5c:fc:f3:0a:45:89:90:28: 0d:49:c2:40:95:40:57:7e:5c:ac:f7:9c:ce:67:7d: f6:71:35:f9:85:dc:82:ad:9c:d5:af:0a:43:4e:e3: 61:d6:79:90:c0:02:55:37:ca:55:1a:26:ba:cf:05: 1f:c5:86:44:1a:54:d5:07:ba:38:b0:ca:5d:42:31: 3b:84:56:70:5b:f1:d4:39:17:be:8d:dc:25:cf:79: f9:fc:9d:61:59:46:fa:47:59:9a:bb:a3:20:4d:d7: c1:09:2b:4c:92:ae:2b:c4:f5:e0:3d:18:52:21:59: f3:6c:e0:51:3a:85:eb:de:5d:9d:2b:ed:e5:58:ef: 5a:39:c4:5f:80:41:00:c3:9f:fc:a9:f5:3c:ec:fe: 65:44:c4:5a:e6:5f:79:7a:fd:50:bf:c4:14:ef:12: 13:89:77:c9:5a:3f:52:10:4f:83:31:43:bc:3e:94: a8:33 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Authority Key Identifier: keyid:07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Basic Constraints: critical CA:TRUE Signature Algorithm: sha256WithRSAEncryption 97:dc:d1:bd:95:37:2c:97:e7:76:9b:bc:9d:e4:5d:d7:73:6e: 81:93:e4:87:02:77:ec:19:de:d4:c1:d4:d8:2b:32:6d:e3:89: fb:97:36:b6:01:62:8c:cf:e6:bd:ce:52:c1:03:c3:60:de:3f: 5b:da:4f:fd:6c:cd:0b:47:65:af:4e:e2:d1:07:84:6c:50:6a: f8:e4:41:3b:ce:ae:f8:b2:66:68:b0:ed:32:04:f2:2f:8d:98: 29:84:16:e7:a3:c4:ea:60:37:b6:0b:db:04:2a:d6:94:a4:aa: 80:eb:2d:14:ad:25:1e:3e:7d:1b:7a:72:1a:06:44:f8:e6:51: 02:3a:cf:36:6b:4b:d5:b4:6b:ee:1f:88:49:1a:22:06:39:ba: 3a:71:19:fa:34:e2:a9:c0:08:3e:25:91:64:1c:74:24:1a:4b: 06:3b:24:5e:62:89:6c:54:f3:b9:15:5b:5f:70:d6:d6:19:a1: eb:a3:52:db:35:53:cb:0b:6b:39:59:5a:23:d5:ed:ca:fc:44: 71:93:a7:66:7c:51:4d:4e:0f:f5:15:57:de:a1:09:2f:e6:23: 76:00:bf:68:d7:bd:7b:69:83:b5:0d:e8:bb:a1:fb:01:18:bf: 7e:39:30:94:02:27:29:ac:c9:f3:18:a2:50:55:e4:58:94:29: f6:1f:d4:24","title":"19.4 - Verify Root Certificate"},{"location":"#195-verify-root-moduli","text":"Warning Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed until they match. Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum Example Output: md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key = 4103146f0ffed8dfb840bfd8f79963af - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt = 4103146f0ffed8dfb840bfd8f79963af -","title":"19.5 - Verify Root  Moduli"},{"location":"#196-create-root-data","text":"The VPN Gateway requires knowledge of the Root Data. The Public certificate data must be uploaded to Azure in a specific format. In a previous step, the root certificate was created in the Privacy Enhanced Mail (PEM) format. PEM is the most common format for X.509 certificates. A PEM file is a text file containing one or more items, encoded in base64 ASCII, and identified by plain-text headers and footers PEM, an example: -----BEGIN CERTIFICATE----- DATA -----END CERTIFICATE----- DER files do NOT contain plain text headers . DER is a binary format for data structures described by ASN.1. Important The Azure VPN Gateway requires the Root Public certificate data use the Distinguished Encoding Rules (DER) format, encoded as base64 ASCII. The conversion from PEM to base64 DER is done by OpenSSL, in the Command(s). Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/root-cert?view=azure-cli-latest#az_network_vnet_gateway_root_cert_create https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail https://en.wikipedia.org/wiki/X.690#DER_encoding https://en.wikipedia.org/wiki/ASN.1 Command(s): az network vnet-gateway root-cert create --gateway-name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --name \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" --public-cert-data \"$(openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -outform der | base64 -w0)\" Example Output: { \"activeActive\": false, \"bgpSettings\": { \"asn\": 65515, \"bgpPeeringAddress\": \"10.10.10.254\", \"bgpPeeringAddresses\": [ { \"customBgpIpAddresses\": [], \"defaultBgpIpAddresses\": [ \"10.10.10.254\" ], \"ipconfigurationId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"tunnelIpAddresses\": [ \"20.55.32.58\" ] } ], \"peerWeight\": 0 }, \"customRoutes\": null, \"enableBgp\": false, \"enableDnsForwarding\": null, \"enablePrivateIpAddress\": false, \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"gatewayDefaultSite\": null, \"gatewayType\": \"Vpn\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn\", \"inboundDnsForwardingEndpoint\": null, \"ipConfigurations\": [ { \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"name\": \"vnetGatewayConfig0\", \"privateIpAddress\": null, \"privateIpAllocationMethod\": \"Dynamic\", \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"resourceGroup\": \"ipm-eastus\" }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"resourceGroup\": \"ipm-eastus\" }, \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\" } ], \"location\": \"eastus\", \"name\": \"ipm-vpn\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"20c26bff-2dad-4a88-8418-06ca4fa257af\", \"sku\": { \"capacity\": 2, \"name\": \"VpnGw1AZ\", \"tier\": \"VpnGw1AZ\" }, \"tags\": null, \"type\": \"Microsoft.Network/virtualNetworkGateways\", \"vpnClientConfiguration\": { \"aadAudience\": null, \"aadIssuer\": null, \"aadTenant\": null, \"radiusServerAddress\": null, \"radiusServerSecret\": null, \"radiusServers\": [], \"vpnClientAddressPool\": { \"addressPrefixes\": [ \"172.16.13.0/24\" ] }, \"vpnClientConnectionHealth\": { \"totalEgressBytesTransferred\": 0, \"totalIngressBytesTransferred\": 0, \"vpnClientConnectionsCount\": 0 }, \"vpnClientIpsecPolicies\": [], \"vpnClientProtocols\": [ \"IkeV2\", \"OpenVPN\" ], \"vpnClientRevokedCertificates\": [], \"vpnClientRootCertificates\": [ { \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/vpnClientRootCertificates/ipm-vpn-root.crt\", \"name\": \"ipm-vpn-root.crt\", \"provisioningState\": \"Succeeded\", \"publicCertData\": \"MIIDBTCCAe2gAwIBAgIUDL+N5H6cQKu6OblCmH+ApF42pz4wDQYJKoZIhvcNAQELBQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzI4NTJaFw0zMDA5MjUwMzI4NTJaMBIxEDAOBgNVBAMMB2lwbS12cG4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCzguAWVlabxIHEqU1ntj60HHw4K+jwwCNd0thx3Ff75lDI9XGZ0Da0I/JLkB0KfPMNb4EqHQeBZRlF3uLcoMjBrWG3paXkeGgD7wdZ9d7/zktc/PMKRYmQKA1JwkCVQFd+XKz3nM5nffZxNfmF3IKtnNWvCkNO42HWeZDAAlU3ylUaJrrPBR/FhkQaVNUHujiwyl1CMTuEVnBb8dQ5F76N3CXPefn8nWFZRvpHWZq7oyBN18EJK0ySrivE9eA9GFIhWfNs4FE6heveXZ0r7eVY71o5xF+AQQDDn/yp9Tzs/mVExFrmX3l6/VC/xBTvEhOJd8laP1IQT4MxQ7w+lKgzAgMBAAGjUzBRMB0GA1UdDgQWBBQH9gH+kGBq5556lD9irqEcbH9BWjAfBgNVHSMEGDAWgBQH9gH+kGBq5556lD9irqEcbH9BWjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCX3NG9lTcsl+d2m7yd5F3Xc26Bk+SHAnfsGd7UwdTYKzJt44n7lza2AWKMz+a9zlLBA8Ng3j9b2k/9bM0LR2WvTuLRB4RsUGr45EE7zq74smZosO0yBPIvjZgphBbno8TqYDe2C9sEKtaUpKqA6y0UrSUePn0benIaBkT45lECOs82a0vVtGvuH4hJGiIGObo6cRn6NOKpwAg+JZFkHHQkGksGOyReYolsVPO5FVtfcNbWGaHro1LbNVPLC2s5WVoj1e3K/ERxk6dmfFFNTg/1FVfeoQkv5iN2AL9o1717aYO1Dei7ofsBGL9+OTCUAicprMnzGKJQVeRYlCn2H9Qk\", \"resourceGroup\": \"ipm-eastus\", \"type\": \"Microsoft.Network/virtualNetworkGateways/vpnClientRootCertificates\" } ] }, \"vpnGatewayGeneration\": \"Generation1\", \"vpnType\": \"RouteBased\" }","title":"19.6 - Create Root Data"},{"location":"#197-verify-root-data","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi Example Output: found ipm-vpn root certificate name = ipm-vpn-root.crt verified ipm-vpn-root.crt exists as a root certificate name for ipm-vpn","title":"19.7 - Verify Root Data"},{"location":"#20-client-certificates","text":"VPN Clients must present an X.509 version 3 certificate when connecting. Each user should have their own bundle of certificate files. This step outlines a procedure to create them with OpenSSL v1.1.1. It will need to be re-run for everyone who requires connectivity. The Azure VPN Gateway supports both IKEv2 (ipsec) and OpenVPN (ssl) client connections. Various VPN client software support these technologies. It is most convenient to distribute a PKCS#12 file to the user, so they can connect to the VPN Gateway and access the private Azure Red Hat OpenShift cluster. In cryptography, PKCS #12 defines an archive file format for storing many cryptography objects as a single file. PKCS#12 evolved from Microsoft's Personal Information Exchange (PFX) standard and is used to exchange public and private objects. It is commonly used to bundle a private key with its X.509 certificate or to bundle all the members of a chain of trust. The terms PKCS #12 (pkcs12) and PFX (pfx) are often used interchangeably. Successful execution of the commands in this step depends upon the previously created VPN Gateway Root Certificate files and exported environment variables. Successful completion of the following steps will produce six (6) files, in this order: VPN Client Key (.key) VPN Client Certificate Request (.req) VPN Client Certificate Extensions (.ext) VPN Client Certificate (.crt) VPN Client Certificate Serial (.serial) VPN Client Certificate Bundle (.pfx) The resulting PFX file is should be given to the user.","title":"20 - Client Certificates"},{"location":"#201-set-vpn-client-environment-variables","text":"These environment variables should be exported each time a new set of client certificate files are created. Important These are example values that must be changed for your installation. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' Example Output: + success does not produce any output","title":"20.1 - Set VPN Client Environment Variables"},{"location":"#202-verify-vpn-client-environment-variables","text":"Reference(s): https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html Command(s): ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE Example Output: ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!!","title":"20.2 - Verify VPN Client Environment Variables"},{"location":"#203-create-vpn-client-key","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-genrsa.html Command(s): openssl genrsa -aes256 -out \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passout env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 Example Output: Generating RSA private key, 2048 bit long modulus (2 primes) .........................................+++++ ...........+++++ e is 65537 (0x010001) + success does not produce any output","title":"20.3 - Create VPN Client Key"},{"location":"#204-verify-vpn-client-key","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 Example Output: + success does not produce any output","title":"20.4 - Verify VPN Client Key"},{"location":"#205-create-client-certificate-request","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -new -out \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -key \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -subj /CN=\"${ARO_VGW_PKI_CLIENT_NAME}\" 2>&1 Example Output: + success does not produce any output","title":"20.5 - Create Client Certificate Request"},{"location":"#206-verify-client-certificate-request","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 Example Output: Certificate Request: Data: Version: 1 (0x0) Subject: CN = ipm-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:a8:dd:23:26:4e:ae:34:53:2a:f7:ed:52:b1:52: 80:eb:75:0d:76:d5:53:11:f2:f4:e9:a0:1b:2f:da: 7a:ee:63:c0:f1:d2:0d:8a:11:2a:7b:4c:11:7b:66: 04:3e:2a:2f:57:87:74:12:1e:fa:c8:ef:bb:69:76: 9d:a6:e4:8f:30:1f:6f:a3:dd:64:cd:b5:f8:ca:6c: 3e:ff:01:93:c8:ff:e4:e1:8a:63:7b:0c:ff:a0:73: d3:60:ad:53:29:46:b8:17:69:3d:17:06:40:b4:44: df:77:fc:7b:44:1e:4c:0e:02:fb:42:4e:a8:ab:55: 21:68:d0:45:7d:f3:5f:81:74:9a:8b:28:08:bd:d5: 8c:84:42:26:bc:fb:a4:c7:e9:2a:17:f6:b8:b2:2d: 44:34:ca:f1:f1:74:dc:16:3f:48:f7:93:3e:fd:21: a4:35:c1:bb:c6:0c:29:a5:6a:a4:ee:34:b4:e2:22: 23:c9:fa:63:16:2a:83:72:20:27:38:aa:56:a8:9f: 50:37:e8:a2:f8:8c:98:d7:6c:60:44:b7:76:95:65: 42:a5:bc:e3:49:bd:74:d2:59:8c:c4:35:eb:bd:ec: 86:97:f6:17:ab:76:a3:1a:ab:19:c3:cd:85:74:5a: 42:32:ff:2c:51:f3:34:9d:46:3f:97:ad:b8:b0:01: c1:c9 Exponent: 65537 (0x10001) Attributes: a0:00 Signature Algorithm: sha256WithRSAEncryption 6b:ec:e9:52:ef:76:ad:c6:49:ad:ed:19:83:ab:01:4c:0c:b5: b6:3c:e0:47:c4:89:af:79:99:fa:69:c9:32:b0:35:97:99:05: c6:ca:60:1d:1a:05:ba:30:9c:b3:8f:f5:8b:a3:ce:c7:af:4c: af:98:d0:82:1d:ca:ec:a3:18:f9:05:d1:e7:79:90:5a:77:f1: b2:4a:41:a2:43:48:d8:52:c2:4d:8b:f6:0f:26:8c:ef:ad:a7: 9c:14:49:b9:9f:ec:20:42:33:ea:12:78:0c:e9:98:a1:e7:bb: 81:b6:44:de:df:f3:63:b8:b6:ac:91:6a:5c:3d:5b:1b:a8:69: cf:d7:4e:21:5a:47:91:7f:e9:e1:6b:5b:ef:29:ee:75:dd:55: 81:ad:df:d7:4c:4c:77:e3:cf:8a:5c:ae:ec:c3:71:fc:b6:ce: f7:17:8a:1a:be:7e:a6:2f:85:a0:d5:16:eb:09:5e:7b:09:e9: a1:0e:d7:a2:55:a9:98:41:69:65:c3:70:ce:3d:04:ea:95:08: 39:a3:ff:c5:41:b2:8f:a9:fe:1b:ae:e5:df:0e:61:5f:90:2c: 35:d2:bb:41:e1:84:7a:54:e0:3d:c7:9d:1e:f5:15:37:a2:a7: 2a:d7:09:5f:4c:ec:e7:33:c7:34:0e:6b:b3:4f:e1:6e:7d:e3: d3:32:40:8d","title":"20.6 - Verify Client Certificate Request"},{"location":"#207-create-client-certificate-extensions","text":"A Root Certificate Authority (CA) uses extensions to issue a certificate only for a specific purpose. Certificate Extensions were introduced in X.509 version 3 (X509v3). The Azure VPN Gateway requires specific Certificate Extensions on VPN Client certificates. More specificially, a VPN Client certificate must have the TLS Web Client Authentication (clientAuth) extended key usage (eku) extension. Additionally, X509v3 Subject Alternative Name (subjectAltName) must always be used per RFC 5280. This step creates a certificate extension file that OpenSSL will read when creating the certificate, and apply the proper extensions. Reference(s): https://tools.ietf.org/html/rfc5280 Command(s): echo \"authorityKeyIdentifier=keyid,issuer\" > \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"basicConstraints=CA:FALSE\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"extendedKeyUsage=clientAuth\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"subjectAltName=DNS:${ARO_VGW_PKI_CLIENT_NAME}\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: + success does not produce any output + success does not produce any output + success does not produce any output + success does not produce any output","title":"20.7 - Create Client Certificate Extensions"},{"location":"#208-verify-client-certificate-extensions","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: authorityKeyIdentifier=keyid,issuer extendedKeyUsage=clientAuth","title":"20.8 - Verify Client Certificate Extensions"},{"location":"#209-create-client-certificate","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -req -sha256 -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -CAkey \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -CA \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE -days 1095 -CAcreateserial -CAserial \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 2>&1 Example Output: Signature ok subject=CN = ipm-vpn-client-example Getting CA Private Key","title":"20.9 - Create Client Certificate"},{"location":"#2010-verify-client-certificate","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 Example Output: Certificate: Data: Version: 3 (0x2) Serial Number: 24:ac:31:61:b3:c2:b6:a2:51:50:cb:f3:7f:36:c5:7b:fa:f0:77:d3 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = ipm-vpn Validity Not Before: Sep 27 03:31:32 2020 GMT Not After : Sep 27 03:31:32 2023 GMT Subject: CN = ipm-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:a8:dd:23:26:4e:ae:34:53:2a:f7:ed:52:b1:52: 80:eb:75:0d:76:d5:53:11:f2:f4:e9:a0:1b:2f:da: 7a:ee:63:c0:f1:d2:0d:8a:11:2a:7b:4c:11:7b:66: 04:3e:2a:2f:57:87:74:12:1e:fa:c8:ef:bb:69:76: 9d:a6:e4:8f:30:1f:6f:a3:dd:64:cd:b5:f8:ca:6c: 3e:ff:01:93:c8:ff:e4:e1:8a:63:7b:0c:ff:a0:73: d3:60:ad:53:29:46:b8:17:69:3d:17:06:40:b4:44: df:77:fc:7b:44:1e:4c:0e:02:fb:42:4e:a8:ab:55: 21:68:d0:45:7d:f3:5f:81:74:9a:8b:28:08:bd:d5: 8c:84:42:26:bc:fb:a4:c7:e9:2a:17:f6:b8:b2:2d: 44:34:ca:f1:f1:74:dc:16:3f:48:f7:93:3e:fd:21: a4:35:c1:bb:c6:0c:29:a5:6a:a4:ee:34:b4:e2:22: 23:c9:fa:63:16:2a:83:72:20:27:38:aa:56:a8:9f: 50:37:e8:a2:f8:8c:98:d7:6c:60:44:b7:76:95:65: 42:a5:bc:e3:49:bd:74:d2:59:8c:c4:35:eb:bd:ec: 86:97:f6:17:ab:76:a3:1a:ab:19:c3:cd:85:74:5a: 42:32:ff:2c:51:f3:34:9d:46:3f:97:ad:b8:b0:01: c1:c9 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Authority Key Identifier: keyid:07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Basic Constraints: CA:FALSE X509v3 Extended Key Usage: TLS Web Client Authentication X509v3 Subject Alternative Name: DNS:ipm-vpn-client-example Signature Algorithm: sha256WithRSAEncryption 5a:8d:83:db:fe:c6:54:a7:9a:db:dc:6e:56:25:6c:79:1c:f0: 26:55:6c:41:3f:00:86:d8:12:96:6e:d7:0f:f0:67:7e:1f:08: 7a:f4:f4:0b:07:92:60:3b:df:5d:26:95:1b:b8:5f:18:19:01: e0:d1:d7:ed:5f:52:21:33:ef:c3:70:ab:86:34:2a:71:25:8c: ae:4c:c9:76:92:a6:c0:f4:c5:06:5f:b7:e1:8c:4a:2d:86:4f: a1:79:8d:94:2c:60:e9:a9:ab:69:b4:01:34:0b:99:63:ab:3f: 57:6c:49:9f:ed:d5:ed:0f:41:d8:af:2b:14:63:ae:b8:16:59: 93:06:35:b1:43:81:7c:c4:68:d2:08:48:ec:36:19:71:a9:ac: c9:c1:70:f5:6d:14:fd:6d:15:e2:d1:fb:86:b6:91:86:e9:3b: 1e:00:41:16:f3:95:49:98:86:30:7c:64:06:49:d1:27:94:b7: 5f:64:ce:46:5d:91:16:74:93:d4:c7:9c:ec:0f:a4:2e:32:80: 43:88:ee:12:33:2c:51:d9:a2:7e:cc:ff:b2:2f:c6:87:30:37: 89:bc:e7:ee:6b:8a:74:6f:e4:69:60:32:54:b3:ea:03:ef:a3: 37:ea:57:7f:fc:05:ef:ae:ce:cd:53:ea:4b:f9:95:b4:22:39: f5:75:01:d9","title":"20.10 - Verify Client Certificate"},{"location":"#2011-verify-client-moduli","text":"Warning Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed until they match. Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_REQ_FILE} = \"; openssl req -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" | md5sum Example Output: md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key = 1ec497f88cbce7449554078dce627bb4 - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt = 1ec497f88cbce7449554078dce627bb4 - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req = 1ec497f88cbce7449554078dce627bb4 -","title":"20.11 - Verify Client  Moduli"},{"location":"#2012-create-vpn-client-pfx","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl pkcs12 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -inkey \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -passout pass: -certfile \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -export 2>&1 Example Output: + success does not produce any output","title":"20.12 - Create VPN Client PFX"},{"location":"#2013-verify-vpn-client-pfx","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1 Example Output: Bag Attributes localKeyID: A0 FD 44 81 5B C9 B3 66 B8 F6 3E 4E 76 98 7E 26 32 7A D1 4B subject=CN = ipm-vpn-client-example issuer=CN = ipm-vpn -----BEGIN CERTIFICATE----- MIIDJzCCAg+gAwIBAgIUJKwxYbPCtqJRUMvzfzbFe/rwd9MwDQYJKoZIhvcNAQEL BQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzMxMzJaFw0yMzA5Mjcw MzMxMzJaMCExHzAdBgNVBAMMFmlwbS12cG4tY2xpZW50LWV4YW1wbGUwggEiMA0G CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCo3SMmTq40Uyr37VKxUoDrdQ121VMR 8vTpoBsv2nruY8Dx0g2KESp7TBF7ZgQ+Ki9Xh3QSHvrI77tpdp2m5I8wH2+j3WTN tfjKbD7/AZPI/+ThimN7DP+gc9NgrVMpRrgXaT0XBkC0RN93/HtEHkwOAvtCTqir VSFo0EV981+BdJqLKAi91YyEQia8+6TH6SoX9riyLUQ0yvHxdNwWP0j3kz79IaQ1 wbvGDCmlaqTuNLTiIiPJ+mMWKoNyICc4qlaon1A36KL4jJjXbGBEt3aVZUKlvONJ vXTSWYzENeu97IaX9herdqMaqxnDzYV0WkIy/yxR8zSdRj+XrbiwAcHJAgMBAAGj ZjBkMB8GA1UdIwQYMBaAFAf2Af6QYGrnnnqUP2KuoRxsf0FaMAkGA1UdEwQCMAAw EwYDVR0lBAwwCgYIKwYBBQUHAwIwIQYDVR0RBBowGIIWaXBtLXZwbi1jbGllbnQt ZXhhbXBsZTANBgkqhkiG9w0BAQsFAAOCAQEAWo2D2/7GVKea29xuViVseRzwJlVs QT8AhtgSlm7XD/Bnfh8IevT0CweSYDvfXSaVG7hfGBkB4NHX7V9SITPvw3CrhjQq cSWMrkzJdpKmwPTFBl+34YxKLYZPoXmNlCxg6amrabQBNAuZY6s/V2xJn+3V7Q9B 2K8rFGOuuBZZkwY1sUOBfMRo0ghI7DYZcamsycFw9W0U/W0V4tH7hraRhuk7HgBB FvOVSZiGMHxkBknRJ5S3X2TORl2RFnST1Mec7A+kLjKAQ4juEjMsUdmifsz/si/G hzA3ibzn7muKdG/kaWAyVLPqA++jN+pXf/wF767OzVPqS/mVtCI59XUB2Q== -----END CERTIFICATE----- Bag Attributes: <No Attributes> subject=CN = ipm-vpn issuer=CN = ipm-vpn -----BEGIN CERTIFICATE----- MIIDBTCCAe2gAwIBAgIUDL+N5H6cQKu6OblCmH+ApF42pz4wDQYJKoZIhvcNAQEL BQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzI4NTJaFw0zMDA5MjUw MzI4NTJaMBIxEDAOBgNVBAMMB2lwbS12cG4wggEiMA0GCSqGSIb3DQEBAQUAA4IB DwAwggEKAoIBAQCzguAWVlabxIHEqU1ntj60HHw4K+jwwCNd0thx3Ff75lDI9XGZ 0Da0I/JLkB0KfPMNb4EqHQeBZRlF3uLcoMjBrWG3paXkeGgD7wdZ9d7/zktc/PMK RYmQKA1JwkCVQFd+XKz3nM5nffZxNfmF3IKtnNWvCkNO42HWeZDAAlU3ylUaJrrP BR/FhkQaVNUHujiwyl1CMTuEVnBb8dQ5F76N3CXPefn8nWFZRvpHWZq7oyBN18EJ K0ySrivE9eA9GFIhWfNs4FE6heveXZ0r7eVY71o5xF+AQQDDn/yp9Tzs/mVExFrm X3l6/VC/xBTvEhOJd8laP1IQT4MxQ7w+lKgzAgMBAAGjUzBRMB0GA1UdDgQWBBQH 9gH+kGBq5556lD9irqEcbH9BWjAfBgNVHSMEGDAWgBQH9gH+kGBq5556lD9irqEc bH9BWjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCX3NG9lTcs l+d2m7yd5F3Xc26Bk+SHAnfsGd7UwdTYKzJt44n7lza2AWKMz+a9zlLBA8Ng3j9b 2k/9bM0LR2WvTuLRB4RsUGr45EE7zq74smZosO0yBPIvjZgphBbno8TqYDe2C9sE KtaUpKqA6y0UrSUePn0benIaBkT45lECOs82a0vVtGvuH4hJGiIGObo6cRn6NOKp wAg+JZFkHHQkGksGOyReYolsVPO5FVtfcNbWGaHro1LbNVPLC2s5WVoj1e3K/ERx k6dmfFFNTg/1FVfeoQkv5iN2AL9o1717aYO1Dei7ofsBGL9+OTCUAicprMnzGKJQ VeRYlCn2H9Qk -----END CERTIFICATE-----","title":"20.13 - Verify VPN Client PFX"},{"location":"#21-vpn-client","text":"Please follow Microsoft's instructions for installing the VPN Client for your operating system. Tip Commands for using az and wget are given below. Reference(s): https://en.wikipedia.org/wiki/X.509 https://en.wikipedia.org/wiki/PKCS_12 https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-vpn-client-install-azure-cert https://www.openssl.org/ Command(s): env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V Example Output: ARO_KEY=ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key","title":"21 - VPN Client"},{"location":"#211-verify-vpn-client-url","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/vpn-client?view=azure-cli-latest#az_network_vnet_gateway_vpn_client_generate Command(s): export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" Example Output: + success does not produce any output ARO_VGW_CONFIGURATION_URL=\"https://nfvprodsuppbl.blob.core.windows.net/vpnprofileimmutable/cf9d0077-d7e7-4c7f-aae7-7f15cc7d58d8/vpnprofile/c55a6b34-3e2f-4747-b19f-6c8ff8c5d22a/vpnclientconfiguration.zip?sv=2018-03-28&sr=b&sig=lt%2FYNiNekY3VCic3qMxtz772%2FyX30OuSiUD0NBZewU0%3D&st=2020-09-27T03%3A26%3A39Z&se=2020-09-27T04%3A26%3A39Z&sp=r&fileExtension=.zip\"","title":"21.1 - Verify VPN Client URL"},{"location":"#212-download-vpn-client","text":"The necessary VPN Client Configuration files may be downloaded via the Azure porta or with the following commands. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/vpn-client?view=azure-cli-latest#az_network_vnet_gateway_vpn_client_generate Command(s): eval wget \"${ARO_VGW_CONFIGURATION_URL}\" -O \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 2>&1 Example Output: --2020-09-26 23:31:47-- https://nfvprodsuppbl.blob.core.windows.net/vpnprofileimmutable/cf9d0077-d7e7-4c7f-aae7-7f15cc7d58d8/vpnprofile/c55a6b34-3e2f-4747-b19f-6c8ff8c5d22a/vpnclientconfiguration.zip?sv=2018-03-28&sr=b&sig=lt%2FYNiNekY3VCic3qMxtz772%2FyX30OuSiUD0NBZewU0%3D&st=2020-09-27T03%3A26%3A39Z&se=2020-09-27T04%3A26%3A39Z&sp=r&fileExtension=.zip Resolving nfvprodsuppbl.blob.core.windows.net (nfvprodsuppbl.blob.core.windows.net)... 52.239.153.36 Connecting to nfvprodsuppbl.blob.core.windows.net (nfvprodsuppbl.blob.core.windows.net)|52.239.153.36|:443... connected. HTTP request sent, awaiting response... 200 OK Length: 303372 (296K) [application/octet-stream] Saving to: \u2018/home/jtingiris/prj/mit/aei/pki/ipm-vpn.zip\u2019 0K .......... .......... .......... .......... .......... 16% 1.01M 0s 50K .......... .......... .......... .......... .......... 33% 1.90M 0s 100K .......... .......... .......... .......... .......... 50% 92.1M 0s 150K .......... .......... .......... .......... .......... 67% 1.95M 0s 200K .......... .......... .......... .......... .......... 84% 50.7M 0s 250K .......... .......... .......... .......... ...... 100% 16.2M=0.1s 2020-09-26 23:31:47 (2.80 MB/s) - \u2018/home/jtingiris/prj/mit/aei/pki/ipm-vpn.zip\u2019 saved [303372/303372]","title":"21.2 - Download VPN Client"},{"location":"#213-distribute-vpn-client-pfx","text":"","title":"21.3 - Distribute VPN Client &amp; PFX"},{"location":"#22-obtain-pull-secrets","text":"Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries.","title":"22 - Obtain Pull Secrets"},{"location":"#221-obtain-red-hat-pull-secret","text":"A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. To obtain a Red Hat pull secret, go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned Note This step must be done manually, via a web browser. It is optional though recommended. Important Make sure to update ${ARO_REDHAT_PULL_SECRET_FILE} with the path where the pull secret was saved. Reference(s): https://access.redhat.com/solutions/4844461","title":"22.1 - Obtain Red Hat Pull Secret"},{"location":"#222-verify-red-hat-pull-secret","text":"Command(s): ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: -rw-rw----. 1 jtingiris mit 2835 Sep 12 10:26 /home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt","title":"22.2 - Verify Red Hat Pull Secret"},{"location":"#23-azure-red-hat-openshift","text":"Reference(s): https://azure.microsoft.com/en-us/services/openshift/ https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest Command(s): env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V Example Output: ARO_CLUSTER_DOMAIN_NAME=ipm.mitaei.net ARO_CLUSTER_NAME=ipm-cluster ARO_CLUSTER_VISIBILITY_API=Private ARO_CLUSTER_VISIBILITY_INGRESS=Private ARO_CLUSTER_VM_MASTER_SIZE=Standard_D8s_v3 ARO_CLUSTER_VM_WORKER_COUNT=3 ARO_CLUSTER_VM_WORKER_DISK_GB=128 ARO_CLUSTER_VM_WORKER_SIZE=Standard_D8s_v3 ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_VNET_NAME=ipm-vnet","title":"23 - Azure Red Hat OpenShift"},{"location":"#231-create-aro-cluster","text":"This can take up to an hour. Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_create https://docs.openshift.com/container-platform/4.4/installing/installing_azure/installing-azure-network-customizations.html#modifying-nwoperator-config-startup_installing-azure-network-customizations Command(s): az aro create --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --name \"${ARO_CLUSTER_NAME}\" --master-subnet \"${ARO_SUBNET_MASTER_NAME}\" --master-vm-size \"${ARO_CLUSTER_VM_MASTER_SIZE}\" --worker-subnet \"${ARO_SUBNET_WORKER_NAME}\" --worker-count ${ARO_CLUSTER_VM_WORKER_COUNT} --worker-vm-size \"${ARO_CLUSTER_VM_WORKER_SIZE}\" --worker-vm-disk-size-gb ${ARO_CLUSTER_VM_WORKER_DISK_GB} --apiserver-visibility \"${ARO_CLUSTER_VISIBILITY_INGRESS}\" --ingress-visibility \"${ARO_CLUSTER_VISIBILITY_API}\" --pod-cidr \"${ARO_SUBNET_POD_CIDR}\" --service-cidr \"${ARO_SUBNET_SERVICE_CIDR}\" --vnet \"${ARO_VNET_NAME}\" --pull-secret @\"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: { \"apiserverProfile\": { \"ip\": \"10.10.0.4\", \"url\": \"https://api.my4zz953.eastus.aroapp.io:6443/\", \"visibility\": \"Private\" }, \"clusterProfile\": { \"domain\": \"my4zz953\", \"pullSecret\": null, \"resourceGroupId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-my4zz953\", \"version\": \"4.4.17\" }, \"consoleProfile\": { \"url\": \"https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/\" }, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.RedHatOpenShift/openShiftClusters/ipm-cluster\", \"ingressProfiles\": [ { \"ip\": \"10.10.2.4\", \"name\": \"default\", \"visibility\": \"Private\" } ], \"location\": \"eastus\", \"masterProfile\": { \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, \"name\": \"ipm-cluster\", \"networkProfile\": { \"podCidr\": \"10.12.0.0/14\", \"serviceCidr\": \"10.11.0.0/16\" }, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"servicePrincipalProfile\": { \"clientId\": \"de8651b4-5479-47c4-8be4-0081ee8ae5d6\", \"clientSecret\": null }, \"tags\": null, \"type\": \"Microsoft.RedHatOpenShift/openShiftClusters\", \"workerProfiles\": [ { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus1\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus2\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus3\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" } ] }","title":"23.1 - Create ARO Cluster"},{"location":"#232-verify-aro-cluster","text":"Command(s): az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" Example Output: https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/ { \"apiserverProfile\": { \"ip\": \"10.10.0.4\", \"url\": \"https://api.my4zz953.eastus.aroapp.io:6443/\", \"visibility\": \"Private\" }, \"clusterProfile\": { \"domain\": \"my4zz953\", \"pullSecret\": null, \"resourceGroupId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-my4zz953\", \"version\": \"4.4.17\" }, \"consoleProfile\": { \"url\": \"https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/\" }, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.RedHatOpenShift/openShiftClusters/ipm-cluster\", \"ingressProfiles\": [ { \"ip\": \"10.10.2.4\", \"name\": \"default\", \"visibility\": \"Private\" } ], \"location\": \"eastus\", \"masterProfile\": { \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, \"name\": \"ipm-cluster\", \"networkProfile\": { \"podCidr\": \"10.12.0.0/14\", \"serviceCidr\": \"10.11.0.0/16\" }, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"servicePrincipalProfile\": { \"clientId\": \"de8651b4-5479-47c4-8be4-0081ee8ae5d6\", \"clientSecret\": null }, \"tags\": null, \"type\": \"Microsoft.RedHatOpenShift/openShiftClusters\", \"workerProfiles\": [ { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus1\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus2\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus3\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" } ] } { \"kubeadminPassword\": \"TSx2J-LY56j-KznE7-SzIU3\", \"kubeadminUsername\": \"kubeadmin\" }","title":"23.2 - Verify ARO Cluster"},{"location":"#24-openshift-cli","text":"The OpenShift CLI client oc simplifies working with Kubernetes and OpenShift clusters, offering a number of advantages over kubectl such as easy login, kube config file management, and access to developer tools. The kubectl binary is included for when strict Kubernetes compliance is necessary. Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_list_credentials https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_show https://cloud.redhat.com/openshift/install/azure/installer-provisioned https://docs.openshift.com/container-platform/4.4/cli_reference/openshift_cli/getting-started-cli.html","title":"24 - OpenShift CLI"},{"location":"#241-install-openshift-cli","text":"Download the latest archive for Azure Red Hat OpenShift from here: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz After extracting the archive, move the oc and kubectl binaries to a location in the PATH, such as /usr/local/bin . To start a session with the OpenShift cluster, login. oc login [API_URL] Reference(s): https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz Command(s): wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -O /tmp/openshift-client-linux.tar.gz 2>&1 cd /tmp tar zxvf openshift-client-linux.tar.gz mv -f oc /usr/local/bin mv -f kubectl /usr/local/in Example Output: README.md oc kubectl","title":"24.1 - Install OpenShift CLI"},{"location":"#242-verify-openshift-cli","text":"Command(s): oc version kubectl version Example Output: Client Version: 4.5.11 Client Version: version.Info{Major:\"1\", Minor:\"18\", GitVersion:\"v1.18.2-0-g52c56ce\", GitCommit:\"d7f3ccf9a5bdc96ba92e31526cf014b3de4c46aa\", GitTreeState:\"clean\", BuildDate:\"2020-09-11T23:48:53Z\", GoVersion:\"go1.13.4\", Compiler:\"gc\", Platform:\"linux/amd64\"}","title":"24.2 - Verify OpenShift CLI"},{"location":"#25-openshift-authentication","text":"TODO","title":"25 - OpenShift Authentication"},{"location":"about/","text":"Azure Red Hat OpenShift for IBM Product Master \u00a9 2020 Mastech InfoTrellis, Ltd. Authors Joseph Tingiris < joseph.tingiris@mastechinfotrellis.com > Arun Babu < arun.babu@mastechinfotrellis.com > SivaPrasad Konduru < sivaprasad.k@mastechinfotrellis.com >","title":"About"},{"location":"about/#azure-red-hat-openshift-for-ibm-product-master","text":"","title":"Azure Red Hat OpenShift for IBM Product Master"},{"location":"about/#2020-mastech-infotrellis-ltd","text":"","title":"&copy; 2020 Mastech InfoTrellis, Ltd."},{"location":"about/#authors","text":"Joseph Tingiris < joseph.tingiris@mastechinfotrellis.com > Arun Babu < arun.babu@mastechinfotrellis.com > SivaPrasad Konduru < sivaprasad.k@mastechinfotrellis.com >","title":"Authors"},{"location":"preview-delete-tldr/","text":"25 - OpenShift Authentication 24 - OpenShift CLI 23 - Azure Red Hat OpenShift 23.1 - Delete ARO Cluster az aro delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_CLUSTER_NAME} --yes 22 - Obtain Pull Secrets 22.1 - Obtain Red Hat Pull Secret 21 - VPN Client 21.1 - Delete VPN Client rm -f \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 20 - Client Certificates 20.1 - Set VPN Client Environment Variables export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' 20.2 - Verify VPN Client Environment Variables ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE 20.3 - Delete VPN Client Key rm -f \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" 20.4 - Delete Client Certificate Request rm -f \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" 20.5 - Delete Client Certificate Extensions rm -f \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.6 - Delete Client Certificate rm -f \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" 20.7 - Delete VPN Client Serial rm -f \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 20.8 - Delete VPN Client PFX rm \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" 19 - VPN Gateway PKI 19.1 - Delete Root Certificate rm -f \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" 19.2 - Delete Root Key rm -f \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" 18 - VPN Gateway 18.1 - Delete VPN Gateway az network vnet-gateway delete --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 18.2 - Delete VPN Address az network public-ip delete --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 18.3 - Delete VPN Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} 17 - Jump Server VM 17.1 - Delete Jump Server VM az vm delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --yes 17.2 - Cancel Jump Server Image URN az vm image terms cancel --urn ${ARO_VM_JUMP_IMAGE_URN} 17.3 - Delete Jump Server AS az vm availability-set delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.4 - Delete Jump Server NIC az network nic delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic 17.5 - Delete Jump Server Address az network public-ip delete --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.6 - Login to Jump Server VM export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\" 16 - Related Subnets 16.1 - Delete Application Gateway Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} 16.2 - Delete Database Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} 16.3 - Delete DMZ Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} 16.4 - Delete Trusted Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} 15 - Network Security Group Rules 15.1 - Delete DMZ NSG Rule (AllowSSH) az network nsg rule delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH 14 - Network Security Groups 14.1 - Delete Network Security Groups az network nsg delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} 13 - OpenShift Subnets 13.1 - Delete Master Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} 13.2 - Delete Worker Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} 12 - Virtual Network 12.1 - Delete Virtual Network az network vnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} 11 - Resource Group 11.1 - Delete Resource Group delete_orphans az group delete --name ${ARO_RESOURCE_GROUP_NAME --yes","title":"Preview delete tldr"},{"location":"preview-delete-tldr/#25-openshift-authentication","text":"","title":"25 - OpenShift Authentication"},{"location":"preview-delete-tldr/#24-openshift-cli","text":"","title":"24 - OpenShift CLI"},{"location":"preview-delete-tldr/#23-azure-red-hat-openshift","text":"23.1 - Delete ARO Cluster az aro delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_CLUSTER_NAME} --yes","title":"23 - Azure Red Hat OpenShift"},{"location":"preview-delete-tldr/#22-obtain-pull-secrets","text":"22.1 - Obtain Red Hat Pull Secret","title":"22 - Obtain Pull Secrets"},{"location":"preview-delete-tldr/#21-vpn-client","text":"21.1 - Delete VPN Client rm -f \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\"","title":"21 - VPN Client"},{"location":"preview-delete-tldr/#20-client-certificates","text":"20.1 - Set VPN Client Environment Variables export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' 20.2 - Verify VPN Client Environment Variables ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE 20.3 - Delete VPN Client Key rm -f \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" 20.4 - Delete Client Certificate Request rm -f \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" 20.5 - Delete Client Certificate Extensions rm -f \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.6 - Delete Client Certificate rm -f \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" 20.7 - Delete VPN Client Serial rm -f \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 20.8 - Delete VPN Client PFX rm \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\"","title":"20 - Client Certificates"},{"location":"preview-delete-tldr/#19-vpn-gateway-pki","text":"19.1 - Delete Root Certificate rm -f \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" 19.2 - Delete Root Key rm -f \"${ARO_VGW_PKI_ROOT_KEY_FILE}\"","title":"19 - VPN Gateway PKI"},{"location":"preview-delete-tldr/#18-vpn-gateway","text":"18.1 - Delete VPN Gateway az network vnet-gateway delete --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 18.2 - Delete VPN Address az network public-ip delete --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 18.3 - Delete VPN Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME}","title":"18 - VPN Gateway"},{"location":"preview-delete-tldr/#17-jump-server-vm","text":"17.1 - Delete Jump Server VM az vm delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --yes 17.2 - Cancel Jump Server Image URN az vm image terms cancel --urn ${ARO_VM_JUMP_IMAGE_URN} 17.3 - Delete Jump Server AS az vm availability-set delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.4 - Delete Jump Server NIC az network nic delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic 17.5 - Delete Jump Server Address az network public-ip delete --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.6 - Login to Jump Server VM export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\"","title":"17 - Jump Server VM"},{"location":"preview-delete-tldr/#16-related-subnets","text":"16.1 - Delete Application Gateway Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} 16.2 - Delete Database Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} 16.3 - Delete DMZ Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} 16.4 - Delete Trusted Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME}","title":"16 - Related Subnets"},{"location":"preview-delete-tldr/#15-network-security-group-rules","text":"15.1 - Delete DMZ NSG Rule (AllowSSH) az network nsg rule delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH","title":"15 - Network Security Group Rules"},{"location":"preview-delete-tldr/#14-network-security-groups","text":"14.1 - Delete Network Security Groups az network nsg delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME}","title":"14 - Network Security Groups"},{"location":"preview-delete-tldr/#13-openshift-subnets","text":"13.1 - Delete Master Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} 13.2 - Delete Worker Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME}","title":"13 - OpenShift Subnets"},{"location":"preview-delete-tldr/#12-virtual-network","text":"12.1 - Delete Virtual Network az network vnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME}","title":"12 - Virtual Network"},{"location":"preview-delete-tldr/#11-resource-group","text":"11.1 - Delete Resource Group delete_orphans az group delete --name ${ARO_RESOURCE_GROUP_NAME --yes","title":"11 - Resource Group"},{"location":"preview-delete/","text":"25 - OpenShift Authentication Work in Progress 24 - OpenShift CLI The OpenShift CLI client oc simplifies working with Kubernetes and OpenShift clusters, offering a number of advantages over kubectl such as easy login, kube config file management, and access to developer tools. The kubectl binary is included for when strict Kubernetes compliance is necessary. 23 - Azure Red Hat OpenShift 23.1 - Delete ARO Cluster Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_delete Command(s): az aro delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_CLUSTER_NAME} --yes Example Output: Warning failed to delete aro cluster ipm-cluster 22 - Obtain Pull Secrets Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries. 22.1 - Obtain Red Hat Pull Secret A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. To obtain a Red Hat pull secret, go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned Note This step must be done manually, via a web browser. It is optional though recommended. Important Make sure to update ${ARO_REDHAT_PULL_SECRET_FILE} with the path where the pull secret was saved. Reference(s): https://access.redhat.com/solutions/4844461 21 - VPN Client Please follow Microsoft's instructions for installing the VPN Client for your operating system. Tip Commands for using az and wget are given below. 21.1 - Delete VPN Client Command(s): rm -f \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" Example Output: 20 - Client Certificates VPN Clients must present an X.509 version 3 certificate when connecting. Each user should have their own bundle of certificate files. This step outlines a procedure to create them with OpenSSL v1.1.1. It will need to be re-run for everyone who requires connectivity. The Azure VPN Gateway supports both IKEv2 (ipsec) and OpenVPN (ssl) client connections. Various VPN client software support these technologies. It is most convenient to distribute a PKCS#12 file to the user, so they can connect to the VPN Gateway and access the private Azure Red Hat OpenShift cluster. In cryptography, PKCS #12 defines an archive file format for storing many cryptography objects as a single file. PKCS#12 evolved from Microsoft's Personal Information Exchange (PFX) standard and is used to exchange public and private objects. It is commonly used to bundle a private key with its X.509 certificate or to bundle all the members of a chain of trust. The terms PKCS #12 (pkcs12) and PFX (pfx) are often used interchangeably. Successful execution of the commands in this step depends upon the previously created VPN Gateway Root Certificate files and exported environment variables. Successful completion of the following steps will produce six (6) files, in this order: VPN Client Key (.key) VPN Client Certificate Request (.req) VPN Client Certificate Extensions (.ext) VPN Client Certificate (.crt) VPN Client Certificate Serial (.serial) VPN Client Certificate Bundle (.pfx) The resulting PFX file is should be given to the user. 20.1 - Set VPN Client Environment Variables These environment variables should be exported each time a new set of client certificate files are created. Important These are example values that must be changed for your installation. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' Example Output: + success does not produce any output 20.2 - Verify VPN Client Environment Variables Reference(s): https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html Command(s): ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE Example Output: ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! 20.3 - Delete VPN Client Key missing './help/Delete VPN Client Key.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" Example Output: 20.4 - Delete Client Certificate Request missing './help/Delete Client Certificate Request.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" Example Output: 20.5 - Delete Client Certificate Extensions missing './help/Delete Client Certificate Extensions.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: 20.6 - Delete Client Certificate missing './help/Delete Client Certificate.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" Example Output: 20.7 - Delete VPN Client Serial missing './help/Delete VPN Client Serial.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" Example Output: 20.8 - Delete VPN Client PFX missing './help/Delete VPN Client PFX.md' Command(s): rm \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" Example Output: 19 - VPN Gateway PKI An Azure VPN Gateway supports using a Public Key Infrastructure (PKI) for Certificate Authentication. With VPN Gateway Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. This series of steps establishes a private Certificate Authority (CA) by creating a Root Key & Certificate. The Certificate Data wil be uploaded to the Azure VPN Gateway, so that VPN Clients Certificates will be authenticated. To be valid for authentication, the VPN Client Certificates must be signed by the Root Certificate. Note VPN Client Certificates will be created later. 19.1 - Delete Root Certificate Command(s): rm -f \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" Example Output: + success does not produce any output 19.2 - Delete Root Key Command(s): rm -f \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" Example Output: + success does not produce any output 18 - VPN Gateway A Virtual Private Network (VPN) Gateway is needed to connect to a private ARO cluster. It is a specific type of gateway that is used to send encrypted traffic between an Azure VNet and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. 18.1 - Delete VPN Gateway Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_delete Command(s): az network vnet-gateway delete --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: + success does not produce any output 18.2 - Delete VPN Address Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_delete Command(s): az network public-ip delete --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: + success does not produce any output 18.3 - Delete VPN Subnet missing './help/Delete VPN Subnet.md' Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} Example Output: + success does not produce any output 17 - Jump Server VM A jump server, jump host, or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example of a jump server is a host in a DMZ. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet. It will be allowed to communicate with the other internal subnets. The NSGs may be further tune to allow specific access, as it will be done for the ARO master subnet when ARO is installed. Note The jumpbox should be created prior to the VPN Gateway, so that there is at least one machine available for connectivity testing from two different security zones: Public (Internet) and Private (RFC1918). 17.1 - Delete Jump Server VM Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_delete Command(s): az vm delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --yes Example Output: + success does not produce any output 17.2 - Cancel Jump Server Image URN missing './help/Cancel Jump Server Image URN.md' Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_cancel Command(s): az vm image terms cancel --urn ${ARO_VM_JUMP_IMAGE_URN} Example Output: az vm image terms cancel --urn cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 # do this manually; this might affect more than this vm + success does not produce any output 17.3 - Delete Jump Server AS Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_delete Command(s): az vm availability-set delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} Example Output: + success does not produce any output 17.4 - Delete Jump Server NIC Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_delete Command(s): az network nic delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic Example Output: + success does not produce any output 17.5 - Delete Jump Server Address Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-delete Command(s): az network public-ip delete --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: + success does not produce any output 16 - Related Subnets IBM Product Manager requires related subnets for supplementary virtual machines, to host applications such as DB2. These subnets should be within the same resource group and VNet range previously defined. The network numbers should be IPv4 RFC1918 compliant and prefixed. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) 16.1 - Delete Application Gateway Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} Example Output: + success does not produce any output 16.2 - Delete Database Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} Example Output: + success does not produce any output 16.3 - Delete DMZ Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} Example Output: + success does not produce any output 16.4 - Delete Trusted Subnet missing './help/Delete Trusted Subnet.md' Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} Example Output: + success does not produce any output 15 - Network Security Group Rules Network Security Group (NSG) Rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows an NSG to be stateful. 15.1 - Delete DMZ NSG Rule (AllowSSH) Command(s): az network nsg rule delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH Example Output: + success does not produce any output 14 - Network Security Groups An Azure Network Security Group (NSG) filters network traffic to and from Azure resources in an Azure virtual network. An NSG contains security rules that allow/deny network traffic to/from several types of Azure resources. Note The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. 14.1 - Delete Network Security Groups Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_delete Command(s): az network nsg delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} Example Output: + success does not produce any output + success does not produce any output + success does not produce any output + success does not produce any output 13 - OpenShift Subnets Before installing, Azure Red Hat OpenShift clusters require manually creating a virtual network with two empty subnets for the master and worker VMs. Additionally, the Pod & Service subnets will automatically assigned during the installation. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Important Pod and Service Network CIDRs are configurable. Workers and masters must be in different subnets. Workers and masters virtual network subnets should be minimum /27. Pod CIDR should be minimum /18 in size. The pod network is non-routable IPs, and is only used inside the OpenShift SDN. Each node is allocated /23 subnet (512 IPs) for its pods. This value cannot be changed. You cannot attach a pod to multiple networks. Note In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher_ ; Please see the references in this section for more details. 13.1 - Delete Master Subnet Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} Example Output: + success does not produce any output 13.2 - Delete Worker Subnet Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} Example Output: + success does not produce any output 12 - Virtual Network An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. 12.1 - Delete Virtual Network Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-delete Command(s): az network vnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: + success does not produce any output 11 - Resource Group An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. 11.1 - Delete Resource Group Command(s): delete_orphans az group delete --name ${ARO_RESOURCE_GROUP_NAME --yes Example Output: Deleting ipm orphan id (/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/2630de73-19ad-4d1c-bf96-041de8f96943) ... Deleting ipm orphan id (/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/fcea5c23-99dc-4d94-bee8-0cd4043e0f11) ... ```diff + success does not produce any output ```diff + success does not produce any output","title":"Preview delete"},{"location":"preview-delete/#25-openshift-authentication","text":"Work in Progress","title":"25 - OpenShift Authentication"},{"location":"preview-delete/#24-openshift-cli","text":"The OpenShift CLI client oc simplifies working with Kubernetes and OpenShift clusters, offering a number of advantages over kubectl such as easy login, kube config file management, and access to developer tools. The kubectl binary is included for when strict Kubernetes compliance is necessary.","title":"24 - OpenShift CLI"},{"location":"preview-delete/#23-azure-red-hat-openshift","text":"","title":"23 - Azure Red Hat OpenShift"},{"location":"preview-delete/#231-delete-aro-cluster","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_delete Command(s): az aro delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_CLUSTER_NAME} --yes Example Output: Warning failed to delete aro cluster ipm-cluster","title":"23.1 - Delete ARO Cluster"},{"location":"preview-delete/#22-obtain-pull-secrets","text":"Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries.","title":"22 - Obtain Pull Secrets"},{"location":"preview-delete/#221-obtain-red-hat-pull-secret","text":"A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. To obtain a Red Hat pull secret, go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned Note This step must be done manually, via a web browser. It is optional though recommended. Important Make sure to update ${ARO_REDHAT_PULL_SECRET_FILE} with the path where the pull secret was saved. Reference(s): https://access.redhat.com/solutions/4844461","title":"22.1 - Obtain Red Hat Pull Secret"},{"location":"preview-delete/#21-vpn-client","text":"Please follow Microsoft's instructions for installing the VPN Client for your operating system. Tip Commands for using az and wget are given below.","title":"21 - VPN Client"},{"location":"preview-delete/#211-delete-vpn-client","text":"Command(s): rm -f \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" Example Output:","title":"21.1 - Delete VPN Client"},{"location":"preview-delete/#20-client-certificates","text":"VPN Clients must present an X.509 version 3 certificate when connecting. Each user should have their own bundle of certificate files. This step outlines a procedure to create them with OpenSSL v1.1.1. It will need to be re-run for everyone who requires connectivity. The Azure VPN Gateway supports both IKEv2 (ipsec) and OpenVPN (ssl) client connections. Various VPN client software support these technologies. It is most convenient to distribute a PKCS#12 file to the user, so they can connect to the VPN Gateway and access the private Azure Red Hat OpenShift cluster. In cryptography, PKCS #12 defines an archive file format for storing many cryptography objects as a single file. PKCS#12 evolved from Microsoft's Personal Information Exchange (PFX) standard and is used to exchange public and private objects. It is commonly used to bundle a private key with its X.509 certificate or to bundle all the members of a chain of trust. The terms PKCS #12 (pkcs12) and PFX (pfx) are often used interchangeably. Successful execution of the commands in this step depends upon the previously created VPN Gateway Root Certificate files and exported environment variables. Successful completion of the following steps will produce six (6) files, in this order: VPN Client Key (.key) VPN Client Certificate Request (.req) VPN Client Certificate Extensions (.ext) VPN Client Certificate (.crt) VPN Client Certificate Serial (.serial) VPN Client Certificate Bundle (.pfx) The resulting PFX file is should be given to the user.","title":"20 - Client Certificates"},{"location":"preview-delete/#201-set-vpn-client-environment-variables","text":"These environment variables should be exported each time a new set of client certificate files are created. Important These are example values that must be changed for your installation. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' Example Output: + success does not produce any output","title":"20.1 - Set VPN Client Environment Variables"},{"location":"preview-delete/#202-verify-vpn-client-environment-variables","text":"Reference(s): https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html Command(s): ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE Example Output: ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!!","title":"20.2 - Verify VPN Client Environment Variables"},{"location":"preview-delete/#203-delete-vpn-client-key","text":"missing './help/Delete VPN Client Key.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" Example Output:","title":"20.3 - Delete VPN Client Key"},{"location":"preview-delete/#204-delete-client-certificate-request","text":"missing './help/Delete Client Certificate Request.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" Example Output:","title":"20.4 - Delete Client Certificate Request"},{"location":"preview-delete/#205-delete-client-certificate-extensions","text":"missing './help/Delete Client Certificate Extensions.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output:","title":"20.5 - Delete Client Certificate Extensions"},{"location":"preview-delete/#206-delete-client-certificate","text":"missing './help/Delete Client Certificate.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" Example Output:","title":"20.6 - Delete Client Certificate"},{"location":"preview-delete/#207-delete-vpn-client-serial","text":"missing './help/Delete VPN Client Serial.md' Command(s): rm -f \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" Example Output:","title":"20.7 - Delete VPN Client Serial"},{"location":"preview-delete/#208-delete-vpn-client-pfx","text":"missing './help/Delete VPN Client PFX.md' Command(s): rm \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" Example Output:","title":"20.8 - Delete VPN Client PFX"},{"location":"preview-delete/#19-vpn-gateway-pki","text":"An Azure VPN Gateway supports using a Public Key Infrastructure (PKI) for Certificate Authentication. With VPN Gateway Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. This series of steps establishes a private Certificate Authority (CA) by creating a Root Key & Certificate. The Certificate Data wil be uploaded to the Azure VPN Gateway, so that VPN Clients Certificates will be authenticated. To be valid for authentication, the VPN Client Certificates must be signed by the Root Certificate. Note VPN Client Certificates will be created later.","title":"19 - VPN Gateway PKI"},{"location":"preview-delete/#191-delete-root-certificate","text":"Command(s): rm -f \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" Example Output: + success does not produce any output","title":"19.1 - Delete Root Certificate"},{"location":"preview-delete/#192-delete-root-key","text":"Command(s): rm -f \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" Example Output: + success does not produce any output","title":"19.2 - Delete Root Key"},{"location":"preview-delete/#18-vpn-gateway","text":"A Virtual Private Network (VPN) Gateway is needed to connect to a private ARO cluster. It is a specific type of gateway that is used to send encrypted traffic between an Azure VNet and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication.","title":"18 - VPN Gateway"},{"location":"preview-delete/#181-delete-vpn-gateway","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_delete Command(s): az network vnet-gateway delete --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: + success does not produce any output","title":"18.1 - Delete VPN Gateway"},{"location":"preview-delete/#182-delete-vpn-address","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_delete Command(s): az network public-ip delete --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: + success does not produce any output","title":"18.2 - Delete VPN Address"},{"location":"preview-delete/#183-delete-vpn-subnet","text":"missing './help/Delete VPN Subnet.md' Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} Example Output: + success does not produce any output","title":"18.3 - Delete VPN Subnet"},{"location":"preview-delete/#17-jump-server-vm","text":"A jump server, jump host, or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example of a jump server is a host in a DMZ. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet. It will be allowed to communicate with the other internal subnets. The NSGs may be further tune to allow specific access, as it will be done for the ARO master subnet when ARO is installed. Note The jumpbox should be created prior to the VPN Gateway, so that there is at least one machine available for connectivity testing from two different security zones: Public (Internet) and Private (RFC1918).","title":"17 - Jump Server VM"},{"location":"preview-delete/#171-delete-jump-server-vm","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_delete Command(s): az vm delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --yes Example Output: + success does not produce any output","title":"17.1 - Delete Jump Server VM"},{"location":"preview-delete/#172-cancel-jump-server-image-urn","text":"missing './help/Cancel Jump Server Image URN.md' Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_cancel Command(s): az vm image terms cancel --urn ${ARO_VM_JUMP_IMAGE_URN} Example Output: az vm image terms cancel --urn cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 # do this manually; this might affect more than this vm + success does not produce any output","title":"17.2 - Cancel Jump Server Image URN"},{"location":"preview-delete/#173-delete-jump-server-as","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_delete Command(s): az vm availability-set delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} Example Output: + success does not produce any output","title":"17.3 - Delete Jump Server AS"},{"location":"preview-delete/#174-delete-jump-server-nic","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_delete Command(s): az network nic delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic Example Output: + success does not produce any output","title":"17.4 - Delete Jump Server NIC"},{"location":"preview-delete/#175-delete-jump-server-address","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-delete Command(s): az network public-ip delete --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: + success does not produce any output","title":"17.5 - Delete Jump Server Address"},{"location":"preview-delete/#16-related-subnets","text":"IBM Product Manager requires related subnets for supplementary virtual machines, to host applications such as DB2. These subnets should be within the same resource group and VNet range previously defined. The network numbers should be IPv4 RFC1918 compliant and prefixed. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool)","title":"16 - Related Subnets"},{"location":"preview-delete/#161-delete-application-gateway-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} Example Output: + success does not produce any output","title":"16.1 - Delete Application Gateway Subnet"},{"location":"preview-delete/#162-delete-database-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} Example Output: + success does not produce any output","title":"16.2 - Delete Database Subnet"},{"location":"preview-delete/#163-delete-dmz-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} Example Output: + success does not produce any output","title":"16.3 - Delete DMZ Subnet"},{"location":"preview-delete/#164-delete-trusted-subnet","text":"missing './help/Delete Trusted Subnet.md' Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_delete Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} Example Output: + success does not produce any output","title":"16.4 - Delete Trusted Subnet"},{"location":"preview-delete/#15-network-security-group-rules","text":"Network Security Group (NSG) Rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows an NSG to be stateful.","title":"15 - Network Security Group Rules"},{"location":"preview-delete/#151-delete-dmz-nsg-rule-allowssh","text":"Command(s): az network nsg rule delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH Example Output: + success does not produce any output","title":"15.1 - Delete DMZ NSG Rule (AllowSSH)"},{"location":"preview-delete/#14-network-security-groups","text":"An Azure Network Security Group (NSG) filters network traffic to and from Azure resources in an Azure virtual network. An NSG contains security rules that allow/deny network traffic to/from several types of Azure resources. Note The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup.","title":"14 - Network Security Groups"},{"location":"preview-delete/#141-delete-network-security-groups","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_delete Command(s): az network nsg delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} Example Output: + success does not produce any output + success does not produce any output + success does not produce any output + success does not produce any output","title":"14.1 - Delete Network Security Groups"},{"location":"preview-delete/#13-openshift-subnets","text":"Before installing, Azure Red Hat OpenShift clusters require manually creating a virtual network with two empty subnets for the master and worker VMs. Additionally, the Pod & Service subnets will automatically assigned during the installation. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Important Pod and Service Network CIDRs are configurable. Workers and masters must be in different subnets. Workers and masters virtual network subnets should be minimum /27. Pod CIDR should be minimum /18 in size. The pod network is non-routable IPs, and is only used inside the OpenShift SDN. Each node is allocated /23 subnet (512 IPs) for its pods. This value cannot be changed. You cannot attach a pod to multiple networks. Note In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher_ ; Please see the references in this section for more details.","title":"13 - OpenShift Subnets"},{"location":"preview-delete/#131-delete-master-subnet","text":"Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} Example Output: + success does not produce any output","title":"13.1 - Delete Master Subnet"},{"location":"preview-delete/#132-delete-worker-subnet","text":"Command(s): az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} Example Output: + success does not produce any output","title":"13.2 - Delete Worker Subnet"},{"location":"preview-delete/#12-virtual-network","text":"An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation.","title":"12 - Virtual Network"},{"location":"preview-delete/#121-delete-virtual-network","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-delete Command(s): az network vnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: + success does not produce any output","title":"12.1 - Delete Virtual Network"},{"location":"preview-delete/#11-resource-group","text":"An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted.","title":"11 - Resource Group"},{"location":"preview-delete/#111-delete-resource-group","text":"Command(s): delete_orphans az group delete --name ${ARO_RESOURCE_GROUP_NAME --yes Example Output: Deleting ipm orphan id (/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/2630de73-19ad-4d1c-bf96-041de8f96943) ... Deleting ipm orphan id (/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/fcea5c23-99dc-4d94-bee8-0cd4043e0f11) ... ```diff + success does not produce any output ```diff + success does not produce any output","title":"11.1 - Delete Resource Group"},{"location":"preview-tldr/","text":"Azure Red Hat OpenShift for IBM Product Master [DRAFT] This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 10:58:30 PM EDT Too Long; Didn't Read This is a representation of only the commands from the index, using the example environment configuration file from section 4.2. All descriptions, references, and example outputs have been removed. 1 - Azure Tenant 1.1 - Create Microsoft Account 1.2 - Create Global Administrator 1.3 - Verify Admin Center Access 1.4 - Verify AAD License 2 - Azure Subscription 2.1 - Create Azure Subscription 3 - Operating System 3.1 - Verify Operating System uname -a 3.2 - Verify GNU bash bash --version 3.3 - Verify GNU awk awk --version 3.4 - Verify GNU coreutils base64 --version basename --version dirname --version sort --version head --version tail --version 3.5 - Verify GNU grep egrep --version 3.6 - Verify GNU wget wget --version 3.7 - Verify Browser firefox --version google-chrome --version 3.8 - Verify OpenSSL openssl version 4 - Environment Variables 4.1 - Unset Environment Variables for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done 4.2 - Set Environment Variables cat << 'EOF' > \"ipm.env\" # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done' EOF cat \"ipm.env\" && source \"ipm.env\" 4.3 - Verify Environment Variables env | grep ^ARO | sort -V 5 - Required Directories env | egrep \"ARO.*DIR\" | sort -V 5.1 - Create Required Directories mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" 6 - Azure CLI which az 6.1 - Install Azure CLI az --version 6.2 - Subscription Owner Login az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv 6.3 - Verify Azure Tenant az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi 6.4 - Set Default Subscription az account set -s \"${ARO_SUBSCRIPTION_NAME}\" 6.5 - Verify Default Subscription az account list --query '[?isDefault == `true`]' 7 - Subscription Owners 7.1 - Create Subscription Owners for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done 7.2 - Verify Subscription Owners az role assignment list --role Owner --output table 8 - Subscription Details env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" 8.1 - Verify Subscription Name az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi 8.2 - Verify Subscription ID az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi 8.3 - Verify Subscription Location az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi 8.4 - Verify Subscription Limits if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi 8.5 - Verify Subscription Quotas for ARO_VERIFY_QUOTA_NAME in \"${ARO_VERIFY_QUOTA_NAMES[@]}\"; do echo \"ARO_VERIFY_QUOTA_NAME=${ARO_VERIFY_QUOTA_NAME}\"; done; unset ARO_VERIFY_QUOTA_NAMES 8.6 - Standard DSv3 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 8.7 - Standard Dv2 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 9 - OpenShift Administrators env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" 9.1 - Create Administrators az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login 9.2 - Verify Administrators for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done 9.3 - Create Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done 9.4 - Verify Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done 10 - Resource Providers echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" 10.1 - Register Provider Microsoft.Compute az provider register -n Microsoft.Compute --wait 10.2 - Verify Provider Microsoft.Compute az provider show --namespace Microsoft.Compute --output table 10.3 - Register Provider Microsoft.RedHatOpenShift az provider register -n Microsoft.RedHatOpenShift --wait 10.4 - Verify Provider Microsoft.RedHatOpenShift az provider show --namespace Microsoft.RedHatOpenShift --output table 10.5 - Register Provider Microsoft.Storage az provider register -n Microsoft.Storage --wait 10.6 - Verify Provider Microsoft.Storage az provider show --namespace Microsoft.Storage --output table 11 - Resource Group env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' 11.1 - Create Resource Group az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} 11.2 - Verify Resource Group az group show --name ${ARO_RESOURCE_GROUP_NAME} 12 - Virtual Network env | grep ^ARO_VNET | sort -V 12.1 - Create Virtual Network az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_CIDR} ${ARO_SUBNET_SERVICE_CIDR} ${ARO_SUBNET_POD_CIDR} 12.2 - Verify Virtual Network az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} 13 - OpenShift Subnets env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V 13.1 - Verify OpenShift Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --output table 2> /dev/null; if [ $? -eq 0 ]; then echo \"ERROR! ARO cluster ${ARO_CLUSTER_NAME} exists; do not recreate the master or worker subnets\"; fi 13.2 - Create Master Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --address-prefixes ${ARO_SUBNET_MASTER_CIDR} --service-endpoints Microsoft.ContainerRegistry 13.3 - Disable Master Subnet Private Link Service az network vnet subnet update --name ${ARO_SUBNET_MASTER_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --disable-private-link-service-network-policies true 13.4 - Verify Master Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table 13.5 - Create Worker Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --address-prefixes ${ARO_SUBNET_WORKER_CIDR} --service-endpoints Microsoft.ContainerRegistry 13.6 - Verify Worker Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table 14 - Network Security Groups env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V 14.1 - Create Network Security Groups az network nsg create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} 14.2 - Verify Network Security Groups az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo 15 - Network Security Group Rules env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V 15.1 - Create DMZ NSG Rule (AllowSSH) az network nsg rule create --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow 15.2 - Verify DMZ NSG Rules az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table 16 - Related Subnets env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V 16.1 - Create Application Gateway Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --address-prefixes ${ARO_SUBNET_AGW_CIDR} --network-security-group=${ARO_SUBNET_AGW_NSG_NAME} 16.2 - Verify Application Gateway Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table 16.3 - Create Database Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --address-prefixes ${ARO_SUBNET_DB_CIDR} --network-security-group=${ARO_SUBNET_DB_NSG_NAME} 16.4 - Verify Database Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table 16.5 - Create DMZ Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --address-prefixes ${ARO_SUBNET_DMZ_CIDR} --network-security-group=${ARO_SUBNET_DMZ_NSG_NAME} 16.6 - Verify DMZ Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table 16.7 - Create Trusted Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --address-prefixes ${ARO_SUBNET_TRUSTED_CIDR} --network-security-group ${ARO_SUBNET_TRUSTED_NSG_NAME} 16.8 - Verify Trusted Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table 17 - Jump Server VM env | egrep ARO.*JUMP | sort -V 17.1 - Create Jump Server Address az network public-ip create --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"Basic\" --allocation-method \"Dynamic\" 17.2 - Verify Jump Server Address az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.3 - Create Jump Server NIC az network nic create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --vnet-name ${ARO_VNET_NAME} --subnet ${ARO_SUBNET_DMZ_NAME} --public-ip-address ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --network-security-group ${ARO_SUBNET_DMZ_NSG_NAME} 17.4 - Verify Jump Server NIC az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table 17.5 - Create Jump Server AS az vm availability-set create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as 17.6 - Verify Jump Server AS az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table 17.7 - Accept Jump Server Image URN az vm image terms accept --urn ${ARO_VM_JUMP_IMAGE_URN} 17.8 - Verify Jump Server Image URN az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table 17.9 - Create Jump Server VM az vm create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --location ${ARO_LOCATION_NAME} --availability-set ${ARO_VM_JUMP_NAME}-as --nics ${ARO_VM_JUMP_NAME}-nic --image ${ARO_VM_JUMP_IMAGE_URN} --admin-username ${ARO_VM_JUMP_ADMIN_NAME} --size ${ARO_VM_JUMP_SIZE} --generate-ssh-keys 17.10 - Verify Jump Server VM az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.11 - Login to Jump Server VM export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\" 18 - VPN Gateway env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V 18.1 - Create VPN Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --address-prefixes ${ARO_SUBNET_VGW_CIDR} 18.2 - Verify VPN Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table 18.3 - Create VPN Address az network public-ip create --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"${VPN_IP_SKU}\" --allocation-method \"${VPN_IP_ALLOCATION_METHOD}\" ${VPN_IP_ZONE} 18.4 - Verify VPN Address az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 18.5 - Create VPN Gateway az network vnet-gateway create --name ${ARO_VGW_NAME} --location ${ARO_LOCATION_NAME} --public-ip-address ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet ${ARO_VNET_NAME} --gateway-type VPN --sku ${ARO_VGW_SKU} --vpn-type ${ARO_VGW_TYPE} --address-prefixes ${ARO_SUBNET_VGW_POOL_CIDR} 18.6 - Verify VPN Gateway az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 19 - VPN Gateway PKI env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V 19.1 - Create Root Key openssl genrsa -aes256 -out ${ARO_VGW_PKI_ROOT_KEY_FILE} -passout env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 19.2 - Verify Root Key openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 19.3 - Create Root Certificate openssl req -x509 -sha256 -new -key \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -out \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -days 3650 -subj /CN=\"${ARO_VGW_NAME}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 # 10 years 19.4 - Verify Root Certificate openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 19.5 - Verify Root Moduli echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum 19.6 - Create Root Data az network vnet-gateway root-cert create --gateway-name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --name \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" --public-cert-data \"$(openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -outform der | base64 -w0)\" 19.7 - Verify Root Data AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi 20 - Client Certificates 20.1 - Set VPN Client Environment Variables export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' 20.2 - Verify VPN Client Environment Variables ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE 20.3 - Create VPN Client Key openssl genrsa -aes256 -out \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passout env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 20.4 - Verify VPN Client Key openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 20.5 - Create Client Certificate Request openssl req -new -out \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -key \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -subj /CN=\"${ARO_VGW_PKI_CLIENT_NAME}\" 2>&1 20.6 - Verify Client Certificate Request openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 20.7 - Create Client Certificate Extensions echo \"authorityKeyIdentifier=keyid,issuer\" > \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"basicConstraints=CA:FALSE\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"extendedKeyUsage=clientAuth\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"subjectAltName=DNS:${ARO_VGW_PKI_CLIENT_NAME}\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.8 - Verify Client Certificate Extensions grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.9 - Create Client Certificate openssl x509 -req -sha256 -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -CAkey \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -CA \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE -days 1095 -CAcreateserial -CAserial \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 2>&1 20.10 - Verify Client Certificate openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 20.11 - Verify Client Moduli echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum 20.12 - Create VPN Client PFX openssl pkcs12 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -inkey \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -passout pass: -certfile \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -export 2>&1 20.13 - Verify VPN Client PFX openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1 21 - VPN Client env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V 21.1 - Verify VPN Client URL export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" 21.2 - Download VPN Client eval wget \"${ARO_VGW_CONFIGURATION_URL}\" -O \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 2>&1 21.3 - Distribute VPN Client & PFX 22 - Obtain Pull Secrets 22.1 - Obtain Red Hat Pull Secret 22.2 - Verify Red Hat Pull Secret ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" 23 - Azure Red Hat OpenShift env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V 23.1 - Create ARO Cluster az aro create --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --name \"${ARO_CLUSTER_NAME}\" --master-subnet \"${ARO_SUBNET_MASTER_NAME}\" --master-vm-size \"${ARO_CLUSTER_VM_MASTER_SIZE}\" --worker-subnet \"${ARO_SUBNET_WORKER_NAME}\" --worker-count ${ARO_CLUSTER_VM_WORKER_COUNT} --worker-vm-size \"${ARO_CLUSTER_VM_WORKER_SIZE}\" --worker-vm-disk-size-gb ${ARO_CLUSTER_VM_WORKER_DISK_GB} --apiserver-visibility \"${ARO_CLUSTER_VISIBILITY_INGRESS}\" --ingress-visibility \"${ARO_CLUSTER_VISIBILITY_API}\" --pod-cidr \"${ARO_SUBNET_POD_CIDR}\" --service-cidr \"${ARO_SUBNET_SERVICE_CIDR}\" --vnet \"${ARO_VNET_NAME}\" --pull-secret @\"${ARO_REDHAT_PULL_SECRET_FILE}\" 23.2 - Verify ARO Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" 24 - OpenShift CLI 24.1 - Install OpenShift CLI wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -O /tmp/openshift-client-linux.tar.gz 2>&1 cd /tmp tar zxvf openshift-client-linux.tar.gz mv -f oc /usr/local/bin mv -f kubectl /usr/local/in 24.2 - Verify OpenShift CLI oc version kubectl version 25 - OpenShift Authentication","title":"Preview tldr"},{"location":"preview-tldr/#azure-red-hat-openshift-for-ibm-product-master","text":"","title":"Azure Red Hat OpenShift for IBM Product Master"},{"location":"preview-tldr/#draft","text":"This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 10:58:30 PM EDT","title":"[DRAFT]"},{"location":"preview-tldr/#too-long-didnt-read","text":"This is a representation of only the commands from the index, using the example environment configuration file from section 4.2. All descriptions, references, and example outputs have been removed.","title":"Too Long; Didn't Read"},{"location":"preview-tldr/#1-azure-tenant","text":"1.1 - Create Microsoft Account 1.2 - Create Global Administrator 1.3 - Verify Admin Center Access 1.4 - Verify AAD License","title":"1 - Azure Tenant"},{"location":"preview-tldr/#2-azure-subscription","text":"2.1 - Create Azure Subscription","title":"2 - Azure Subscription"},{"location":"preview-tldr/#3-operating-system","text":"3.1 - Verify Operating System uname -a 3.2 - Verify GNU bash bash --version 3.3 - Verify GNU awk awk --version 3.4 - Verify GNU coreutils base64 --version basename --version dirname --version sort --version head --version tail --version 3.5 - Verify GNU grep egrep --version 3.6 - Verify GNU wget wget --version 3.7 - Verify Browser firefox --version google-chrome --version 3.8 - Verify OpenSSL openssl version","title":"3 - Operating System"},{"location":"preview-tldr/#4-environment-variables","text":"4.1 - Unset Environment Variables for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done 4.2 - Set Environment Variables cat << 'EOF' > \"ipm.env\" # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done' EOF cat \"ipm.env\" && source \"ipm.env\" 4.3 - Verify Environment Variables env | grep ^ARO | sort -V","title":"4 - Environment Variables"},{"location":"preview-tldr/#5-required-directories","text":"env | egrep \"ARO.*DIR\" | sort -V 5.1 - Create Required Directories mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\"","title":"5 - Required Directories"},{"location":"preview-tldr/#6-azure-cli","text":"which az 6.1 - Install Azure CLI az --version 6.2 - Subscription Owner Login az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv 6.3 - Verify Azure Tenant az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi 6.4 - Set Default Subscription az account set -s \"${ARO_SUBSCRIPTION_NAME}\" 6.5 - Verify Default Subscription az account list --query '[?isDefault == `true`]'","title":"6 - Azure CLI"},{"location":"preview-tldr/#7-subscription-owners","text":"7.1 - Create Subscription Owners for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done 7.2 - Verify Subscription Owners az role assignment list --role Owner --output table","title":"7 - Subscription Owners"},{"location":"preview-tldr/#8-subscription-details","text":"env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" 8.1 - Verify Subscription Name az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi 8.2 - Verify Subscription ID az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi 8.3 - Verify Subscription Location az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi 8.4 - Verify Subscription Limits if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi 8.5 - Verify Subscription Quotas for ARO_VERIFY_QUOTA_NAME in \"${ARO_VERIFY_QUOTA_NAMES[@]}\"; do echo \"ARO_VERIFY_QUOTA_NAME=${ARO_VERIFY_QUOTA_NAME}\"; done; unset ARO_VERIFY_QUOTA_NAMES 8.6 - Standard DSv3 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 8.7 - Standard Dv2 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi","title":"8 - Subscription Details"},{"location":"preview-tldr/#9-openshift-administrators","text":"env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" 9.1 - Create Administrators az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login 9.2 - Verify Administrators for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done 9.3 - Create Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done 9.4 - Verify Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done","title":"9 - OpenShift Administrators"},{"location":"preview-tldr/#10-resource-providers","text":"echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" 10.1 - Register Provider Microsoft.Compute az provider register -n Microsoft.Compute --wait 10.2 - Verify Provider Microsoft.Compute az provider show --namespace Microsoft.Compute --output table 10.3 - Register Provider Microsoft.RedHatOpenShift az provider register -n Microsoft.RedHatOpenShift --wait 10.4 - Verify Provider Microsoft.RedHatOpenShift az provider show --namespace Microsoft.RedHatOpenShift --output table 10.5 - Register Provider Microsoft.Storage az provider register -n Microsoft.Storage --wait 10.6 - Verify Provider Microsoft.Storage az provider show --namespace Microsoft.Storage --output table","title":"10 - Resource Providers"},{"location":"preview-tldr/#11-resource-group","text":"env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' 11.1 - Create Resource Group az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} 11.2 - Verify Resource Group az group show --name ${ARO_RESOURCE_GROUP_NAME}","title":"11 - Resource Group"},{"location":"preview-tldr/#12-virtual-network","text":"env | grep ^ARO_VNET | sort -V 12.1 - Create Virtual Network az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_CIDR} ${ARO_SUBNET_SERVICE_CIDR} ${ARO_SUBNET_POD_CIDR} 12.2 - Verify Virtual Network az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME}","title":"12 - Virtual Network"},{"location":"preview-tldr/#13-openshift-subnets","text":"env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V 13.1 - Verify OpenShift Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --output table 2> /dev/null; if [ $? -eq 0 ]; then echo \"ERROR! ARO cluster ${ARO_CLUSTER_NAME} exists; do not recreate the master or worker subnets\"; fi 13.2 - Create Master Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --address-prefixes ${ARO_SUBNET_MASTER_CIDR} --service-endpoints Microsoft.ContainerRegistry 13.3 - Disable Master Subnet Private Link Service az network vnet subnet update --name ${ARO_SUBNET_MASTER_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --disable-private-link-service-network-policies true 13.4 - Verify Master Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table 13.5 - Create Worker Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --address-prefixes ${ARO_SUBNET_WORKER_CIDR} --service-endpoints Microsoft.ContainerRegistry 13.6 - Verify Worker Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table","title":"13 - OpenShift Subnets"},{"location":"preview-tldr/#14-network-security-groups","text":"env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V 14.1 - Create Network Security Groups az network nsg create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} 14.2 - Verify Network Security Groups az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo","title":"14 - Network Security Groups"},{"location":"preview-tldr/#15-network-security-group-rules","text":"env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V 15.1 - Create DMZ NSG Rule (AllowSSH) az network nsg rule create --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow 15.2 - Verify DMZ NSG Rules az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table","title":"15 - Network Security Group Rules"},{"location":"preview-tldr/#16-related-subnets","text":"env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V 16.1 - Create Application Gateway Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --address-prefixes ${ARO_SUBNET_AGW_CIDR} --network-security-group=${ARO_SUBNET_AGW_NSG_NAME} 16.2 - Verify Application Gateway Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table 16.3 - Create Database Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --address-prefixes ${ARO_SUBNET_DB_CIDR} --network-security-group=${ARO_SUBNET_DB_NSG_NAME} 16.4 - Verify Database Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table 16.5 - Create DMZ Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --address-prefixes ${ARO_SUBNET_DMZ_CIDR} --network-security-group=${ARO_SUBNET_DMZ_NSG_NAME} 16.6 - Verify DMZ Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table 16.7 - Create Trusted Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --address-prefixes ${ARO_SUBNET_TRUSTED_CIDR} --network-security-group ${ARO_SUBNET_TRUSTED_NSG_NAME} 16.8 - Verify Trusted Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table","title":"16 - Related Subnets"},{"location":"preview-tldr/#17-jump-server-vm","text":"env | egrep ARO.*JUMP | sort -V 17.1 - Create Jump Server Address az network public-ip create --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"Basic\" --allocation-method \"Dynamic\" 17.2 - Verify Jump Server Address az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.3 - Create Jump Server NIC az network nic create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --vnet-name ${ARO_VNET_NAME} --subnet ${ARO_SUBNET_DMZ_NAME} --public-ip-address ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --network-security-group ${ARO_SUBNET_DMZ_NSG_NAME} 17.4 - Verify Jump Server NIC az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table 17.5 - Create Jump Server AS az vm availability-set create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as 17.6 - Verify Jump Server AS az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table 17.7 - Accept Jump Server Image URN az vm image terms accept --urn ${ARO_VM_JUMP_IMAGE_URN} 17.8 - Verify Jump Server Image URN az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table 17.9 - Create Jump Server VM az vm create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --location ${ARO_LOCATION_NAME} --availability-set ${ARO_VM_JUMP_NAME}-as --nics ${ARO_VM_JUMP_NAME}-nic --image ${ARO_VM_JUMP_IMAGE_URN} --admin-username ${ARO_VM_JUMP_ADMIN_NAME} --size ${ARO_VM_JUMP_SIZE} --generate-ssh-keys 17.10 - Verify Jump Server VM az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.11 - Login to Jump Server VM export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\"","title":"17 - Jump Server VM"},{"location":"preview-tldr/#18-vpn-gateway","text":"env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V 18.1 - Create VPN Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --address-prefixes ${ARO_SUBNET_VGW_CIDR} 18.2 - Verify VPN Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table 18.3 - Create VPN Address az network public-ip create --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"${VPN_IP_SKU}\" --allocation-method \"${VPN_IP_ALLOCATION_METHOD}\" ${VPN_IP_ZONE} 18.4 - Verify VPN Address az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 18.5 - Create VPN Gateway az network vnet-gateway create --name ${ARO_VGW_NAME} --location ${ARO_LOCATION_NAME} --public-ip-address ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet ${ARO_VNET_NAME} --gateway-type VPN --sku ${ARO_VGW_SKU} --vpn-type ${ARO_VGW_TYPE} --address-prefixes ${ARO_SUBNET_VGW_POOL_CIDR} 18.6 - Verify VPN Gateway az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table","title":"18 - VPN Gateway"},{"location":"preview-tldr/#19-vpn-gateway-pki","text":"env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V 19.1 - Create Root Key openssl genrsa -aes256 -out ${ARO_VGW_PKI_ROOT_KEY_FILE} -passout env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 19.2 - Verify Root Key openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 19.3 - Create Root Certificate openssl req -x509 -sha256 -new -key \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -out \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -days 3650 -subj /CN=\"${ARO_VGW_NAME}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 # 10 years 19.4 - Verify Root Certificate openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 19.5 - Verify Root Moduli echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum 19.6 - Create Root Data az network vnet-gateway root-cert create --gateway-name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --name \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" --public-cert-data \"$(openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -outform der | base64 -w0)\" 19.7 - Verify Root Data AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi","title":"19 - VPN Gateway PKI"},{"location":"preview-tldr/#20-client-certificates","text":"20.1 - Set VPN Client Environment Variables export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' 20.2 - Verify VPN Client Environment Variables ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE 20.3 - Create VPN Client Key openssl genrsa -aes256 -out \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passout env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 20.4 - Verify VPN Client Key openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 20.5 - Create Client Certificate Request openssl req -new -out \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -key \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -subj /CN=\"${ARO_VGW_PKI_CLIENT_NAME}\" 2>&1 20.6 - Verify Client Certificate Request openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 20.7 - Create Client Certificate Extensions echo \"authorityKeyIdentifier=keyid,issuer\" > \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"basicConstraints=CA:FALSE\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"extendedKeyUsage=clientAuth\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"subjectAltName=DNS:${ARO_VGW_PKI_CLIENT_NAME}\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.8 - Verify Client Certificate Extensions grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.9 - Create Client Certificate openssl x509 -req -sha256 -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -CAkey \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -CA \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE -days 1095 -CAcreateserial -CAserial \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 2>&1 20.10 - Verify Client Certificate openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 20.11 - Verify Client Moduli echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum 20.12 - Create VPN Client PFX openssl pkcs12 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -inkey \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -passout pass: -certfile \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -export 2>&1 20.13 - Verify VPN Client PFX openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1","title":"20 - Client Certificates"},{"location":"preview-tldr/#21-vpn-client","text":"env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V 21.1 - Verify VPN Client URL export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" 21.2 - Download VPN Client eval wget \"${ARO_VGW_CONFIGURATION_URL}\" -O \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 2>&1 21.3 - Distribute VPN Client & PFX","title":"21 - VPN Client"},{"location":"preview-tldr/#22-obtain-pull-secrets","text":"22.1 - Obtain Red Hat Pull Secret 22.2 - Verify Red Hat Pull Secret ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\"","title":"22 - Obtain Pull Secrets"},{"location":"preview-tldr/#23-azure-red-hat-openshift","text":"env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V 23.1 - Create ARO Cluster az aro create --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --name \"${ARO_CLUSTER_NAME}\" --master-subnet \"${ARO_SUBNET_MASTER_NAME}\" --master-vm-size \"${ARO_CLUSTER_VM_MASTER_SIZE}\" --worker-subnet \"${ARO_SUBNET_WORKER_NAME}\" --worker-count ${ARO_CLUSTER_VM_WORKER_COUNT} --worker-vm-size \"${ARO_CLUSTER_VM_WORKER_SIZE}\" --worker-vm-disk-size-gb ${ARO_CLUSTER_VM_WORKER_DISK_GB} --apiserver-visibility \"${ARO_CLUSTER_VISIBILITY_INGRESS}\" --ingress-visibility \"${ARO_CLUSTER_VISIBILITY_API}\" --pod-cidr \"${ARO_SUBNET_POD_CIDR}\" --service-cidr \"${ARO_SUBNET_SERVICE_CIDR}\" --vnet \"${ARO_VNET_NAME}\" --pull-secret @\"${ARO_REDHAT_PULL_SECRET_FILE}\" 23.2 - Verify ARO Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\"","title":"23 - Azure Red Hat OpenShift"},{"location":"preview-tldr/#24-openshift-cli","text":"24.1 - Install OpenShift CLI wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -O /tmp/openshift-client-linux.tar.gz 2>&1 cd /tmp tar zxvf openshift-client-linux.tar.gz mv -f oc /usr/local/bin mv -f kubectl /usr/local/in 24.2 - Verify OpenShift CLI oc version kubectl version","title":"24 - OpenShift CLI"},{"location":"preview-tldr/#25-openshift-authentication","text":"","title":"25 - OpenShift Authentication"},{"location":"preview/","text":"Azure Red Hat OpenShift for IBM Product Master [DRAFT] This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 10:58:31 PM EDT Introduction This document details the steps required to automate the build of a secure, private Azure Red Hat OpenShift v4.x (ARO) infrastructure for IBM Product Master v12.x. The procedure to install IBM Product Master is an accompanying document. Azure Microsoft Azure is a comprehensive cloud computing service managed by Microsoft. It provides software as a service (SaaS), platform as a service (PaaS), and infrastructure as a service (IaaS). OpenShift Container Platform Red Hat's OpenShift Container Platform (OCP) is a hybrid cloud, enterprise Kubernetes application platform. It is a platform as a service (Paas) built on Red Hat Enterprise Linux (RHEL), with Docker containers managed by Kubernetes. Azure Red Hat OpenShift Azure Red Hat OpenShift (ARO) is a fully managed offering of Red Hat OpenShift running in Microsoft Azure. This service is jointly managed and supported by both Microsoft and Red Hat. For more details, see the Azure Red Hat OpenShift Service documentation. IBM Product Master IBM Product Master (IPM) provides trusted Product Information Management (PIM) and collaborative Master Data Management (MDM) capabilities. It creates an accurate and up-to-date repository of product and service information that can be used throughout organizations for strategic business initiatives Reference(s): https://www.openshift.com/blog/introducing-azure-red-hat-openshift-on-openshift-4 https://docs.openshift.com/aro/4/architecture/architecture.html https://azure.microsoft.com/ https://www.openshift.com/ https://www.docker.com/ https://kubernetes.io/ https://docs.microsoft.com/en-us/azure/openshift/openshift-faq https://docs.microsoft.com/en-us/azure/openshift/support-lifecycle https://www.ibm.com/products/product-master Usage This document provides a step-by-step approach. Each step is dependent upon the successful completion of previous steps. The steps are structured and all follow this same pattern. Description Many steps will have a detailed description that will provide additional context. In the interest of brevity, not all steps will have detailed descriptions. Reference(s) Most steps will have relevant, linked references. All references given are to supporting documentation. Command(s) These are the bash commands that must be run. The expectation is that they will be copy/paste. For that reason, the majority of commands rely on pre-set environment variables. The environment variables provide for portability, flexibility, and a consistent experience. If there are problems running any commands then it's most likely the environment variables are incorrect. Example Output When there is output from a command, the example output will be given. Please compare the outputs to ensure consistency. It may be helpful. 1 - Azure Tenant A tenant is Microsoft's representation of an organization. It is a dedicated instance of Azure Active Directory (AAD) that is received when creating a new relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before Azure Red Hat OpenShift (ARO) can be installed, Microsoft accounts must exist and have appropriate access to an AAD tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. Note If you are the Global Administrator of an existing tenant, go to step 2. Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant 1.1 - Create Microsoft Account Reference(s): https://support.microsoft.com/en-us/help/4558219/microsoft-account-what-is https://en.wikipedia.org/wiki/Microsoft_account 1.2 - Create Global Administrator The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Add and manage domains Assign the Global Administrator role to other users Reset passwords for all users Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide 1.3 - Verify Admin Center Access The Microsoft 365 admin center simplifies management of Microsoft 365 services. The admin center provides a tailored experience based on the the role of the logged in user. It is the common entry point for all Microsoft administrators. https://admin.microsoft.com/ Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide 1.4 - Verify AAD License The Azure Active Directory license can be verified by visiting the Directory Overview section on the Azure Portal. https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis 2 - Azure Subscription An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required during the installation of ARO. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators. Reference(s): https://docs.microsoft.com/en-us/microsoft-365/enterprise/subscriptions-licenses-accounts-and-tenants-for-microsoft-cloud-offerings?view=o365-worldwide 2.1 - Create Azure Subscription An Azure subscription may be purchased directly from Microsoft through the Azure website, through a Microsoft representative, or as part of a managed service from a Microsoft Partner. The Microsoft account that purchases the Azure subscription will automtically be assigned the Owner role. Additional Owners may be added later. To learn more about the Azure purchase options, visit this link. https://azure.microsoft.com/en-us/pricing/purchase-options/ Reference(s): https://azure.microsoft.com/ 3 - Operating System The ARO build procedures in this document depend upon a GNU/Linux Operating System (OS) and related tools. Special care has been taken to ensure the commands given will work on any GNU/Linux distribution. As of this writing, they have been successfully tested on Fedora 31+, Debian 9+, and Ubuntu 18+. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+ GNU bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep GNU wget Google Chrome or Firefox OpenSSL Reference(s): https://www.gnu.org/gnu/linux-and-gnu 3.1 - Verify Operating System The purpose of this step is to verify the Operating System is GNU/Linux and the dependent tools used in this document are installed. Reference(s): https://man7.org/linux/man-pages/man2/uname.2.html https://en.wikipedia.org/wiki/Uname Command(s): uname -a Example Output: Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux 3.2 - Verify GNU bash Reference(s): https://www.man7.org/linux/man-pages/man1/bash.1.html https://en.wikipedia.org/wiki/Bash_(Unix_shell) https://www.gnu.org/software/bash/ Command(s): bash --version Example Output: GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. 3.3 - Verify GNU awk Reference(s): https://man7.org/linux/man-pages/man1/awk.1p.html https://en.wikipedia.org/wiki/AWK https://www.gnu.org/software/gawk/ Command(s): awk --version Example Output: GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/. 3.4 - Verify GNU coreutils Reference(s): https://www.gnu.org/software/coreutils/ https://en.wikipedia.org/wiki/GNU_Core_Utilities Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering. 3.5 - Verify GNU grep Reference(s): https://man7.org/linux/man-pages/man1/grep.1.html https://en.wikipedia.org/wiki/Grep https://www.gnu.org/software/grep/ Command(s): egrep --version Example Output: grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. 3.6 - Verify GNU wget Reference(s): https://man7.org/linux/man-pages/man1/wget.1.html https://en.wikipedia.org/wiki/Wget https://www.gnu.org/software/wget/ Command(s): wget --version Example Output: GNU Wget 1.20.3 built on linux-gnu. -cares +digest +gpgme +https +ipv6 +iri +large-file +metalink +nls +ntlm +opie +psl +ssl/gnutls Wgetrc: /etc/wgetrc (system) Locale: /usr/share/locale Compile: gcc -DHAVE_CONFIG_H -DSYSTEM_WGETRC=\"/etc/wgetrc\" -DLOCALEDIR=\"/usr/share/locale\" -I. -I../lib -I../lib -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection Link: gcc -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lmetalink -lpcre2-8 -luuid -lidn2 -lnettle -lgnutls -lz -lpsl -L/usr/lib64 -lgpgme ftp-opie.o gnutls.o http-ntlm.o ../lib/libgnu.a Copyright (C) 2015 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://www.gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Originally written by Hrvoje Niksic <hniksic@xemacs.org>. Please send bug reports and questions to <bug-wget@gnu.org>. 3.7 - Verify Browser Either Google Chrome or Firefox is needed for a few steps. Other browsers will probably work, too, though haven't been tested. Reference(s): https://www.mozilla.org/ https://www.google.com/chrome/ Command(s): firefox --version google-chrome --version Example Output: Mozilla Firefox 80.0 Google Chrome 85.0.4183.83 3.8 - Verify OpenSSL Reference(s): https://www.openssl.org/ Command(s): openssl version Example Output: OpenSSL 1.1.1g FIPS 21 Apr 2020 4 - Environment Variables Important This document depends heavily on the bash shell. There are required bash environment variables that are necessary to execute most steps in this document. The environment variables must be exported prior to running the Command(s). Warning Subsequent steps in this document will not work unless the bash shell environment is properly setup. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html 4.1 - Unset Environment Variables Note Unsetting the ARO environment variables can help prevent issues when, or if they have changed in the configuration file. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done Example Output: unset ARO unset ARO_ADMINISTRATORS_GROUP_NAME unset ARO_APPLICATION_NAME unset ARO_CLUSTER_DOMAIN_NAME unset ARO_CLUSTER_NAME unset ARO_CLUSTER_VISIBILITY_API unset ARO_CLUSTER_VISIBILITY_INGRESS unset ARO_CLUSTER_VM_MASTER_SIZE unset ARO_CLUSTER_VM_WORKER_COUNT unset ARO_CLUSTER_VM_WORKER_DISK_GB unset ARO_CLUSTER_VM_WORKER_SIZE unset ARO_DOMAIN_NAME unset ARO_LOCATION_NAME unset ARO_REDHAT_PULL_SECRET_DIR unset ARO_REDHAT_PULL_SECRET_FILE unset ARO_RESOURCE_GROUP_NAME unset ARO_SERVICE_PRINCIPAL_NAME unset ARO_SERVICE_PRINCIPAL_PASSWORD unset ARO_SUBNET_AGW_CIDR unset ARO_SUBNET_AGW_NAME unset ARO_SUBNET_AGW_NSG_NAME unset ARO_SUBNET_DB_CIDR unset ARO_SUBNET_DB_NAME unset ARO_SUBNET_DB_NSG_NAME unset ARO_SUBNET_DMZ_CIDR unset ARO_SUBNET_DMZ_NAME unset ARO_SUBNET_DMZ_NSG_NAME unset ARO_SUBNET_MASTER_CIDR unset ARO_SUBNET_MASTER_NAME unset ARO_SUBNET_MASTER_NSG_NAME unset ARO_SUBNET_POD_CIDR unset ARO_SUBNET_SERVICE_CIDR unset ARO_SUBNET_TRUSTED_CIDR unset ARO_SUBNET_TRUSTED_NAME unset ARO_SUBNET_TRUSTED_NSG_NAME unset ARO_SUBNET_VGW_CIDR unset ARO_SUBNET_VGW_NAME unset ARO_SUBNET_VGW_POOL_CIDR unset ARO_SUBNET_VGW_POOL_NAME unset ARO_SUBNET_VGW_POOL_NSG_NAME unset ARO_SUBNET_WORKER_CIDR unset ARO_SUBNET_WORKER_NAME unset ARO_SUBNET_WORKER_NSG_NAME unset ARO_SUBSCRIPTION_ID unset ARO_SUBSCRIPTION_NAME unset ARO_TENANT_ID unset ARO_TENANT_NAME unset ARO_VGW_NAME unset ARO_VGW_PKI_BITS unset ARO_VGW_PKI_CLIENT unset ARO_VGW_PKI_CLIENT_CRT_FILE unset ARO_VGW_PKI_CLIENT_EXT_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_CLIENT_NAME unset ARO_VGW_PKI_CLIENT_PFX_FILE unset ARO_VGW_PKI_CLIENT_REQ_FILE unset ARO_VGW_PKI_CLIENT_SERIAL_FILE unset ARO_VGW_PKI_DIR unset ARO_VGW_PKI_ROOT_CA_SERIAL_FILE unset ARO_VGW_PKI_ROOT_CRT_FILE unset ARO_VGW_PKI_ROOT_CRT_NAME unset ARO_VGW_PKI_ROOT_KEY_FILE unset ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_ROOT_KEY_NAME unset ARO_VGW_PUBLIC_ADDRESS_NAME unset ARO_VGW_REDUNDANCY unset ARO_VGW_SKU unset ARO_VGW_TYPE unset ARO_VM_JUMP_ADMIN_NAME unset ARO_VM_JUMP_IMAGE_MARKETPLACE unset ARO_VM_JUMP_IMAGE_URN unset ARO_VM_JUMP_NAME unset ARO_VM_JUMP_PUBLIC_ADDRESS_NAME unset ARO_VM_JUMP_SIZE unset ARO_VNET_CIDR unset ARO_VNET_NAME 4.2 - Set Environment Variables The following bash shell environment variables are required. They are reused for multiple steps. It is recommended that the environment variables be maintained in a configuration file, i.e. ipm.env Maintaining a configuration file will make them easier to use and update. Important Before proceeding, please take your time ensuring the environment variable values are correct. These are example values that must be changed. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): cat \"ipm.env\" && source \"ipm.env\" Example Output: # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done' 4.3 - Verify Environment Variables Ensure the ARO variables are avaialble in the bash shell environment that you're working in. Reference(s): https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=ipm ARO_ADMINISTRATORS_GROUP_NAME=OpenShift Administrators ARO_APPLICATION_NAME=ipm-app ARO_CLUSTER_DOMAIN_NAME=ipm.mitaei.net ARO_CLUSTER_NAME=ipm-cluster ARO_CLUSTER_VISIBILITY_API=Private ARO_CLUSTER_VISIBILITY_INGRESS=Private ARO_CLUSTER_VM_MASTER_SIZE=Standard_D8s_v3 ARO_CLUSTER_VM_WORKER_COUNT=3 ARO_CLUSTER_VM_WORKER_DISK_GB=128 ARO_CLUSTER_VM_WORKER_SIZE=Standard_D8s_v3 ARO_DOMAIN_NAME=mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SERVICE_PRINCIPAL_NAME=http://ipm-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBNET_AGW_CIDR=10.10.11.0/24 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_CIDR=10.10.12.0/24 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_POD_CIDR=10.12.0.0/14 ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_CIDR=10.10.10.0/24 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 ARO_SUBNET_VGW_POOL_NAME=ipm-vnet-vpn-pool-subnet ARO_SUBNET_VGW_POOL_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_CIDR=10.10.0.0/16 ARO_VNET_NAME=ipm-vnet 5 - Required Directories This documentation provides commands that create files. To better organize the output files, the directories must exist or be created. Command(s): env | egrep \"ARO.*DIR\" | sort -V Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki 5.1 - Create Required Directories Reference(s): https://man7.org/linux/man-pages/man1/mkdir.1.html Command(s): mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: + success does not produce any output 5.2 - Verify Required Directories Reference(s): https://man7.org/linux/man-pages/man1/ls.1.html Command(s): ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: drwxrws---+ 2 jtingiris mit 24 Sep 26 22:34 /home/jtingiris/prj/mit/aei/pki drwxrws---+ 2 jtingiris mit 4096 Sep 26 11:51 /home/jtingiris/prj/mit/aei/secrets 6 - Azure CLI The Azure CLI is a Command Line Interface (CLI) used to create and manage Azure resources. The Azure CLI works with all Azure services. It is designed to more quickly work with Azure, with an emphasis on automation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest Command(s): which az Example Output: /usr/bin/az 6.1 - Install Azure CLI The Azure CLI is available to install on Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. Note To install the Azure CLI, please follow the link in the Reference(s) section. Reference(s): https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Command(s): az --version Example Output: azure-cli 2.12.0 core 2.12.0 telemetry 1.0.6 Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Your CLI is up-to-date. Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy 6.2 - Subscription Owner Login The Azure Subscription Owner must perform the remaining steps in this documentation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Command(s): az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net 6.3 - Verify Azure Tenant One way to verify the Azure Tenant is to obtain the Tenant ID with az. Another way is to login to the Azure AAD portal. The Tenant ID must match what is in the environment configuration file. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_show https://aad.portal.azure.com/ Command(s): az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi Example Output: [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ] 6.4 - Set Default Subscription Set the default subscription that the ARO resources will be installed in. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_set Command(s): az account set -s \"${ARO_SUBSCRIPTION_NAME}\" Example Output: + success does not produce any output 6.5 - Verify Default Subscription The Azure CLI Default Subscription will be used to provision all ARO resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Command(s): az account list --query '[?isDefault == `true`]' Example Output: [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ] 7 - Subscription Owners There should be at least two (2) Subscription Owners. This step is optional, but recommended. It will use the ${ARO_SUBSCRIPTION_OWNERS} environment value and ensure all User Principal Names (UPNs) are added as Subscription Owners. Reference(s): https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner 7.1 - Create Subscription Owners Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create Command(s): for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"name\": \"c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"principalId\": \"52f7dd5d-ad08-4b40-878f-40686c51c24e\", \"principalName\": \"christy.walsh@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"name\": \"0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } 7.2 - Verify Subscription Owners Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Principal Role Scope -------------------------- ------ --------------------------------------------------- christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 8 - Subscription Details Uze az to verify Azure Subscription details. The subscription may also be manually verified via the Azure Portal Subscription blade. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest Command(s): env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" Example Output: ARO_LOCATION_NAME=eastus ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_SUBSCRIPTION_OWNERS=christy.walsh@mitaei.net joseph.tingiris@mitaei.net ARO_VERIFY_QUOTA_NAMES=Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs 8.1 - Verify Subscription Name Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade Command(s): az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi Example Output: Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ] 8.2 - Verify Subscription ID Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show Command(s): az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi Example Output: [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ] 8.3 - Verify Subscription Location Note Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable location for the installation. The location name will be used throughout this document. Reference(s): https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Command(s): az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi Example Output: Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US 8.4 - Verify Subscription Limits An ARO cluster uses several Microsoft Azure components. It requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. The Azure subscription and service limits, quotas, and constraints may be insufficient to install ARO. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. It is wise to check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. ARO minimum limits are required for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html Command(s): if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi Example Output: + success does not produce any output 8.5 - Verify Subscription Quotas Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner must do this step. Important To increase the quota limits, a support case must be opened with Microsoft. They will communicate directly to the person who requested the increase. An increase in the VM series quotas will automatically increase the total regional vCPU limit by the same amount. Links to Microsoft's directions on how to request a quota increase are provided in the Reference(s) section. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Verify subscription quotas for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests Command(s): for ARO_VERIFY_QUOTA_NAME in \"${ARO_VERIFY_QUOTA_NAMES[@]}\"; do echo \"ARO_VERIFY_QUOTA_NAME=${ARO_VERIFY_QUOTA_NAME}\"; done; unset ARO_VERIFY_QUOTA_NAMES Example Output: ARO_VERIFY_QUOTA_NAME=Standard DSv3 Family vCPUs ARO_VERIFY_QUOTA_NAME=Standard Dv2 Family vCPUs 9 - OpenShift Administrators Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities. The details for how to use az to create users, groups, and add the necessary subscription roles is described below. Command(s): env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" Example Output: ARO_DOMAIN_NAME=mitaei.net ARO_ADMINISTRATORS=openshift-admin@mitaei.net arun.babu@mitaei.net joseph.tingiris@mitaei.net sivaprasad.k@mitaei.net 9.1 - Create Administrators This is a good time for the Global Administrator to create Microsoft accounts for the OpenShift Administrators. Ideally, the OpenShift Administrators would also have the Global Administrator role for the tenant. However, this is not always possible. If you are the Global Administrator then please take note that the OpenShift Administrators must have Microsoft accounts in the tenant , and their Microsoft accounts must have at least the Contributor and User Access Administrator roles for the Azure Subscription in which ARO is to be deployed. Creating users may be done with az , via the AAD portal, or [https://admin.microsoft.com]. Important The openshift-admin user created is an example and should not be used. We strongly recommend using real names and individual accounts, not ficticous names or group accounts. Command(s): az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login Example Output: { \"accountEnabled\": true, \"ageGroup\": null, \"assignedLicenses\": [], \"assignedPlans\": [], \"city\": null, \"companyName\": null, \"consentProvidedForMinor\": null, \"country\": null, \"createdDateTime\": null, \"creationType\": null, \"deletionTimestamp\": null, \"department\": null, \"dirSyncEnabled\": null, \"displayName\": \"openshift-admin@mitaei.net\", \"employeeId\": null, \"facsimileTelephoneNumber\": null, \"givenName\": null, \"immutableId\": null, \"isCompromised\": null, \"jobTitle\": null, \"lastDirSyncTime\": null, \"legalAgeGroupClassification\": null, \"mail\": null, \"mailNickname\": \"openshift-admin\", \"mobile\": null, \"objectId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"objectType\": \"User\", \"odata.metadata\": \"https://graph.windows.net/25fe96e7-85ec-4e6a-b93f-779b16ff751d/$metadata#directoryObjects/@Element\", \"odata.type\": \"Microsoft.DirectoryServices.User\", \"onPremisesDistinguishedName\": null, \"onPremisesSecurityIdentifier\": null, \"otherMails\": [], \"passwordPolicies\": null, \"passwordProfile\": { \"enforceChangePasswordPolicy\": false, \"forceChangePasswordNextLogin\": true, \"password\": null }, \"physicalDeliveryOfficeName\": null, \"postalCode\": null, \"preferredLanguage\": null, \"provisionedPlans\": [], \"provisioningErrors\": [], \"proxyAddresses\": [], \"refreshTokensValidFromDateTime\": \"2020-09-27T02:58:50.8444883Z\", \"showInAddressList\": null, \"signInNames\": [], \"sipProxyAddress\": null, \"state\": null, \"streetAddress\": null, \"surname\": null, \"telephoneNumber\": null, \"thumbnailPhoto@odata.mediaEditLink\": \"directoryObjects/95ccd40a-9c98-4d4f-9846-eaed016e3ef9/Microsoft.DirectoryServices.User/thumbnailPhoto\", \"usageLocation\": null, \"userIdentities\": [], \"userPrincipalName\": \"openshift-admin@mitaei.net\", \"userState\": null, \"userStateChangedOn\": null, \"userType\": \"Member\" } 9.2 - Verify Administrators Verify the OpenShift Administrator accounts listed in ${ARO_ADMINISTRATORS} exist. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done Example Output: [ { \"userPrincipalName\": \"openshift-admin@mitaei.net\" }, { \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\" } ] [ { \"userPrincipalName\": \"arun.babu@mitaei.net\" }, { \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\" } ] [ { \"userPrincipalName\": \"joseph.tingiris@mitaei.net\" }, { \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\" } ] [ { \"userPrincipalName\": \"sivaprasad.k@mitaei.net\" }, { \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\" } ] 9.3 - Create Administrator Roles The Contributor and User Access Administrator subscription roles are required to administer ARO. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/00c1ec40-d6b3-40b0-b784-41c9ab6250f5\", \"name\": \"00c1ec40-d6b3-40b0-b784-41c9ab6250f5\", \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/e25a7a15-d599-4cb7-8593-c34c6d31b448\", \"name\": \"e25a7a15-d599-4cb7-8593-c34c6d31b448\", \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/8f458612-ca5f-4ff2-832a-d00e700975b0\", \"name\": \"8f458612-ca5f-4ff2-832a-d00e700975b0\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/7f1ba7da-c858-489f-a988-39123faa181f\", \"name\": \"7f1ba7da-c858-489f-a988-39123faa181f\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/6f98e077-c161-453d-a903-b00acb9bd5f2\", \"name\": \"6f98e077-c161-453d-a903-b00acb9bd5f2\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"name\": \"91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/1bf7b433-935b-4160-a634-43bd291739c8\", \"name\": \"1bf7b433-935b-4160-a634-43bd291739c8\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"name\": \"13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } 9.4 - Verify Administrator Roles Verify all ${ARO_ADMINISTRATORS} have the Contributor and User Access Administrator subscription roles. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done Example Output: Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- openshift-admin@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 openshift-admin@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 10 - Resource Providers Make sure you are logged in to Azure via az az login and have the Contributor or Owner role. Warning These steps will fail with only the User Access Administrator role. An unauthorized message will be received. These steps will fail without the --wait flag. Dependent providers are automatically registered and they must be registered first. Reference(s): https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types Command(s): echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" Example Output: ARO_RESOURCE_PROVIDERS=Microsoft.Compute Microsoft.RedHatOpenShift Microsoft.Storage 10.1 - Register Provider Microsoft.Compute Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Compute --wait Example Output: + success does not produce any output 10.2 - Verify Provider Microsoft.Compute Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Compute --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered 10.3 - Register Provider Microsoft.RedHatOpenShift Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.RedHatOpenShift --wait Example Output: + success does not produce any output 10.4 - Verify Provider Microsoft.RedHatOpenShift Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.RedHatOpenShift --output table Example Output: Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered 10.5 - Register Provider Microsoft.Storage Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Storage --wait Example Output: + success does not produce any output 10.6 - Verify Provider Microsoft.Storage Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Storage --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered 11 - Resource Group An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest Command(s): env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' Example Output: ARO_LOCATION_NAME=eastus ARO_RESOURCE_GROUP_NAME=ipm-eastus 11.1 - Create Resource Group Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Command(s): az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } 11.2 - Verify Resource Group Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Command(s): az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } 12 - Virtual Network An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Command(s): env | grep ^ARO_VNET | sort -V Example Output: ARO_VNET_CIDR=10.10.0.0/16 ARO_VNET_NAME=ipm-vnet 12.1 - Create Virtual Network In addition to the VNet CIDR, to be able to route to the Service & POD CIDRs then include them as address prefixes too. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_CIDR} ${ARO_SUBNET_SERVICE_CIDR} ${ARO_SUBNET_POD_CIDR} Example Output: { \"newVNet\": { \"addressSpace\": { \"addressPrefixes\": [ \"10.10.0.0/16\", \"10.11.0.0/16\", \"10.12.0.0/14\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"3fe1740b-d54f-4543-bd34-eb70a25c3285\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"e6da571b-7213-4fa5-ad7b-9164be85e48a\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] } } 12.2 - Verify Virtual Network Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Command(s): az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: { \"addressSpace\": { \"addressPrefixes\": [ \"10.10.0.0/16\", \"10.11.0.0/16\", \"10.12.0.0/14\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"3fe1740b-d54f-4543-bd34-eb70a25c3285\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"e6da571b-7213-4fa5-ad7b-9164be85e48a\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] } 13 - OpenShift Subnets Before installing, Azure Red Hat OpenShift clusters require manually creating a virtual network with two empty subnets for the master and worker VMs. Additionally, the Pod & Service subnets will automatically assigned during the installation. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Important Pod and Service Network CIDRs are configurable. Workers and masters must be in different subnets. Workers and masters virtual network subnets should be minimum /27. Pod CIDR should be minimum /18 in size. The pod network is non-routable IPs, and is only used inside the OpenShift SDN. Each node is allocated /23 subnet (512 IPs) for its pods. This value cannot be changed. You cannot attach a pod to multiple networks. Note In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher_ ; Please see the references in this section for more details. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-create https://docs.microsoft.com/en-us/azure/openshift/concepts-networking https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://docs.openshift.com/aro/4/networking/understanding-networking.html https://tools.ietf.org/html/rfc1918 Command(s): env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V Example Output: ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg 13.1 - Verify OpenShift Cluster Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_show Command(s): az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --output table 2> /dev/null; if [ $? -eq 0 ]; then echo \"ERROR! ARO cluster ${ARO_CLUSTER_NAME} exists; do not recreate the master or worker subnets\"; fi Example Output: + success does not produce any output 13.2 - Create Master Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --address-prefixes ${ARO_SUBNET_MASTER_CIDR} --service-endpoints Microsoft.ContainerRegistry Example Output: { \"addressPrefix\": \"10.10.0.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"a4a4f3f3-7031-4349-a4db-918e078ca7ad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-master-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 13.3 - Disable Master Subnet Private Link Service This is required to be able to connect and manage the cluster. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_update https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet update --name ${ARO_SUBNET_MASTER_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --disable-private-link-service-network-policies true Example Output: { \"addressPrefix\": \"10.10.0.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"9611966b-4097-4d4f-bc93-b42cc963488a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-master-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Disabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 13.4 - Verify Master Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.0.0/23 ipm-vnet-master-subnet Enabled Disabled Succeeded ipm-eastus 13.5 - Create Worker Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --address-prefixes ${ARO_SUBNET_WORKER_CIDR} --service-endpoints Microsoft.ContainerRegistry Example Output: { \"addressPrefix\": \"10.10.2.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"5ab0e900-d3cf-4f86-a3d8-c447f29eb66c\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-worker-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 13.6 - Verify Worker Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.2.0/23 ipm-vnet-worker-subnet Enabled Enabled Succeeded ipm-eastus 14 - Network Security Groups An Azure Network Security Group (NSG) filters network traffic to and from Azure resources in an Azure virtual network. An NSG contains security rules that allow/deny network traffic to/from several types of Azure resources. Note The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Command(s): env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg 14.1 - Create Network Security Groups Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_create Command(s): az network nsg create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} Example Output: { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-agw-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"be4701a3-7c2d-492a-a689-adc40198cba7\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-db-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"a58d572b-dfba-4a3e-b95e-a7c131b01f62\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-dmz-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"ed09e48f-c160-4d63-ad0c-a6df53b6e9eb\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-trusted-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"b415518e-9aa4-447c-abbe-80ebea22c62b\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } 14.2 - Verify Network Security Groups Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_show Command(s): az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo Example Output: Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-agw-subnet-nsg Succeeded ipm-eastus be4701a3-7c2d-492a-a689-adc40198cba7 Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ---------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-db-subnet-nsg Succeeded ipm-eastus a58d572b-dfba-4a3e-b95e-a7c131b01f62 Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-dmz-subnet-nsg Succeeded ipm-eastus ed09e48f-c160-4d63-ad0c-a6df53b6e9eb Location Name ProvisioningState ResourceGroup ResourceGuid ---------- --------------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-trusted-subnet-nsg Succeeded ipm-eastus b415518e-9aa4-447c-abbe-80ebea22c62b 15 - Network Security Group Rules Network Security Group (NSG) Rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows an NSG to be stateful. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Command(s): env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg 15.1 - Create DMZ NSG Rule (AllowSSH) To be able to access the Jump Server (jumpbox) via the Internet, without a VPN setup, tcp port 22 must be opened for ssh. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_create Command(s): az network nsg rule create --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow Example Output: { \"access\": \"Allow\", \"description\": null, \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"22\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"fafcaf82-35be-48e1-9461-561a4b71e119\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/securityRules/AllowSSH\", \"name\": \"AllowSSH\", \"priority\": 1000, \"protocol\": \"Tcp\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/securityRules\" } 15.2 - Verify DMZ NSG Rules Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_show Command(s): az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table Example Output: Protocol SourcePortRange DestinationPortRange SourceAddressPrefix DestinationAddressPrefix Access Priority Direction ProvisioningState Name ResourceGroup ---------- ----------------- ---------------------- --------------------- -------------------------- -------- ---------- ----------- ------------------- -------- --------------- Tcp * 22 * * Allow 1000 Inbound Succeeded AllowSSH ipm-eastus 16 - Related Subnets IBM Product Manager requires related subnets for supplementary virtual machines, to host applications such as DB2. These subnets should be within the same resource group and VNet range previously defined. The network numbers should be IPv4 RFC1918 compliant and prefixed. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Command(s): env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_CIDR=10.10.11.0/24 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_CIDR=10.10.12.0/24 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_POD_CIDR=10.12.0.0/14 ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg 16.1 - Create Application Gateway Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --address-prefixes ${ARO_SUBNET_AGW_CIDR} --network-security-group=${ARO_SUBNET_AGW_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.11.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"e4ad09d4-d5f7-4a42-872f-8821dcd23248\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-agw-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-agw-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 16.2 - Verify Application Gateway Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.11.0/24 ipm-vnet-agw-subnet Enabled Enabled Succeeded ipm-eastus 16.3 - Create Database Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --address-prefixes ${ARO_SUBNET_DB_CIDR} --network-security-group=${ARO_SUBNET_DB_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.12.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"2aa8c48d-8c85-4eee-98ff-19d5a5f9e6dd\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-db-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-db-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 16.4 - Verify Database Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------ -------------------------------- ----------------------------------- ------------------- --------------- 10.10.12.0/24 ipm-vnet-db-subnet Enabled Enabled Succeeded ipm-eastus 16.5 - Create DMZ Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --address-prefixes ${ARO_SUBNET_DMZ_CIDR} --network-security-group=${ARO_SUBNET_DMZ_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.13.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"026bbc03-cf38-45c8-b813-6283fe479fcc\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-dmz-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-dmz-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 16.6 - Verify DMZ Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.13.0/24 ipm-vnet-dmz-subnet Enabled Enabled Succeeded ipm-eastus 16.7 - Create Trusted Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --address-prefixes ${ARO_SUBNET_TRUSTED_CIDR} --network-security-group ${ARO_SUBNET_TRUSTED_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.14.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"40b5794b-9c55-4230-8f97-84ccda8b94e1\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-trusted-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-trusted-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 16.8 - Verify Trusted Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.14.0/24 ipm-vnet-trusted-subnet Enabled Enabled Succeeded ipm-eastus 17 - Jump Server VM A jump server, jump host, or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example of a jump server is a host in a DMZ. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet. It will be allowed to communicate with the other internal subnets. The NSGs may be further tune to allow specific access, as it will be done for the ARO master subnet when ARO is installed. Note The jumpbox should be created prior to the VPN Gateway, so that there is at least one machine available for connectivity testing from two different security zones: Public (Internet) and Private (RFC1918). Reference(s): https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-cli-complete https://en.wikipedia.org/wiki/Jump_server https://en.wikipedia.org/wiki/DMZ Command(s): env | egrep ARO.*JUMP | sort -V Example Output: ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms 17.1 - Create Jump Server Address Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-create Command(s): az network public-ip create --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"Basic\" --allocation-method \"Dynamic\" Example Output: { \"publicIp\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"db3f0454-61e8-4b8d-840e-694b71e697a2\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"3ea50ce6-bb5b-41fe-94f6-9d95e8103cbe\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null } } 17.2 - Verify Jump Server Address Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"db3f0454-61e8-4b8d-840e-694b71e697a2\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"3ea50ce6-bb5b-41fe-94f6-9d95e8103cbe\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null } 17.3 - Create Jump Server NIC Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_create Command(s): az network nic create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --vnet-name ${ARO_VNET_NAME} --subnet ${ARO_SUBNET_DMZ_NAME} --public-ip-address ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --network-security-group ${ARO_SUBNET_DMZ_NSG_NAME} Example Output: { \"NewNIC\": { \"dnsSettings\": { \"appliedDnsServers\": [], \"dnsServers\": [], \"internalDnsNameLabel\": null, \"internalDomainNameSuffix\": \"dnl3vzqtoksu5ll1sfsl3bperc.bx.internal.cloudapp.net\", \"internalFqdn\": null }, \"dscpConfiguration\": null, \"enableAcceleratedNetworking\": false, \"enableIpForwarding\": false, \"etag\": \"W/\\\"f1db4270-6f99-494b-bae8-c4077bb8c482\\\"\", \"hostedWorkloads\": [], \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic\", \"ipConfigurations\": [ { \"applicationGatewayBackendAddressPools\": null, \"applicationSecurityGroups\": null, \"etag\": \"W/\\\"f1db4270-6f99-494b-bae8-c4077bb8c482\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic/ipConfigurations/ipconfig1\", \"loadBalancerBackendAddressPools\": null, \"loadBalancerInboundNatRules\": null, \"name\": \"ipconfig1\", \"primary\": true, \"privateIpAddress\": \"10.10.13.4\", \"privateIpAddressVersion\": \"IPv4\", \"privateIpAllocationMethod\": \"Dynamic\", \"privateLinkConnectionProperties\": null, \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": null, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": null, \"location\": null, \"name\": null, \"provisioningState\": null, \"publicIpAddressVersion\": null, \"publicIpAllocationMethod\": null, \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"sku\": null, \"tags\": null, \"type\": null, \"zones\": null }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"addressPrefix\": null, \"addressPrefixes\": null, \"delegations\": null, \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-dmz-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": null, \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": null, \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": null, \"provisioningState\": null, \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null }, \"type\": \"Microsoft.Network/networkInterfaces/ipConfigurations\", \"virtualNetworkTaps\": null } ], \"location\": \"eastus\", \"macAddress\": null, \"name\": \"ipm-vm-jumpbox-nic\", \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"primary\": null, \"privateEndpoint\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"16debdd3-c550-4941-8c5c-729ed79686e7\", \"tags\": null, \"tapConfigurations\": [], \"type\": \"Microsoft.Network/networkInterfaces\", \"virtualMachine\": null } } 17.4 - Verify Jump Server NIC A network interface enables an Azure Virtual Machine to communicate with internet, Azure, and on-premises resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_show https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface Command(s): az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table Example Output: EnableAcceleratedNetworking EnableIpForwarding Location Name ProvisioningState ResourceGroup ResourceGuid ----------------------------- -------------------- ---------- ------------------ ------------------- --------------- ------------------------------------ False False eastus ipm-vm-jumpbox-nic Succeeded ipm-eastus 16debdd3-c550-4941-8c5c-729ed79686e7 17.5 - Create Jump Server AS An Availability Set (AS) helps spread VMs across fault domains and update domains. It's best practice to use availability sets for VMs, to make it easier to expand in the future. Fault domains define a grouping of virtual machines that share a common power source and network switch. By default, the virtual machines that are configured within the availability set are separated across up to three fault domains. A hardware issue in one of these fault domains does not affect the VM. Update domains indicate groups of virtual machines and underlying physical hardware that can be rebooted at the same time. During planned maintenance, the order in which update domains are rebooted might not be sequential, but only one update domain is rebooted at a time. Azure automatically distributes VMs across the fault and update domains when placing them in an availability set. For more information, see managing the availability of VMs. Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create https://docs.microsoft.com/en-us/azure/virtual-machines/linux/manage-availability Command(s): az vm availability-set create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/availabilitySets/ipm-vm-jumpbox-as\", \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-as\", \"platformFaultDomainCount\": 2, \"platformUpdateDomainCount\": 5, \"proximityPlacementGroup\": null, \"resourceGroup\": \"ipm-eastus\", \"sku\": { \"capacity\": null, \"name\": \"Aligned\", \"tier\": null }, \"statuses\": null, \"tags\": {}, \"type\": \"Microsoft.Compute/availabilitySets\", \"virtualMachines\": [] } 17.6 - Verify Jump Server AS Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_show Command(s): az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table Example Output: Location Name PlatformFaultDomainCount PlatformUpdateDomainCount ResourceGroup ---------- ----------------- -------------------------- --------------------------- --------------- eastus ipm-vm-jumpbox-as 2 5 ipm-eastus 17.7 - Accept Jump Server Image URN Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_accept https://docs.microsoft.com/en-us/azure/virtual-machines/windows/cli-ps-findimage Command(s): az vm image terms accept --urn ${ARO_VM_JUMP_IMAGE_URN} Example Output: { \"accepted\": true, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.MarketplaceOrdering/offerTypes/Microsoft.MarketplaceOrdering/offertypes/publishers/cognosys/offers/docker-ce-with-centos-8-0-free/plans/docker-ce-with-centos-8-0-free/agreements/current\", \"licenseTextLink\": \"https://storelegalterms.blob.core.windows.net/legalterms/3E5ED_legalterms_COGNOSYS%253a24DOCKER%253a2DCE%253a2DWITH%253a2DCENTOS%253a2D8%253a2D0%253a2DFREE%253a24DOCKER%253a2DCE%253a2DWITH%253a2DCENTOS%253a2D8%253a2D0%253a2DFREE%253a24T622IBUBKL6J3MHL5NUAWG2XNZ5H5FVSJGLCOC54LB63AGIONYH5CDZVDEYDONEFK2NHKCZROAP7ZU5PLZHXJ5ZNBFEUCBOWWMC4DSY.txt\", \"name\": \"docker-ce-with-centos-8-0-free\", \"plan\": \"docker-ce-with-centos-8-0-free\", \"privacyPolicyLink\": \"http://www.cogno-sys.com/cognosys-technologies-partners/privacy-policy/\", \"product\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"retrieveDatetime\": \"2020-09-27T03:03:24.6212864Z\", \"signature\": \"7TK6WC7YUSEVPL5URUWHBHRILKUK5JO6RZ5WSTOPBEKJ6QQTKWXNX5F627R4U3FMPQQTPDJIXNOJZEPSFH324RLHXNMZ3MSEOCJ7ZII\", \"type\": \"Microsoft.MarketplaceOrdering/offertypes\" } 17.8 - Verify Jump Server Image URN Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_show https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cognosys.docker-ce-with-centos-8-0-free?tab=Overview Command(s): az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Example Output: Accepted Name Plan Product Publisher ---------- ------------------------------ ------------------------------ ------------------------------ ----------- True docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free cognosys 17.9 - Create Jump Server VM An Azure Virtual Machines (VM) is one of several types of on-demand, scalable computing resources that Azure offers. An Azure VM gives you the flexibility of virtualization without having to buy and maintain the physical hardware that runs it. However, you still need to maintain the VM by performing tasks, such as configuring, patching, and installing the software that runs on it. Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_create https://docs.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-manage-vm https://docs.microsoft.com/en-us/azure/virtual-machines/linux/ Command(s): az vm create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --location ${ARO_LOCATION_NAME} --availability-set ${ARO_VM_JUMP_NAME}-as --nics ${ARO_VM_JUMP_NAME}-nic --image ${ARO_VM_JUMP_IMAGE_URN} --admin-username ${ARO_VM_JUMP_ADMIN_NAME} --size ${ARO_VM_JUMP_SIZE} --generate-ssh-keys Example Output: { \"fqdns\": \"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/virtualMachines/ipm-vm-jumpbox\", \"location\": \"eastus\", \"macAddress\": \"00-0D-3A-9E-B0-AB\", \"powerState\": \"VM running\", \"privateIpAddress\": \"10.10.13.4\", \"publicIpAddress\": \"40.88.33.248\", \"resourceGroup\": \"ipm-eastus\", \"zones\": \"\" } 17.10 - Verify Jump Server VM Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Command(s): az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} Example Output: 40.88.33.248 { \"additionalCapabilities\": null, \"availabilitySet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/availabilitySets/IPM-VM-JUMPBOX-AS\", \"resourceGroup\": \"ipm-eastus\" }, \"billingProfile\": null, \"diagnosticsProfile\": null, \"evictionPolicy\": null, \"extensionsTimeBudget\": null, \"hardwareProfile\": { \"vmSize\": \"Standard_B1ms\" }, \"host\": null, \"hostGroup\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/virtualMachines/ipm-vm-jumpbox\", \"identity\": null, \"instanceView\": null, \"licenseType\": null, \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox\", \"networkProfile\": { \"networkInterfaces\": [ { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic\", \"primary\": true, \"resourceGroup\": \"ipm-eastus\" } ] }, \"osProfile\": { \"adminPassword\": null, \"adminUsername\": \"ipm-vm-jumpbox-admin\", \"allowExtensionOperations\": true, \"computerName\": \"ipm-vm-jumpbox\", \"customData\": null, \"linuxConfiguration\": { \"disablePasswordAuthentication\": true, \"patchSettings\": { \"patchMode\": \"ImageDefault\" }, \"provisionVmAgent\": true, \"ssh\": { \"publicKeys\": [ { \"keyData\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDec9G5K26hxFj+Ha0gQChwhSW4fT6mlZrb0066h+moGMJKMJ2YiHMaNMUULFT8SkJch4KYjQfqgJE8YnSGRHPzmUWwF/v7AwcozIlwralduUdYNIScDnzaFCBa55pLQwCWIN7zXFCdtEG935XwaV+A+tOgokiGvGXMAUj/Dz0A5ClIhbD/i3dr2AFKuuSwMGpFc1EqZDh72ZsYTcDaZT5hhPPUCUyTqOfEJuWQYeE3DAuA1EoI2tmBQWNl2S1jtdHa/69BBAmA6t0MZXuMKpk0udzQjw/d6b64hKYHDDlfxaTEBnt1Vbd8Rv5bxJSI1y2QgCutRZwVa/dt1X71fwpAq4yr0H8JCrabKrIumgqyZ6VQyCTVu3AXZ3E/yMQmJhLK2RvPHrHp8DedZ3su62zvU9aUACyd6b89R6S4eYOmIE+nNG/M/yqS2Ru3GPUalsQXE5/auCsg6rPetxMNoEbZz5qTfJUfq3Xx61WQuLrAsyvEiIiM5rrgA/FhYbthxKKacYr0b6oi6HQW6KQ3JnPMm/QF2UxDxoNOG+NHi2UBfgiXLEHZQ3YnkS4QkB9aCK4YJyOJ5I/34gAGcUIPQ8nkUSky7btjsQlHNB6pHPI+8Xd2SntRmfgBwJwOUS+LqjK4OCCpkqUTSopXQ8vL8L/e2gw+8QIdTYe47/P0IG5zVQ== jtingiris@jt\\n\", \"path\": \"/home/ipm-vm-jumpbox-admin/.ssh/authorized_keys\" } ] } }, \"requireGuestProvisionSignal\": true, \"secrets\": [], \"windowsConfiguration\": null }, \"plan\": { \"name\": \"docker-ce-with-centos-8-0-free\", \"product\": \"docker-ce-with-centos-8-0-free\", \"promotionCode\": null, \"publisher\": \"cognosys\" }, \"priority\": null, \"provisioningState\": \"Succeeded\", \"proximityPlacementGroup\": null, \"resourceGroup\": \"ipm-eastus\", \"resources\": null, \"securityProfile\": null, \"storageProfile\": { \"dataDisks\": [], \"imageReference\": { \"exactVersion\": \"1.2019.0710\", \"id\": null, \"offer\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"sku\": \"docker-ce-with-centos-8-0-free\", \"version\": \"1.2019.0710\" }, \"osDisk\": { \"caching\": \"ReadWrite\", \"createOption\": \"FromImage\", \"diffDiskSettings\": null, \"diskSizeGb\": 30, \"encryptionSettings\": null, \"image\": null, \"managedDisk\": { \"diskEncryptionSet\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/IPM-EASTUS/providers/Microsoft.Compute/disks/ipm-vm-jumpbox_OsDisk_1_30aa79f1b3f44738b4fffb0818c1f500\", \"resourceGroup\": \"IPM-EASTUS\", \"storageAccountType\": \"Premium_LRS\" }, \"name\": \"ipm-vm-jumpbox_OsDisk_1_30aa79f1b3f44738b4fffb0818c1f500\", \"osType\": \"Linux\", \"vhd\": null, \"writeAcceleratorEnabled\": null } }, \"tags\": {}, \"type\": \"Microsoft.Compute/virtualMachines\", \"virtualMachineScaleSet\": null, \"vmId\": \"c6af84ea-fe96-4e23-a3ff-11770109f080\", \"zones\": null } 17.11 - Login to Jump Server VM Reference(s): https://man7.org/linux/man-pages/man1/ssh.1.html Command(s): export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\" Example Output: 40.88.33.248 18 - VPN Gateway A Virtual Private Network (VPN) Gateway is needed to connect to a private ARO cluster. It is a specific type of gateway that is used to send encrypted traffic between an Azure VNet and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. Reference(s): https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://docs.microsoft.com/en-us/azure/vpn-gateway/create-routebased-vpn-gateway-cli Command(s): env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V Example Output: ARO_SUBNET_VGW_CIDR=10.10.10.0/24 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 ARO_SUBNET_VGW_POOL_NAME=ipm-vnet-vpn-pool-subnet ARO_SUBNET_VGW_POOL_NSG_NAME=GatewaySubnet-nsg ARO_VGW_NAME=ipm-vpn ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased 18.1 - Create VPN Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-create https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsub Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --address-prefixes ${ARO_SUBNET_VGW_CIDR} Example Output: { \"addressPrefix\": \"10.10.10.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"5719d87d-ccc4-4683-9638-12f7508a1950\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"GatewaySubnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" } 18.2 - Verify VPN Subnet Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.10.0/24 GatewaySubnet Enabled Enabled Succeeded ipm-eastus 18.3 - Create VPN Address The VPN Gateway requires a Public IP Address. Zone-redundant VPN gateways and zonal gateways both rely on the Azure public IP resource Standard SKU. The configuration of the Azure public IP resource determines whether the gateway that you deploy is zone-redundant, or zonal. If you create a public IP resource with a Basic SKU, the gateway will not have any zone redundancy, and the gateway resources will be regional. Note The public-ip --sku and --allocation-method may differ, depending on the needs of the VPN Gateway. Refer to the Reference(s) for details. A Redundant VPN Gateway is being created in this example. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-create https://docs.microsoft.com/en-us/azure/virtual-network/public-ip-addresses Command(s): az network public-ip create --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"${VPN_IP_SKU}\" --allocation-method \"${VPN_IP_ALLOCATION_METHOD}\" ${VPN_IP_ZONE} Example Output: { \"publicIp\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"c516d2ba-28fa-4259-a9fd-8e0220e9d7d9\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": \"20.55.32.58\", \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vpn-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Static\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"8a54cef2-c31d-4b8d-ae52-b1dbbf9d6802\", \"sku\": { \"name\": \"Standard\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": [ \"1\" ] } } 18.4 - Verify VPN Address Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: Name ResourceGroup Location Zones Address AddressVersion AllocationMethod IdleTimeoutInMinutes ProvisioningState ----------------- --------------- ---------- ------- ----------- ---------------- ------------------ ---------------------- ------------------- ipm-vpn-public-ip ipm-eastus eastus 1 20.55.32.58 IPv4 Static 4 Succeeded 18.5 - Create VPN Gateway There are two types of Azure VPN Gateways, the Classic and Resource Manager deployment models. Each virtual network can have only one VPN gateway. Note Creating a virtual network gateway can take up to 45 minutes to complete. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_create Command(s): az network vnet-gateway create --name ${ARO_VGW_NAME} --location ${ARO_LOCATION_NAME} --public-ip-address ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet ${ARO_VNET_NAME} --gateway-type VPN --sku ${ARO_VGW_SKU} --vpn-type ${ARO_VGW_TYPE} --address-prefixes ${ARO_SUBNET_VGW_POOL_CIDR} Example Output: { \"vnetGateway\": { \"activeActive\": false, \"bgpSettings\": { \"asn\": 65515, \"bgpPeeringAddress\": \"10.10.10.254\", \"bgpPeeringAddresses\": [ { \"customBgpIpAddresses\": [], \"defaultBgpIpAddresses\": [ \"10.10.10.254\" ], \"ipconfigurationId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"tunnelIpAddresses\": [ \"20.55.32.58\" ] } ], \"peerWeight\": 0 }, \"customRoutes\": null, \"enableBgp\": false, \"enableDnsForwarding\": null, \"enablePrivateIpAddress\": false, \"etag\": \"W/\\\"e794796d-23a5-40ea-b5d3-391b68595bfb\\\"\", \"gatewayDefaultSite\": null, \"gatewayType\": \"Vpn\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn\", \"inboundDnsForwardingEndpoint\": null, \"ipConfigurations\": [ { \"etag\": \"W/\\\"e794796d-23a5-40ea-b5d3-391b68595bfb\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"name\": \"vnetGatewayConfig0\", \"privateIpAddress\": null, \"privateIpAllocationMethod\": \"Dynamic\", \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"resourceGroup\": \"ipm-eastus\" }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"resourceGroup\": \"ipm-eastus\" }, \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\" } ], \"location\": \"eastus\", \"name\": \"ipm-vpn\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"20c26bff-2dad-4a88-8418-06ca4fa257af\", \"sku\": { \"capacity\": 2, \"name\": \"VpnGw1AZ\", \"tier\": \"VpnGw1AZ\" }, \"tags\": null, \"type\": \"Microsoft.Network/virtualNetworkGateways\", \"vpnClientConfiguration\": { \"aadAudience\": null, \"aadIssuer\": null, \"aadTenant\": null, \"radiusServerAddress\": null, \"radiusServerSecret\": null, \"radiusServers\": [], \"vpnClientAddressPool\": { \"addressPrefixes\": [ \"172.16.13.0/24\" ] }, \"vpnClientConnectionHealth\": { \"totalEgressBytesTransferred\": 0, \"totalIngressBytesTransferred\": 0, \"vpnClientConnectionsCount\": 0 }, \"vpnClientIpsecPolicies\": [], \"vpnClientProtocols\": [ \"IkeV2\", \"OpenVPN\" ], \"vpnClientRevokedCertificates\": [], \"vpnClientRootCertificates\": [] }, \"vpnGatewayGeneration\": \"Generation1\", \"vpnType\": \"RouteBased\" } } 18.6 - Verify VPN Gateway Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: ActiveActive EnableBgp EnablePrivateIpAddress GatewayType Location Name ProvisioningState ResourceGroup ResourceGuid VpnGatewayGeneration VpnType -------------- ----------- ------------------------ ------------- ---------- ------- ------------------- --------------- ------------------------------------ ---------------------- ---------- False False False Vpn eastus ipm-vpn Succeeded ipm-eastus 20c26bff-2dad-4a88-8418-06ca4fa257af Generation1 RouteBased 19 - VPN Gateway PKI An Azure VPN Gateway supports using a Public Key Infrastructure (PKI) for Certificate Authentication. With VPN Gateway Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. This series of steps establishes a private Certificate Authority (CA) by creating a Root Key & Certificate. The Certificate Data wil be uploaded to the Azure VPN Gateway, so that VPN Clients Certificates will be authenticated. To be valid for authentication, the VPN Client Certificates must be signed by the Root Certificate. Note VPN Client Certificates will be created later. Reference(s): https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://en.wikipedia.org/wiki/Public_key_infrastructure https://en.wikipedia.org/wiki/Root_certificate Command(s): env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V Example Output: ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key 19.1 - Create Root Key Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-genrsa.html Command(s): openssl genrsa -aes256 -out ${ARO_VGW_PKI_ROOT_KEY_FILE} -passout env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 Example Output: Generating RSA private key, 2048 bit long modulus (2 primes) ..+++++ .................+++++ e is 65537 (0x010001) 19.2 - Verify Root Key Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 Example Output: + success does not produce any output 19.3 - Create Root Certificate This step creates a root certificate that is valid for 10 years (3650 days). Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -x509 -sha256 -new -key \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -out \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -days 3650 -subj /CN=\"${ARO_VGW_NAME}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 # 10 years Example Output: + success does not produce any output 19.4 - Verify Root Certificate Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 Example Output: Certificate: Data: Version: 3 (0x2) Serial Number: 0c:bf:8d:e4:7e:9c:40:ab:ba:39:b9:42:98:7f:80:a4:5e:36:a7:3e Signature Algorithm: sha256WithRSAEncryption Issuer: CN = ipm-vpn Validity Not Before: Sep 27 03:28:52 2020 GMT Not After : Sep 25 03:28:52 2030 GMT Subject: CN = ipm-vpn Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:b3:82:e0:16:56:56:9b:c4:81:c4:a9:4d:67:b6: 3e:b4:1c:7c:38:2b:e8:f0:c0:23:5d:d2:d8:71:dc: 57:fb:e6:50:c8:f5:71:99:d0:36:b4:23:f2:4b:90: 1d:0a:7c:f3:0d:6f:81:2a:1d:07:81:65:19:45:de: e2:dc:a0:c8:c1:ad:61:b7:a5:a5:e4:78:68:03:ef: 07:59:f5:de:ff:ce:4b:5c:fc:f3:0a:45:89:90:28: 0d:49:c2:40:95:40:57:7e:5c:ac:f7:9c:ce:67:7d: f6:71:35:f9:85:dc:82:ad:9c:d5:af:0a:43:4e:e3: 61:d6:79:90:c0:02:55:37:ca:55:1a:26:ba:cf:05: 1f:c5:86:44:1a:54:d5:07:ba:38:b0:ca:5d:42:31: 3b:84:56:70:5b:f1:d4:39:17:be:8d:dc:25:cf:79: f9:fc:9d:61:59:46:fa:47:59:9a:bb:a3:20:4d:d7: c1:09:2b:4c:92:ae:2b:c4:f5:e0:3d:18:52:21:59: f3:6c:e0:51:3a:85:eb:de:5d:9d:2b:ed:e5:58:ef: 5a:39:c4:5f:80:41:00:c3:9f:fc:a9:f5:3c:ec:fe: 65:44:c4:5a:e6:5f:79:7a:fd:50:bf:c4:14:ef:12: 13:89:77:c9:5a:3f:52:10:4f:83:31:43:bc:3e:94: a8:33 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Authority Key Identifier: keyid:07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Basic Constraints: critical CA:TRUE Signature Algorithm: sha256WithRSAEncryption 97:dc:d1:bd:95:37:2c:97:e7:76:9b:bc:9d:e4:5d:d7:73:6e: 81:93:e4:87:02:77:ec:19:de:d4:c1:d4:d8:2b:32:6d:e3:89: fb:97:36:b6:01:62:8c:cf:e6:bd:ce:52:c1:03:c3:60:de:3f: 5b:da:4f:fd:6c:cd:0b:47:65:af:4e:e2:d1:07:84:6c:50:6a: f8:e4:41:3b:ce:ae:f8:b2:66:68:b0:ed:32:04:f2:2f:8d:98: 29:84:16:e7:a3:c4:ea:60:37:b6:0b:db:04:2a:d6:94:a4:aa: 80:eb:2d:14:ad:25:1e:3e:7d:1b:7a:72:1a:06:44:f8:e6:51: 02:3a:cf:36:6b:4b:d5:b4:6b:ee:1f:88:49:1a:22:06:39:ba: 3a:71:19:fa:34:e2:a9:c0:08:3e:25:91:64:1c:74:24:1a:4b: 06:3b:24:5e:62:89:6c:54:f3:b9:15:5b:5f:70:d6:d6:19:a1: eb:a3:52:db:35:53:cb:0b:6b:39:59:5a:23:d5:ed:ca:fc:44: 71:93:a7:66:7c:51:4d:4e:0f:f5:15:57:de:a1:09:2f:e6:23: 76:00:bf:68:d7:bd:7b:69:83:b5:0d:e8:bb:a1:fb:01:18:bf: 7e:39:30:94:02:27:29:ac:c9:f3:18:a2:50:55:e4:58:94:29: f6:1f:d4:24 19.5 - Verify Root Moduli Warning Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed until they match. Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum Example Output: md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key = 4103146f0ffed8dfb840bfd8f79963af - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt = 4103146f0ffed8dfb840bfd8f79963af - 19.6 - Create Root Data The VPN Gateway requires knowledge of the Root Data. The Public certificate data must be uploaded to Azure in a specific format. In a previous step, the root certificate was created in the Privacy Enhanced Mail (PEM) format. PEM is the most common format for X.509 certificates. A PEM file is a text file containing one or more items, encoded in base64 ASCII, and identified by plain-text headers and footers PEM, an example: -----BEGIN CERTIFICATE----- DATA -----END CERTIFICATE----- DER files do NOT contain plain text headers . DER is a binary format for data structures described by ASN.1. Important The Azure VPN Gateway requires the Root Public certificate data use the Distinguished Encoding Rules (DER) format, encoded as base64 ASCII. The conversion from PEM to base64 DER is done by OpenSSL, in the Command(s). Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/root-cert?view=azure-cli-latest#az_network_vnet_gateway_root_cert_create https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail https://en.wikipedia.org/wiki/X.690#DER_encoding https://en.wikipedia.org/wiki/ASN.1 Command(s): az network vnet-gateway root-cert create --gateway-name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --name \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" --public-cert-data \"$(openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -outform der | base64 -w0)\" Example Output: { \"activeActive\": false, \"bgpSettings\": { \"asn\": 65515, \"bgpPeeringAddress\": \"10.10.10.254\", \"bgpPeeringAddresses\": [ { \"customBgpIpAddresses\": [], \"defaultBgpIpAddresses\": [ \"10.10.10.254\" ], \"ipconfigurationId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"tunnelIpAddresses\": [ \"20.55.32.58\" ] } ], \"peerWeight\": 0 }, \"customRoutes\": null, \"enableBgp\": false, \"enableDnsForwarding\": null, \"enablePrivateIpAddress\": false, \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"gatewayDefaultSite\": null, \"gatewayType\": \"Vpn\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn\", \"inboundDnsForwardingEndpoint\": null, \"ipConfigurations\": [ { \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"name\": \"vnetGatewayConfig0\", \"privateIpAddress\": null, \"privateIpAllocationMethod\": \"Dynamic\", \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"resourceGroup\": \"ipm-eastus\" }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"resourceGroup\": \"ipm-eastus\" }, \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\" } ], \"location\": \"eastus\", \"name\": \"ipm-vpn\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"20c26bff-2dad-4a88-8418-06ca4fa257af\", \"sku\": { \"capacity\": 2, \"name\": \"VpnGw1AZ\", \"tier\": \"VpnGw1AZ\" }, \"tags\": null, \"type\": \"Microsoft.Network/virtualNetworkGateways\", \"vpnClientConfiguration\": { \"aadAudience\": null, \"aadIssuer\": null, \"aadTenant\": null, \"radiusServerAddress\": null, \"radiusServerSecret\": null, \"radiusServers\": [], \"vpnClientAddressPool\": { \"addressPrefixes\": [ \"172.16.13.0/24\" ] }, \"vpnClientConnectionHealth\": { \"totalEgressBytesTransferred\": 0, \"totalIngressBytesTransferred\": 0, \"vpnClientConnectionsCount\": 0 }, \"vpnClientIpsecPolicies\": [], \"vpnClientProtocols\": [ \"IkeV2\", \"OpenVPN\" ], \"vpnClientRevokedCertificates\": [], \"vpnClientRootCertificates\": [ { \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/vpnClientRootCertificates/ipm-vpn-root.crt\", \"name\": \"ipm-vpn-root.crt\", \"provisioningState\": \"Succeeded\", \"publicCertData\": \"MIIDBTCCAe2gAwIBAgIUDL+N5H6cQKu6OblCmH+ApF42pz4wDQYJKoZIhvcNAQELBQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzI4NTJaFw0zMDA5MjUwMzI4NTJaMBIxEDAOBgNVBAMMB2lwbS12cG4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCzguAWVlabxIHEqU1ntj60HHw4K+jwwCNd0thx3Ff75lDI9XGZ0Da0I/JLkB0KfPMNb4EqHQeBZRlF3uLcoMjBrWG3paXkeGgD7wdZ9d7/zktc/PMKRYmQKA1JwkCVQFd+XKz3nM5nffZxNfmF3IKtnNWvCkNO42HWeZDAAlU3ylUaJrrPBR/FhkQaVNUHujiwyl1CMTuEVnBb8dQ5F76N3CXPefn8nWFZRvpHWZq7oyBN18EJK0ySrivE9eA9GFIhWfNs4FE6heveXZ0r7eVY71o5xF+AQQDDn/yp9Tzs/mVExFrmX3l6/VC/xBTvEhOJd8laP1IQT4MxQ7w+lKgzAgMBAAGjUzBRMB0GA1UdDgQWBBQH9gH+kGBq5556lD9irqEcbH9BWjAfBgNVHSMEGDAWgBQH9gH+kGBq5556lD9irqEcbH9BWjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCX3NG9lTcsl+d2m7yd5F3Xc26Bk+SHAnfsGd7UwdTYKzJt44n7lza2AWKMz+a9zlLBA8Ng3j9b2k/9bM0LR2WvTuLRB4RsUGr45EE7zq74smZosO0yBPIvjZgphBbno8TqYDe2C9sEKtaUpKqA6y0UrSUePn0benIaBkT45lECOs82a0vVtGvuH4hJGiIGObo6cRn6NOKpwAg+JZFkHHQkGksGOyReYolsVPO5FVtfcNbWGaHro1LbNVPLC2s5WVoj1e3K/ERxk6dmfFFNTg/1FVfeoQkv5iN2AL9o1717aYO1Dei7ofsBGL9+OTCUAicprMnzGKJQVeRYlCn2H9Qk\", \"resourceGroup\": \"ipm-eastus\", \"type\": \"Microsoft.Network/virtualNetworkGateways/vpnClientRootCertificates\" } ] }, \"vpnGatewayGeneration\": \"Generation1\", \"vpnType\": \"RouteBased\" } 19.7 - Verify Root Data Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi Example Output: found ipm-vpn root certificate name = ipm-vpn-root.crt verified ipm-vpn-root.crt exists as a root certificate name for ipm-vpn 20 - Client Certificates VPN Clients must present an X.509 version 3 certificate when connecting. Each user should have their own bundle of certificate files. This step outlines a procedure to create them with OpenSSL v1.1.1. It will need to be re-run for everyone who requires connectivity. The Azure VPN Gateway supports both IKEv2 (ipsec) and OpenVPN (ssl) client connections. Various VPN client software support these technologies. It is most convenient to distribute a PKCS#12 file to the user, so they can connect to the VPN Gateway and access the private Azure Red Hat OpenShift cluster. In cryptography, PKCS #12 defines an archive file format for storing many cryptography objects as a single file. PKCS#12 evolved from Microsoft's Personal Information Exchange (PFX) standard and is used to exchange public and private objects. It is commonly used to bundle a private key with its X.509 certificate or to bundle all the members of a chain of trust. The terms PKCS #12 (pkcs12) and PFX (pfx) are often used interchangeably. Successful execution of the commands in this step depends upon the previously created VPN Gateway Root Certificate files and exported environment variables. Successful completion of the following steps will produce six (6) files, in this order: VPN Client Key (.key) VPN Client Certificate Request (.req) VPN Client Certificate Extensions (.ext) VPN Client Certificate (.crt) VPN Client Certificate Serial (.serial) VPN Client Certificate Bundle (.pfx) The resulting PFX file is should be given to the user. 20.1 - Set VPN Client Environment Variables These environment variables should be exported each time a new set of client certificate files are created. Important These are example values that must be changed for your installation. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' Example Output: + success does not produce any output 20.2 - Verify VPN Client Environment Variables Reference(s): https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html Command(s): ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE Example Output: ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! 20.3 - Create VPN Client Key Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-genrsa.html Command(s): openssl genrsa -aes256 -out \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passout env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 Example Output: Generating RSA private key, 2048 bit long modulus (2 primes) .........................................+++++ ...........+++++ e is 65537 (0x010001) + success does not produce any output 20.4 - Verify VPN Client Key Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 Example Output: + success does not produce any output 20.5 - Create Client Certificate Request Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -new -out \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -key \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -subj /CN=\"${ARO_VGW_PKI_CLIENT_NAME}\" 2>&1 Example Output: + success does not produce any output 20.6 - Verify Client Certificate Request Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 Example Output: Certificate Request: Data: Version: 1 (0x0) Subject: CN = ipm-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:a8:dd:23:26:4e:ae:34:53:2a:f7:ed:52:b1:52: 80:eb:75:0d:76:d5:53:11:f2:f4:e9:a0:1b:2f:da: 7a:ee:63:c0:f1:d2:0d:8a:11:2a:7b:4c:11:7b:66: 04:3e:2a:2f:57:87:74:12:1e:fa:c8:ef:bb:69:76: 9d:a6:e4:8f:30:1f:6f:a3:dd:64:cd:b5:f8:ca:6c: 3e:ff:01:93:c8:ff:e4:e1:8a:63:7b:0c:ff:a0:73: d3:60:ad:53:29:46:b8:17:69:3d:17:06:40:b4:44: df:77:fc:7b:44:1e:4c:0e:02:fb:42:4e:a8:ab:55: 21:68:d0:45:7d:f3:5f:81:74:9a:8b:28:08:bd:d5: 8c:84:42:26:bc:fb:a4:c7:e9:2a:17:f6:b8:b2:2d: 44:34:ca:f1:f1:74:dc:16:3f:48:f7:93:3e:fd:21: a4:35:c1:bb:c6:0c:29:a5:6a:a4:ee:34:b4:e2:22: 23:c9:fa:63:16:2a:83:72:20:27:38:aa:56:a8:9f: 50:37:e8:a2:f8:8c:98:d7:6c:60:44:b7:76:95:65: 42:a5:bc:e3:49:bd:74:d2:59:8c:c4:35:eb:bd:ec: 86:97:f6:17:ab:76:a3:1a:ab:19:c3:cd:85:74:5a: 42:32:ff:2c:51:f3:34:9d:46:3f:97:ad:b8:b0:01: c1:c9 Exponent: 65537 (0x10001) Attributes: a0:00 Signature Algorithm: sha256WithRSAEncryption 6b:ec:e9:52:ef:76:ad:c6:49:ad:ed:19:83:ab:01:4c:0c:b5: b6:3c:e0:47:c4:89:af:79:99:fa:69:c9:32:b0:35:97:99:05: c6:ca:60:1d:1a:05:ba:30:9c:b3:8f:f5:8b:a3:ce:c7:af:4c: af:98:d0:82:1d:ca:ec:a3:18:f9:05:d1:e7:79:90:5a:77:f1: b2:4a:41:a2:43:48:d8:52:c2:4d:8b:f6:0f:26:8c:ef:ad:a7: 9c:14:49:b9:9f:ec:20:42:33:ea:12:78:0c:e9:98:a1:e7:bb: 81:b6:44:de:df:f3:63:b8:b6:ac:91:6a:5c:3d:5b:1b:a8:69: cf:d7:4e:21:5a:47:91:7f:e9:e1:6b:5b:ef:29:ee:75:dd:55: 81:ad:df:d7:4c:4c:77:e3:cf:8a:5c:ae:ec:c3:71:fc:b6:ce: f7:17:8a:1a:be:7e:a6:2f:85:a0:d5:16:eb:09:5e:7b:09:e9: a1:0e:d7:a2:55:a9:98:41:69:65:c3:70:ce:3d:04:ea:95:08: 39:a3:ff:c5:41:b2:8f:a9:fe:1b:ae:e5:df:0e:61:5f:90:2c: 35:d2:bb:41:e1:84:7a:54:e0:3d:c7:9d:1e:f5:15:37:a2:a7: 2a:d7:09:5f:4c:ec:e7:33:c7:34:0e:6b:b3:4f:e1:6e:7d:e3: d3:32:40:8d 20.7 - Create Client Certificate Extensions A Root Certificate Authority (CA) uses extensions to issue a certificate only for a specific purpose. Certificate Extensions were introduced in X.509 version 3 (X509v3). The Azure VPN Gateway requires specific Certificate Extensions on VPN Client certificates. More specificially, a VPN Client certificate must have the TLS Web Client Authentication (clientAuth) extended key usage (eku) extension. Additionally, X509v3 Subject Alternative Name (subjectAltName) must always be used per RFC 5280. This step creates a certificate extension file that OpenSSL will read when creating the certificate, and apply the proper extensions. Reference(s): https://tools.ietf.org/html/rfc5280 Command(s): echo \"authorityKeyIdentifier=keyid,issuer\" > \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"basicConstraints=CA:FALSE\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"extendedKeyUsage=clientAuth\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"subjectAltName=DNS:${ARO_VGW_PKI_CLIENT_NAME}\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: + success does not produce any output + success does not produce any output + success does not produce any output + success does not produce any output 20.8 - Verify Client Certificate Extensions Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: authorityKeyIdentifier=keyid,issuer extendedKeyUsage=clientAuth 20.9 - Create Client Certificate Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -req -sha256 -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -CAkey \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -CA \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE -days 1095 -CAcreateserial -CAserial \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 2>&1 Example Output: Signature ok subject=CN = ipm-vpn-client-example Getting CA Private Key 20.10 - Verify Client Certificate Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 Example Output: Certificate: Data: Version: 3 (0x2) Serial Number: 24:ac:31:61:b3:c2:b6:a2:51:50:cb:f3:7f:36:c5:7b:fa:f0:77:d3 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = ipm-vpn Validity Not Before: Sep 27 03:31:32 2020 GMT Not After : Sep 27 03:31:32 2023 GMT Subject: CN = ipm-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:a8:dd:23:26:4e:ae:34:53:2a:f7:ed:52:b1:52: 80:eb:75:0d:76:d5:53:11:f2:f4:e9:a0:1b:2f:da: 7a:ee:63:c0:f1:d2:0d:8a:11:2a:7b:4c:11:7b:66: 04:3e:2a:2f:57:87:74:12:1e:fa:c8:ef:bb:69:76: 9d:a6:e4:8f:30:1f:6f:a3:dd:64:cd:b5:f8:ca:6c: 3e:ff:01:93:c8:ff:e4:e1:8a:63:7b:0c:ff:a0:73: d3:60:ad:53:29:46:b8:17:69:3d:17:06:40:b4:44: df:77:fc:7b:44:1e:4c:0e:02:fb:42:4e:a8:ab:55: 21:68:d0:45:7d:f3:5f:81:74:9a:8b:28:08:bd:d5: 8c:84:42:26:bc:fb:a4:c7:e9:2a:17:f6:b8:b2:2d: 44:34:ca:f1:f1:74:dc:16:3f:48:f7:93:3e:fd:21: a4:35:c1:bb:c6:0c:29:a5:6a:a4:ee:34:b4:e2:22: 23:c9:fa:63:16:2a:83:72:20:27:38:aa:56:a8:9f: 50:37:e8:a2:f8:8c:98:d7:6c:60:44:b7:76:95:65: 42:a5:bc:e3:49:bd:74:d2:59:8c:c4:35:eb:bd:ec: 86:97:f6:17:ab:76:a3:1a:ab:19:c3:cd:85:74:5a: 42:32:ff:2c:51:f3:34:9d:46:3f:97:ad:b8:b0:01: c1:c9 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Authority Key Identifier: keyid:07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Basic Constraints: CA:FALSE X509v3 Extended Key Usage: TLS Web Client Authentication X509v3 Subject Alternative Name: DNS:ipm-vpn-client-example Signature Algorithm: sha256WithRSAEncryption 5a:8d:83:db:fe:c6:54:a7:9a:db:dc:6e:56:25:6c:79:1c:f0: 26:55:6c:41:3f:00:86:d8:12:96:6e:d7:0f:f0:67:7e:1f:08: 7a:f4:f4:0b:07:92:60:3b:df:5d:26:95:1b:b8:5f:18:19:01: e0:d1:d7:ed:5f:52:21:33:ef:c3:70:ab:86:34:2a:71:25:8c: ae:4c:c9:76:92:a6:c0:f4:c5:06:5f:b7:e1:8c:4a:2d:86:4f: a1:79:8d:94:2c:60:e9:a9:ab:69:b4:01:34:0b:99:63:ab:3f: 57:6c:49:9f:ed:d5:ed:0f:41:d8:af:2b:14:63:ae:b8:16:59: 93:06:35:b1:43:81:7c:c4:68:d2:08:48:ec:36:19:71:a9:ac: c9:c1:70:f5:6d:14:fd:6d:15:e2:d1:fb:86:b6:91:86:e9:3b: 1e:00:41:16:f3:95:49:98:86:30:7c:64:06:49:d1:27:94:b7: 5f:64:ce:46:5d:91:16:74:93:d4:c7:9c:ec:0f:a4:2e:32:80: 43:88:ee:12:33:2c:51:d9:a2:7e:cc:ff:b2:2f:c6:87:30:37: 89:bc:e7:ee:6b:8a:74:6f:e4:69:60:32:54:b3:ea:03:ef:a3: 37:ea:57:7f:fc:05:ef:ae:ce:cd:53:ea:4b:f9:95:b4:22:39: f5:75:01:d9 20.11 - Verify Client Moduli Warning Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed until they match. Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_REQ_FILE} = \"; openssl req -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" | md5sum Example Output: md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key = 1ec497f88cbce7449554078dce627bb4 - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt = 1ec497f88cbce7449554078dce627bb4 - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req = 1ec497f88cbce7449554078dce627bb4 - 20.12 - Create VPN Client PFX Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl pkcs12 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -inkey \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -passout pass: -certfile \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -export 2>&1 Example Output: + success does not produce any output 20.13 - Verify VPN Client PFX Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1 Example Output: Bag Attributes localKeyID: A0 FD 44 81 5B C9 B3 66 B8 F6 3E 4E 76 98 7E 26 32 7A D1 4B subject=CN = ipm-vpn-client-example issuer=CN = ipm-vpn -----BEGIN CERTIFICATE----- MIIDJzCCAg+gAwIBAgIUJKwxYbPCtqJRUMvzfzbFe/rwd9MwDQYJKoZIhvcNAQEL BQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzMxMzJaFw0yMzA5Mjcw MzMxMzJaMCExHzAdBgNVBAMMFmlwbS12cG4tY2xpZW50LWV4YW1wbGUwggEiMA0G CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCo3SMmTq40Uyr37VKxUoDrdQ121VMR 8vTpoBsv2nruY8Dx0g2KESp7TBF7ZgQ+Ki9Xh3QSHvrI77tpdp2m5I8wH2+j3WTN tfjKbD7/AZPI/+ThimN7DP+gc9NgrVMpRrgXaT0XBkC0RN93/HtEHkwOAvtCTqir VSFo0EV981+BdJqLKAi91YyEQia8+6TH6SoX9riyLUQ0yvHxdNwWP0j3kz79IaQ1 wbvGDCmlaqTuNLTiIiPJ+mMWKoNyICc4qlaon1A36KL4jJjXbGBEt3aVZUKlvONJ vXTSWYzENeu97IaX9herdqMaqxnDzYV0WkIy/yxR8zSdRj+XrbiwAcHJAgMBAAGj ZjBkMB8GA1UdIwQYMBaAFAf2Af6QYGrnnnqUP2KuoRxsf0FaMAkGA1UdEwQCMAAw EwYDVR0lBAwwCgYIKwYBBQUHAwIwIQYDVR0RBBowGIIWaXBtLXZwbi1jbGllbnQt ZXhhbXBsZTANBgkqhkiG9w0BAQsFAAOCAQEAWo2D2/7GVKea29xuViVseRzwJlVs QT8AhtgSlm7XD/Bnfh8IevT0CweSYDvfXSaVG7hfGBkB4NHX7V9SITPvw3CrhjQq cSWMrkzJdpKmwPTFBl+34YxKLYZPoXmNlCxg6amrabQBNAuZY6s/V2xJn+3V7Q9B 2K8rFGOuuBZZkwY1sUOBfMRo0ghI7DYZcamsycFw9W0U/W0V4tH7hraRhuk7HgBB FvOVSZiGMHxkBknRJ5S3X2TORl2RFnST1Mec7A+kLjKAQ4juEjMsUdmifsz/si/G hzA3ibzn7muKdG/kaWAyVLPqA++jN+pXf/wF767OzVPqS/mVtCI59XUB2Q== -----END CERTIFICATE----- Bag Attributes: <No Attributes> subject=CN = ipm-vpn issuer=CN = ipm-vpn -----BEGIN CERTIFICATE----- MIIDBTCCAe2gAwIBAgIUDL+N5H6cQKu6OblCmH+ApF42pz4wDQYJKoZIhvcNAQEL BQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzI4NTJaFw0zMDA5MjUw MzI4NTJaMBIxEDAOBgNVBAMMB2lwbS12cG4wggEiMA0GCSqGSIb3DQEBAQUAA4IB DwAwggEKAoIBAQCzguAWVlabxIHEqU1ntj60HHw4K+jwwCNd0thx3Ff75lDI9XGZ 0Da0I/JLkB0KfPMNb4EqHQeBZRlF3uLcoMjBrWG3paXkeGgD7wdZ9d7/zktc/PMK RYmQKA1JwkCVQFd+XKz3nM5nffZxNfmF3IKtnNWvCkNO42HWeZDAAlU3ylUaJrrP BR/FhkQaVNUHujiwyl1CMTuEVnBb8dQ5F76N3CXPefn8nWFZRvpHWZq7oyBN18EJ K0ySrivE9eA9GFIhWfNs4FE6heveXZ0r7eVY71o5xF+AQQDDn/yp9Tzs/mVExFrm X3l6/VC/xBTvEhOJd8laP1IQT4MxQ7w+lKgzAgMBAAGjUzBRMB0GA1UdDgQWBBQH 9gH+kGBq5556lD9irqEcbH9BWjAfBgNVHSMEGDAWgBQH9gH+kGBq5556lD9irqEc bH9BWjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCX3NG9lTcs l+d2m7yd5F3Xc26Bk+SHAnfsGd7UwdTYKzJt44n7lza2AWKMz+a9zlLBA8Ng3j9b 2k/9bM0LR2WvTuLRB4RsUGr45EE7zq74smZosO0yBPIvjZgphBbno8TqYDe2C9sE KtaUpKqA6y0UrSUePn0benIaBkT45lECOs82a0vVtGvuH4hJGiIGObo6cRn6NOKp wAg+JZFkHHQkGksGOyReYolsVPO5FVtfcNbWGaHro1LbNVPLC2s5WVoj1e3K/ERx k6dmfFFNTg/1FVfeoQkv5iN2AL9o1717aYO1Dei7ofsBGL9+OTCUAicprMnzGKJQ VeRYlCn2H9Qk -----END CERTIFICATE----- 21 - VPN Client Please follow Microsoft's instructions for installing the VPN Client for your operating system. Tip Commands for using az and wget are given below. Reference(s): https://en.wikipedia.org/wiki/X.509 https://en.wikipedia.org/wiki/PKCS_12 https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-vpn-client-install-azure-cert https://www.openssl.org/ Command(s): env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V Example Output: ARO_KEY=ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key 21.1 - Verify VPN Client URL Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/vpn-client?view=azure-cli-latest#az_network_vnet_gateway_vpn_client_generate Command(s): export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" Example Output: + success does not produce any output ARO_VGW_CONFIGURATION_URL=\"https://nfvprodsuppbl.blob.core.windows.net/vpnprofileimmutable/cf9d0077-d7e7-4c7f-aae7-7f15cc7d58d8/vpnprofile/c55a6b34-3e2f-4747-b19f-6c8ff8c5d22a/vpnclientconfiguration.zip?sv=2018-03-28&sr=b&sig=lt%2FYNiNekY3VCic3qMxtz772%2FyX30OuSiUD0NBZewU0%3D&st=2020-09-27T03%3A26%3A39Z&se=2020-09-27T04%3A26%3A39Z&sp=r&fileExtension=.zip\" 21.2 - Download VPN Client The necessary VPN Client Configuration files may be downloaded via the Azure porta or with the following commands. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/vpn-client?view=azure-cli-latest#az_network_vnet_gateway_vpn_client_generate Command(s): eval wget \"${ARO_VGW_CONFIGURATION_URL}\" -O \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 2>&1 Example Output: --2020-09-26 23:31:47-- https://nfvprodsuppbl.blob.core.windows.net/vpnprofileimmutable/cf9d0077-d7e7-4c7f-aae7-7f15cc7d58d8/vpnprofile/c55a6b34-3e2f-4747-b19f-6c8ff8c5d22a/vpnclientconfiguration.zip?sv=2018-03-28&sr=b&sig=lt%2FYNiNekY3VCic3qMxtz772%2FyX30OuSiUD0NBZewU0%3D&st=2020-09-27T03%3A26%3A39Z&se=2020-09-27T04%3A26%3A39Z&sp=r&fileExtension=.zip Resolving nfvprodsuppbl.blob.core.windows.net (nfvprodsuppbl.blob.core.windows.net)... 52.239.153.36 Connecting to nfvprodsuppbl.blob.core.windows.net (nfvprodsuppbl.blob.core.windows.net)|52.239.153.36|:443... connected. HTTP request sent, awaiting response... 200 OK Length: 303372 (296K) [application/octet-stream] Saving to: \u2018/home/jtingiris/prj/mit/aei/pki/ipm-vpn.zip\u2019 0K .......... .......... .......... .......... .......... 16% 1.01M 0s 50K .......... .......... .......... .......... .......... 33% 1.90M 0s 100K .......... .......... .......... .......... .......... 50% 92.1M 0s 150K .......... .......... .......... .......... .......... 67% 1.95M 0s 200K .......... .......... .......... .......... .......... 84% 50.7M 0s 250K .......... .......... .......... .......... ...... 100% 16.2M=0.1s 2020-09-26 23:31:47 (2.80 MB/s) - \u2018/home/jtingiris/prj/mit/aei/pki/ipm-vpn.zip\u2019 saved [303372/303372] 21.3 - Distribute VPN Client & PFX 22 - Obtain Pull Secrets Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries. 22.1 - Obtain Red Hat Pull Secret A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. To obtain a Red Hat pull secret, go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned Note This step must be done manually, via a web browser. It is optional though recommended. Important Make sure to update ${ARO_REDHAT_PULL_SECRET_FILE} with the path where the pull secret was saved. Reference(s): https://access.redhat.com/solutions/4844461 22.2 - Verify Red Hat Pull Secret Command(s): ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: -rw-rw----. 1 jtingiris mit 2835 Sep 12 10:26 /home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt 23 - Azure Red Hat OpenShift Reference(s): https://azure.microsoft.com/en-us/services/openshift/ https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest Command(s): env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V Example Output: ARO_CLUSTER_DOMAIN_NAME=ipm.mitaei.net ARO_CLUSTER_NAME=ipm-cluster ARO_CLUSTER_VISIBILITY_API=Private ARO_CLUSTER_VISIBILITY_INGRESS=Private ARO_CLUSTER_VM_MASTER_SIZE=Standard_D8s_v3 ARO_CLUSTER_VM_WORKER_COUNT=3 ARO_CLUSTER_VM_WORKER_DISK_GB=128 ARO_CLUSTER_VM_WORKER_SIZE=Standard_D8s_v3 ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_VNET_NAME=ipm-vnet 23.1 - Create ARO Cluster This can take up to an hour. Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_create https://docs.openshift.com/container-platform/4.4/installing/installing_azure/installing-azure-network-customizations.html#modifying-nwoperator-config-startup_installing-azure-network-customizations Command(s): az aro create --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --name \"${ARO_CLUSTER_NAME}\" --master-subnet \"${ARO_SUBNET_MASTER_NAME}\" --master-vm-size \"${ARO_CLUSTER_VM_MASTER_SIZE}\" --worker-subnet \"${ARO_SUBNET_WORKER_NAME}\" --worker-count ${ARO_CLUSTER_VM_WORKER_COUNT} --worker-vm-size \"${ARO_CLUSTER_VM_WORKER_SIZE}\" --worker-vm-disk-size-gb ${ARO_CLUSTER_VM_WORKER_DISK_GB} --apiserver-visibility \"${ARO_CLUSTER_VISIBILITY_INGRESS}\" --ingress-visibility \"${ARO_CLUSTER_VISIBILITY_API}\" --pod-cidr \"${ARO_SUBNET_POD_CIDR}\" --service-cidr \"${ARO_SUBNET_SERVICE_CIDR}\" --vnet \"${ARO_VNET_NAME}\" --pull-secret @\"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: { \"apiserverProfile\": { \"ip\": \"10.10.0.4\", \"url\": \"https://api.my4zz953.eastus.aroapp.io:6443/\", \"visibility\": \"Private\" }, \"clusterProfile\": { \"domain\": \"my4zz953\", \"pullSecret\": null, \"resourceGroupId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-my4zz953\", \"version\": \"4.4.17\" }, \"consoleProfile\": { \"url\": \"https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/\" }, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.RedHatOpenShift/openShiftClusters/ipm-cluster\", \"ingressProfiles\": [ { \"ip\": \"10.10.2.4\", \"name\": \"default\", \"visibility\": \"Private\" } ], \"location\": \"eastus\", \"masterProfile\": { \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, \"name\": \"ipm-cluster\", \"networkProfile\": { \"podCidr\": \"10.12.0.0/14\", \"serviceCidr\": \"10.11.0.0/16\" }, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"servicePrincipalProfile\": { \"clientId\": \"de8651b4-5479-47c4-8be4-0081ee8ae5d6\", \"clientSecret\": null }, \"tags\": null, \"type\": \"Microsoft.RedHatOpenShift/openShiftClusters\", \"workerProfiles\": [ { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus1\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus2\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus3\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" } ] } 23.2 - Verify ARO Cluster Command(s): az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" Example Output: https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/ { \"apiserverProfile\": { \"ip\": \"10.10.0.4\", \"url\": \"https://api.my4zz953.eastus.aroapp.io:6443/\", \"visibility\": \"Private\" }, \"clusterProfile\": { \"domain\": \"my4zz953\", \"pullSecret\": null, \"resourceGroupId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-my4zz953\", \"version\": \"4.4.17\" }, \"consoleProfile\": { \"url\": \"https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/\" }, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.RedHatOpenShift/openShiftClusters/ipm-cluster\", \"ingressProfiles\": [ { \"ip\": \"10.10.2.4\", \"name\": \"default\", \"visibility\": \"Private\" } ], \"location\": \"eastus\", \"masterProfile\": { \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, \"name\": \"ipm-cluster\", \"networkProfile\": { \"podCidr\": \"10.12.0.0/14\", \"serviceCidr\": \"10.11.0.0/16\" }, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"servicePrincipalProfile\": { \"clientId\": \"de8651b4-5479-47c4-8be4-0081ee8ae5d6\", \"clientSecret\": null }, \"tags\": null, \"type\": \"Microsoft.RedHatOpenShift/openShiftClusters\", \"workerProfiles\": [ { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus1\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus2\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus3\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" } ] } { \"kubeadminPassword\": \"TSx2J-LY56j-KznE7-SzIU3\", \"kubeadminUsername\": \"kubeadmin\" } 24 - OpenShift CLI The OpenShift CLI client oc simplifies working with Kubernetes and OpenShift clusters, offering a number of advantages over kubectl such as easy login, kube config file management, and access to developer tools. The kubectl binary is included for when strict Kubernetes compliance is necessary. Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_list_credentials https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_show https://cloud.redhat.com/openshift/install/azure/installer-provisioned https://docs.openshift.com/container-platform/4.4/cli_reference/openshift_cli/getting-started-cli.html 24.1 - Install OpenShift CLI Download the latest archive for Azure Red Hat OpenShift from here: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz After extracting the archive, move the oc and kubectl binaries to a location in the PATH, such as /usr/local/bin . To start a session with the OpenShift cluster, login. oc login [API_URL] Reference(s): https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz Command(s): wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -O /tmp/openshift-client-linux.tar.gz 2>&1 cd /tmp tar zxvf openshift-client-linux.tar.gz mv -f oc /usr/local/bin mv -f kubectl /usr/local/in Example Output: README.md oc kubectl 24.2 - Verify OpenShift CLI missing './help/Verify OpenShift CLI.md' Command(s): oc version kubectl version Example Output: Client Version: 4.5.11 Client Version: version.Info{Major:\"1\", Minor:\"18\", GitVersion:\"v1.18.2-0-g52c56ce\", GitCommit:\"d7f3ccf9a5bdc96ba92e31526cf014b3de4c46aa\", GitTreeState:\"clean\", BuildDate:\"2020-09-11T23:48:53Z\", GoVersion:\"go1.13.4\", Compiler:\"gc\", Platform:\"linux/amd64\"} 25 - OpenShift Authentication missing './help/OpenShift Authentication.md' TODO","title":"Preview"},{"location":"preview/#azure-red-hat-openshift-for-ibm-product-master","text":"","title":"Azure Red Hat OpenShift for IBM Product Master"},{"location":"preview/#draft","text":"This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 10:58:31 PM EDT","title":"[DRAFT]"},{"location":"preview/#introduction","text":"This document details the steps required to automate the build of a secure, private Azure Red Hat OpenShift v4.x (ARO) infrastructure for IBM Product Master v12.x. The procedure to install IBM Product Master is an accompanying document.","title":"Introduction"},{"location":"preview/#azure","text":"Microsoft Azure is a comprehensive cloud computing service managed by Microsoft. It provides software as a service (SaaS), platform as a service (PaaS), and infrastructure as a service (IaaS).","title":"Azure"},{"location":"preview/#openshift-container-platform","text":"Red Hat's OpenShift Container Platform (OCP) is a hybrid cloud, enterprise Kubernetes application platform. It is a platform as a service (Paas) built on Red Hat Enterprise Linux (RHEL), with Docker containers managed by Kubernetes.","title":"OpenShift Container Platform"},{"location":"preview/#azure-red-hat-openshift","text":"Azure Red Hat OpenShift (ARO) is a fully managed offering of Red Hat OpenShift running in Microsoft Azure. This service is jointly managed and supported by both Microsoft and Red Hat. For more details, see the Azure Red Hat OpenShift Service documentation.","title":"Azure Red Hat OpenShift"},{"location":"preview/#ibm-product-master","text":"IBM Product Master (IPM) provides trusted Product Information Management (PIM) and collaborative Master Data Management (MDM) capabilities. It creates an accurate and up-to-date repository of product and service information that can be used throughout organizations for strategic business initiatives Reference(s): https://www.openshift.com/blog/introducing-azure-red-hat-openshift-on-openshift-4 https://docs.openshift.com/aro/4/architecture/architecture.html https://azure.microsoft.com/ https://www.openshift.com/ https://www.docker.com/ https://kubernetes.io/ https://docs.microsoft.com/en-us/azure/openshift/openshift-faq https://docs.microsoft.com/en-us/azure/openshift/support-lifecycle https://www.ibm.com/products/product-master","title":"IBM Product Master"},{"location":"preview/#usage","text":"This document provides a step-by-step approach. Each step is dependent upon the successful completion of previous steps. The steps are structured and all follow this same pattern.","title":"Usage"},{"location":"preview/#description","text":"Many steps will have a detailed description that will provide additional context. In the interest of brevity, not all steps will have detailed descriptions.","title":"Description"},{"location":"preview/#references","text":"Most steps will have relevant, linked references. All references given are to supporting documentation.","title":"Reference(s)"},{"location":"preview/#commands","text":"These are the bash commands that must be run. The expectation is that they will be copy/paste. For that reason, the majority of commands rely on pre-set environment variables. The environment variables provide for portability, flexibility, and a consistent experience. If there are problems running any commands then it's most likely the environment variables are incorrect.","title":"Command(s)"},{"location":"preview/#example-output","text":"When there is output from a command, the example output will be given. Please compare the outputs to ensure consistency. It may be helpful.","title":"Example Output"},{"location":"preview/#1-azure-tenant","text":"A tenant is Microsoft's representation of an organization. It is a dedicated instance of Azure Active Directory (AAD) that is received when creating a new relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before Azure Red Hat OpenShift (ARO) can be installed, Microsoft accounts must exist and have appropriate access to an AAD tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. Note If you are the Global Administrator of an existing tenant, go to step 2. Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant","title":"1 - Azure Tenant"},{"location":"preview/#11-create-microsoft-account","text":"Reference(s): https://support.microsoft.com/en-us/help/4558219/microsoft-account-what-is https://en.wikipedia.org/wiki/Microsoft_account","title":"1.1 - Create Microsoft Account"},{"location":"preview/#12-create-global-administrator","text":"The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Add and manage domains Assign the Global Administrator role to other users Reset passwords for all users Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide","title":"1.2 - Create Global Administrator"},{"location":"preview/#13-verify-admin-center-access","text":"The Microsoft 365 admin center simplifies management of Microsoft 365 services. The admin center provides a tailored experience based on the the role of the logged in user. It is the common entry point for all Microsoft administrators. https://admin.microsoft.com/ Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide","title":"1.3 - Verify Admin Center Access"},{"location":"preview/#14-verify-aad-license","text":"The Azure Active Directory license can be verified by visiting the Directory Overview section on the Azure Portal. https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis","title":"1.4 - Verify AAD License"},{"location":"preview/#2-azure-subscription","text":"An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required during the installation of ARO. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators. Reference(s): https://docs.microsoft.com/en-us/microsoft-365/enterprise/subscriptions-licenses-accounts-and-tenants-for-microsoft-cloud-offerings?view=o365-worldwide","title":"2 - Azure Subscription"},{"location":"preview/#21-create-azure-subscription","text":"An Azure subscription may be purchased directly from Microsoft through the Azure website, through a Microsoft representative, or as part of a managed service from a Microsoft Partner. The Microsoft account that purchases the Azure subscription will automtically be assigned the Owner role. Additional Owners may be added later. To learn more about the Azure purchase options, visit this link. https://azure.microsoft.com/en-us/pricing/purchase-options/ Reference(s): https://azure.microsoft.com/","title":"2.1 - Create Azure Subscription"},{"location":"preview/#3-operating-system","text":"The ARO build procedures in this document depend upon a GNU/Linux Operating System (OS) and related tools. Special care has been taken to ensure the commands given will work on any GNU/Linux distribution. As of this writing, they have been successfully tested on Fedora 31+, Debian 9+, and Ubuntu 18+. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+ GNU bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep GNU wget Google Chrome or Firefox OpenSSL Reference(s): https://www.gnu.org/gnu/linux-and-gnu","title":"3 - Operating System"},{"location":"preview/#31-verify-operating-system","text":"The purpose of this step is to verify the Operating System is GNU/Linux and the dependent tools used in this document are installed. Reference(s): https://man7.org/linux/man-pages/man2/uname.2.html https://en.wikipedia.org/wiki/Uname Command(s): uname -a Example Output: Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux","title":"3.1 - Verify Operating System"},{"location":"preview/#32-verify-gnu-bash","text":"Reference(s): https://www.man7.org/linux/man-pages/man1/bash.1.html https://en.wikipedia.org/wiki/Bash_(Unix_shell) https://www.gnu.org/software/bash/ Command(s): bash --version Example Output: GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law.","title":"3.2 - Verify GNU bash"},{"location":"preview/#33-verify-gnu-awk","text":"Reference(s): https://man7.org/linux/man-pages/man1/awk.1p.html https://en.wikipedia.org/wiki/AWK https://www.gnu.org/software/gawk/ Command(s): awk --version Example Output: GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/.","title":"3.3 - Verify GNU awk"},{"location":"preview/#34-verify-gnu-coreutils","text":"Reference(s): https://www.gnu.org/software/coreutils/ https://en.wikipedia.org/wiki/GNU_Core_Utilities Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering.","title":"3.4 - Verify GNU coreutils"},{"location":"preview/#35-verify-gnu-grep","text":"Reference(s): https://man7.org/linux/man-pages/man1/grep.1.html https://en.wikipedia.org/wiki/Grep https://www.gnu.org/software/grep/ Command(s): egrep --version Example Output: grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>.","title":"3.5 - Verify GNU grep"},{"location":"preview/#36-verify-gnu-wget","text":"Reference(s): https://man7.org/linux/man-pages/man1/wget.1.html https://en.wikipedia.org/wiki/Wget https://www.gnu.org/software/wget/ Command(s): wget --version Example Output: GNU Wget 1.20.3 built on linux-gnu. -cares +digest +gpgme +https +ipv6 +iri +large-file +metalink +nls +ntlm +opie +psl +ssl/gnutls Wgetrc: /etc/wgetrc (system) Locale: /usr/share/locale Compile: gcc -DHAVE_CONFIG_H -DSYSTEM_WGETRC=\"/etc/wgetrc\" -DLOCALEDIR=\"/usr/share/locale\" -I. -I../lib -I../lib -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection Link: gcc -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lmetalink -lpcre2-8 -luuid -lidn2 -lnettle -lgnutls -lz -lpsl -L/usr/lib64 -lgpgme ftp-opie.o gnutls.o http-ntlm.o ../lib/libgnu.a Copyright (C) 2015 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://www.gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Originally written by Hrvoje Niksic <hniksic@xemacs.org>. Please send bug reports and questions to <bug-wget@gnu.org>.","title":"3.6 - Verify GNU wget"},{"location":"preview/#37-verify-browser","text":"Either Google Chrome or Firefox is needed for a few steps. Other browsers will probably work, too, though haven't been tested. Reference(s): https://www.mozilla.org/ https://www.google.com/chrome/ Command(s): firefox --version google-chrome --version Example Output: Mozilla Firefox 80.0 Google Chrome 85.0.4183.83","title":"3.7 - Verify Browser"},{"location":"preview/#38-verify-openssl","text":"Reference(s): https://www.openssl.org/ Command(s): openssl version Example Output: OpenSSL 1.1.1g FIPS 21 Apr 2020","title":"3.8 - Verify OpenSSL"},{"location":"preview/#4-environment-variables","text":"Important This document depends heavily on the bash shell. There are required bash environment variables that are necessary to execute most steps in this document. The environment variables must be exported prior to running the Command(s). Warning Subsequent steps in this document will not work unless the bash shell environment is properly setup. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html","title":"4 - Environment Variables"},{"location":"preview/#41-unset-environment-variables","text":"Note Unsetting the ARO environment variables can help prevent issues when, or if they have changed in the configuration file. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done Example Output: unset ARO unset ARO_ADMINISTRATORS_GROUP_NAME unset ARO_APPLICATION_NAME unset ARO_CLUSTER_DOMAIN_NAME unset ARO_CLUSTER_NAME unset ARO_CLUSTER_VISIBILITY_API unset ARO_CLUSTER_VISIBILITY_INGRESS unset ARO_CLUSTER_VM_MASTER_SIZE unset ARO_CLUSTER_VM_WORKER_COUNT unset ARO_CLUSTER_VM_WORKER_DISK_GB unset ARO_CLUSTER_VM_WORKER_SIZE unset ARO_DOMAIN_NAME unset ARO_LOCATION_NAME unset ARO_REDHAT_PULL_SECRET_DIR unset ARO_REDHAT_PULL_SECRET_FILE unset ARO_RESOURCE_GROUP_NAME unset ARO_SERVICE_PRINCIPAL_NAME unset ARO_SERVICE_PRINCIPAL_PASSWORD unset ARO_SUBNET_AGW_CIDR unset ARO_SUBNET_AGW_NAME unset ARO_SUBNET_AGW_NSG_NAME unset ARO_SUBNET_DB_CIDR unset ARO_SUBNET_DB_NAME unset ARO_SUBNET_DB_NSG_NAME unset ARO_SUBNET_DMZ_CIDR unset ARO_SUBNET_DMZ_NAME unset ARO_SUBNET_DMZ_NSG_NAME unset ARO_SUBNET_MASTER_CIDR unset ARO_SUBNET_MASTER_NAME unset ARO_SUBNET_MASTER_NSG_NAME unset ARO_SUBNET_POD_CIDR unset ARO_SUBNET_SERVICE_CIDR unset ARO_SUBNET_TRUSTED_CIDR unset ARO_SUBNET_TRUSTED_NAME unset ARO_SUBNET_TRUSTED_NSG_NAME unset ARO_SUBNET_VGW_CIDR unset ARO_SUBNET_VGW_NAME unset ARO_SUBNET_VGW_POOL_CIDR unset ARO_SUBNET_VGW_POOL_NAME unset ARO_SUBNET_VGW_POOL_NSG_NAME unset ARO_SUBNET_WORKER_CIDR unset ARO_SUBNET_WORKER_NAME unset ARO_SUBNET_WORKER_NSG_NAME unset ARO_SUBSCRIPTION_ID unset ARO_SUBSCRIPTION_NAME unset ARO_TENANT_ID unset ARO_TENANT_NAME unset ARO_VGW_NAME unset ARO_VGW_PKI_BITS unset ARO_VGW_PKI_CLIENT unset ARO_VGW_PKI_CLIENT_CRT_FILE unset ARO_VGW_PKI_CLIENT_EXT_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_CLIENT_NAME unset ARO_VGW_PKI_CLIENT_PFX_FILE unset ARO_VGW_PKI_CLIENT_REQ_FILE unset ARO_VGW_PKI_CLIENT_SERIAL_FILE unset ARO_VGW_PKI_DIR unset ARO_VGW_PKI_ROOT_CA_SERIAL_FILE unset ARO_VGW_PKI_ROOT_CRT_FILE unset ARO_VGW_PKI_ROOT_CRT_NAME unset ARO_VGW_PKI_ROOT_KEY_FILE unset ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_ROOT_KEY_NAME unset ARO_VGW_PUBLIC_ADDRESS_NAME unset ARO_VGW_REDUNDANCY unset ARO_VGW_SKU unset ARO_VGW_TYPE unset ARO_VM_JUMP_ADMIN_NAME unset ARO_VM_JUMP_IMAGE_MARKETPLACE unset ARO_VM_JUMP_IMAGE_URN unset ARO_VM_JUMP_NAME unset ARO_VM_JUMP_PUBLIC_ADDRESS_NAME unset ARO_VM_JUMP_SIZE unset ARO_VNET_CIDR unset ARO_VNET_NAME","title":"4.1 - Unset Environment Variables"},{"location":"preview/#42-set-environment-variables","text":"The following bash shell environment variables are required. They are reused for multiple steps. It is recommended that the environment variables be maintained in a configuration file, i.e. ipm.env Maintaining a configuration file will make them easier to use and update. Important Before proceeding, please take your time ensuring the environment variable values are correct. These are example values that must be changed. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): cat \"ipm.env\" && source \"ipm.env\" Example Output: # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done'","title":"4.2 - Set Environment Variables"},{"location":"preview/#43-verify-environment-variables","text":"Ensure the ARO variables are avaialble in the bash shell environment that you're working in. Reference(s): https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=ipm ARO_ADMINISTRATORS_GROUP_NAME=OpenShift Administrators ARO_APPLICATION_NAME=ipm-app ARO_CLUSTER_DOMAIN_NAME=ipm.mitaei.net ARO_CLUSTER_NAME=ipm-cluster ARO_CLUSTER_VISIBILITY_API=Private ARO_CLUSTER_VISIBILITY_INGRESS=Private ARO_CLUSTER_VM_MASTER_SIZE=Standard_D8s_v3 ARO_CLUSTER_VM_WORKER_COUNT=3 ARO_CLUSTER_VM_WORKER_DISK_GB=128 ARO_CLUSTER_VM_WORKER_SIZE=Standard_D8s_v3 ARO_DOMAIN_NAME=mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SERVICE_PRINCIPAL_NAME=http://ipm-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBNET_AGW_CIDR=10.10.11.0/24 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_CIDR=10.10.12.0/24 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_POD_CIDR=10.12.0.0/14 ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_CIDR=10.10.10.0/24 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 ARO_SUBNET_VGW_POOL_NAME=ipm-vnet-vpn-pool-subnet ARO_SUBNET_VGW_POOL_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_CIDR=10.10.0.0/16 ARO_VNET_NAME=ipm-vnet","title":"4.3 - Verify Environment Variables"},{"location":"preview/#5-required-directories","text":"This documentation provides commands that create files. To better organize the output files, the directories must exist or be created. Command(s): env | egrep \"ARO.*DIR\" | sort -V Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki","title":"5 - Required Directories"},{"location":"preview/#51-create-required-directories","text":"Reference(s): https://man7.org/linux/man-pages/man1/mkdir.1.html Command(s): mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: + success does not produce any output","title":"5.1 - Create Required Directories"},{"location":"preview/#52-verify-required-directories","text":"Reference(s): https://man7.org/linux/man-pages/man1/ls.1.html Command(s): ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: drwxrws---+ 2 jtingiris mit 24 Sep 26 22:34 /home/jtingiris/prj/mit/aei/pki drwxrws---+ 2 jtingiris mit 4096 Sep 26 11:51 /home/jtingiris/prj/mit/aei/secrets","title":"5.2 - Verify Required Directories"},{"location":"preview/#6-azure-cli","text":"The Azure CLI is a Command Line Interface (CLI) used to create and manage Azure resources. The Azure CLI works with all Azure services. It is designed to more quickly work with Azure, with an emphasis on automation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest Command(s): which az Example Output: /usr/bin/az","title":"6 - Azure CLI"},{"location":"preview/#61-install-azure-cli","text":"The Azure CLI is available to install on Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. Note To install the Azure CLI, please follow the link in the Reference(s) section. Reference(s): https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Command(s): az --version Example Output: azure-cli 2.12.0 core 2.12.0 telemetry 1.0.6 Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Your CLI is up-to-date. Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy","title":"6.1 - Install Azure CLI"},{"location":"preview/#62-subscription-owner-login","text":"The Azure Subscription Owner must perform the remaining steps in this documentation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Command(s): az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net","title":"6.2 - Subscription Owner Login"},{"location":"preview/#63-verify-azure-tenant","text":"One way to verify the Azure Tenant is to obtain the Tenant ID with az. Another way is to login to the Azure AAD portal. The Tenant ID must match what is in the environment configuration file. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_show https://aad.portal.azure.com/ Command(s): az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi Example Output: [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ]","title":"6.3 - Verify Azure Tenant"},{"location":"preview/#64-set-default-subscription","text":"Set the default subscription that the ARO resources will be installed in. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_set Command(s): az account set -s \"${ARO_SUBSCRIPTION_NAME}\" Example Output: + success does not produce any output","title":"6.4 - Set Default Subscription"},{"location":"preview/#65-verify-default-subscription","text":"The Azure CLI Default Subscription will be used to provision all ARO resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Command(s): az account list --query '[?isDefault == `true`]' Example Output: [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ]","title":"6.5 - Verify Default Subscription"},{"location":"preview/#7-subscription-owners","text":"There should be at least two (2) Subscription Owners. This step is optional, but recommended. It will use the ${ARO_SUBSCRIPTION_OWNERS} environment value and ensure all User Principal Names (UPNs) are added as Subscription Owners. Reference(s): https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner","title":"7 - Subscription Owners"},{"location":"preview/#71-create-subscription-owners","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create Command(s): for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"name\": \"c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"principalId\": \"52f7dd5d-ad08-4b40-878f-40686c51c24e\", \"principalName\": \"christy.walsh@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"name\": \"0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" }","title":"7.1 - Create Subscription Owners"},{"location":"preview/#72-verify-subscription-owners","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Principal Role Scope -------------------------- ------ --------------------------------------------------- christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"7.2 - Verify Subscription Owners"},{"location":"preview/#8-subscription-details","text":"Uze az to verify Azure Subscription details. The subscription may also be manually verified via the Azure Portal Subscription blade. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest Command(s): env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" Example Output: ARO_LOCATION_NAME=eastus ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_SUBSCRIPTION_OWNERS=christy.walsh@mitaei.net joseph.tingiris@mitaei.net ARO_VERIFY_QUOTA_NAMES=Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs","title":"8 - Subscription Details"},{"location":"preview/#81-verify-subscription-name","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade Command(s): az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi Example Output: Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ]","title":"8.1 - Verify Subscription Name"},{"location":"preview/#82-verify-subscription-id","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show Command(s): az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi Example Output: [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ]","title":"8.2 - Verify Subscription ID"},{"location":"preview/#83-verify-subscription-location","text":"Note Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable location for the installation. The location name will be used throughout this document. Reference(s): https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Command(s): az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi Example Output: Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US","title":"8.3 - Verify Subscription Location"},{"location":"preview/#84-verify-subscription-limits","text":"An ARO cluster uses several Microsoft Azure components. It requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. The Azure subscription and service limits, quotas, and constraints may be insufficient to install ARO. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. It is wise to check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. ARO minimum limits are required for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html Command(s): if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi Example Output: + success does not produce any output","title":"8.4 - Verify Subscription Limits"},{"location":"preview/#85-verify-subscription-quotas","text":"Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner must do this step. Important To increase the quota limits, a support case must be opened with Microsoft. They will communicate directly to the person who requested the increase. An increase in the VM series quotas will automatically increase the total regional vCPU limit by the same amount. Links to Microsoft's directions on how to request a quota increase are provided in the Reference(s) section. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Verify subscription quotas for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests Command(s): for ARO_VERIFY_QUOTA_NAME in \"${ARO_VERIFY_QUOTA_NAMES[@]}\"; do echo \"ARO_VERIFY_QUOTA_NAME=${ARO_VERIFY_QUOTA_NAME}\"; done; unset ARO_VERIFY_QUOTA_NAMES Example Output: ARO_VERIFY_QUOTA_NAME=Standard DSv3 Family vCPUs ARO_VERIFY_QUOTA_NAME=Standard Dv2 Family vCPUs","title":"8.5 - Verify Subscription Quotas"},{"location":"preview/#9-openshift-administrators","text":"Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities. The details for how to use az to create users, groups, and add the necessary subscription roles is described below. Command(s): env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" Example Output: ARO_DOMAIN_NAME=mitaei.net ARO_ADMINISTRATORS=openshift-admin@mitaei.net arun.babu@mitaei.net joseph.tingiris@mitaei.net sivaprasad.k@mitaei.net","title":"9 - OpenShift Administrators"},{"location":"preview/#91-create-administrators","text":"This is a good time for the Global Administrator to create Microsoft accounts for the OpenShift Administrators. Ideally, the OpenShift Administrators would also have the Global Administrator role for the tenant. However, this is not always possible. If you are the Global Administrator then please take note that the OpenShift Administrators must have Microsoft accounts in the tenant , and their Microsoft accounts must have at least the Contributor and User Access Administrator roles for the Azure Subscription in which ARO is to be deployed. Creating users may be done with az , via the AAD portal, or [https://admin.microsoft.com]. Important The openshift-admin user created is an example and should not be used. We strongly recommend using real names and individual accounts, not ficticous names or group accounts. Command(s): az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login Example Output: { \"accountEnabled\": true, \"ageGroup\": null, \"assignedLicenses\": [], \"assignedPlans\": [], \"city\": null, \"companyName\": null, \"consentProvidedForMinor\": null, \"country\": null, \"createdDateTime\": null, \"creationType\": null, \"deletionTimestamp\": null, \"department\": null, \"dirSyncEnabled\": null, \"displayName\": \"openshift-admin@mitaei.net\", \"employeeId\": null, \"facsimileTelephoneNumber\": null, \"givenName\": null, \"immutableId\": null, \"isCompromised\": null, \"jobTitle\": null, \"lastDirSyncTime\": null, \"legalAgeGroupClassification\": null, \"mail\": null, \"mailNickname\": \"openshift-admin\", \"mobile\": null, \"objectId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"objectType\": \"User\", \"odata.metadata\": \"https://graph.windows.net/25fe96e7-85ec-4e6a-b93f-779b16ff751d/$metadata#directoryObjects/@Element\", \"odata.type\": \"Microsoft.DirectoryServices.User\", \"onPremisesDistinguishedName\": null, \"onPremisesSecurityIdentifier\": null, \"otherMails\": [], \"passwordPolicies\": null, \"passwordProfile\": { \"enforceChangePasswordPolicy\": false, \"forceChangePasswordNextLogin\": true, \"password\": null }, \"physicalDeliveryOfficeName\": null, \"postalCode\": null, \"preferredLanguage\": null, \"provisionedPlans\": [], \"provisioningErrors\": [], \"proxyAddresses\": [], \"refreshTokensValidFromDateTime\": \"2020-09-27T02:58:50.8444883Z\", \"showInAddressList\": null, \"signInNames\": [], \"sipProxyAddress\": null, \"state\": null, \"streetAddress\": null, \"surname\": null, \"telephoneNumber\": null, \"thumbnailPhoto@odata.mediaEditLink\": \"directoryObjects/95ccd40a-9c98-4d4f-9846-eaed016e3ef9/Microsoft.DirectoryServices.User/thumbnailPhoto\", \"usageLocation\": null, \"userIdentities\": [], \"userPrincipalName\": \"openshift-admin@mitaei.net\", \"userState\": null, \"userStateChangedOn\": null, \"userType\": \"Member\" }","title":"9.1 - Create Administrators"},{"location":"preview/#92-verify-administrators","text":"Verify the OpenShift Administrator accounts listed in ${ARO_ADMINISTRATORS} exist. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done Example Output: [ { \"userPrincipalName\": \"openshift-admin@mitaei.net\" }, { \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\" } ] [ { \"userPrincipalName\": \"arun.babu@mitaei.net\" }, { \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\" } ] [ { \"userPrincipalName\": \"joseph.tingiris@mitaei.net\" }, { \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\" } ] [ { \"userPrincipalName\": \"sivaprasad.k@mitaei.net\" }, { \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\" } ]","title":"9.2 - Verify Administrators"},{"location":"preview/#93-create-administrator-roles","text":"The Contributor and User Access Administrator subscription roles are required to administer ARO. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/00c1ec40-d6b3-40b0-b784-41c9ab6250f5\", \"name\": \"00c1ec40-d6b3-40b0-b784-41c9ab6250f5\", \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/e25a7a15-d599-4cb7-8593-c34c6d31b448\", \"name\": \"e25a7a15-d599-4cb7-8593-c34c6d31b448\", \"principalId\": \"95ccd40a-9c98-4d4f-9846-eaed016e3ef9\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/8f458612-ca5f-4ff2-832a-d00e700975b0\", \"name\": \"8f458612-ca5f-4ff2-832a-d00e700975b0\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/7f1ba7da-c858-489f-a988-39123faa181f\", \"name\": \"7f1ba7da-c858-489f-a988-39123faa181f\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/6f98e077-c161-453d-a903-b00acb9bd5f2\", \"name\": \"6f98e077-c161-453d-a903-b00acb9bd5f2\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"name\": \"91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/1bf7b433-935b-4160-a634-43bd291739c8\", \"name\": \"1bf7b433-935b-4160-a634-43bd291739c8\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"name\": \"13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" }","title":"9.3 - Create Administrator Roles"},{"location":"preview/#94-verify-administrator-roles","text":"Verify all ${ARO_ADMINISTRATORS} have the Contributor and User Access Administrator subscription roles. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done Example Output: Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- openshift-admin@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 openshift-admin@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"9.4 - Verify Administrator Roles"},{"location":"preview/#10-resource-providers","text":"Make sure you are logged in to Azure via az az login and have the Contributor or Owner role. Warning These steps will fail with only the User Access Administrator role. An unauthorized message will be received. These steps will fail without the --wait flag. Dependent providers are automatically registered and they must be registered first. Reference(s): https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types Command(s): echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" Example Output: ARO_RESOURCE_PROVIDERS=Microsoft.Compute Microsoft.RedHatOpenShift Microsoft.Storage","title":"10 - Resource Providers"},{"location":"preview/#101-register-provider-microsoftcompute","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Compute --wait Example Output: + success does not produce any output","title":"10.1 - Register Provider Microsoft.Compute"},{"location":"preview/#102-verify-provider-microsoftcompute","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Compute --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered","title":"10.2 - Verify Provider Microsoft.Compute"},{"location":"preview/#103-register-provider-microsoftredhatopenshift","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.RedHatOpenShift --wait Example Output: + success does not produce any output","title":"10.3 - Register Provider Microsoft.RedHatOpenShift"},{"location":"preview/#104-verify-provider-microsoftredhatopenshift","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.RedHatOpenShift --output table Example Output: Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered","title":"10.4 - Verify Provider Microsoft.RedHatOpenShift"},{"location":"preview/#105-register-provider-microsoftstorage","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Storage --wait Example Output: + success does not produce any output","title":"10.5 - Register Provider Microsoft.Storage"},{"location":"preview/#106-verify-provider-microsoftstorage","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Storage --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered","title":"10.6 - Verify Provider Microsoft.Storage"},{"location":"preview/#11-resource-group","text":"An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest Command(s): env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' Example Output: ARO_LOCATION_NAME=eastus ARO_RESOURCE_GROUP_NAME=ipm-eastus","title":"11 - Resource Group"},{"location":"preview/#111-create-resource-group","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Command(s): az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"11.1 - Create Resource Group"},{"location":"preview/#112-verify-resource-group","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Command(s): az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"11.2 - Verify Resource Group"},{"location":"preview/#12-virtual-network","text":"An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Command(s): env | grep ^ARO_VNET | sort -V Example Output: ARO_VNET_CIDR=10.10.0.0/16 ARO_VNET_NAME=ipm-vnet","title":"12 - Virtual Network"},{"location":"preview/#121-create-virtual-network","text":"In addition to the VNet CIDR, to be able to route to the Service & POD CIDRs then include them as address prefixes too. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_CIDR} ${ARO_SUBNET_SERVICE_CIDR} ${ARO_SUBNET_POD_CIDR} Example Output: { \"newVNet\": { \"addressSpace\": { \"addressPrefixes\": [ \"10.10.0.0/16\", \"10.11.0.0/16\", \"10.12.0.0/14\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"3fe1740b-d54f-4543-bd34-eb70a25c3285\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"e6da571b-7213-4fa5-ad7b-9164be85e48a\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] } }","title":"12.1 - Create Virtual Network"},{"location":"preview/#122-verify-virtual-network","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Command(s): az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: { \"addressSpace\": { \"addressPrefixes\": [ \"10.10.0.0/16\", \"10.11.0.0/16\", \"10.12.0.0/14\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"3fe1740b-d54f-4543-bd34-eb70a25c3285\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"e6da571b-7213-4fa5-ad7b-9164be85e48a\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] }","title":"12.2 - Verify Virtual Network"},{"location":"preview/#13-openshift-subnets","text":"Before installing, Azure Red Hat OpenShift clusters require manually creating a virtual network with two empty subnets for the master and worker VMs. Additionally, the Pod & Service subnets will automatically assigned during the installation. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Important Pod and Service Network CIDRs are configurable. Workers and masters must be in different subnets. Workers and masters virtual network subnets should be minimum /27. Pod CIDR should be minimum /18 in size. The pod network is non-routable IPs, and is only used inside the OpenShift SDN. Each node is allocated /23 subnet (512 IPs) for its pods. This value cannot be changed. You cannot attach a pod to multiple networks. Note In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher_ ; Please see the references in this section for more details. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-create https://docs.microsoft.com/en-us/azure/openshift/concepts-networking https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://docs.openshift.com/aro/4/networking/understanding-networking.html https://tools.ietf.org/html/rfc1918 Command(s): env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V Example Output: ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg","title":"13 - OpenShift Subnets"},{"location":"preview/#131-verify-openshift-cluster","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_show Command(s): az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --output table 2> /dev/null; if [ $? -eq 0 ]; then echo \"ERROR! ARO cluster ${ARO_CLUSTER_NAME} exists; do not recreate the master or worker subnets\"; fi Example Output: + success does not produce any output","title":"13.1 - Verify OpenShift Cluster"},{"location":"preview/#132-create-master-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --address-prefixes ${ARO_SUBNET_MASTER_CIDR} --service-endpoints Microsoft.ContainerRegistry Example Output: { \"addressPrefix\": \"10.10.0.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"a4a4f3f3-7031-4349-a4db-918e078ca7ad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-master-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"13.2 - Create Master Subnet"},{"location":"preview/#133-disable-master-subnet-private-link-service","text":"This is required to be able to connect and manage the cluster. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_update https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet update --name ${ARO_SUBNET_MASTER_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --disable-private-link-service-network-policies true Example Output: { \"addressPrefix\": \"10.10.0.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"9611966b-4097-4d4f-bc93-b42cc963488a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-master-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Disabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"13.3 - Disable Master Subnet Private Link Service"},{"location":"preview/#134-verify-master-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.0.0/23 ipm-vnet-master-subnet Enabled Disabled Succeeded ipm-eastus","title":"13.4 - Verify Master Subnet"},{"location":"preview/#135-create-worker-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --address-prefixes ${ARO_SUBNET_WORKER_CIDR} --service-endpoints Microsoft.ContainerRegistry Example Output: { \"addressPrefix\": \"10.10.2.0/23\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"5ab0e900-d3cf-4f86-a3d8-c447f29eb66c\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-worker-subnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": [ { \"locations\": [ \"*\" ], \"provisioningState\": \"Succeeded\", \"service\": \"Microsoft.ContainerRegistry\" } ], \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"13.5 - Create Worker Subnet"},{"location":"preview/#136-verify-worker-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.2.0/23 ipm-vnet-worker-subnet Enabled Enabled Succeeded ipm-eastus","title":"13.6 - Verify Worker Subnet"},{"location":"preview/#14-network-security-groups","text":"An Azure Network Security Group (NSG) filters network traffic to and from Azure resources in an Azure virtual network. An NSG contains security rules that allow/deny network traffic to/from several types of Azure resources. Note The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Command(s): env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg","title":"14 - Network Security Groups"},{"location":"preview/#141-create-network-security-groups","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_create Command(s): az network nsg create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} Example Output: { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"9a1dec9f-4adf-43c4-8401-7f5fe1fedaad\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-agw-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"be4701a3-7c2d-492a-a689-adc40198cba7\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"54c747c1-0cd8-49b4-b623-ad0a53342f9a\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-db-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"a58d572b-dfba-4a3e-b95e-a7c131b01f62\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"7152f348-c858-4b09-9a4e-f6963fc67291\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-dmz-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"ed09e48f-c160-4d63-ad0c-a6df53b6e9eb\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } } { \"NewNSG\": { \"defaultSecurityRules\": [ { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowVnetInBound\", \"name\": \"AllowVnetInBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow inbound traffic from azure load balancer\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowAzureLoadBalancerInBound\", \"name\": \"AllowAzureLoadBalancerInBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"AzureLoadBalancer\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all inbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/DenyAllInBound\", \"name\": \"DenyAllInBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\", \"destinationAddressPrefix\": \"VirtualNetwork\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowVnetOutBound\", \"name\": \"AllowVnetOutBound\", \"priority\": 65000, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"VirtualNetwork\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Allow\", \"description\": \"Allow outbound traffic from all VMs to Internet\", \"destinationAddressPrefix\": \"Internet\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/AllowInternetOutBound\", \"name\": \"AllowInternetOutBound\", \"priority\": 65001, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" }, { \"access\": \"Deny\", \"description\": \"Deny all outbound traffic\", \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"*\", \"destinationPortRanges\": [], \"direction\": \"Outbound\", \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg/defaultSecurityRules/DenyAllOutBound\", \"name\": \"DenyAllOutBound\", \"priority\": 65500, \"protocol\": \"*\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/defaultSecurityRules\" } ], \"etag\": \"W/\\\"b420118b-11d2-490f-b07c-b6201dc54b50\\\"\", \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg\", \"location\": \"eastus\", \"name\": \"ipm-vnet-trusted-subnet-nsg\", \"networkInterfaces\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"b415518e-9aa4-447c-abbe-80ebea22c62b\", \"securityRules\": [], \"subnets\": null, \"tags\": null, \"type\": \"Microsoft.Network/networkSecurityGroups\" } }","title":"14.1 - Create Network Security Groups"},{"location":"preview/#142-verify-network-security-groups","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_show Command(s): az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo Example Output: Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-agw-subnet-nsg Succeeded ipm-eastus be4701a3-7c2d-492a-a689-adc40198cba7 Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ---------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-db-subnet-nsg Succeeded ipm-eastus a58d572b-dfba-4a3e-b95e-a7c131b01f62 Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-dmz-subnet-nsg Succeeded ipm-eastus ed09e48f-c160-4d63-ad0c-a6df53b6e9eb Location Name ProvisioningState ResourceGroup ResourceGuid ---------- --------------------------- ------------------- --------------- ------------------------------------ eastus ipm-vnet-trusted-subnet-nsg Succeeded ipm-eastus b415518e-9aa4-447c-abbe-80ebea22c62b","title":"14.2 - Verify Network Security Groups"},{"location":"preview/#15-network-security-group-rules","text":"Network Security Group (NSG) Rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows an NSG to be stateful. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Command(s): env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg","title":"15 - Network Security Group Rules"},{"location":"preview/#151-create-dmz-nsg-rule-allowssh","text":"To be able to access the Jump Server (jumpbox) via the Internet, without a VPN setup, tcp port 22 must be opened for ssh. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_create Command(s): az network nsg rule create --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow Example Output: { \"access\": \"Allow\", \"description\": null, \"destinationAddressPrefix\": \"*\", \"destinationAddressPrefixes\": [], \"destinationApplicationSecurityGroups\": null, \"destinationPortRange\": \"22\", \"destinationPortRanges\": [], \"direction\": \"Inbound\", \"etag\": \"W/\\\"fafcaf82-35be-48e1-9461-561a4b71e119\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg/securityRules/AllowSSH\", \"name\": \"AllowSSH\", \"priority\": 1000, \"protocol\": \"Tcp\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"sourceAddressPrefix\": \"*\", \"sourceAddressPrefixes\": [], \"sourceApplicationSecurityGroups\": null, \"sourcePortRange\": \"*\", \"sourcePortRanges\": [], \"type\": \"Microsoft.Network/networkSecurityGroups/securityRules\" }","title":"15.1 - Create DMZ NSG Rule (AllowSSH)"},{"location":"preview/#152-verify-dmz-nsg-rules","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_show Command(s): az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table Example Output: Protocol SourcePortRange DestinationPortRange SourceAddressPrefix DestinationAddressPrefix Access Priority Direction ProvisioningState Name ResourceGroup ---------- ----------------- ---------------------- --------------------- -------------------------- -------- ---------- ----------- ------------------- -------- --------------- Tcp * 22 * * Allow 1000 Inbound Succeeded AllowSSH ipm-eastus","title":"15.2 - Verify DMZ NSG Rules"},{"location":"preview/#16-related-subnets","text":"IBM Product Manager requires related subnets for supplementary virtual machines, to host applications such as DB2. These subnets should be within the same resource group and VNet range previously defined. The network numbers should be IPv4 RFC1918 compliant and prefixed. These are the subnets used in this document, and the suggested CIDR prefixes for installing ARO and IPM. 10.10.0.0/16 - VNet 10.10.0.0/23 - Master 10.10.2.0/23 - Worker 10.10.10.0/24 - VPN Gateway (GatewaySubnet) 10.10.11.0/24 - Application Gateway 10.10.12.0/24 - Database 10.10.13.0/24 - DMZ 10.10.14.0/24 - Trusted 10.11.0.0/16 - Service 10.12.4.0/14 - Pod 172.16.13.0/24 - VPN Gateway (Pool) Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Command(s): env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V Example Output: ARO_SUBNET_AGW_CIDR=10.10.11.0/24 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_CIDR=10.10.12.0/24 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_POD_CIDR=10.12.0.0/14 ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg","title":"16 - Related Subnets"},{"location":"preview/#161-create-application-gateway-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --address-prefixes ${ARO_SUBNET_AGW_CIDR} --network-security-group=${ARO_SUBNET_AGW_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.11.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"e4ad09d4-d5f7-4a42-872f-8821dcd23248\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-agw-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-agw-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-agw-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"16.1 - Create Application Gateway Subnet"},{"location":"preview/#162-verify-application-gateway-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.11.0/24 ipm-vnet-agw-subnet Enabled Enabled Succeeded ipm-eastus","title":"16.2 - Verify Application Gateway Subnet"},{"location":"preview/#163-create-database-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --address-prefixes ${ARO_SUBNET_DB_CIDR} --network-security-group=${ARO_SUBNET_DB_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.12.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"2aa8c48d-8c85-4eee-98ff-19d5a5f9e6dd\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-db-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-db-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-db-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"16.3 - Create Database Subnet"},{"location":"preview/#164-verify-database-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------ -------------------------------- ----------------------------------- ------------------- --------------- 10.10.12.0/24 ipm-vnet-db-subnet Enabled Enabled Succeeded ipm-eastus","title":"16.4 - Verify Database Subnet"},{"location":"preview/#165-create-dmz-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --address-prefixes ${ARO_SUBNET_DMZ_CIDR} --network-security-group=${ARO_SUBNET_DMZ_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.13.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"026bbc03-cf38-45c8-b813-6283fe479fcc\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-dmz-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-dmz-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"16.5 - Create DMZ Subnet"},{"location":"preview/#166-verify-dmz-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.13.0/24 ipm-vnet-dmz-subnet Enabled Enabled Succeeded ipm-eastus","title":"16.6 - Verify DMZ Subnet"},{"location":"preview/#167-create-trusted-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_create Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --address-prefixes ${ARO_SUBNET_TRUSTED_CIDR} --network-security-group ${ARO_SUBNET_TRUSTED_NSG_NAME} Example Output: { \"addressPrefix\": \"10.10.14.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"40b5794b-9c55-4230-8f97-84ccda8b94e1\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-trusted-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"ipm-vnet-trusted-subnet\", \"natGateway\": null, \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-trusted-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"16.7 - Create Trusted Subnet"},{"location":"preview/#168-verify-trusted-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az_network_vnet_subnet_show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.14.0/24 ipm-vnet-trusted-subnet Enabled Enabled Succeeded ipm-eastus","title":"16.8 - Verify Trusted Subnet"},{"location":"preview/#17-jump-server-vm","text":"A jump server, jump host, or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example of a jump server is a host in a DMZ. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet. It will be allowed to communicate with the other internal subnets. The NSGs may be further tune to allow specific access, as it will be done for the ARO master subnet when ARO is installed. Note The jumpbox should be created prior to the VPN Gateway, so that there is at least one machine available for connectivity testing from two different security zones: Public (Internet) and Private (RFC1918). Reference(s): https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-cli-complete https://en.wikipedia.org/wiki/Jump_server https://en.wikipedia.org/wiki/DMZ Command(s): env | egrep ARO.*JUMP | sort -V Example Output: ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms","title":"17 - Jump Server VM"},{"location":"preview/#171-create-jump-server-address","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-create Command(s): az network public-ip create --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"Basic\" --allocation-method \"Dynamic\" Example Output: { \"publicIp\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"db3f0454-61e8-4b8d-840e-694b71e697a2\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"3ea50ce6-bb5b-41fe-94f6-9d95e8103cbe\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null } }","title":"17.1 - Create Jump Server Address"},{"location":"preview/#172-verify-jump-server-address","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"db3f0454-61e8-4b8d-840e-694b71e697a2\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"3ea50ce6-bb5b-41fe-94f6-9d95e8103cbe\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null }","title":"17.2 - Verify Jump Server Address"},{"location":"preview/#173-create-jump-server-nic","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_create Command(s): az network nic create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --vnet-name ${ARO_VNET_NAME} --subnet ${ARO_SUBNET_DMZ_NAME} --public-ip-address ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --network-security-group ${ARO_SUBNET_DMZ_NSG_NAME} Example Output: { \"NewNIC\": { \"dnsSettings\": { \"appliedDnsServers\": [], \"dnsServers\": [], \"internalDnsNameLabel\": null, \"internalDomainNameSuffix\": \"dnl3vzqtoksu5ll1sfsl3bperc.bx.internal.cloudapp.net\", \"internalFqdn\": null }, \"dscpConfiguration\": null, \"enableAcceleratedNetworking\": false, \"enableIpForwarding\": false, \"etag\": \"W/\\\"f1db4270-6f99-494b-bae8-c4077bb8c482\\\"\", \"hostedWorkloads\": [], \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic\", \"ipConfigurations\": [ { \"applicationGatewayBackendAddressPools\": null, \"applicationSecurityGroups\": null, \"etag\": \"W/\\\"f1db4270-6f99-494b-bae8-c4077bb8c482\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic/ipConfigurations/ipconfig1\", \"loadBalancerBackendAddressPools\": null, \"loadBalancerInboundNatRules\": null, \"name\": \"ipconfig1\", \"primary\": true, \"privateIpAddress\": \"10.10.13.4\", \"privateIpAddressVersion\": \"IPv4\", \"privateIpAllocationMethod\": \"Dynamic\", \"privateLinkConnectionProperties\": null, \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": null, \"ipAddress\": null, \"ipConfiguration\": null, \"ipTags\": null, \"location\": null, \"name\": null, \"provisioningState\": null, \"publicIpAddressVersion\": null, \"publicIpAllocationMethod\": null, \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"sku\": null, \"tags\": null, \"type\": null, \"zones\": null }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"addressPrefix\": null, \"addressPrefixes\": null, \"delegations\": null, \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-dmz-subnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": null, \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": null, \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": null, \"provisioningState\": null, \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null }, \"type\": \"Microsoft.Network/networkInterfaces/ipConfigurations\", \"virtualNetworkTaps\": null } ], \"location\": \"eastus\", \"macAddress\": null, \"name\": \"ipm-vm-jumpbox-nic\", \"networkSecurityGroup\": { \"defaultSecurityRules\": null, \"etag\": null, \"flowLogs\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkSecurityGroups/ipm-vnet-dmz-subnet-nsg\", \"location\": null, \"name\": null, \"networkInterfaces\": null, \"provisioningState\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": null, \"securityRules\": null, \"subnets\": null, \"tags\": null, \"type\": null }, \"primary\": null, \"privateEndpoint\": null, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"16debdd3-c550-4941-8c5c-729ed79686e7\", \"tags\": null, \"tapConfigurations\": [], \"type\": \"Microsoft.Network/networkInterfaces\", \"virtualMachine\": null } }","title":"17.3 - Create Jump Server NIC"},{"location":"preview/#174-verify-jump-server-nic","text":"A network interface enables an Azure Virtual Machine to communicate with internet, Azure, and on-premises resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_show https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface Command(s): az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table Example Output: EnableAcceleratedNetworking EnableIpForwarding Location Name ProvisioningState ResourceGroup ResourceGuid ----------------------------- -------------------- ---------- ------------------ ------------------- --------------- ------------------------------------ False False eastus ipm-vm-jumpbox-nic Succeeded ipm-eastus 16debdd3-c550-4941-8c5c-729ed79686e7","title":"17.4 - Verify Jump Server NIC"},{"location":"preview/#175-create-jump-server-as","text":"An Availability Set (AS) helps spread VMs across fault domains and update domains. It's best practice to use availability sets for VMs, to make it easier to expand in the future. Fault domains define a grouping of virtual machines that share a common power source and network switch. By default, the virtual machines that are configured within the availability set are separated across up to three fault domains. A hardware issue in one of these fault domains does not affect the VM. Update domains indicate groups of virtual machines and underlying physical hardware that can be rebooted at the same time. During planned maintenance, the order in which update domains are rebooted might not be sequential, but only one update domain is rebooted at a time. Azure automatically distributes VMs across the fault and update domains when placing them in an availability set. For more information, see managing the availability of VMs. Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create https://docs.microsoft.com/en-us/azure/virtual-machines/linux/manage-availability Command(s): az vm availability-set create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/availabilitySets/ipm-vm-jumpbox-as\", \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox-as\", \"platformFaultDomainCount\": 2, \"platformUpdateDomainCount\": 5, \"proximityPlacementGroup\": null, \"resourceGroup\": \"ipm-eastus\", \"sku\": { \"capacity\": null, \"name\": \"Aligned\", \"tier\": null }, \"statuses\": null, \"tags\": {}, \"type\": \"Microsoft.Compute/availabilitySets\", \"virtualMachines\": [] }","title":"17.5 - Create Jump Server AS"},{"location":"preview/#176-verify-jump-server-as","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_show Command(s): az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table Example Output: Location Name PlatformFaultDomainCount PlatformUpdateDomainCount ResourceGroup ---------- ----------------- -------------------------- --------------------------- --------------- eastus ipm-vm-jumpbox-as 2 5 ipm-eastus","title":"17.6 - Verify Jump Server AS"},{"location":"preview/#177-accept-jump-server-image-urn","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_accept https://docs.microsoft.com/en-us/azure/virtual-machines/windows/cli-ps-findimage Command(s): az vm image terms accept --urn ${ARO_VM_JUMP_IMAGE_URN} Example Output: { \"accepted\": true, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.MarketplaceOrdering/offerTypes/Microsoft.MarketplaceOrdering/offertypes/publishers/cognosys/offers/docker-ce-with-centos-8-0-free/plans/docker-ce-with-centos-8-0-free/agreements/current\", \"licenseTextLink\": \"https://storelegalterms.blob.core.windows.net/legalterms/3E5ED_legalterms_COGNOSYS%253a24DOCKER%253a2DCE%253a2DWITH%253a2DCENTOS%253a2D8%253a2D0%253a2DFREE%253a24DOCKER%253a2DCE%253a2DWITH%253a2DCENTOS%253a2D8%253a2D0%253a2DFREE%253a24T622IBUBKL6J3MHL5NUAWG2XNZ5H5FVSJGLCOC54LB63AGIONYH5CDZVDEYDONEFK2NHKCZROAP7ZU5PLZHXJ5ZNBFEUCBOWWMC4DSY.txt\", \"name\": \"docker-ce-with-centos-8-0-free\", \"plan\": \"docker-ce-with-centos-8-0-free\", \"privacyPolicyLink\": \"http://www.cogno-sys.com/cognosys-technologies-partners/privacy-policy/\", \"product\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"retrieveDatetime\": \"2020-09-27T03:03:24.6212864Z\", \"signature\": \"7TK6WC7YUSEVPL5URUWHBHRILKUK5JO6RZ5WSTOPBEKJ6QQTKWXNX5F627R4U3FMPQQTPDJIXNOJZEPSFH324RLHXNMZ3MSEOCJ7ZII\", \"type\": \"Microsoft.MarketplaceOrdering/offertypes\" }","title":"17.7 - Accept Jump Server Image URN"},{"location":"preview/#178-verify-jump-server-image-urn","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_show https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cognosys.docker-ce-with-centos-8-0-free?tab=Overview Command(s): az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Example Output: Accepted Name Plan Product Publisher ---------- ------------------------------ ------------------------------ ------------------------------ ----------- True docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free cognosys","title":"17.8 - Verify Jump Server Image URN"},{"location":"preview/#179-create-jump-server-vm","text":"An Azure Virtual Machines (VM) is one of several types of on-demand, scalable computing resources that Azure offers. An Azure VM gives you the flexibility of virtualization without having to buy and maintain the physical hardware that runs it. However, you still need to maintain the VM by performing tasks, such as configuring, patching, and installing the software that runs on it. Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_create https://docs.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-manage-vm https://docs.microsoft.com/en-us/azure/virtual-machines/linux/ Command(s): az vm create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --location ${ARO_LOCATION_NAME} --availability-set ${ARO_VM_JUMP_NAME}-as --nics ${ARO_VM_JUMP_NAME}-nic --image ${ARO_VM_JUMP_IMAGE_URN} --admin-username ${ARO_VM_JUMP_ADMIN_NAME} --size ${ARO_VM_JUMP_SIZE} --generate-ssh-keys Example Output: { \"fqdns\": \"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/virtualMachines/ipm-vm-jumpbox\", \"location\": \"eastus\", \"macAddress\": \"00-0D-3A-9E-B0-AB\", \"powerState\": \"VM running\", \"privateIpAddress\": \"10.10.13.4\", \"publicIpAddress\": \"40.88.33.248\", \"resourceGroup\": \"ipm-eastus\", \"zones\": \"\" }","title":"17.9 - Create Jump Server VM"},{"location":"preview/#1710-verify-jump-server-vm","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Command(s): az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} Example Output: 40.88.33.248 { \"additionalCapabilities\": null, \"availabilitySet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/availabilitySets/IPM-VM-JUMPBOX-AS\", \"resourceGroup\": \"ipm-eastus\" }, \"billingProfile\": null, \"diagnosticsProfile\": null, \"evictionPolicy\": null, \"extensionsTimeBudget\": null, \"hardwareProfile\": { \"vmSize\": \"Standard_B1ms\" }, \"host\": null, \"hostGroup\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Compute/virtualMachines/ipm-vm-jumpbox\", \"identity\": null, \"instanceView\": null, \"licenseType\": null, \"location\": \"eastus\", \"name\": \"ipm-vm-jumpbox\", \"networkProfile\": { \"networkInterfaces\": [ { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/networkInterfaces/ipm-vm-jumpbox-nic\", \"primary\": true, \"resourceGroup\": \"ipm-eastus\" } ] }, \"osProfile\": { \"adminPassword\": null, \"adminUsername\": \"ipm-vm-jumpbox-admin\", \"allowExtensionOperations\": true, \"computerName\": \"ipm-vm-jumpbox\", \"customData\": null, \"linuxConfiguration\": { \"disablePasswordAuthentication\": true, \"patchSettings\": { \"patchMode\": \"ImageDefault\" }, \"provisionVmAgent\": true, \"ssh\": { \"publicKeys\": [ { \"keyData\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDec9G5K26hxFj+Ha0gQChwhSW4fT6mlZrb0066h+moGMJKMJ2YiHMaNMUULFT8SkJch4KYjQfqgJE8YnSGRHPzmUWwF/v7AwcozIlwralduUdYNIScDnzaFCBa55pLQwCWIN7zXFCdtEG935XwaV+A+tOgokiGvGXMAUj/Dz0A5ClIhbD/i3dr2AFKuuSwMGpFc1EqZDh72ZsYTcDaZT5hhPPUCUyTqOfEJuWQYeE3DAuA1EoI2tmBQWNl2S1jtdHa/69BBAmA6t0MZXuMKpk0udzQjw/d6b64hKYHDDlfxaTEBnt1Vbd8Rv5bxJSI1y2QgCutRZwVa/dt1X71fwpAq4yr0H8JCrabKrIumgqyZ6VQyCTVu3AXZ3E/yMQmJhLK2RvPHrHp8DedZ3su62zvU9aUACyd6b89R6S4eYOmIE+nNG/M/yqS2Ru3GPUalsQXE5/auCsg6rPetxMNoEbZz5qTfJUfq3Xx61WQuLrAsyvEiIiM5rrgA/FhYbthxKKacYr0b6oi6HQW6KQ3JnPMm/QF2UxDxoNOG+NHi2UBfgiXLEHZQ3YnkS4QkB9aCK4YJyOJ5I/34gAGcUIPQ8nkUSky7btjsQlHNB6pHPI+8Xd2SntRmfgBwJwOUS+LqjK4OCCpkqUTSopXQ8vL8L/e2gw+8QIdTYe47/P0IG5zVQ== jtingiris@jt\\n\", \"path\": \"/home/ipm-vm-jumpbox-admin/.ssh/authorized_keys\" } ] } }, \"requireGuestProvisionSignal\": true, \"secrets\": [], \"windowsConfiguration\": null }, \"plan\": { \"name\": \"docker-ce-with-centos-8-0-free\", \"product\": \"docker-ce-with-centos-8-0-free\", \"promotionCode\": null, \"publisher\": \"cognosys\" }, \"priority\": null, \"provisioningState\": \"Succeeded\", \"proximityPlacementGroup\": null, \"resourceGroup\": \"ipm-eastus\", \"resources\": null, \"securityProfile\": null, \"storageProfile\": { \"dataDisks\": [], \"imageReference\": { \"exactVersion\": \"1.2019.0710\", \"id\": null, \"offer\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"sku\": \"docker-ce-with-centos-8-0-free\", \"version\": \"1.2019.0710\" }, \"osDisk\": { \"caching\": \"ReadWrite\", \"createOption\": \"FromImage\", \"diffDiskSettings\": null, \"diskSizeGb\": 30, \"encryptionSettings\": null, \"image\": null, \"managedDisk\": { \"diskEncryptionSet\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/IPM-EASTUS/providers/Microsoft.Compute/disks/ipm-vm-jumpbox_OsDisk_1_30aa79f1b3f44738b4fffb0818c1f500\", \"resourceGroup\": \"IPM-EASTUS\", \"storageAccountType\": \"Premium_LRS\" }, \"name\": \"ipm-vm-jumpbox_OsDisk_1_30aa79f1b3f44738b4fffb0818c1f500\", \"osType\": \"Linux\", \"vhd\": null, \"writeAcceleratorEnabled\": null } }, \"tags\": {}, \"type\": \"Microsoft.Compute/virtualMachines\", \"virtualMachineScaleSet\": null, \"vmId\": \"c6af84ea-fe96-4e23-a3ff-11770109f080\", \"zones\": null }","title":"17.10 - Verify Jump Server VM"},{"location":"preview/#1711-login-to-jump-server-vm","text":"Reference(s): https://man7.org/linux/man-pages/man1/ssh.1.html Command(s): export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\" Example Output: 40.88.33.248","title":"17.11 - Login to Jump Server VM"},{"location":"preview/#18-vpn-gateway","text":"A Virtual Private Network (VPN) Gateway is needed to connect to a private ARO cluster. It is a specific type of gateway that is used to send encrypted traffic between an Azure VNet and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. Reference(s): https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://docs.microsoft.com/en-us/azure/vpn-gateway/create-routebased-vpn-gateway-cli Command(s): env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V Example Output: ARO_SUBNET_VGW_CIDR=10.10.10.0/24 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 ARO_SUBNET_VGW_POOL_NAME=ipm-vnet-vpn-pool-subnet ARO_SUBNET_VGW_POOL_NSG_NAME=GatewaySubnet-nsg ARO_VGW_NAME=ipm-vpn ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased","title":"18 - VPN Gateway"},{"location":"preview/#181-create-vpn-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-create https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsub Command(s): az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --address-prefixes ${ARO_SUBNET_VGW_CIDR} Example Output: { \"addressPrefix\": \"10.10.10.0/24\", \"addressPrefixes\": null, \"delegations\": [], \"etag\": \"W/\\\"5719d87d-ccc4-4683-9638-12f7508a1950\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"ipAllocations\": null, \"ipConfigurationProfiles\": null, \"ipConfigurations\": null, \"name\": \"GatewaySubnet\", \"natGateway\": null, \"networkSecurityGroup\": null, \"privateEndpointNetworkPolicies\": \"Enabled\", \"privateEndpoints\": null, \"privateLinkServiceNetworkPolicies\": \"Enabled\", \"provisioningState\": \"Succeeded\", \"purpose\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceNavigationLinks\": null, \"routeTable\": null, \"serviceAssociationLinks\": null, \"serviceEndpointPolicies\": null, \"serviceEndpoints\": null, \"type\": \"Microsoft.Network/virtualNetworks/subnets\" }","title":"18.1 - Create VPN Subnet"},{"location":"preview/#182-verify-vpn-subnet","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table Example Output: AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.10.10.0/24 GatewaySubnet Enabled Enabled Succeeded ipm-eastus","title":"18.2 - Verify VPN Subnet"},{"location":"preview/#183-create-vpn-address","text":"The VPN Gateway requires a Public IP Address. Zone-redundant VPN gateways and zonal gateways both rely on the Azure public IP resource Standard SKU. The configuration of the Azure public IP resource determines whether the gateway that you deploy is zone-redundant, or zonal. If you create a public IP resource with a Basic SKU, the gateway will not have any zone redundancy, and the gateway resources will be regional. Note The public-ip --sku and --allocation-method may differ, depending on the needs of the VPN Gateway. Refer to the Reference(s) for details. A Redundant VPN Gateway is being created in this example. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az-network-public-ip-create https://docs.microsoft.com/en-us/azure/virtual-network/public-ip-addresses Command(s): az network public-ip create --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"${VPN_IP_SKU}\" --allocation-method \"${VPN_IP_ALLOCATION_METHOD}\" ${VPN_IP_ZONE} Example Output: { \"publicIp\": { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"c516d2ba-28fa-4259-a9fd-8e0220e9d7d9\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": \"20.55.32.58\", \"ipConfiguration\": null, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"ipm-vpn-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Static\", \"publicIpPrefix\": null, \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"8a54cef2-c31d-4b8d-ae52-b1dbbf9d6802\", \"sku\": { \"name\": \"Standard\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": [ \"1\" ] } }","title":"18.3 - Create VPN Address"},{"location":"preview/#184-verify-vpn-address","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: Name ResourceGroup Location Zones Address AddressVersion AllocationMethod IdleTimeoutInMinutes ProvisioningState ----------------- --------------- ---------- ------- ----------- ---------------- ------------------ ---------------------- ------------------- ipm-vpn-public-ip ipm-eastus eastus 1 20.55.32.58 IPv4 Static 4 Succeeded","title":"18.4 - Verify VPN Address"},{"location":"preview/#185-create-vpn-gateway","text":"There are two types of Azure VPN Gateways, the Classic and Resource Manager deployment models. Each virtual network can have only one VPN gateway. Note Creating a virtual network gateway can take up to 45 minutes to complete. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_create Command(s): az network vnet-gateway create --name ${ARO_VGW_NAME} --location ${ARO_LOCATION_NAME} --public-ip-address ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet ${ARO_VNET_NAME} --gateway-type VPN --sku ${ARO_VGW_SKU} --vpn-type ${ARO_VGW_TYPE} --address-prefixes ${ARO_SUBNET_VGW_POOL_CIDR} Example Output: { \"vnetGateway\": { \"activeActive\": false, \"bgpSettings\": { \"asn\": 65515, \"bgpPeeringAddress\": \"10.10.10.254\", \"bgpPeeringAddresses\": [ { \"customBgpIpAddresses\": [], \"defaultBgpIpAddresses\": [ \"10.10.10.254\" ], \"ipconfigurationId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"tunnelIpAddresses\": [ \"20.55.32.58\" ] } ], \"peerWeight\": 0 }, \"customRoutes\": null, \"enableBgp\": false, \"enableDnsForwarding\": null, \"enablePrivateIpAddress\": false, \"etag\": \"W/\\\"e794796d-23a5-40ea-b5d3-391b68595bfb\\\"\", \"gatewayDefaultSite\": null, \"gatewayType\": \"Vpn\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn\", \"inboundDnsForwardingEndpoint\": null, \"ipConfigurations\": [ { \"etag\": \"W/\\\"e794796d-23a5-40ea-b5d3-391b68595bfb\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"name\": \"vnetGatewayConfig0\", \"privateIpAddress\": null, \"privateIpAllocationMethod\": \"Dynamic\", \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"resourceGroup\": \"ipm-eastus\" }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"resourceGroup\": \"ipm-eastus\" }, \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\" } ], \"location\": \"eastus\", \"name\": \"ipm-vpn\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"20c26bff-2dad-4a88-8418-06ca4fa257af\", \"sku\": { \"capacity\": 2, \"name\": \"VpnGw1AZ\", \"tier\": \"VpnGw1AZ\" }, \"tags\": null, \"type\": \"Microsoft.Network/virtualNetworkGateways\", \"vpnClientConfiguration\": { \"aadAudience\": null, \"aadIssuer\": null, \"aadTenant\": null, \"radiusServerAddress\": null, \"radiusServerSecret\": null, \"radiusServers\": [], \"vpnClientAddressPool\": { \"addressPrefixes\": [ \"172.16.13.0/24\" ] }, \"vpnClientConnectionHealth\": { \"totalEgressBytesTransferred\": 0, \"totalIngressBytesTransferred\": 0, \"vpnClientConnectionsCount\": 0 }, \"vpnClientIpsecPolicies\": [], \"vpnClientProtocols\": [ \"IkeV2\", \"OpenVPN\" ], \"vpnClientRevokedCertificates\": [], \"vpnClientRootCertificates\": [] }, \"vpnGatewayGeneration\": \"Generation1\", \"vpnType\": \"RouteBased\" } }","title":"18.5 - Create VPN Gateway"},{"location":"preview/#186-verify-vpn-gateway","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: ActiveActive EnableBgp EnablePrivateIpAddress GatewayType Location Name ProvisioningState ResourceGroup ResourceGuid VpnGatewayGeneration VpnType -------------- ----------- ------------------------ ------------- ---------- ------- ------------------- --------------- ------------------------------------ ---------------------- ---------- False False False Vpn eastus ipm-vpn Succeeded ipm-eastus 20c26bff-2dad-4a88-8418-06ca4fa257af Generation1 RouteBased","title":"18.6 - Verify VPN Gateway"},{"location":"preview/#19-vpn-gateway-pki","text":"An Azure VPN Gateway supports using a Public Key Infrastructure (PKI) for Certificate Authentication. With VPN Gateway Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. This series of steps establishes a private Certificate Authority (CA) by creating a Root Key & Certificate. The Certificate Data wil be uploaded to the Azure VPN Gateway, so that VPN Clients Certificates will be authenticated. To be valid for authentication, the VPN Client Certificates must be signed by the Root Certificate. Note VPN Client Certificates will be created later. Reference(s): https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://en.wikipedia.org/wiki/Public_key_infrastructure https://en.wikipedia.org/wiki/Root_certificate Command(s): env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V Example Output: ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key","title":"19 - VPN Gateway PKI"},{"location":"preview/#191-create-root-key","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-genrsa.html Command(s): openssl genrsa -aes256 -out ${ARO_VGW_PKI_ROOT_KEY_FILE} -passout env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 Example Output: Generating RSA private key, 2048 bit long modulus (2 primes) ..+++++ .................+++++ e is 65537 (0x010001)","title":"19.1 - Create Root Key"},{"location":"preview/#192-verify-root-key","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 Example Output: + success does not produce any output","title":"19.2 - Verify Root Key"},{"location":"preview/#193-create-root-certificate","text":"This step creates a root certificate that is valid for 10 years (3650 days). Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -x509 -sha256 -new -key \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -out \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -days 3650 -subj /CN=\"${ARO_VGW_NAME}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 # 10 years Example Output: + success does not produce any output","title":"19.3 - Create Root Certificate"},{"location":"preview/#194-verify-root-certificate","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 Example Output: Certificate: Data: Version: 3 (0x2) Serial Number: 0c:bf:8d:e4:7e:9c:40:ab:ba:39:b9:42:98:7f:80:a4:5e:36:a7:3e Signature Algorithm: sha256WithRSAEncryption Issuer: CN = ipm-vpn Validity Not Before: Sep 27 03:28:52 2020 GMT Not After : Sep 25 03:28:52 2030 GMT Subject: CN = ipm-vpn Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:b3:82:e0:16:56:56:9b:c4:81:c4:a9:4d:67:b6: 3e:b4:1c:7c:38:2b:e8:f0:c0:23:5d:d2:d8:71:dc: 57:fb:e6:50:c8:f5:71:99:d0:36:b4:23:f2:4b:90: 1d:0a:7c:f3:0d:6f:81:2a:1d:07:81:65:19:45:de: e2:dc:a0:c8:c1:ad:61:b7:a5:a5:e4:78:68:03:ef: 07:59:f5:de:ff:ce:4b:5c:fc:f3:0a:45:89:90:28: 0d:49:c2:40:95:40:57:7e:5c:ac:f7:9c:ce:67:7d: f6:71:35:f9:85:dc:82:ad:9c:d5:af:0a:43:4e:e3: 61:d6:79:90:c0:02:55:37:ca:55:1a:26:ba:cf:05: 1f:c5:86:44:1a:54:d5:07:ba:38:b0:ca:5d:42:31: 3b:84:56:70:5b:f1:d4:39:17:be:8d:dc:25:cf:79: f9:fc:9d:61:59:46:fa:47:59:9a:bb:a3:20:4d:d7: c1:09:2b:4c:92:ae:2b:c4:f5:e0:3d:18:52:21:59: f3:6c:e0:51:3a:85:eb:de:5d:9d:2b:ed:e5:58:ef: 5a:39:c4:5f:80:41:00:c3:9f:fc:a9:f5:3c:ec:fe: 65:44:c4:5a:e6:5f:79:7a:fd:50:bf:c4:14:ef:12: 13:89:77:c9:5a:3f:52:10:4f:83:31:43:bc:3e:94: a8:33 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Authority Key Identifier: keyid:07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Basic Constraints: critical CA:TRUE Signature Algorithm: sha256WithRSAEncryption 97:dc:d1:bd:95:37:2c:97:e7:76:9b:bc:9d:e4:5d:d7:73:6e: 81:93:e4:87:02:77:ec:19:de:d4:c1:d4:d8:2b:32:6d:e3:89: fb:97:36:b6:01:62:8c:cf:e6:bd:ce:52:c1:03:c3:60:de:3f: 5b:da:4f:fd:6c:cd:0b:47:65:af:4e:e2:d1:07:84:6c:50:6a: f8:e4:41:3b:ce:ae:f8:b2:66:68:b0:ed:32:04:f2:2f:8d:98: 29:84:16:e7:a3:c4:ea:60:37:b6:0b:db:04:2a:d6:94:a4:aa: 80:eb:2d:14:ad:25:1e:3e:7d:1b:7a:72:1a:06:44:f8:e6:51: 02:3a:cf:36:6b:4b:d5:b4:6b:ee:1f:88:49:1a:22:06:39:ba: 3a:71:19:fa:34:e2:a9:c0:08:3e:25:91:64:1c:74:24:1a:4b: 06:3b:24:5e:62:89:6c:54:f3:b9:15:5b:5f:70:d6:d6:19:a1: eb:a3:52:db:35:53:cb:0b:6b:39:59:5a:23:d5:ed:ca:fc:44: 71:93:a7:66:7c:51:4d:4e:0f:f5:15:57:de:a1:09:2f:e6:23: 76:00:bf:68:d7:bd:7b:69:83:b5:0d:e8:bb:a1:fb:01:18:bf: 7e:39:30:94:02:27:29:ac:c9:f3:18:a2:50:55:e4:58:94:29: f6:1f:d4:24","title":"19.4 - Verify Root Certificate"},{"location":"preview/#195-verify-root-moduli","text":"Warning Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed until they match. Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum Example Output: md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key = 4103146f0ffed8dfb840bfd8f79963af - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.crt = 4103146f0ffed8dfb840bfd8f79963af -","title":"19.5 - Verify Root  Moduli"},{"location":"preview/#196-create-root-data","text":"The VPN Gateway requires knowledge of the Root Data. The Public certificate data must be uploaded to Azure in a specific format. In a previous step, the root certificate was created in the Privacy Enhanced Mail (PEM) format. PEM is the most common format for X.509 certificates. A PEM file is a text file containing one or more items, encoded in base64 ASCII, and identified by plain-text headers and footers PEM, an example: -----BEGIN CERTIFICATE----- DATA -----END CERTIFICATE----- DER files do NOT contain plain text headers . DER is a binary format for data structures described by ASN.1. Important The Azure VPN Gateway requires the Root Public certificate data use the Distinguished Encoding Rules (DER) format, encoded as base64 ASCII. The conversion from PEM to base64 DER is done by OpenSSL, in the Command(s). Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/root-cert?view=azure-cli-latest#az_network_vnet_gateway_root_cert_create https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail https://en.wikipedia.org/wiki/X.690#DER_encoding https://en.wikipedia.org/wiki/ASN.1 Command(s): az network vnet-gateway root-cert create --gateway-name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --name \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" --public-cert-data \"$(openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -outform der | base64 -w0)\" Example Output: { \"activeActive\": false, \"bgpSettings\": { \"asn\": 65515, \"bgpPeeringAddress\": \"10.10.10.254\", \"bgpPeeringAddresses\": [ { \"customBgpIpAddresses\": [], \"defaultBgpIpAddresses\": [ \"10.10.10.254\" ], \"ipconfigurationId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"tunnelIpAddresses\": [ \"20.55.32.58\" ] } ], \"peerWeight\": 0 }, \"customRoutes\": null, \"enableBgp\": false, \"enableDnsForwarding\": null, \"enablePrivateIpAddress\": false, \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"gatewayDefaultSite\": null, \"gatewayType\": \"Vpn\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn\", \"inboundDnsForwardingEndpoint\": null, \"ipConfigurations\": [ { \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/ipConfigurations/vnetGatewayConfig0\", \"name\": \"vnetGatewayConfig0\", \"privateIpAddress\": null, \"privateIpAllocationMethod\": \"Dynamic\", \"provisioningState\": \"Succeeded\", \"publicIpAddress\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/publicIPAddresses/ipm-vpn-public-ip\", \"resourceGroup\": \"ipm-eastus\" }, \"resourceGroup\": \"ipm-eastus\", \"subnet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/GatewaySubnet\", \"resourceGroup\": \"ipm-eastus\" }, \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\" } ], \"location\": \"eastus\", \"name\": \"ipm-vpn\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"20c26bff-2dad-4a88-8418-06ca4fa257af\", \"sku\": { \"capacity\": 2, \"name\": \"VpnGw1AZ\", \"tier\": \"VpnGw1AZ\" }, \"tags\": null, \"type\": \"Microsoft.Network/virtualNetworkGateways\", \"vpnClientConfiguration\": { \"aadAudience\": null, \"aadIssuer\": null, \"aadTenant\": null, \"radiusServerAddress\": null, \"radiusServerSecret\": null, \"radiusServers\": [], \"vpnClientAddressPool\": { \"addressPrefixes\": [ \"172.16.13.0/24\" ] }, \"vpnClientConnectionHealth\": { \"totalEgressBytesTransferred\": 0, \"totalIngressBytesTransferred\": 0, \"vpnClientConnectionsCount\": 0 }, \"vpnClientIpsecPolicies\": [], \"vpnClientProtocols\": [ \"IkeV2\", \"OpenVPN\" ], \"vpnClientRevokedCertificates\": [], \"vpnClientRootCertificates\": [ { \"etag\": \"W/\\\"521ee314-bc40-45ea-9f66-d30ced4626c3\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworkGateways/ipm-vpn/vpnClientRootCertificates/ipm-vpn-root.crt\", \"name\": \"ipm-vpn-root.crt\", \"provisioningState\": \"Succeeded\", \"publicCertData\": \"MIIDBTCCAe2gAwIBAgIUDL+N5H6cQKu6OblCmH+ApF42pz4wDQYJKoZIhvcNAQELBQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzI4NTJaFw0zMDA5MjUwMzI4NTJaMBIxEDAOBgNVBAMMB2lwbS12cG4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCzguAWVlabxIHEqU1ntj60HHw4K+jwwCNd0thx3Ff75lDI9XGZ0Da0I/JLkB0KfPMNb4EqHQeBZRlF3uLcoMjBrWG3paXkeGgD7wdZ9d7/zktc/PMKRYmQKA1JwkCVQFd+XKz3nM5nffZxNfmF3IKtnNWvCkNO42HWeZDAAlU3ylUaJrrPBR/FhkQaVNUHujiwyl1CMTuEVnBb8dQ5F76N3CXPefn8nWFZRvpHWZq7oyBN18EJK0ySrivE9eA9GFIhWfNs4FE6heveXZ0r7eVY71o5xF+AQQDDn/yp9Tzs/mVExFrmX3l6/VC/xBTvEhOJd8laP1IQT4MxQ7w+lKgzAgMBAAGjUzBRMB0GA1UdDgQWBBQH9gH+kGBq5556lD9irqEcbH9BWjAfBgNVHSMEGDAWgBQH9gH+kGBq5556lD9irqEcbH9BWjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCX3NG9lTcsl+d2m7yd5F3Xc26Bk+SHAnfsGd7UwdTYKzJt44n7lza2AWKMz+a9zlLBA8Ng3j9b2k/9bM0LR2WvTuLRB4RsUGr45EE7zq74smZosO0yBPIvjZgphBbno8TqYDe2C9sEKtaUpKqA6y0UrSUePn0benIaBkT45lECOs82a0vVtGvuH4hJGiIGObo6cRn6NOKpwAg+JZFkHHQkGksGOyReYolsVPO5FVtfcNbWGaHro1LbNVPLC2s5WVoj1e3K/ERxk6dmfFFNTg/1FVfeoQkv5iN2AL9o1717aYO1Dei7ofsBGL9+OTCUAicprMnzGKJQVeRYlCn2H9Qk\", \"resourceGroup\": \"ipm-eastus\", \"type\": \"Microsoft.Network/virtualNetworkGateways/vpnClientRootCertificates\" } ] }, \"vpnGatewayGeneration\": \"Generation1\", \"vpnType\": \"RouteBased\" }","title":"19.6 - Create Root Data"},{"location":"preview/#197-verify-root-data","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi Example Output: found ipm-vpn root certificate name = ipm-vpn-root.crt verified ipm-vpn-root.crt exists as a root certificate name for ipm-vpn","title":"19.7 - Verify Root Data"},{"location":"preview/#20-client-certificates","text":"VPN Clients must present an X.509 version 3 certificate when connecting. Each user should have their own bundle of certificate files. This step outlines a procedure to create them with OpenSSL v1.1.1. It will need to be re-run for everyone who requires connectivity. The Azure VPN Gateway supports both IKEv2 (ipsec) and OpenVPN (ssl) client connections. Various VPN client software support these technologies. It is most convenient to distribute a PKCS#12 file to the user, so they can connect to the VPN Gateway and access the private Azure Red Hat OpenShift cluster. In cryptography, PKCS #12 defines an archive file format for storing many cryptography objects as a single file. PKCS#12 evolved from Microsoft's Personal Information Exchange (PFX) standard and is used to exchange public and private objects. It is commonly used to bundle a private key with its X.509 certificate or to bundle all the members of a chain of trust. The terms PKCS #12 (pkcs12) and PFX (pfx) are often used interchangeably. Successful execution of the commands in this step depends upon the previously created VPN Gateway Root Certificate files and exported environment variables. Successful completion of the following steps will produce six (6) files, in this order: VPN Client Key (.key) VPN Client Certificate Request (.req) VPN Client Certificate Extensions (.ext) VPN Client Certificate (.crt) VPN Client Certificate Serial (.serial) VPN Client Certificate Bundle (.pfx) The resulting PFX file is should be given to the user.","title":"20 - Client Certificates"},{"location":"preview/#201-set-vpn-client-environment-variables","text":"These environment variables should be exported each time a new set of client certificate files are created. Important These are example values that must be changed for your installation. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' Example Output: + success does not produce any output","title":"20.1 - Set VPN Client Environment Variables"},{"location":"preview/#202-verify-vpn-client-environment-variables","text":"Reference(s): https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html Command(s): ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE Example Output: ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!!","title":"20.2 - Verify VPN Client Environment Variables"},{"location":"preview/#203-create-vpn-client-key","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-genrsa.html Command(s): openssl genrsa -aes256 -out \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passout env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 Example Output: Generating RSA private key, 2048 bit long modulus (2 primes) .........................................+++++ ...........+++++ e is 65537 (0x010001) + success does not produce any output","title":"20.3 - Create VPN Client Key"},{"location":"preview/#204-verify-vpn-client-key","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 Example Output: + success does not produce any output","title":"20.4 - Verify VPN Client Key"},{"location":"preview/#205-create-client-certificate-request","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -new -out \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -key \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -subj /CN=\"${ARO_VGW_PKI_CLIENT_NAME}\" 2>&1 Example Output: + success does not produce any output","title":"20.5 - Create Client Certificate Request"},{"location":"preview/#206-verify-client-certificate-request","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 Example Output: Certificate Request: Data: Version: 1 (0x0) Subject: CN = ipm-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:a8:dd:23:26:4e:ae:34:53:2a:f7:ed:52:b1:52: 80:eb:75:0d:76:d5:53:11:f2:f4:e9:a0:1b:2f:da: 7a:ee:63:c0:f1:d2:0d:8a:11:2a:7b:4c:11:7b:66: 04:3e:2a:2f:57:87:74:12:1e:fa:c8:ef:bb:69:76: 9d:a6:e4:8f:30:1f:6f:a3:dd:64:cd:b5:f8:ca:6c: 3e:ff:01:93:c8:ff:e4:e1:8a:63:7b:0c:ff:a0:73: d3:60:ad:53:29:46:b8:17:69:3d:17:06:40:b4:44: df:77:fc:7b:44:1e:4c:0e:02:fb:42:4e:a8:ab:55: 21:68:d0:45:7d:f3:5f:81:74:9a:8b:28:08:bd:d5: 8c:84:42:26:bc:fb:a4:c7:e9:2a:17:f6:b8:b2:2d: 44:34:ca:f1:f1:74:dc:16:3f:48:f7:93:3e:fd:21: a4:35:c1:bb:c6:0c:29:a5:6a:a4:ee:34:b4:e2:22: 23:c9:fa:63:16:2a:83:72:20:27:38:aa:56:a8:9f: 50:37:e8:a2:f8:8c:98:d7:6c:60:44:b7:76:95:65: 42:a5:bc:e3:49:bd:74:d2:59:8c:c4:35:eb:bd:ec: 86:97:f6:17:ab:76:a3:1a:ab:19:c3:cd:85:74:5a: 42:32:ff:2c:51:f3:34:9d:46:3f:97:ad:b8:b0:01: c1:c9 Exponent: 65537 (0x10001) Attributes: a0:00 Signature Algorithm: sha256WithRSAEncryption 6b:ec:e9:52:ef:76:ad:c6:49:ad:ed:19:83:ab:01:4c:0c:b5: b6:3c:e0:47:c4:89:af:79:99:fa:69:c9:32:b0:35:97:99:05: c6:ca:60:1d:1a:05:ba:30:9c:b3:8f:f5:8b:a3:ce:c7:af:4c: af:98:d0:82:1d:ca:ec:a3:18:f9:05:d1:e7:79:90:5a:77:f1: b2:4a:41:a2:43:48:d8:52:c2:4d:8b:f6:0f:26:8c:ef:ad:a7: 9c:14:49:b9:9f:ec:20:42:33:ea:12:78:0c:e9:98:a1:e7:bb: 81:b6:44:de:df:f3:63:b8:b6:ac:91:6a:5c:3d:5b:1b:a8:69: cf:d7:4e:21:5a:47:91:7f:e9:e1:6b:5b:ef:29:ee:75:dd:55: 81:ad:df:d7:4c:4c:77:e3:cf:8a:5c:ae:ec:c3:71:fc:b6:ce: f7:17:8a:1a:be:7e:a6:2f:85:a0:d5:16:eb:09:5e:7b:09:e9: a1:0e:d7:a2:55:a9:98:41:69:65:c3:70:ce:3d:04:ea:95:08: 39:a3:ff:c5:41:b2:8f:a9:fe:1b:ae:e5:df:0e:61:5f:90:2c: 35:d2:bb:41:e1:84:7a:54:e0:3d:c7:9d:1e:f5:15:37:a2:a7: 2a:d7:09:5f:4c:ec:e7:33:c7:34:0e:6b:b3:4f:e1:6e:7d:e3: d3:32:40:8d","title":"20.6 - Verify Client Certificate Request"},{"location":"preview/#207-create-client-certificate-extensions","text":"A Root Certificate Authority (CA) uses extensions to issue a certificate only for a specific purpose. Certificate Extensions were introduced in X.509 version 3 (X509v3). The Azure VPN Gateway requires specific Certificate Extensions on VPN Client certificates. More specificially, a VPN Client certificate must have the TLS Web Client Authentication (clientAuth) extended key usage (eku) extension. Additionally, X509v3 Subject Alternative Name (subjectAltName) must always be used per RFC 5280. This step creates a certificate extension file that OpenSSL will read when creating the certificate, and apply the proper extensions. Reference(s): https://tools.ietf.org/html/rfc5280 Command(s): echo \"authorityKeyIdentifier=keyid,issuer\" > \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"basicConstraints=CA:FALSE\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"extendedKeyUsage=clientAuth\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"subjectAltName=DNS:${ARO_VGW_PKI_CLIENT_NAME}\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: + success does not produce any output + success does not produce any output + success does not produce any output + success does not produce any output","title":"20.7 - Create Client Certificate Extensions"},{"location":"preview/#208-verify-client-certificate-extensions","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: authorityKeyIdentifier=keyid,issuer extendedKeyUsage=clientAuth","title":"20.8 - Verify Client Certificate Extensions"},{"location":"preview/#209-create-client-certificate","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -req -sha256 -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -CAkey \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -CA \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE -days 1095 -CAcreateserial -CAserial \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 2>&1 Example Output: Signature ok subject=CN = ipm-vpn-client-example Getting CA Private Key","title":"20.9 - Create Client Certificate"},{"location":"preview/#2010-verify-client-certificate","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 Example Output: Certificate: Data: Version: 3 (0x2) Serial Number: 24:ac:31:61:b3:c2:b6:a2:51:50:cb:f3:7f:36:c5:7b:fa:f0:77:d3 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = ipm-vpn Validity Not Before: Sep 27 03:31:32 2020 GMT Not After : Sep 27 03:31:32 2023 GMT Subject: CN = ipm-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:a8:dd:23:26:4e:ae:34:53:2a:f7:ed:52:b1:52: 80:eb:75:0d:76:d5:53:11:f2:f4:e9:a0:1b:2f:da: 7a:ee:63:c0:f1:d2:0d:8a:11:2a:7b:4c:11:7b:66: 04:3e:2a:2f:57:87:74:12:1e:fa:c8:ef:bb:69:76: 9d:a6:e4:8f:30:1f:6f:a3:dd:64:cd:b5:f8:ca:6c: 3e:ff:01:93:c8:ff:e4:e1:8a:63:7b:0c:ff:a0:73: d3:60:ad:53:29:46:b8:17:69:3d:17:06:40:b4:44: df:77:fc:7b:44:1e:4c:0e:02:fb:42:4e:a8:ab:55: 21:68:d0:45:7d:f3:5f:81:74:9a:8b:28:08:bd:d5: 8c:84:42:26:bc:fb:a4:c7:e9:2a:17:f6:b8:b2:2d: 44:34:ca:f1:f1:74:dc:16:3f:48:f7:93:3e:fd:21: a4:35:c1:bb:c6:0c:29:a5:6a:a4:ee:34:b4:e2:22: 23:c9:fa:63:16:2a:83:72:20:27:38:aa:56:a8:9f: 50:37:e8:a2:f8:8c:98:d7:6c:60:44:b7:76:95:65: 42:a5:bc:e3:49:bd:74:d2:59:8c:c4:35:eb:bd:ec: 86:97:f6:17:ab:76:a3:1a:ab:19:c3:cd:85:74:5a: 42:32:ff:2c:51:f3:34:9d:46:3f:97:ad:b8:b0:01: c1:c9 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Authority Key Identifier: keyid:07:F6:01:FE:90:60:6A:E7:9E:7A:94:3F:62:AE:A1:1C:6C:7F:41:5A X509v3 Basic Constraints: CA:FALSE X509v3 Extended Key Usage: TLS Web Client Authentication X509v3 Subject Alternative Name: DNS:ipm-vpn-client-example Signature Algorithm: sha256WithRSAEncryption 5a:8d:83:db:fe:c6:54:a7:9a:db:dc:6e:56:25:6c:79:1c:f0: 26:55:6c:41:3f:00:86:d8:12:96:6e:d7:0f:f0:67:7e:1f:08: 7a:f4:f4:0b:07:92:60:3b:df:5d:26:95:1b:b8:5f:18:19:01: e0:d1:d7:ed:5f:52:21:33:ef:c3:70:ab:86:34:2a:71:25:8c: ae:4c:c9:76:92:a6:c0:f4:c5:06:5f:b7:e1:8c:4a:2d:86:4f: a1:79:8d:94:2c:60:e9:a9:ab:69:b4:01:34:0b:99:63:ab:3f: 57:6c:49:9f:ed:d5:ed:0f:41:d8:af:2b:14:63:ae:b8:16:59: 93:06:35:b1:43:81:7c:c4:68:d2:08:48:ec:36:19:71:a9:ac: c9:c1:70:f5:6d:14:fd:6d:15:e2:d1:fb:86:b6:91:86:e9:3b: 1e:00:41:16:f3:95:49:98:86:30:7c:64:06:49:d1:27:94:b7: 5f:64:ce:46:5d:91:16:74:93:d4:c7:9c:ec:0f:a4:2e:32:80: 43:88:ee:12:33:2c:51:d9:a2:7e:cc:ff:b2:2f:c6:87:30:37: 89:bc:e7:ee:6b:8a:74:6f:e4:69:60:32:54:b3:ea:03:ef:a3: 37:ea:57:7f:fc:05:ef:ae:ce:cd:53:ea:4b:f9:95:b4:22:39: f5:75:01:d9","title":"20.10 - Verify Client Certificate"},{"location":"preview/#2011-verify-client-moduli","text":"Warning Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed until they match. Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_REQ_FILE} = \"; openssl req -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" | md5sum Example Output: md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key = 1ec497f88cbce7449554078dce627bb4 - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt = 1ec497f88cbce7449554078dce627bb4 - md5sum for /home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req = 1ec497f88cbce7449554078dce627bb4 -","title":"20.11 - Verify Client  Moduli"},{"location":"preview/#2012-create-vpn-client-pfx","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl pkcs12 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -inkey \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -passout pass: -certfile \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -export 2>&1 Example Output: + success does not produce any output","title":"20.12 - Create VPN Client PFX"},{"location":"preview/#2013-verify-vpn-client-pfx","text":"Reference(s): https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1 Example Output: Bag Attributes localKeyID: A0 FD 44 81 5B C9 B3 66 B8 F6 3E 4E 76 98 7E 26 32 7A D1 4B subject=CN = ipm-vpn-client-example issuer=CN = ipm-vpn -----BEGIN CERTIFICATE----- MIIDJzCCAg+gAwIBAgIUJKwxYbPCtqJRUMvzfzbFe/rwd9MwDQYJKoZIhvcNAQEL BQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzMxMzJaFw0yMzA5Mjcw MzMxMzJaMCExHzAdBgNVBAMMFmlwbS12cG4tY2xpZW50LWV4YW1wbGUwggEiMA0G CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCo3SMmTq40Uyr37VKxUoDrdQ121VMR 8vTpoBsv2nruY8Dx0g2KESp7TBF7ZgQ+Ki9Xh3QSHvrI77tpdp2m5I8wH2+j3WTN tfjKbD7/AZPI/+ThimN7DP+gc9NgrVMpRrgXaT0XBkC0RN93/HtEHkwOAvtCTqir VSFo0EV981+BdJqLKAi91YyEQia8+6TH6SoX9riyLUQ0yvHxdNwWP0j3kz79IaQ1 wbvGDCmlaqTuNLTiIiPJ+mMWKoNyICc4qlaon1A36KL4jJjXbGBEt3aVZUKlvONJ vXTSWYzENeu97IaX9herdqMaqxnDzYV0WkIy/yxR8zSdRj+XrbiwAcHJAgMBAAGj ZjBkMB8GA1UdIwQYMBaAFAf2Af6QYGrnnnqUP2KuoRxsf0FaMAkGA1UdEwQCMAAw EwYDVR0lBAwwCgYIKwYBBQUHAwIwIQYDVR0RBBowGIIWaXBtLXZwbi1jbGllbnQt ZXhhbXBsZTANBgkqhkiG9w0BAQsFAAOCAQEAWo2D2/7GVKea29xuViVseRzwJlVs QT8AhtgSlm7XD/Bnfh8IevT0CweSYDvfXSaVG7hfGBkB4NHX7V9SITPvw3CrhjQq cSWMrkzJdpKmwPTFBl+34YxKLYZPoXmNlCxg6amrabQBNAuZY6s/V2xJn+3V7Q9B 2K8rFGOuuBZZkwY1sUOBfMRo0ghI7DYZcamsycFw9W0U/W0V4tH7hraRhuk7HgBB FvOVSZiGMHxkBknRJ5S3X2TORl2RFnST1Mec7A+kLjKAQ4juEjMsUdmifsz/si/G hzA3ibzn7muKdG/kaWAyVLPqA++jN+pXf/wF767OzVPqS/mVtCI59XUB2Q== -----END CERTIFICATE----- Bag Attributes: <No Attributes> subject=CN = ipm-vpn issuer=CN = ipm-vpn -----BEGIN CERTIFICATE----- MIIDBTCCAe2gAwIBAgIUDL+N5H6cQKu6OblCmH+ApF42pz4wDQYJKoZIhvcNAQEL BQAwEjEQMA4GA1UEAwwHaXBtLXZwbjAeFw0yMDA5MjcwMzI4NTJaFw0zMDA5MjUw MzI4NTJaMBIxEDAOBgNVBAMMB2lwbS12cG4wggEiMA0GCSqGSIb3DQEBAQUAA4IB DwAwggEKAoIBAQCzguAWVlabxIHEqU1ntj60HHw4K+jwwCNd0thx3Ff75lDI9XGZ 0Da0I/JLkB0KfPMNb4EqHQeBZRlF3uLcoMjBrWG3paXkeGgD7wdZ9d7/zktc/PMK RYmQKA1JwkCVQFd+XKz3nM5nffZxNfmF3IKtnNWvCkNO42HWeZDAAlU3ylUaJrrP BR/FhkQaVNUHujiwyl1CMTuEVnBb8dQ5F76N3CXPefn8nWFZRvpHWZq7oyBN18EJ K0ySrivE9eA9GFIhWfNs4FE6heveXZ0r7eVY71o5xF+AQQDDn/yp9Tzs/mVExFrm X3l6/VC/xBTvEhOJd8laP1IQT4MxQ7w+lKgzAgMBAAGjUzBRMB0GA1UdDgQWBBQH 9gH+kGBq5556lD9irqEcbH9BWjAfBgNVHSMEGDAWgBQH9gH+kGBq5556lD9irqEc bH9BWjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCX3NG9lTcs l+d2m7yd5F3Xc26Bk+SHAnfsGd7UwdTYKzJt44n7lza2AWKMz+a9zlLBA8Ng3j9b 2k/9bM0LR2WvTuLRB4RsUGr45EE7zq74smZosO0yBPIvjZgphBbno8TqYDe2C9sE KtaUpKqA6y0UrSUePn0benIaBkT45lECOs82a0vVtGvuH4hJGiIGObo6cRn6NOKp wAg+JZFkHHQkGksGOyReYolsVPO5FVtfcNbWGaHro1LbNVPLC2s5WVoj1e3K/ERx k6dmfFFNTg/1FVfeoQkv5iN2AL9o1717aYO1Dei7ofsBGL9+OTCUAicprMnzGKJQ VeRYlCn2H9Qk -----END CERTIFICATE-----","title":"20.13 - Verify VPN Client PFX"},{"location":"preview/#21-vpn-client","text":"Please follow Microsoft's instructions for installing the VPN Client for your operating system. Tip Commands for using az and wget are given below. Reference(s): https://en.wikipedia.org/wiki/X.509 https://en.wikipedia.org/wiki/PKCS_12 https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-vpn-client-install-azure-cert https://www.openssl.org/ Command(s): env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V Example Output: ARO_KEY=ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_PKI_ROOT_KEY_NAME=ipm-vpn-root.key","title":"21 - VPN Client"},{"location":"preview/#211-verify-vpn-client-url","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/vpn-client?view=azure-cli-latest#az_network_vnet_gateway_vpn_client_generate Command(s): export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" Example Output: + success does not produce any output ARO_VGW_CONFIGURATION_URL=\"https://nfvprodsuppbl.blob.core.windows.net/vpnprofileimmutable/cf9d0077-d7e7-4c7f-aae7-7f15cc7d58d8/vpnprofile/c55a6b34-3e2f-4747-b19f-6c8ff8c5d22a/vpnclientconfiguration.zip?sv=2018-03-28&sr=b&sig=lt%2FYNiNekY3VCic3qMxtz772%2FyX30OuSiUD0NBZewU0%3D&st=2020-09-27T03%3A26%3A39Z&se=2020-09-27T04%3A26%3A39Z&sp=r&fileExtension=.zip\"","title":"21.1 - Verify VPN Client URL"},{"location":"preview/#212-download-vpn-client","text":"The necessary VPN Client Configuration files may be downloaded via the Azure porta or with the following commands. Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway/vpn-client?view=azure-cli-latest#az_network_vnet_gateway_vpn_client_generate Command(s): eval wget \"${ARO_VGW_CONFIGURATION_URL}\" -O \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 2>&1 Example Output: --2020-09-26 23:31:47-- https://nfvprodsuppbl.blob.core.windows.net/vpnprofileimmutable/cf9d0077-d7e7-4c7f-aae7-7f15cc7d58d8/vpnprofile/c55a6b34-3e2f-4747-b19f-6c8ff8c5d22a/vpnclientconfiguration.zip?sv=2018-03-28&sr=b&sig=lt%2FYNiNekY3VCic3qMxtz772%2FyX30OuSiUD0NBZewU0%3D&st=2020-09-27T03%3A26%3A39Z&se=2020-09-27T04%3A26%3A39Z&sp=r&fileExtension=.zip Resolving nfvprodsuppbl.blob.core.windows.net (nfvprodsuppbl.blob.core.windows.net)... 52.239.153.36 Connecting to nfvprodsuppbl.blob.core.windows.net (nfvprodsuppbl.blob.core.windows.net)|52.239.153.36|:443... connected. HTTP request sent, awaiting response... 200 OK Length: 303372 (296K) [application/octet-stream] Saving to: \u2018/home/jtingiris/prj/mit/aei/pki/ipm-vpn.zip\u2019 0K .......... .......... .......... .......... .......... 16% 1.01M 0s 50K .......... .......... .......... .......... .......... 33% 1.90M 0s 100K .......... .......... .......... .......... .......... 50% 92.1M 0s 150K .......... .......... .......... .......... .......... 67% 1.95M 0s 200K .......... .......... .......... .......... .......... 84% 50.7M 0s 250K .......... .......... .......... .......... ...... 100% 16.2M=0.1s 2020-09-26 23:31:47 (2.80 MB/s) - \u2018/home/jtingiris/prj/mit/aei/pki/ipm-vpn.zip\u2019 saved [303372/303372]","title":"21.2 - Download VPN Client"},{"location":"preview/#213-distribute-vpn-client-pfx","text":"","title":"21.3 - Distribute VPN Client &amp; PFX"},{"location":"preview/#22-obtain-pull-secrets","text":"Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries.","title":"22 - Obtain Pull Secrets"},{"location":"preview/#221-obtain-red-hat-pull-secret","text":"A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. To obtain a Red Hat pull secret, go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned Note This step must be done manually, via a web browser. It is optional though recommended. Important Make sure to update ${ARO_REDHAT_PULL_SECRET_FILE} with the path where the pull secret was saved. Reference(s): https://access.redhat.com/solutions/4844461","title":"22.1 - Obtain Red Hat Pull Secret"},{"location":"preview/#222-verify-red-hat-pull-secret","text":"Command(s): ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: -rw-rw----. 1 jtingiris mit 2835 Sep 12 10:26 /home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt","title":"22.2 - Verify Red Hat Pull Secret"},{"location":"preview/#23-azure-red-hat-openshift","text":"Reference(s): https://azure.microsoft.com/en-us/services/openshift/ https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest Command(s): env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V Example Output: ARO_CLUSTER_DOMAIN_NAME=ipm.mitaei.net ARO_CLUSTER_NAME=ipm-cluster ARO_CLUSTER_VISIBILITY_API=Private ARO_CLUSTER_VISIBILITY_INGRESS=Private ARO_CLUSTER_VM_MASTER_SIZE=Standard_D8s_v3 ARO_CLUSTER_VM_WORKER_COUNT=3 ARO_CLUSTER_VM_WORKER_DISK_GB=128 ARO_CLUSTER_VM_WORKER_SIZE=Standard_D8s_v3 ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_VNET_NAME=ipm-vnet","title":"23 - Azure Red Hat OpenShift"},{"location":"preview/#231-create-aro-cluster","text":"This can take up to an hour. Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_create https://docs.openshift.com/container-platform/4.4/installing/installing_azure/installing-azure-network-customizations.html#modifying-nwoperator-config-startup_installing-azure-network-customizations Command(s): az aro create --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --name \"${ARO_CLUSTER_NAME}\" --master-subnet \"${ARO_SUBNET_MASTER_NAME}\" --master-vm-size \"${ARO_CLUSTER_VM_MASTER_SIZE}\" --worker-subnet \"${ARO_SUBNET_WORKER_NAME}\" --worker-count ${ARO_CLUSTER_VM_WORKER_COUNT} --worker-vm-size \"${ARO_CLUSTER_VM_WORKER_SIZE}\" --worker-vm-disk-size-gb ${ARO_CLUSTER_VM_WORKER_DISK_GB} --apiserver-visibility \"${ARO_CLUSTER_VISIBILITY_INGRESS}\" --ingress-visibility \"${ARO_CLUSTER_VISIBILITY_API}\" --pod-cidr \"${ARO_SUBNET_POD_CIDR}\" --service-cidr \"${ARO_SUBNET_SERVICE_CIDR}\" --vnet \"${ARO_VNET_NAME}\" --pull-secret @\"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: { \"apiserverProfile\": { \"ip\": \"10.10.0.4\", \"url\": \"https://api.my4zz953.eastus.aroapp.io:6443/\", \"visibility\": \"Private\" }, \"clusterProfile\": { \"domain\": \"my4zz953\", \"pullSecret\": null, \"resourceGroupId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-my4zz953\", \"version\": \"4.4.17\" }, \"consoleProfile\": { \"url\": \"https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/\" }, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.RedHatOpenShift/openShiftClusters/ipm-cluster\", \"ingressProfiles\": [ { \"ip\": \"10.10.2.4\", \"name\": \"default\", \"visibility\": \"Private\" } ], \"location\": \"eastus\", \"masterProfile\": { \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, \"name\": \"ipm-cluster\", \"networkProfile\": { \"podCidr\": \"10.12.0.0/14\", \"serviceCidr\": \"10.11.0.0/16\" }, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"servicePrincipalProfile\": { \"clientId\": \"de8651b4-5479-47c4-8be4-0081ee8ae5d6\", \"clientSecret\": null }, \"tags\": null, \"type\": \"Microsoft.RedHatOpenShift/openShiftClusters\", \"workerProfiles\": [ { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus1\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus2\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus3\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" } ] }","title":"23.1 - Create ARO Cluster"},{"location":"preview/#232-verify-aro-cluster","text":"Command(s): az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" Example Output: https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/ { \"apiserverProfile\": { \"ip\": \"10.10.0.4\", \"url\": \"https://api.my4zz953.eastus.aroapp.io:6443/\", \"visibility\": \"Private\" }, \"clusterProfile\": { \"domain\": \"my4zz953\", \"pullSecret\": null, \"resourceGroupId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-my4zz953\", \"version\": \"4.4.17\" }, \"consoleProfile\": { \"url\": \"https://console-openshift-console.apps.my4zz953.eastus.aroapp.io/\" }, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.RedHatOpenShift/openShiftClusters/ipm-cluster\", \"ingressProfiles\": [ { \"ip\": \"10.10.2.4\", \"name\": \"default\", \"visibility\": \"Private\" } ], \"location\": \"eastus\", \"masterProfile\": { \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-master-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, \"name\": \"ipm-cluster\", \"networkProfile\": { \"podCidr\": \"10.12.0.0/14\", \"serviceCidr\": \"10.11.0.0/16\" }, \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"servicePrincipalProfile\": { \"clientId\": \"de8651b4-5479-47c4-8be4-0081ee8ae5d6\", \"clientSecret\": null }, \"tags\": null, \"type\": \"Microsoft.RedHatOpenShift/openShiftClusters\", \"workerProfiles\": [ { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus1\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus2\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" }, { \"count\": 1, \"diskSizeGb\": 128, \"name\": \"ipm-cluster-rvdxb-worker-eastus3\", \"subnetId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet/subnets/ipm-vnet-worker-subnet\", \"vmSize\": \"Standard_D8s_v3\" } ] } { \"kubeadminPassword\": \"TSx2J-LY56j-KznE7-SzIU3\", \"kubeadminUsername\": \"kubeadmin\" }","title":"23.2 - Verify ARO Cluster"},{"location":"preview/#24-openshift-cli","text":"The OpenShift CLI client oc simplifies working with Kubernetes and OpenShift clusters, offering a number of advantages over kubectl such as easy login, kube config file management, and access to developer tools. The kubectl binary is included for when strict Kubernetes compliance is necessary. Reference(s): https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_list_credentials https://docs.microsoft.com/en-us/cli/azure/aro?view=azure-cli-latest#az_aro_show https://cloud.redhat.com/openshift/install/azure/installer-provisioned https://docs.openshift.com/container-platform/4.4/cli_reference/openshift_cli/getting-started-cli.html","title":"24 - OpenShift CLI"},{"location":"preview/#241-install-openshift-cli","text":"Download the latest archive for Azure Red Hat OpenShift from here: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz After extracting the archive, move the oc and kubectl binaries to a location in the PATH, such as /usr/local/bin . To start a session with the OpenShift cluster, login. oc login [API_URL] Reference(s): https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz Command(s): wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -O /tmp/openshift-client-linux.tar.gz 2>&1 cd /tmp tar zxvf openshift-client-linux.tar.gz mv -f oc /usr/local/bin mv -f kubectl /usr/local/in Example Output: README.md oc kubectl","title":"24.1 - Install OpenShift CLI"},{"location":"preview/#242-verify-openshift-cli","text":"missing './help/Verify OpenShift CLI.md' Command(s): oc version kubectl version Example Output: Client Version: 4.5.11 Client Version: version.Info{Major:\"1\", Minor:\"18\", GitVersion:\"v1.18.2-0-g52c56ce\", GitCommit:\"d7f3ccf9a5bdc96ba92e31526cf014b3de4c46aa\", GitTreeState:\"clean\", BuildDate:\"2020-09-11T23:48:53Z\", GoVersion:\"go1.13.4\", Compiler:\"gc\", Platform:\"linux/amd64\"}","title":"24.2 - Verify OpenShift CLI"},{"location":"preview/#25-openshift-authentication","text":"missing './help/OpenShift Authentication.md' TODO","title":"25 - OpenShift Authentication"},{"location":"tldr/","text":"Azure Red Hat OpenShift for IBM Product Master [DRAFT] This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 10:58:30 PM EDT Too Long; Didn't Read This is a representation of only the commands from the index, using the example environment configuration file from section 4.2. All descriptions, references, and example outputs have been removed. 1 - Azure Tenant 1.1 - Create Microsoft Account 1.2 - Create Global Administrator 1.3 - Verify Admin Center Access 1.4 - Verify AAD License 2 - Azure Subscription 2.1 - Create Azure Subscription 3 - Operating System 3.1 - Verify Operating System uname -a 3.2 - Verify GNU bash bash --version 3.3 - Verify GNU awk awk --version 3.4 - Verify GNU coreutils base64 --version basename --version dirname --version sort --version head --version tail --version 3.5 - Verify GNU grep egrep --version 3.6 - Verify GNU wget wget --version 3.7 - Verify Browser firefox --version google-chrome --version 3.8 - Verify OpenSSL openssl version 4 - Environment Variables 4.1 - Unset Environment Variables for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done 4.2 - Set Environment Variables cat << 'EOF' > \"ipm.env\" # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done' EOF cat \"ipm.env\" && source \"ipm.env\" 4.3 - Verify Environment Variables env | grep ^ARO | sort -V 5 - Required Directories env | egrep \"ARO.*DIR\" | sort -V 5.1 - Create Required Directories mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" 6 - Azure CLI which az 6.1 - Install Azure CLI az --version 6.2 - Subscription Owner Login az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv 6.3 - Verify Azure Tenant az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi 6.4 - Set Default Subscription az account set -s \"${ARO_SUBSCRIPTION_NAME}\" 6.5 - Verify Default Subscription az account list --query '[?isDefault == `true`]' 7 - Subscription Owners 7.1 - Create Subscription Owners for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done 7.2 - Verify Subscription Owners az role assignment list --role Owner --output table 8 - Subscription Details env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" 8.1 - Verify Subscription Name az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi 8.2 - Verify Subscription ID az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi 8.3 - Verify Subscription Location az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi 8.4 - Verify Subscription Limits if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi 8.5 - Verify Subscription Quotas for ARO_VERIFY_QUOTA_NAME in \"${ARO_VERIFY_QUOTA_NAMES[@]}\"; do echo \"ARO_VERIFY_QUOTA_NAME=${ARO_VERIFY_QUOTA_NAME}\"; done; unset ARO_VERIFY_QUOTA_NAMES 8.6 - Standard DSv3 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 8.7 - Standard Dv2 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 9 - OpenShift Administrators env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" 9.1 - Create Administrators az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login 9.2 - Verify Administrators for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done 9.3 - Create Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done 9.4 - Verify Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done 10 - Resource Providers echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" 10.1 - Register Provider Microsoft.Compute az provider register -n Microsoft.Compute --wait 10.2 - Verify Provider Microsoft.Compute az provider show --namespace Microsoft.Compute --output table 10.3 - Register Provider Microsoft.RedHatOpenShift az provider register -n Microsoft.RedHatOpenShift --wait 10.4 - Verify Provider Microsoft.RedHatOpenShift az provider show --namespace Microsoft.RedHatOpenShift --output table 10.5 - Register Provider Microsoft.Storage az provider register -n Microsoft.Storage --wait 10.6 - Verify Provider Microsoft.Storage az provider show --namespace Microsoft.Storage --output table 11 - Resource Group env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' 11.1 - Create Resource Group az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} 11.2 - Verify Resource Group az group show --name ${ARO_RESOURCE_GROUP_NAME} 12 - Virtual Network env | grep ^ARO_VNET | sort -V 12.1 - Create Virtual Network az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_CIDR} ${ARO_SUBNET_SERVICE_CIDR} ${ARO_SUBNET_POD_CIDR} 12.2 - Verify Virtual Network az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} 13 - OpenShift Subnets env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V 13.1 - Verify OpenShift Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --output table 2> /dev/null; if [ $? -eq 0 ]; then echo \"ERROR! ARO cluster ${ARO_CLUSTER_NAME} exists; do not recreate the master or worker subnets\"; fi 13.2 - Create Master Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --address-prefixes ${ARO_SUBNET_MASTER_CIDR} --service-endpoints Microsoft.ContainerRegistry 13.3 - Disable Master Subnet Private Link Service az network vnet subnet update --name ${ARO_SUBNET_MASTER_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --disable-private-link-service-network-policies true 13.4 - Verify Master Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table 13.5 - Create Worker Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --address-prefixes ${ARO_SUBNET_WORKER_CIDR} --service-endpoints Microsoft.ContainerRegistry 13.6 - Verify Worker Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table 14 - Network Security Groups env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V 14.1 - Create Network Security Groups az network nsg create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} 14.2 - Verify Network Security Groups az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo 15 - Network Security Group Rules env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V 15.1 - Create DMZ NSG Rule (AllowSSH) az network nsg rule create --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow 15.2 - Verify DMZ NSG Rules az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table 16 - Related Subnets env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V 16.1 - Create Application Gateway Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --address-prefixes ${ARO_SUBNET_AGW_CIDR} --network-security-group=${ARO_SUBNET_AGW_NSG_NAME} 16.2 - Verify Application Gateway Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table 16.3 - Create Database Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --address-prefixes ${ARO_SUBNET_DB_CIDR} --network-security-group=${ARO_SUBNET_DB_NSG_NAME} 16.4 - Verify Database Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table 16.5 - Create DMZ Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --address-prefixes ${ARO_SUBNET_DMZ_CIDR} --network-security-group=${ARO_SUBNET_DMZ_NSG_NAME} 16.6 - Verify DMZ Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table 16.7 - Create Trusted Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --address-prefixes ${ARO_SUBNET_TRUSTED_CIDR} --network-security-group ${ARO_SUBNET_TRUSTED_NSG_NAME} 16.8 - Verify Trusted Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table 17 - Jump Server VM env | egrep ARO.*JUMP | sort -V 17.1 - Create Jump Server Address az network public-ip create --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"Basic\" --allocation-method \"Dynamic\" 17.2 - Verify Jump Server Address az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.3 - Create Jump Server NIC az network nic create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --vnet-name ${ARO_VNET_NAME} --subnet ${ARO_SUBNET_DMZ_NAME} --public-ip-address ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --network-security-group ${ARO_SUBNET_DMZ_NSG_NAME} 17.4 - Verify Jump Server NIC az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table 17.5 - Create Jump Server AS az vm availability-set create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as 17.6 - Verify Jump Server AS az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table 17.7 - Accept Jump Server Image URN az vm image terms accept --urn ${ARO_VM_JUMP_IMAGE_URN} 17.8 - Verify Jump Server Image URN az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table 17.9 - Create Jump Server VM az vm create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --location ${ARO_LOCATION_NAME} --availability-set ${ARO_VM_JUMP_NAME}-as --nics ${ARO_VM_JUMP_NAME}-nic --image ${ARO_VM_JUMP_IMAGE_URN} --admin-username ${ARO_VM_JUMP_ADMIN_NAME} --size ${ARO_VM_JUMP_SIZE} --generate-ssh-keys 17.10 - Verify Jump Server VM az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.11 - Login to Jump Server VM export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\" 18 - VPN Gateway env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V 18.1 - Create VPN Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --address-prefixes ${ARO_SUBNET_VGW_CIDR} 18.2 - Verify VPN Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table 18.3 - Create VPN Address az network public-ip create --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"${VPN_IP_SKU}\" --allocation-method \"${VPN_IP_ALLOCATION_METHOD}\" ${VPN_IP_ZONE} 18.4 - Verify VPN Address az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 18.5 - Create VPN Gateway az network vnet-gateway create --name ${ARO_VGW_NAME} --location ${ARO_LOCATION_NAME} --public-ip-address ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet ${ARO_VNET_NAME} --gateway-type VPN --sku ${ARO_VGW_SKU} --vpn-type ${ARO_VGW_TYPE} --address-prefixes ${ARO_SUBNET_VGW_POOL_CIDR} 18.6 - Verify VPN Gateway az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 19 - VPN Gateway PKI env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V 19.1 - Create Root Key openssl genrsa -aes256 -out ${ARO_VGW_PKI_ROOT_KEY_FILE} -passout env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 19.2 - Verify Root Key openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 19.3 - Create Root Certificate openssl req -x509 -sha256 -new -key \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -out \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -days 3650 -subj /CN=\"${ARO_VGW_NAME}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 # 10 years 19.4 - Verify Root Certificate openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 19.5 - Verify Root Moduli echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum 19.6 - Create Root Data az network vnet-gateway root-cert create --gateway-name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --name \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" --public-cert-data \"$(openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -outform der | base64 -w0)\" 19.7 - Verify Root Data AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi 20 - Client Certificates 20.1 - Set VPN Client Environment Variables export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' 20.2 - Verify VPN Client Environment Variables ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE 20.3 - Create VPN Client Key openssl genrsa -aes256 -out \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passout env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 20.4 - Verify VPN Client Key openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 20.5 - Create Client Certificate Request openssl req -new -out \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -key \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -subj /CN=\"${ARO_VGW_PKI_CLIENT_NAME}\" 2>&1 20.6 - Verify Client Certificate Request openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 20.7 - Create Client Certificate Extensions echo \"authorityKeyIdentifier=keyid,issuer\" > \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"basicConstraints=CA:FALSE\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"extendedKeyUsage=clientAuth\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"subjectAltName=DNS:${ARO_VGW_PKI_CLIENT_NAME}\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.8 - Verify Client Certificate Extensions grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.9 - Create Client Certificate openssl x509 -req -sha256 -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -CAkey \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -CA \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE -days 1095 -CAcreateserial -CAserial \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 2>&1 20.10 - Verify Client Certificate openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 20.11 - Verify Client Moduli echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum 20.12 - Create VPN Client PFX openssl pkcs12 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -inkey \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -passout pass: -certfile \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -export 2>&1 20.13 - Verify VPN Client PFX openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1 21 - VPN Client env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V 21.1 - Verify VPN Client URL export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" 21.2 - Download VPN Client eval wget \"${ARO_VGW_CONFIGURATION_URL}\" -O \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 2>&1 21.3 - Distribute VPN Client & PFX 22 - Obtain Pull Secrets 22.1 - Obtain Red Hat Pull Secret 22.2 - Verify Red Hat Pull Secret ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" 23 - Azure Red Hat OpenShift env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V 23.1 - Create ARO Cluster az aro create --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --name \"${ARO_CLUSTER_NAME}\" --master-subnet \"${ARO_SUBNET_MASTER_NAME}\" --master-vm-size \"${ARO_CLUSTER_VM_MASTER_SIZE}\" --worker-subnet \"${ARO_SUBNET_WORKER_NAME}\" --worker-count ${ARO_CLUSTER_VM_WORKER_COUNT} --worker-vm-size \"${ARO_CLUSTER_VM_WORKER_SIZE}\" --worker-vm-disk-size-gb ${ARO_CLUSTER_VM_WORKER_DISK_GB} --apiserver-visibility \"${ARO_CLUSTER_VISIBILITY_INGRESS}\" --ingress-visibility \"${ARO_CLUSTER_VISIBILITY_API}\" --pod-cidr \"${ARO_SUBNET_POD_CIDR}\" --service-cidr \"${ARO_SUBNET_SERVICE_CIDR}\" --vnet \"${ARO_VNET_NAME}\" --pull-secret @\"${ARO_REDHAT_PULL_SECRET_FILE}\" 23.2 - Verify ARO Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" 24 - OpenShift CLI 24.1 - Install OpenShift CLI wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -O /tmp/openshift-client-linux.tar.gz 2>&1 cd /tmp tar zxvf openshift-client-linux.tar.gz mv -f oc /usr/local/bin mv -f kubectl /usr/local/in 24.2 - Verify OpenShift CLI oc version kubectl version 25 - OpenShift Authentication","title":"TLDR"},{"location":"tldr/#azure-red-hat-openshift-for-ibm-product-master","text":"","title":"Azure Red Hat OpenShift for IBM Product Master"},{"location":"tldr/#draft","text":"This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 10:58:30 PM EDT","title":"[DRAFT]"},{"location":"tldr/#too-long-didnt-read","text":"This is a representation of only the commands from the index, using the example environment configuration file from section 4.2. All descriptions, references, and example outputs have been removed.","title":"Too Long; Didn't Read"},{"location":"tldr/#1-azure-tenant","text":"1.1 - Create Microsoft Account 1.2 - Create Global Administrator 1.3 - Verify Admin Center Access 1.4 - Verify AAD License","title":"1 - Azure Tenant"},{"location":"tldr/#2-azure-subscription","text":"2.1 - Create Azure Subscription","title":"2 - Azure Subscription"},{"location":"tldr/#3-operating-system","text":"3.1 - Verify Operating System uname -a 3.2 - Verify GNU bash bash --version 3.3 - Verify GNU awk awk --version 3.4 - Verify GNU coreutils base64 --version basename --version dirname --version sort --version head --version tail --version 3.5 - Verify GNU grep egrep --version 3.6 - Verify GNU wget wget --version 3.7 - Verify Browser firefox --version google-chrome --version 3.8 - Verify OpenSSL openssl version","title":"3 - Operating System"},{"location":"tldr/#4-environment-variables","text":"4.1 - Unset Environment Variables for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done 4.2 - Set Environment Variables cat << 'EOF' > \"ipm.env\" # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done' EOF cat \"ipm.env\" && source \"ipm.env\" 4.3 - Verify Environment Variables env | grep ^ARO | sort -V","title":"4 - Environment Variables"},{"location":"tldr/#5-required-directories","text":"env | egrep \"ARO.*DIR\" | sort -V 5.1 - Create Required Directories mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\"","title":"5 - Required Directories"},{"location":"tldr/#6-azure-cli","text":"which az 6.1 - Install Azure CLI az --version 6.2 - Subscription Owner Login az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv 6.3 - Verify Azure Tenant az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi 6.4 - Set Default Subscription az account set -s \"${ARO_SUBSCRIPTION_NAME}\" 6.5 - Verify Default Subscription az account list --query '[?isDefault == `true`]'","title":"6 - Azure CLI"},{"location":"tldr/#7-subscription-owners","text":"7.1 - Create Subscription Owners for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done 7.2 - Verify Subscription Owners az role assignment list --role Owner --output table","title":"7 - Subscription Owners"},{"location":"tldr/#8-subscription-details","text":"env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" 8.1 - Verify Subscription Name az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi 8.2 - Verify Subscription ID az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi 8.3 - Verify Subscription Location az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi 8.4 - Verify Subscription Limits if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi 8.5 - Verify Subscription Quotas for ARO_VERIFY_QUOTA_NAME in \"${ARO_VERIFY_QUOTA_NAMES[@]}\"; do echo \"ARO_VERIFY_QUOTA_NAME=${ARO_VERIFY_QUOTA_NAME}\"; done; unset ARO_VERIFY_QUOTA_NAMES 8.6 - Standard DSv3 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 8.7 - Standard Dv2 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi","title":"8 - Subscription Details"},{"location":"tldr/#9-openshift-administrators","text":"env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" 9.1 - Create Administrators az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login 9.2 - Verify Administrators for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done 9.3 - Create Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done 9.4 - Verify Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done","title":"9 - OpenShift Administrators"},{"location":"tldr/#10-resource-providers","text":"echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" 10.1 - Register Provider Microsoft.Compute az provider register -n Microsoft.Compute --wait 10.2 - Verify Provider Microsoft.Compute az provider show --namespace Microsoft.Compute --output table 10.3 - Register Provider Microsoft.RedHatOpenShift az provider register -n Microsoft.RedHatOpenShift --wait 10.4 - Verify Provider Microsoft.RedHatOpenShift az provider show --namespace Microsoft.RedHatOpenShift --output table 10.5 - Register Provider Microsoft.Storage az provider register -n Microsoft.Storage --wait 10.6 - Verify Provider Microsoft.Storage az provider show --namespace Microsoft.Storage --output table","title":"10 - Resource Providers"},{"location":"tldr/#11-resource-group","text":"env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' 11.1 - Create Resource Group az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} 11.2 - Verify Resource Group az group show --name ${ARO_RESOURCE_GROUP_NAME}","title":"11 - Resource Group"},{"location":"tldr/#12-virtual-network","text":"env | grep ^ARO_VNET | sort -V 12.1 - Create Virtual Network az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_CIDR} ${ARO_SUBNET_SERVICE_CIDR} ${ARO_SUBNET_POD_CIDR} 12.2 - Verify Virtual Network az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME}","title":"12 - Virtual Network"},{"location":"tldr/#13-openshift-subnets","text":"env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V 13.1 - Verify OpenShift Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --output table 2> /dev/null; if [ $? -eq 0 ]; then echo \"ERROR! ARO cluster ${ARO_CLUSTER_NAME} exists; do not recreate the master or worker subnets\"; fi 13.2 - Create Master Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --address-prefixes ${ARO_SUBNET_MASTER_CIDR} --service-endpoints Microsoft.ContainerRegistry 13.3 - Disable Master Subnet Private Link Service az network vnet subnet update --name ${ARO_SUBNET_MASTER_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --disable-private-link-service-network-policies true 13.4 - Verify Master Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table 13.5 - Create Worker Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --address-prefixes ${ARO_SUBNET_WORKER_CIDR} --service-endpoints Microsoft.ContainerRegistry 13.6 - Verify Worker Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table","title":"13 - OpenShift Subnets"},{"location":"tldr/#14-network-security-groups","text":"env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V 14.1 - Create Network Security Groups az network nsg create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} 14.2 - Verify Network Security Groups az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo","title":"14 - Network Security Groups"},{"location":"tldr/#15-network-security-group-rules","text":"env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V 15.1 - Create DMZ NSG Rule (AllowSSH) az network nsg rule create --resource-group ${ARO_RESOURCE_GROUP_NAME} --nsg-name ${ARO_SUBNET_DMZ_NSG_NAME} --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow 15.2 - Verify DMZ NSG Rules az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table","title":"15 - Network Security Group Rules"},{"location":"tldr/#16-related-subnets","text":"env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V 16.1 - Create Application Gateway Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --address-prefixes ${ARO_SUBNET_AGW_CIDR} --network-security-group=${ARO_SUBNET_AGW_NSG_NAME} 16.2 - Verify Application Gateway Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table 16.3 - Create Database Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --address-prefixes ${ARO_SUBNET_DB_CIDR} --network-security-group=${ARO_SUBNET_DB_NSG_NAME} 16.4 - Verify Database Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table 16.5 - Create DMZ Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --address-prefixes ${ARO_SUBNET_DMZ_CIDR} --network-security-group=${ARO_SUBNET_DMZ_NSG_NAME} 16.6 - Verify DMZ Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table 16.7 - Create Trusted Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --address-prefixes ${ARO_SUBNET_TRUSTED_CIDR} --network-security-group ${ARO_SUBNET_TRUSTED_NSG_NAME} 16.8 - Verify Trusted Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table","title":"16 - Related Subnets"},{"location":"tldr/#17-jump-server-vm","text":"env | egrep ARO.*JUMP | sort -V 17.1 - Create Jump Server Address az network public-ip create --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"Basic\" --allocation-method \"Dynamic\" 17.2 - Verify Jump Server Address az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.3 - Create Jump Server NIC az network nic create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --vnet-name ${ARO_VNET_NAME} --subnet ${ARO_SUBNET_DMZ_NAME} --public-ip-address ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --network-security-group ${ARO_SUBNET_DMZ_NSG_NAME} 17.4 - Verify Jump Server NIC az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table 17.5 - Create Jump Server AS az vm availability-set create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as 17.6 - Verify Jump Server AS az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table 17.7 - Accept Jump Server Image URN az vm image terms accept --urn ${ARO_VM_JUMP_IMAGE_URN} 17.8 - Verify Jump Server Image URN az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table 17.9 - Create Jump Server VM az vm create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --location ${ARO_LOCATION_NAME} --availability-set ${ARO_VM_JUMP_NAME}-as --nics ${ARO_VM_JUMP_NAME}-nic --image ${ARO_VM_JUMP_IMAGE_URN} --admin-username ${ARO_VM_JUMP_ADMIN_NAME} --size ${ARO_VM_JUMP_SIZE} --generate-ssh-keys 17.10 - Verify Jump Server VM az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.11 - Login to Jump Server VM export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\"","title":"17 - Jump Server VM"},{"location":"tldr/#18-vpn-gateway","text":"env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V 18.1 - Create VPN Subnet az network vnet subnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --address-prefixes ${ARO_SUBNET_VGW_CIDR} 18.2 - Verify VPN Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table 18.3 - Create VPN Address az network public-ip create --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --sku \"${VPN_IP_SKU}\" --allocation-method \"${VPN_IP_ALLOCATION_METHOD}\" ${VPN_IP_ZONE} 18.4 - Verify VPN Address az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 18.5 - Create VPN Gateway az network vnet-gateway create --name ${ARO_VGW_NAME} --location ${ARO_LOCATION_NAME} --public-ip-address ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet ${ARO_VNET_NAME} --gateway-type VPN --sku ${ARO_VGW_SKU} --vpn-type ${ARO_VGW_TYPE} --address-prefixes ${ARO_SUBNET_VGW_POOL_CIDR} 18.6 - Verify VPN Gateway az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table","title":"18 - VPN Gateway"},{"location":"tldr/#19-vpn-gateway-pki","text":"env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V 19.1 - Create Root Key openssl genrsa -aes256 -out ${ARO_VGW_PKI_ROOT_KEY_FILE} -passout env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 19.2 - Verify Root Key openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 19.3 - Create Root Certificate openssl req -x509 -sha256 -new -key \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -out \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -days 3650 -subj /CN=\"${ARO_VGW_NAME}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 # 10 years 19.4 - Verify Root Certificate openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 19.5 - Verify Root Moduli echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum 19.6 - Create Root Data az network vnet-gateway root-cert create --gateway-name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --name \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" --public-cert-data \"$(openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -outform der | base64 -w0)\" 19.7 - Verify Root Data AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi","title":"19 - VPN Gateway PKI"},{"location":"tldr/#20-client-certificates","text":"20.1 - Set VPN Client Environment Variables export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' 20.2 - Verify VPN Client Environment Variables ARO_VERIFY_VARIABLES=(ARO_VGW_NAME ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE 20.3 - Create VPN Client Key openssl genrsa -aes256 -out \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passout env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ${ARO_VGW_PKI_BITS} 2>&1 20.4 - Verify VPN Client Key openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 20.5 - Create Client Certificate Request openssl req -new -out \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -key \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -subj /CN=\"${ARO_VGW_PKI_CLIENT_NAME}\" 2>&1 20.6 - Verify Client Certificate Request openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 20.7 - Create Client Certificate Extensions echo \"authorityKeyIdentifier=keyid,issuer\" > \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"basicConstraints=CA:FALSE\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"extendedKeyUsage=clientAuth\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" echo \"subjectAltName=DNS:${ARO_VGW_PKI_CLIENT_NAME}\" >> \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.8 - Verify Client Certificate Extensions grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.9 - Create Client Certificate openssl x509 -req -sha256 -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -CAkey \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -CA \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE -days 1095 -CAcreateserial -CAserial \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 2>&1 20.10 - Verify Client Certificate openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 20.11 - Verify Client Moduli echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum 20.12 - Create VPN Client PFX openssl pkcs12 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -out \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -inkey \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE -passout pass: -certfile \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -export 2>&1 20.13 - Verify VPN Client PFX openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1","title":"20 - Client Certificates"},{"location":"tldr/#21-vpn-client","text":"env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V 21.1 - Verify VPN Client URL export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" 21.2 - Download VPN Client eval wget \"${ARO_VGW_CONFIGURATION_URL}\" -O \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 2>&1 21.3 - Distribute VPN Client & PFX","title":"21 - VPN Client"},{"location":"tldr/#22-obtain-pull-secrets","text":"22.1 - Obtain Red Hat Pull Secret 22.2 - Verify Red Hat Pull Secret ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\"","title":"22 - Obtain Pull Secrets"},{"location":"tldr/#23-azure-red-hat-openshift","text":"env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V 23.1 - Create ARO Cluster az aro create --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --name \"${ARO_CLUSTER_NAME}\" --master-subnet \"${ARO_SUBNET_MASTER_NAME}\" --master-vm-size \"${ARO_CLUSTER_VM_MASTER_SIZE}\" --worker-subnet \"${ARO_SUBNET_WORKER_NAME}\" --worker-count ${ARO_CLUSTER_VM_WORKER_COUNT} --worker-vm-size \"${ARO_CLUSTER_VM_WORKER_SIZE}\" --worker-vm-disk-size-gb ${ARO_CLUSTER_VM_WORKER_DISK_GB} --apiserver-visibility \"${ARO_CLUSTER_VISIBILITY_INGRESS}\" --ingress-visibility \"${ARO_CLUSTER_VISIBILITY_API}\" --pod-cidr \"${ARO_SUBNET_POD_CIDR}\" --service-cidr \"${ARO_SUBNET_SERVICE_CIDR}\" --vnet \"${ARO_VNET_NAME}\" --pull-secret @\"${ARO_REDHAT_PULL_SECRET_FILE}\" 23.2 - Verify ARO Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\"","title":"23 - Azure Red Hat OpenShift"},{"location":"tldr/#24-openshift-cli","text":"24.1 - Install OpenShift CLI wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -O /tmp/openshift-client-linux.tar.gz 2>&1 cd /tmp tar zxvf openshift-client-linux.tar.gz mv -f oc /usr/local/bin mv -f kubectl /usr/local/in 24.2 - Verify OpenShift CLI oc version kubectl version","title":"24 - OpenShift CLI"},{"location":"tldr/#25-openshift-authentication","text":"","title":"25 - OpenShift Authentication"},{"location":"wip-tldr/","text":"Too Long; Didn't Read This is a representation of only the commands from the index, using the example environment configuration file from section 4.2. All descriptions, references, and example outputs have been removed. Azure Red Hat OpenShift for IBM Product Master [DRAFT] This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 05:16:42 PM EDT 1 - Azure Tenant 1.1 - Create Microsoft Account 1.2 - Create Global Administrator 1.3 - Verify Admin Center Access 1.4 - Verify AAD License 2 - Azure Subscription 2.1 - Create Azure Subscription 3 - Operating System 3.1 - Verify Operating System uname -a 3.2 - Verify GNU bash bash --version 3.3 - Verify GNU awk awk --version 3.4 - Verify GNU coreutils base64 --version basename --version dirname --version sort --version head --version tail --version 3.5 - Verify GNU grep egrep --version 3.6 - Verify GNU wget wget --version 3.7 - Verify Browser firefox --version google-chrome --version 3.8 - Verify OpenSSL openssl version 4 - Environment Variables 4.1 - Unset Environment Variables for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done 4.2 - Set Environment Variables cat << 'EOF' > \"ipm.env\" # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet export ARO_SUBNET_VGW_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 export ARO_SUBNET_SERVICE_NAME=${ARO_VNET_NAME}-service-subnet export ARO_SUBNET_SERVICE_NSG_NAME=${ARO_SUBNET_SERVICE_NAME}-nsg # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 export ARO_SUBNET_POD_NAME=${ARO_VNET_NAME}-pod-subnet export ARO_SUBNET_POD_NSG_NAME=${ARO_SUBNET_POD_NAME}-nsg # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done' EOF cat \"ipm.env\" && source \"ipm.env\" 4.3 - Verify Environment Variables env | grep ^ARO | sort -V 5 - Required Directories env | egrep \"ARO.*DIR\" | sort -V 5.1 - Delete Required Directories rm -rf \"${ARO_VGW_PKI_DIR}\" rm -rf \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" 6 - Azure CLI which az 6.1 - Install Azure CLI az --version 6.2 - Subscription Owner Login az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv 6.3 - Verify Azure Tenant az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi 6.4 - Verify Default Subscription az account list --query '[?isDefault == `true`]' 7 - Subscription Owners 7.1 - Delete Subscription Owners 7.2 - Verify Subscription Owners az role assignment list --role Owner --output table 8 - Subscription Details env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" 8.1 - Verify Subscription Name az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi 8.2 - Verify Subscription ID az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi 8.3 - Verify Subscription Location az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi 8.4 - Verify Subscription Limits if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi 8.5 - Verify Subscription Quotas 8.6 - Standard DSv3 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 8.7 - Standard Dv2 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 9 - OpenShift Administrators env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" 9.1 - Delete Administrators 9.2 - Delete Administrator Roles 9.3 - Delete Administrator Group 9.4 - Verify Administrators for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done 9.5 - Verify Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done 10 - Resource Providers echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" 10.1 - Unregister Provider Microsoft.Compute 10.2 - Unregister Provider Microsoft.RedHatOpenShift 10.3 - Unregister Provider Microsoft.Storage 11 - Resource Group env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' 11.1 - Delete Resource Group delete_orphans az group delete --name ${ARO_RESOURCE_GROUP_NAME --yes 11.2 - Verify Resource Group az group show --name ${ARO_RESOURCE_GROUP_NAME} 12 - Virtual Network env | grep ^ARO_VNET | sort -V 12.1 - Delete Virtual Network az network vnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} 12.2 - Verify Virtual Network az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} 13 - OpenShift Subnets env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V 13.1 - Delete Master Subnet 13.2 - Delete Worker Subnet 13.3 - Verify Master Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table 13.4 - Verify Worker Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table 14 - Network Security Groups env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V 14.1 - Delete Network Security Groups az network nsg delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} 14.2 - Verify Network Security Groups az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_POD_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_SERVICE_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo 15 - Network Security Group Rules env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V 15.1 - Delete DMZ NSG Rule (AllowSSH) 15.2 - Verify DMZ NSG Rules az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table 16 - Related Subnets env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V 16.1 - Delete Application Gateway Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} 16.2 - Delete Database Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} 16.3 - Delete DMZ Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} 16.4 - Delete Trusted Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} 16.5 - Verify Application Gateway Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table 16.6 - Verify Database Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table 16.7 - Verify DMZ Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table 16.8 - Verify Trusted Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table 17 - Jump Server VM env | egrep ARO.*JUMP | sort -V 17.1 - Delete Jump Server VM az vm delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --yes 17.2 - Cancel Jump Server Image URN az vm image terms cancel --urn ${ARO_VM_JUMP_IMAGE_URN} 17.3 - Delete Jump Server AS az vm availability-set delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.4 - Delete Jump Server NIC az network nic delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic 17.5 - Delete Jump Server Address az network public-ip delete --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.6 - Verify Jump Server Address az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.7 - Verify Jump Server NIC az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table 17.8 - Verify Jump Server AS az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table 17.9 - Verify Jump Server Image URN az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table 17.10 - Verify Jump Server VM az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.11 - Login to Jump Server VM export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\" 18 - VPN Gateway env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V 18.1 - Delete VPN Gateway az network vnet-gateway delete --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 18.2 - Delete VPN Address az network public-ip delete --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 18.3 - Delete VPN Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} 18.4 - Verify VPN Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table 18.5 - Verify VPN Address az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 18.6 - Verify VPN Gateway az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 19 - VPN Gateway PKI env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V 19.1 - Delete Root Certificate rm -f \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" 19.2 - Delete Root Key rm -f \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" 19.3 - Verify Root Key openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 19.4 - Verify Root Certificate openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 19.5 - Verify Root Moduli echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum 19.6 - Verify Root Data AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi 20 - Client Certificates 20.1 - Set VPN Client Environment Variables export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' 20.2 - Verify VPN Client Environment Variables ARO_VERIFY_VARIABLES=(ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_NAME ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE 20.3 - Delete VPN Client Key rm -f \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" 20.4 - Delete Client Certificate Request rm -f \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" 20.5 - Delete Client Certificate Extensions rm -f \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.6 - Delete Client Certificate rm -f \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" 20.7 - Delete VPN Client Serial rm -f \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 20.8 - Delete VPN Client PFX rm \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" 20.9 - Verify VPN Client Key openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 20.10 - Verify Client Certificate Request openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 20.11 - Verify Client Certificate Extensions grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.12 - Verify Client Certificate openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 20.13 - Verify Client Moduli echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_REQ_FILE} = \"; openssl req -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" | md5sum 20.14 - Verify VPN Client PFX openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1 21 - VPN Client env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V 21.1 - Delete VPN Client rm -f \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 21.2 - Verify VPN Client URL export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\" 22 - Obtain Pull Secrets 22.1 - Obtain Red Hat Pull Secret 22.2 - Verify Red Hat Pull Secret ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" 23 - Azure Red Hat OpenShift env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V 23.1 - Delete ARO Cluster az aro delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_CLUSTER_NAME} --yes 23.2 - Verify ARO Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" 24 - OpenShift CLI 24.1 - Verify OpenShift CLI oc version kubectl version 25 - OpenShift Authentication","title":"Too Long; Didn't Read"},{"location":"wip-tldr/#too-long-didnt-read","text":"This is a representation of only the commands from the index, using the example environment configuration file from section 4.2. All descriptions, references, and example outputs have been removed.","title":"Too Long; Didn't Read"},{"location":"wip-tldr/#azure-red-hat-openshift-for-ibm-product-master","text":"","title":"Azure Red Hat OpenShift for IBM Product Master"},{"location":"wip-tldr/#draft","text":"This document is functional, though still in active development and undergoing frequent changes. Revision: Sat 26 Sep 2020 05:16:42 PM EDT","title":"[DRAFT]"},{"location":"wip-tldr/#1-azure-tenant","text":"1.1 - Create Microsoft Account 1.2 - Create Global Administrator 1.3 - Verify Admin Center Access 1.4 - Verify AAD License","title":"1 - Azure Tenant"},{"location":"wip-tldr/#2-azure-subscription","text":"2.1 - Create Azure Subscription","title":"2 - Azure Subscription"},{"location":"wip-tldr/#3-operating-system","text":"3.1 - Verify Operating System uname -a 3.2 - Verify GNU bash bash --version 3.3 - Verify GNU awk awk --version 3.4 - Verify GNU coreutils base64 --version basename --version dirname --version sort --version head --version tail --version 3.5 - Verify GNU grep egrep --version 3.6 - Verify GNU wget wget --version 3.7 - Verify Browser firefox --version google-chrome --version 3.8 - Verify OpenSSL openssl version","title":"3 - Operating System"},{"location":"wip-tldr/#4-environment-variables","text":"4.1 - Unset Environment Variables for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done 4.2 - Set Environment Variables cat << 'EOF' > \"ipm.env\" # NOTE: # # These variables may be set statically or dynamically. # # This example shows both, static and dynamic variables. # For the dynamic variables, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. # # Each of these are required. export ARO=ipm export ARO_DOMAIN_NAME=mitaei.net export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_DOMAIN_NAME=\"${ARO}.${ARO_DOMAIN_NAME}\" export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_CLUSTER_VISIBILITY_API=\"Private\" export ARO_CLUSTER_VISIBILITY_INGRESS=\"Private\" export ARO_CLUSTER_VM_MASTER_SIZE=\"Standard_D8s_v3\" export ARO_CLUSTER_VM_WORKER_COUNT=3 export ARO_CLUSTER_VM_WORKER_DISK_GB=128 export ARO_CLUSTER_VM_WORKER_SIZE=\"Standard_D8s_v3\" export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=${ARO_DOMAIN_NAME} # CIDRs # VNet - 10.10.0.0/16 export ARO_VNET_CIDR=10.10.0.0/16 export ARO_VNET_NAME=${ARO}-vnet # Master - 10.10.0.0/23 export ARO_SUBNET_MASTER_CIDR=10.10.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg # Worker - 10.10.2.0/23 export ARO_SUBNET_WORKER_CIDR=10.10.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # Unused - 10.10.4.0/23 # Unused - 10.10.6.0/23 # Unused - 10.10.8.0/23 # VPN Gateway - 10.10.10.0/24 export ARO_SUBNET_VGW_CIDR=10.10.10.0/24 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet export ARO_SUBNET_VGW_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # Application Gateway - 10.10.11.0/24 export ARO_SUBNET_AGW_CIDR=10.10.11.0/24 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg # Database - 10.10.12.0/24 export ARO_SUBNET_DB_CIDR=10.10.12.0/24 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg # DMZ - 10.10.13.0/24 export ARO_SUBNET_DMZ_CIDR=10.10.13.0/24 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg # Trusted 10.10.14.0/24 export ARO_SUBNET_TRUSTED_CIDR=10.10.14.0/24 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg # Service - 10.11.0.0/16 export ARO_SUBNET_SERVICE_CIDR=10.11.0.0/16 export ARO_SUBNET_SERVICE_NAME=${ARO_VNET_NAME}-service-subnet export ARO_SUBNET_SERVICE_NSG_NAME=${ARO_SUBNET_SERVICE_NAME}-nsg # Pod - 10.12.0.0/14 (must be /18 or larger) export ARO_SUBNET_POD_CIDR=10.12.0.0/14 export ARO_SUBNET_POD_NAME=${ARO_VNET_NAME}-pod-subnet export ARO_SUBNET_POD_NSG_NAME=${ARO_SUBNET_POD_NAME}-nsg # VPN Gateway Pool - 172.16.13.0/24 export ARO_SUBNET_VGW_POOL_CIDR=172.16.13.0/24 # this subnet cannot overlap with the VNet export ARO_SUBNET_VGW_POOL_NAME=${ARO_VNET_NAME}-vpn-pool-subnet export ARO_SUBNET_VGW_POOL_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_NAME}\" export ARO_VGW_PKI_ROOT_KEY_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@${ARO_DOMAIN_NAME}) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') # helpful aliases alias env_aro='env | grep ^ARO | sort -V' alias unset_aro='for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done' EOF cat \"ipm.env\" && source \"ipm.env\" 4.3 - Verify Environment Variables env | grep ^ARO | sort -V","title":"4 - Environment Variables"},{"location":"wip-tldr/#5-required-directories","text":"env | egrep \"ARO.*DIR\" | sort -V 5.1 - Delete Required Directories rm -rf \"${ARO_VGW_PKI_DIR}\" rm -rf \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\"","title":"5 - Required Directories"},{"location":"wip-tldr/#6-azure-cli","text":"which az 6.1 - Install Azure CLI az --version 6.2 - Subscription Owner Login az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv 6.3 - Verify Azure Tenant az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi 6.4 - Verify Default Subscription az account list --query '[?isDefault == `true`]'","title":"6 - Azure CLI"},{"location":"wip-tldr/#7-subscription-owners","text":"7.1 - Delete Subscription Owners 7.2 - Verify Subscription Owners az role assignment list --role Owner --output table","title":"7 - Subscription Owners"},{"location":"wip-tldr/#8-subscription-details","text":"env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" 8.1 - Verify Subscription Name az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi 8.2 - Verify Subscription ID az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi 8.3 - Verify Subscription Location az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi 8.4 - Verify Subscription Limits if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi 8.5 - Verify Subscription Quotas 8.6 - Standard DSv3 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 8.7 - Standard Dv2 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi","title":"8 - Subscription Details"},{"location":"wip-tldr/#9-openshift-administrators","text":"env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" 9.1 - Delete Administrators 9.2 - Delete Administrator Roles 9.3 - Delete Administrator Group 9.4 - Verify Administrators for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done 9.5 - Verify Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done","title":"9 - OpenShift Administrators"},{"location":"wip-tldr/#10-resource-providers","text":"echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" 10.1 - Unregister Provider Microsoft.Compute 10.2 - Unregister Provider Microsoft.RedHatOpenShift 10.3 - Unregister Provider Microsoft.Storage","title":"10 - Resource Providers"},{"location":"wip-tldr/#11-resource-group","text":"env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' 11.1 - Delete Resource Group delete_orphans az group delete --name ${ARO_RESOURCE_GROUP_NAME --yes 11.2 - Verify Resource Group az group show --name ${ARO_RESOURCE_GROUP_NAME}","title":"11 - Resource Group"},{"location":"wip-tldr/#12-virtual-network","text":"env | grep ^ARO_VNET | sort -V 12.1 - Delete Virtual Network az network vnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} 12.2 - Verify Virtual Network az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME}","title":"12 - Virtual Network"},{"location":"wip-tldr/#13-openshift-subnets","text":"env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort -V 13.1 - Delete Master Subnet 13.2 - Delete Worker Subnet 13.3 - Verify Master Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table 13.4 - Verify Worker Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table","title":"13 - OpenShift Subnets"},{"location":"wip-tldr/#14-network-security-groups","text":"env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|VGW' | sort -V 14.1 - Delete Network Security Groups az network nsg delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} 14.2 - Verify Network Security Groups az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_POD_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_SERVICE_NSG_NAME} --output table && echo az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table && echo","title":"14 - Network Security Groups"},{"location":"wip-tldr/#15-network-security-group-rules","text":"env | grep ARO.*NSG | egrep -ve 'MASTER|WORKER|VGW' | sort -V 15.1 - Delete DMZ NSG Rule (AllowSSH) 15.2 - Verify DMZ NSG Rules az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --query securityRules --output table","title":"15 - Network Security Group Rules"},{"location":"wip-tldr/#16-related-subnets","text":"env | grep ^ARO_SUBNET | egrep -ve 'MASTER|WORKER|VGW' | sort -V 16.1 - Delete Application Gateway Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} 16.2 - Delete Database Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} 16.3 - Delete DMZ Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} 16.4 - Delete Trusted Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} 16.5 - Verify Application Gateway Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table 16.6 - Verify Database Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table 16.7 - Verify DMZ Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table 16.8 - Verify Trusted Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table","title":"16 - Related Subnets"},{"location":"wip-tldr/#17-jump-server-vm","text":"env | egrep ARO.*JUMP | sort -V 17.1 - Delete Jump Server VM az vm delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} --yes 17.2 - Cancel Jump Server Image URN az vm image terms cancel --urn ${ARO_VM_JUMP_IMAGE_URN} 17.3 - Delete Jump Server AS az vm availability-set delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.4 - Delete Jump Server NIC az network nic delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic 17.5 - Delete Jump Server Address az network public-ip delete --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.6 - Verify Jump Server Address az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 17.7 - Verify Jump Server NIC az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table 17.8 - Verify Jump Server AS az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table 17.9 - Verify Jump Server Image URN az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table 17.10 - Verify Jump Server VM az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} 17.11 - Login to Jump Server VM export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} \"hostname && uptime\"","title":"17 - Jump Server VM"},{"location":"wip-tldr/#18-vpn-gateway","text":"env | egrep ARO.*VGW | egrep -ve 'PKI' | sort -V 18.1 - Delete VPN Gateway az network vnet-gateway delete --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 18.2 - Delete VPN Address az network public-ip delete --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} 18.3 - Delete VPN Subnet az network vnet subnet delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} 18.4 - Verify VPN Subnet az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table 18.5 - Verify VPN Address az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table 18.6 - Verify VPN Gateway az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table","title":"18 - VPN Gateway"},{"location":"wip-tldr/#19-vpn-gateway-pki","text":"env | grep ARO_VGW_PKI | grep -v CLIENT | sort -V 19.1 - Delete Root Certificate rm -f \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" 19.2 - Delete Root Key rm -f \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" 19.3 - Verify Root Key openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE 2>&1 19.4 - Verify Root Certificate openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text 2>&1 19.5 - Verify Root Moduli echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_ROOT_KEY_FILE}\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_ROOT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" | md5sum 19.6 - Verify Root Data AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi","title":"19 - VPN Gateway PKI"},{"location":"wip-tldr/#20-client-certificates","text":"20.1 - Set VPN Client Environment Variables export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' 20.2 - Verify VPN Client Environment Variables ARO_VERIFY_VARIABLES=(ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_NAME ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for ARO_VERIFY_VARIABLE in ${ARO_VERIFY_VARIABLES[@]}; do if [ \"${!ARO_VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR! Environment Variable ${ARO_VERIFY_VARIABLE} is NOT set\"; else echo \"${ARO_VERIFY_VARIABLE}=${!ARO_VERIFY_VARIABLE}\"; fi; done; unset ARO_VERIFY_VARIABLE 20.3 - Delete VPN Client Key rm -f \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" 20.4 - Delete Client Certificate Request rm -f \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" 20.5 - Delete Client Certificate Extensions rm -f \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.6 - Delete Client Certificate rm -f \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" 20.7 - Delete VPN Client Serial rm -f \"${ARO_VGW_PKI_CLIENT_SERIAL_FILE}\" 20.8 - Delete VPN Client PFX rm \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" 20.9 - Verify VPN Client Key openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE 2>&1 20.10 - Verify Client Certificate Request openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text 2>&1 20.11 - Verify Client Certificate Extensions grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" 20.12 - Verify Client Certificate openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text 2>&1 20.13 - Verify Client Moduli echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_KEY_FILE} = \"; openssl rsa -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_CRT_FILE} = \"; openssl x509 -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" | md5sum echo -n \"md5sum for ${ARO_VGW_PKI_CLIENT_REQ_FILE} = \"; openssl req -noout -modulus -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" | md5sum 20.14 - Verify VPN Client PFX openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text 2>&1","title":"20 - Client Certificates"},{"location":"wip-tldr/#21-vpn-client","text":"env | egrep -e \"ARO.*PKI_CLIENT|ARO_VGW_NAME|ARO_VGW_PKI_BITS|ARO_VGW_PKI_DIR|ARO_VGW_PKI_ROOT_KEY\" | sort -V 21.1 - Delete VPN Client rm -f \"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}.zip\" 21.2 - Verify VPN Client URL export ARO_VGW_CONFIGURATION_URL=$(az network vnet-gateway vpn-client generate -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VGW_NAME} --processor-architecture Amd64) echo \"ARO_VGW_CONFIGURATION_URL=${ARO_VGW_CONFIGURATION_URL}\"","title":"21 - VPN Client"},{"location":"wip-tldr/#22-obtain-pull-secrets","text":"22.1 - Obtain Red Hat Pull Secret 22.2 - Verify Red Hat Pull Secret ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\"","title":"22 - Obtain Pull Secrets"},{"location":"wip-tldr/#23-azure-red-hat-openshift","text":"env | egrep -e 'ARO_CLUSTER|ARO_REDHAT_PULL_SECRET_FILE|ARO_RESOURCE_GROUP_NAME|ARO_VNET_NAME|ARO_SUBNET_MASTER_NAME|ARO_SUBNET_WORKER_NAME' | sort -V 23.1 - Delete ARO Cluster az aro delete --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_CLUSTER_NAME} --yes 23.2 - Verify ARO Cluster az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" --query consoleProfile.url --output tsv az aro show --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\" az aro list-credentials --name \"${ARO_CLUSTER_NAME}\" --resource-group \"${ARO_RESOURCE_GROUP_NAME}\"","title":"23 - Azure Red Hat OpenShift"},{"location":"wip-tldr/#24-openshift-cli","text":"24.1 - Verify OpenShift CLI oc version kubectl version","title":"24 - OpenShift CLI"},{"location":"wip-tldr/#25-openshift-authentication","text":"","title":"25 - OpenShift Authentication"},{"location":"wip/","text":"5 - Required Directories This documentation provides commands that create files. To better organize the output files, the directories must exist or be created. Command(s): env | egrep \"ARO.*DIR\" | sort -V Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki 5.1 - Create Required Directories Reference(s): https://man7.org/linux/man-pages/man1/mkdir.1.html Command(s): mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: + success does not produce any output 5.2 - Verify Required Directories Reference(s): https://man7.org/linux/man-pages/man1/ls.1.html Command(s): ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: drwxrws---+ 2 jtingiris mit 4096 Sep 26 13:41 /home/jtingiris/prj/mit/aei/pki drwxrws---+ 2 jtingiris mit 4096 Sep 26 11:51 /home/jtingiris/prj/mit/aei/secrets","title":"Wip"},{"location":"wip/#5-required-directories","text":"This documentation provides commands that create files. To better organize the output files, the directories must exist or be created. Command(s): env | egrep \"ARO.*DIR\" | sort -V Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki","title":"5 - Required Directories"},{"location":"wip/#51-create-required-directories","text":"Reference(s): https://man7.org/linux/man-pages/man1/mkdir.1.html Command(s): mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: + success does not produce any output","title":"5.1 - Create Required Directories"},{"location":"wip/#52-verify-required-directories","text":"Reference(s): https://man7.org/linux/man-pages/man1/ls.1.html Command(s): ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: drwxrws---+ 2 jtingiris mit 4096 Sep 26 13:41 /home/jtingiris/prj/mit/aei/pki drwxrws---+ 2 jtingiris mit 4096 Sep 26 11:51 /home/jtingiris/prj/mit/aei/secrets","title":"5.2 - Verify Required Directories"}]}