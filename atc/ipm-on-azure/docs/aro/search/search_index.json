{"config":{"lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Azure Red Hat OpenShift for IBM Product Master [DRAFT] This document is functional, though still in active development and undergoing frequent changes. Revision: Wed 23 Sep 2020 10:08:41 AM EDT Introduction This document details the steps required to automate the build of a secure, private Azure Red Hat OpenShift v4.x (ARO) infrastructure for IBM Product Master v12.x. The procedure to install IBM Product Master is an accompanying document. Azure Microsoft Azure is a comprehensive cloud computing service managed by Microsoft. It provides software as a service (SaaS), platform as a service (PaaS), and infrastructure as a service (IaaS). OpenShift Container Platform Red Hat's OpenShift Container Platform (OCP) is a hybrid cloud, enterprise Kubernetes application platform. It is a platform as a service (Paas) built on Red Hat Enterprise Linux (RHEL), with Docker containers managed by Kubernetes. Azure Red Hat OpenShift Azure Red Hat OpenShift (ARO) is a fully managed offering of Red Hat OpenShift running in Microsoft Azure. This service is jointly managed and supported by both Microsoft and Red Hat. For more details, see the Azure Red Hat OpenShift Service documentation. IBM Product Master IBM Product Master (IPM) provides trusted Product Information Management (PIM) and collaborative Master Data Management (MDM) capabilities. It creates an accurate and up-to-date repository of product and service information that can be used throughout organizations for strategic business initiatives Reference(s): https://www.openshift.com/blog/introducing-azure-red-hat-openshift-on-openshift-4 https://docs.openshift.com/aro/4/architecture/architecture.html https://azure.microsoft.com/ https://www.openshift.com/ https://www.docker.com/ https://kubernetes.io/ https://docs.microsoft.com/en-us/azure/openshift/openshift-faq https://docs.microsoft.com/en-us/azure/openshift/support-lifecycle https://www.ibm.com/products/product-master Usage This document follows a step-by-step approach. Each step is dependent upon the successful completion of previous steps. The steps are structured and all follow this same pattern. Detailed Description Many steps will have a detailed description that will provide additional context. In the interest of brevity, not all steps will have detailed descriptions. Reference(s) Most steps will have relevant, linked references. All references given are to the official supporting documentation. Command(s) These are the bash commands that must be run. The expectation is that they will be copy/paste. For that reason, the majority of commands rely on pre-set environment variables. The environment variables provide for portability, flexibility, and a consistent experience. If there are problems running any commands then it's most likely the environment variables are incorrect. Example Output When there is output from a command, the example output will be given. Please compare the outputs to ensure consistency. It may be helpful. 1 - Setup Azure Tenant A tenant is Microsoft's representation of an organization. It is a dedicated instance of Azure Active Directory (AAD) that is received when creating a new relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before Azure Red Hat OpenShift (ARO) can be installed, Microsoft accounts must exist and have appropriate access to an AAD tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. If you are the Global Administrator of an existing tenant, go to step 2. Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant 1.1 - Create Microsoft Account A Microsoft account represents a billing relationship. The account consists of a user identity, one or more subscriptions, and an associated set of resources. The person who creates the account is the administrator for all subscriptions created in that account. That person is also the default Service Administrator for the subscription(s) and, for Microsoft 365, possesses the Global Administrator role. The purpose of this step is to create a new Microsoft 365 (onmicrosoft.com) account, to establish a Global Administrator relationship for use with all Microsoft services, including Azure. An Azure tenant with an Active Directory Premium P1 license is required. Please note that this step does not mandate a purchase of a Microsoft 365 Business Premium license . This is simply one way to create a new tenant and become a Global Administrator. Licenses may be purchased now, or later. Go to the Microsoft 365 store. A credit card will not be required at this time. https://www.microsoft.com/microsoft-365 Proceed to purchase at least one (1) Microsoft 365 Business Premium license. This will also include an Azure Active Directory (AAD) Premium P1 license, which is needed for Azure Red Hat OpenShift (ARO). The Microsoft 365 Business Premium provides an AAD P1 license, and other 365 services. However, a dedicated AAD Premium P1 (or better) may be purchased by a Billing or Global Administrator who has access to an existing tenant. Reference(s): https://support.microsoft.com/en-us/help/4558219/microsoft-account-what-is https://en.wikipedia.org/wiki/Microsoft_account 1.2 - Create Global Administrator The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Add and manage domains Assign the Global Administrator role to other users Reset passwords for all users Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide 1.3 - Verify Admin Center Access The Microsoft 365 admin center simplifies management of Microsoft 365 services. The admin center provides a tailored experience based on the the role of the logged in user. It is the common entry point for all administrators. https://admin.microsoft.com/ Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide 1.4 - Verify AAD License The Azure Active Directory license can be verified by visiting the Directory Overview section on the Azure Portal. https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis 2 - Setup Azure Subscription An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required during the installation of ARO. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators. Reference(s): https://docs.microsoft.com/en-us/microsoft-365/enterprise/subscriptions-licenses-accounts-and-tenants-for-microsoft-cloud-offerings?view=o365-worldwide 2.1 - Create Azure Subscription An Azure subscription may be purchased directly from Microsoft through the Azure website, through a Microsoft representative, or as part of a managed service from a Microsoft Partner. The Microsoft account that purchases the Azure subscription will be assigned the owner administrative role. To learn more about the Azure purchase options, visit this link. https://azure.microsoft.com/en-us/pricing/purchase-options/ Reference(s): https://azure.microsoft.com/ 3 - Setup Linux Operating System The ARO build procedures in this document depend on the Linux operating system and tools. Special care has been taken to ensure the commands given will work on any GNU/Linux distribution. As of this writing, they have been tested on Fedora 31+, Debian 9+, and Ubuntu 18+. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+ GNU bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep GNU wget Google Chrome or Firefox OpenSSL Reference(s): https://www.gnu.org/gnu/linux-and-gnu 3.1 - Verify Operating System This step is to verify the Operating System is GNU/Linux. Reference(s): https://man7.org/linux/man-pages/man2/uname.2.html https://en.wikipedia.org/wiki/Uname Command(s): uname -a Example Output: Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux 3.2 - Verify GNU bash Reference(s): https://www.man7.org/linux/man-pages/man1/bash.1.html https://en.wikipedia.org/wiki/Bash_(Unix_shell) https://www.gnu.org/software/bash/ Command(s): bash --version Example Output: GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. 3.3 - Verify GNU awk Reference(s): https://man7.org/linux/man-pages/man1/awk.1p.html https://en.wikipedia.org/wiki/AWK https://www.gnu.org/software/gawk/ Command(s): awk --version Example Output: GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/. 3.4 - Verify GNU coreutils Reference(s): https://www.gnu.org/software/coreutils/ https://en.wikipedia.org/wiki/GNU_Core_Utilities Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering. 3.5 - Verify GNU grep Reference(s): https://man7.org/linux/man-pages/man1/grep.1.html https://en.wikipedia.org/wiki/Grep https://www.gnu.org/software/grep/ Command(s): egrep --version Example Output: grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. 3.6 - Verify GNU wget Reference(s): https://man7.org/linux/man-pages/man1/wget.1.html https://en.wikipedia.org/wiki/Wget https://www.gnu.org/software/wget/ Command(s): wget --version Example Output: GNU Wget 1.20.3 built on linux-gnu. -cares +digest +gpgme +https +ipv6 +iri +large-file +metalink +nls +ntlm +opie +psl +ssl/gnutls Wgetrc: /etc/wgetrc (system) Locale: /usr/share/locale Compile: gcc -DHAVE_CONFIG_H -DSYSTEM_WGETRC=\"/etc/wgetrc\" -DLOCALEDIR=\"/usr/share/locale\" -I. -I../lib -I../lib -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection Link: gcc -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lmetalink -lpcre2-8 -luuid -lidn2 -lnettle -lgnutls -lz -lpsl -L/usr/lib64 -lgpgme ftp-opie.o gnutls.o http-ntlm.o ../lib/libgnu.a Copyright (C) 2015 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://www.gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Originally written by Hrvoje Niksic <hniksic@xemacs.org>. Please send bug reports and questions to <bug-wget@gnu.org>. 3.7 - Verify Browser Reference(s): https://www.mozilla.org/ https://www.google.com/chrome/ Command(s): firefox --version google-chrome --version Example Output: Mozilla Firefox 80.0 Google Chrome 85.0.4183.83 3.8 - Verify OpenSSL Reference(s): https://www.openssl.org/ Command(s): openssl version Example Output: OpenSSL 1.1.1g FIPS 21 Apr 2020 4 - Setup Environment Variables This step is most important. The other steps in this document will not work unless the bash shell environment is properly setup. There are many prerequisites for a successful installation of Azure Red Hat OpenShift. The necessary bash environment variables are required to execute the steps in this document. The environment variables must be exported. Before proceeding , please take your time ensuring the environment variable values are correct. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html 4.1 - Unset Environment Variables Unsetting the ARO environment variables can help prevent issues when, or if they have changed. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done Example Output: unset ARO unset ARO_ADMINISTRATORS_GROUP_NAME unset ARO_APPLICATION_NAME unset ARO_CLUSTER_NAME unset ARO_DOMAIN_NAME unset ARO_LOCATION_NAME unset ARO_REDHAT_PULL_SECRET_DIR unset ARO_REDHAT_PULL_SECRET_FILE unset ARO_RESOURCE_GROUP_NAME unset ARO_SERVICE_PRINCIPAL_NAME unset ARO_SERVICE_PRINCIPAL_PASSWORD unset ARO_SUBDOMAIN_NAME unset ARO_SUBNET_AGW_ADDRESS_PREFIX unset ARO_SUBNET_AGW_NAME unset ARO_SUBNET_AGW_NSG_NAME unset ARO_SUBNET_DB_ADDRESS_PREFIX unset ARO_SUBNET_DB_NAME unset ARO_SUBNET_DB_NSG_NAME unset ARO_SUBNET_DMZ_ADDRESS_PREFIX unset ARO_SUBNET_DMZ_NAME unset ARO_SUBNET_DMZ_NSG_NAME unset ARO_SUBNET_MASTER_ADDRESS_PREFIX unset ARO_SUBNET_MASTER_NAME unset ARO_SUBNET_MASTER_NSG_NAME unset ARO_SUBNET_TRUSTED_ADDRESS_PREFIX unset ARO_SUBNET_TRUSTED_NAME unset ARO_SUBNET_TRUSTED_NSG_NAME unset ARO_SUBNET_VGW_ADDRESS_PREFIX unset ARO_SUBNET_VGW_NAME unset ARO_SUBNET_VGW_NSG_NAME unset ARO_SUBNET_WORKER_ADDRESS_PREFIX unset ARO_SUBNET_WORKER_NAME unset ARO_SUBNET_WORKER_NSG_NAME unset ARO_SUBSCRIPTION_ID unset ARO_SUBSCRIPTION_NAME unset ARO_TENANT_ID unset ARO_TENANT_NAME unset ARO_VGW_NAME unset ARO_VGW_PKI_BITS unset ARO_VGW_PKI_CLIENT unset ARO_VGW_PKI_CLIENT_CRT_FILE unset ARO_VGW_PKI_CLIENT_EXT_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_CLIENT_NAME unset ARO_VGW_PKI_CLIENT_PFX_FILE unset ARO_VGW_PKI_CLIENT_REQ_FILE unset ARO_VGW_PKI_CLIENT_SERIAL_FILE unset ARO_VGW_PKI_DIR unset ARO_VGW_PKI_ROOT_CA_SERIAL_FILE unset ARO_VGW_PKI_ROOT_CRT_FILE unset ARO_VGW_PKI_ROOT_CRT_FILE_NAME unset ARO_VGW_PKI_ROOT_KEY_FILE unset ARO_VGW_PKI_ROOT_KEY_FILE_NAME unset ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE unset ARO_VGW_POOL_ADDRESS_PREFIX unset ARO_VGW_PUBLIC_ADDRESS_NAME unset ARO_VGW_REDUNDANCY unset ARO_VGW_SKU unset ARO_VGW_TYPE unset ARO_VM_JUMP_ADMIN_NAME unset ARO_VM_JUMP_IMAGE_MARKETPLACE unset ARO_VM_JUMP_IMAGE_URN unset ARO_VM_JUMP_NAME unset ARO_VM_JUMP_PUBLIC_ADDRESS_NAME unset ARO_VM_JUMP_SIZE unset ARO_VNET_ADDRESS_PREFIX unset ARO_VNET_NAME 4.2 - Set Environment Variables Many bash shell environment variables are required. They are reused for multiple steps. It is recommended that the environment variables be maintained in a configuration file, i.e. ipm.env Maintaining the variables in a configuration file will make them easier to use and update. These are example values that should be changed for this installation. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): cat \"ipm.env\" && source \"ipm.env\" Example Output: # NOTE: # # These variables may be set statically or dynamically. # # This example shows dynamic variables. In this case, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. Each of these are required. export ARO=ipm export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_DOMAIN_NAME=mitaei.net export ARO_SUBDOMAIN_NAME=${ARO}.${ARO_DOMAIN_NAME} export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=mitaei.net export ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 export ARO_VNET_NAME=${ARO}-vnet # ARO subnets: MASTER, WORKER export ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg export ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # non-ARO subnets AGW, DB, DMZ, TRUSTED, VPN (GatewaySubnet) export ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg export ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg export ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg export ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg export ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet export ARO_SUBNET_VGW_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # this can't be used? # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_FILE_NAME}\" export ARO_VGW_PKI_ROOT_CRT_FILE_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_FILE_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_POOL_ADDRESS_PREFIX=172.16.11.0/24 export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@mitaei.net) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') 4.3 - Verify Environment Variables Ensure the ARO variables are avaialble in the bash shell environment that you're working in. Reference(s): https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=ipm ARO_ADMINISTRATORS_GROUP_NAME=OpenShift Administrators ARO_APPLICATION_NAME=ipm-app ARO_CLUSTER_NAME=ipm-cluster ARO_DOMAIN_NAME=mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SERVICE_PRINCIPAL_NAME=http://ipm-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBDOMAIN_NAME=ipm.mitaei.net ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ ARO_VGW_PKI_ROOT_CRT_FILE_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ ARO_VGW_PKI_ROOT_KEY_FILE_NAME=ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=ipm-vnet 5 - Setup Required Directories This documentation provides commands that create files. To better organize the output files, the directories must exist or be created. Command(s): env | egrep \"ARO.*DIR\" Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki 5.1 - Create Required Directories Reference(s): https://man7.org/linux/man-pages/man1/mkdir.1.html Command(s): mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories Reference(s): https://man7.org/linux/man-pages/man1/ls.1.html Command(s): ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: drwxrws---+ 3 jtingiris mit 4096 Sep 21 10:06 /home/jtingiris/prj/mit/aei/pki drwxrws---+ 2 jtingiris mit 4096 Sep 17 16:11 /home/jtingiris/prj/mit/aei/secrets 6 - Setup Azure CLI The Azure CLI is a Command Line Interface (CLI) used to create and manage Azure resources. The Azure CLI works with all Azure services. It is designed to more quickly work with Azure, with an emphasis on automation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest Command(s): env | egrep \"ARO.*DIR\" Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki 6.1 - Install Azure CLI The Azure CLI is available to install on Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. To install the Azure CLI, please follow the link in the Reference(s) section of this topic. Reference(s): https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Command(s): az --version Example Output: azure-cli 2.12.0 core 2.12.0 telemetry 1.0.6 Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Your CLI is up-to-date. Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy 6.2 - Subscription Owner Login The Azure Subscription Owner must perform the remaining steps in this documentation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Command(s): az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net 6.3 - Verify Azure Tenant One way to verify the Azure Tenant is to obtain the Tenant ID with az. Another way is to login to the Azure AAD portal. The Tenant ID must match what is in the environment configuration file. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_show https://aad.portal.azure.com/ Command(s): az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi Example Output: [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ] 6.4 - Set Default Subscription Set the default subscription that the ARO resources will be installed in. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_set Command(s): az account set -s \"${ARO_SUBSCRIPTION_NAME}\" Example Output: + success does not produce any output 6.5 - Verify Default Subscription The Azure CLI Default Subscription will be used to provision all ARO resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Command(s): az account list --query '[?isDefault == `true`]' Example Output: [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ] 7 - Setup Subscription Owners There should be at least two (2) Subscription Owners. This step is optional, but recommended. It will use the ${ARO_SUBSCRIPTION_OWNERS} environment value and ensure all User Principal Names (UPNs) are added as Subscription Owners. Reference(s): https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner 7.1 - Create Subscription Owners Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create Command(s): for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"name\": \"c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"principalId\": \"52f7dd5d-ad08-4b40-878f-40686c51c24e\", \"principalName\": \"christy.walsh@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"name\": \"0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } 7.2 - Verify Subscription Owners Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Example Output: Principal Role Scope -------------------------- ------ --------------------------------------------------- christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 8 - Verify Azure Subscription Uze az to verify Azure Subscription details. The subscription may also be manually verified via the Azure Portal Subscription blade. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest Command(s): env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" Example Output: ARO_LOCATION_NAME=eastus ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_SUBSCRIPTION_OWNERS=christy.walsh@mitaei.net joseph.tingiris@mitaei.net ARO_VERIFY_QUOTA_NAMES=Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs 8.1 - Verify Subscription Name Verify the following configuration variables are valid: ${ARO_SUBSCRIPTION_NAME} Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade Command(s): az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi Example Output: Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ] 8.2 - Verify Subscription ID Verify the following configuration variables are valid: ${ARO_SUBSCRIPTION_ID} Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show Command(s): az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi Example Output: [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ] 8.3 - Verify Subscription Location Verify the following configuration variables are valid: ${ARO_LOCATION_NAME} NOTE: Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable location for the installation. The location name will be used throughout this document. Reference(s): https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Command(s): az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi Example Output: Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US 8.4 - Verify Subscription Limits Verify the following configuration variable is not empty: ${ARO_VERIFY_QUOTA_NAMES} An ARO cluster uses several Microsoft Azure components. It requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. The Azure subscription and service limits, quotas, and constraints may be insufficient to install ARO. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. It is wise to check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. ARO minimum limits are required for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html Command(s): if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi Example Output: + success does not produce any output 8.5 - Verify Subscription Quotas This step must be done manually. Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner must do this step. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Dv2 Series DSv3 Series To increase the quota limits, a support case must be opened. Microsoft will communicate directly to the person who requested the increase. An increase in the VM series quotas automatically increases the total regional vCPU limit by the same amount. Links to Microsoft's directions on how to request a quota increase for a specific subscription are provided in the references section of this topic. Verify subscription quotas for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests 8.6 - Standard DSv3 Family vCPUs Ensure the quota \"limit\" is greater than 50. Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi Example Output: [ { \"currentValue\": \"0\", \"limit\": \"100\", \"localName\": \"Standard DSv3 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard DSv3 Family vCPUs\", \"value\": \"standardDSv3Family\" } } ] 8.7 - Standard Dv2 Family vCPUs Ensure the quota \"limit\" is greater than 50. Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi Example Output: [ { \"currentValue\": \"0\", \"limit\": \"100\", \"localName\": \"Standard Dv2 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard Dv2 Family vCPUs\", \"value\": \"standardDv2Family\" } } ] 9 - Setup OpenShift Administrators Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities. The details for how to use az to create users, groups, and add the necessary subscription roles is described below. Command(s): env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" Example Output: ARO_DOMAIN_NAME=mitaei.net ARO_ADMINISTRATORS=openshift-admin@mitaei.net arun.babu@mitaei.net joseph.tingiris@mitaei.net sivaprasad.k@mitaei.net 9.1 - Create Administrator Accounts This is a good time for the Global Administrator to create Microsoft accounts for the OpenShift Administrators. Ideally, the OpenShift Administrators would also have the Global Administrator role for the tenant. However, this is not always possible. If you are the Global Administrator then please take note that the OpenShift Administrators must have Microsoft accounts in the tenant , and their Microsoft accounts must have at least the Contributor and User Access Administrator roles for the Azure Subscription in which ARO is to be deployed. Creating users may be done with az , via the AAD portal, or [https://admin.microsoft.com]. NOTE: The openshift-admin user created is an example and should not be used. We strongly recommend using real names and individual accounts, not ficticous names or group accounts. Command(s): az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login Example Output: { \"accountEnabled\": true, \"ageGroup\": null, \"assignedLicenses\": [], \"assignedPlans\": [], \"city\": null, \"companyName\": null, \"consentProvidedForMinor\": null, \"country\": null, \"createdDateTime\": null, \"creationType\": null, \"deletionTimestamp\": null, \"department\": null, \"dirSyncEnabled\": null, \"displayName\": \"openshift-admin@mitaei.net\", \"employeeId\": null, \"facsimileTelephoneNumber\": null, \"givenName\": null, \"immutableId\": null, \"isCompromised\": null, \"jobTitle\": null, \"lastDirSyncTime\": null, \"legalAgeGroupClassification\": null, \"mail\": null, \"mailNickname\": \"openshift-admin\", \"mobile\": null, \"objectId\": \"8f9fc0bc-e694-435f-b0f8-1eb4c66caabb\", \"objectType\": \"User\", \"odata.metadata\": \"https://graph.windows.net/25fe96e7-85ec-4e6a-b93f-779b16ff751d/$metadata#directoryObjects/@Element\", \"odata.type\": \"Microsoft.DirectoryServices.User\", \"onPremisesDistinguishedName\": null, \"onPremisesSecurityIdentifier\": null, \"otherMails\": [], \"passwordPolicies\": null, \"passwordProfile\": { \"enforceChangePasswordPolicy\": false, \"forceChangePasswordNextLogin\": true, \"password\": null }, \"physicalDeliveryOfficeName\": null, \"postalCode\": null, \"preferredLanguage\": null, \"provisionedPlans\": [], \"provisioningErrors\": [], \"proxyAddresses\": [], \"refreshTokensValidFromDateTime\": \"2020-09-23T14:09:26.228763Z\", \"showInAddressList\": null, \"signInNames\": [], \"sipProxyAddress\": null, \"state\": null, \"streetAddress\": null, \"surname\": null, \"telephoneNumber\": null, \"thumbnailPhoto@odata.mediaEditLink\": \"directoryObjects/8f9fc0bc-e694-435f-b0f8-1eb4c66caabb/Microsoft.DirectoryServices.User/thumbnailPhoto\", \"usageLocation\": null, \"userIdentities\": [], \"userPrincipalName\": \"openshift-admin@mitaei.net\", \"userState\": null, \"userStateChangedOn\": null, \"userType\": \"Member\" } 9.2 - Verify Administrator Accounts Verify the OpenShift Administrator accounts listed in ${ARO_ADMINISTRATORS} exist. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done Example Output: [ { \"userPrincipalName\": \"openshift-admin@mitaei.net\" }, { \"principalId\": \"8f9fc0bc-e694-435f-b0f8-1eb4c66caabb\" } ] [ { \"userPrincipalName\": \"arun.babu@mitaei.net\" }, { \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\" } ] [ { \"userPrincipalName\": \"joseph.tingiris@mitaei.net\" }, { \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\" } ] [ { \"userPrincipalName\": \"sivaprasad.k@mitaei.net\" }, { \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\" } ] 9.3 - Create Administrator Roles The Contributor and User Access Administrator subscription roles are required to administer ARO. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/af5625a2-869f-4b1f-af1e-c7dc3bd9fd29\", \"name\": \"af5625a2-869f-4b1f-af1e-c7dc3bd9fd29\", \"principalId\": \"8f9fc0bc-e694-435f-b0f8-1eb4c66caabb\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/c1488473-33f8-488e-8db5-2f39e2c8d74f\", \"name\": \"c1488473-33f8-488e-8db5-2f39e2c8d74f\", \"principalId\": \"8f9fc0bc-e694-435f-b0f8-1eb4c66caabb\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/8f458612-ca5f-4ff2-832a-d00e700975b0\", \"name\": \"8f458612-ca5f-4ff2-832a-d00e700975b0\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/7f1ba7da-c858-489f-a988-39123faa181f\", \"name\": \"7f1ba7da-c858-489f-a988-39123faa181f\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/6f98e077-c161-453d-a903-b00acb9bd5f2\", \"name\": \"6f98e077-c161-453d-a903-b00acb9bd5f2\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"name\": \"91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/1bf7b433-935b-4160-a634-43bd291739c8\", \"name\": \"1bf7b433-935b-4160-a634-43bd291739c8\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"name\": \"13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } 9.4 - Verify Administrator Roles Verify all ${ARO_ADMINISTRATORS} have the Contributor and User Access Administrator subscription roles. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done Example Output: Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- openshift-admin@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 openshift-admin@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 10 - Setup Resource Providers Make sure you are logged in to Azure via az az login and have the Contributor or Owner role. NOTE: These steps will fail with only the User Access Administrator role. An unauthorized message will be received. These steps will fail without the --wait flag. Dependent providers are automatically registered and they must be registered first. Reference(s): https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types Command(s): echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" Example Output: ARO_RESOURCE_PROVIDERS=Microsoft.Compute Microsoft.RedHatOpenShift Microsoft.Storage 10.1 - Register Provider Microsoft.Compute Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Compute --wait Example Output: + success does not produce any output 10.2 - Verify Provider Microsoft.Compute Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Compute --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered 10.3 - Register Provider Microsoft.RedHatOpenShift Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.RedHatOpenShift --wait Example Output: + success does not produce any output 10.4 - Verify Provider Microsoft.RedHatOpenShift Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.RedHatOpenShift --output table Example Output: Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered 10.5 - Register Provider Microsoft.Storage Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Storage --wait Example Output: + success does not produce any output 10.6 - Verify Provider Microsoft.Storage Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Storage --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered 11 - Setup Resource Group An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest Command(s): env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' Example Output: ARO_LOCATION_NAME=eastus ARO_RESOURCE_GROUP_NAME=ipm-eastus 11.1 - Create Resource Group Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Command(s): az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } 11.2 - Verify Resource Group Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Command(s): az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } 12 - Setup Virtual Network An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Command(s): env | grep ^ARO_VNET | sort -V Example Output: ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=ipm-vnet 12.1 - Create Virtual Network Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_ADDRESS_PREFIX} Example Output: { \"newVNet\": { \"addressSpace\": { \"addressPrefixes\": [ \"10.11.0.0/21\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"070e6b93-8c8b-4c6a-84f9-231a20da9180\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"71df59a1-9f16-450f-a6b5-282bacfe01bb\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] } } 12.2 - Verify Virtual Network Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Command(s): az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --output table Example Output: EnableDdosProtection EnableVmProtection Location Name ProvisioningState ResourceGroup ResourceGuid ---------------------- -------------------- ---------- -------- ------------------- --------------- ------------------------------------ False False eastus ipm-vnet Succeeded ipm-eastus 71df59a1-9f16-450f-a6b5-282bacfe01bb","title":"Index"},{"location":"#azure-red-hat-openshift-for-ibm-product-master","text":"","title":"Azure Red Hat OpenShift for IBM Product Master"},{"location":"#draft","text":"This document is functional, though still in active development and undergoing frequent changes. Revision: Wed 23 Sep 2020 10:08:41 AM EDT","title":"[DRAFT]"},{"location":"#introduction","text":"This document details the steps required to automate the build of a secure, private Azure Red Hat OpenShift v4.x (ARO) infrastructure for IBM Product Master v12.x. The procedure to install IBM Product Master is an accompanying document.","title":"Introduction"},{"location":"#azure","text":"Microsoft Azure is a comprehensive cloud computing service managed by Microsoft. It provides software as a service (SaaS), platform as a service (PaaS), and infrastructure as a service (IaaS).","title":"Azure"},{"location":"#openshift-container-platform","text":"Red Hat's OpenShift Container Platform (OCP) is a hybrid cloud, enterprise Kubernetes application platform. It is a platform as a service (Paas) built on Red Hat Enterprise Linux (RHEL), with Docker containers managed by Kubernetes.","title":"OpenShift Container Platform"},{"location":"#azure-red-hat-openshift","text":"Azure Red Hat OpenShift (ARO) is a fully managed offering of Red Hat OpenShift running in Microsoft Azure. This service is jointly managed and supported by both Microsoft and Red Hat. For more details, see the Azure Red Hat OpenShift Service documentation.","title":"Azure Red Hat OpenShift"},{"location":"#ibm-product-master","text":"IBM Product Master (IPM) provides trusted Product Information Management (PIM) and collaborative Master Data Management (MDM) capabilities. It creates an accurate and up-to-date repository of product and service information that can be used throughout organizations for strategic business initiatives Reference(s): https://www.openshift.com/blog/introducing-azure-red-hat-openshift-on-openshift-4 https://docs.openshift.com/aro/4/architecture/architecture.html https://azure.microsoft.com/ https://www.openshift.com/ https://www.docker.com/ https://kubernetes.io/ https://docs.microsoft.com/en-us/azure/openshift/openshift-faq https://docs.microsoft.com/en-us/azure/openshift/support-lifecycle https://www.ibm.com/products/product-master","title":"IBM Product Master"},{"location":"#usage","text":"This document follows a step-by-step approach. Each step is dependent upon the successful completion of previous steps. The steps are structured and all follow this same pattern.","title":"Usage"},{"location":"#detailed-description","text":"Many steps will have a detailed description that will provide additional context. In the interest of brevity, not all steps will have detailed descriptions.","title":"Detailed Description"},{"location":"#references","text":"Most steps will have relevant, linked references. All references given are to the official supporting documentation.","title":"Reference(s)"},{"location":"#commands","text":"These are the bash commands that must be run. The expectation is that they will be copy/paste. For that reason, the majority of commands rely on pre-set environment variables. The environment variables provide for portability, flexibility, and a consistent experience. If there are problems running any commands then it's most likely the environment variables are incorrect.","title":"Command(s)"},{"location":"#example-output","text":"When there is output from a command, the example output will be given. Please compare the outputs to ensure consistency. It may be helpful.","title":"Example Output"},{"location":"#1-setup-azure-tenant","text":"A tenant is Microsoft's representation of an organization. It is a dedicated instance of Azure Active Directory (AAD) that is received when creating a new relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before Azure Red Hat OpenShift (ARO) can be installed, Microsoft accounts must exist and have appropriate access to an AAD tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. If you are the Global Administrator of an existing tenant, go to step 2. Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant","title":"1 - Setup Azure Tenant"},{"location":"#11-create-microsoft-account","text":"A Microsoft account represents a billing relationship. The account consists of a user identity, one or more subscriptions, and an associated set of resources. The person who creates the account is the administrator for all subscriptions created in that account. That person is also the default Service Administrator for the subscription(s) and, for Microsoft 365, possesses the Global Administrator role. The purpose of this step is to create a new Microsoft 365 (onmicrosoft.com) account, to establish a Global Administrator relationship for use with all Microsoft services, including Azure. An Azure tenant with an Active Directory Premium P1 license is required. Please note that this step does not mandate a purchase of a Microsoft 365 Business Premium license . This is simply one way to create a new tenant and become a Global Administrator. Licenses may be purchased now, or later. Go to the Microsoft 365 store. A credit card will not be required at this time. https://www.microsoft.com/microsoft-365 Proceed to purchase at least one (1) Microsoft 365 Business Premium license. This will also include an Azure Active Directory (AAD) Premium P1 license, which is needed for Azure Red Hat OpenShift (ARO). The Microsoft 365 Business Premium provides an AAD P1 license, and other 365 services. However, a dedicated AAD Premium P1 (or better) may be purchased by a Billing or Global Administrator who has access to an existing tenant. Reference(s): https://support.microsoft.com/en-us/help/4558219/microsoft-account-what-is https://en.wikipedia.org/wiki/Microsoft_account","title":"1.1 - Create Microsoft Account"},{"location":"#12-create-global-administrator","text":"The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Add and manage domains Assign the Global Administrator role to other users Reset passwords for all users Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide","title":"1.2 - Create Global Administrator"},{"location":"#13-verify-admin-center-access","text":"The Microsoft 365 admin center simplifies management of Microsoft 365 services. The admin center provides a tailored experience based on the the role of the logged in user. It is the common entry point for all administrators. https://admin.microsoft.com/ Reference(s): https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide","title":"1.3 - Verify Admin Center Access"},{"location":"#14-verify-aad-license","text":"The Azure Active Directory license can be verified by visiting the Directory Overview section on the Azure Portal. https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview Reference(s): https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis","title":"1.4 - Verify AAD License"},{"location":"#2-setup-azure-subscription","text":"An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required during the installation of ARO. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators. Reference(s): https://docs.microsoft.com/en-us/microsoft-365/enterprise/subscriptions-licenses-accounts-and-tenants-for-microsoft-cloud-offerings?view=o365-worldwide","title":"2 - Setup Azure Subscription"},{"location":"#21-create-azure-subscription","text":"An Azure subscription may be purchased directly from Microsoft through the Azure website, through a Microsoft representative, or as part of a managed service from a Microsoft Partner. The Microsoft account that purchases the Azure subscription will be assigned the owner administrative role. To learn more about the Azure purchase options, visit this link. https://azure.microsoft.com/en-us/pricing/purchase-options/ Reference(s): https://azure.microsoft.com/","title":"2.1 - Create Azure Subscription"},{"location":"#3-setup-linux-operating-system","text":"The ARO build procedures in this document depend on the Linux operating system and tools. Special care has been taken to ensure the commands given will work on any GNU/Linux distribution. As of this writing, they have been tested on Fedora 31+, Debian 9+, and Ubuntu 18+. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+ GNU bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep GNU wget Google Chrome or Firefox OpenSSL Reference(s): https://www.gnu.org/gnu/linux-and-gnu","title":"3 - Setup Linux Operating System"},{"location":"#31-verify-operating-system","text":"This step is to verify the Operating System is GNU/Linux. Reference(s): https://man7.org/linux/man-pages/man2/uname.2.html https://en.wikipedia.org/wiki/Uname Command(s): uname -a Example Output: Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux","title":"3.1 - Verify Operating System"},{"location":"#32-verify-gnu-bash","text":"Reference(s): https://www.man7.org/linux/man-pages/man1/bash.1.html https://en.wikipedia.org/wiki/Bash_(Unix_shell) https://www.gnu.org/software/bash/ Command(s): bash --version Example Output: GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law.","title":"3.2 - Verify GNU bash"},{"location":"#33-verify-gnu-awk","text":"Reference(s): https://man7.org/linux/man-pages/man1/awk.1p.html https://en.wikipedia.org/wiki/AWK https://www.gnu.org/software/gawk/ Command(s): awk --version Example Output: GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/.","title":"3.3 - Verify GNU awk"},{"location":"#34-verify-gnu-coreutils","text":"Reference(s): https://www.gnu.org/software/coreutils/ https://en.wikipedia.org/wiki/GNU_Core_Utilities Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering.","title":"3.4 - Verify GNU coreutils"},{"location":"#35-verify-gnu-grep","text":"Reference(s): https://man7.org/linux/man-pages/man1/grep.1.html https://en.wikipedia.org/wiki/Grep https://www.gnu.org/software/grep/ Command(s): egrep --version Example Output: grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>.","title":"3.5 - Verify GNU grep"},{"location":"#36-verify-gnu-wget","text":"Reference(s): https://man7.org/linux/man-pages/man1/wget.1.html https://en.wikipedia.org/wiki/Wget https://www.gnu.org/software/wget/ Command(s): wget --version Example Output: GNU Wget 1.20.3 built on linux-gnu. -cares +digest +gpgme +https +ipv6 +iri +large-file +metalink +nls +ntlm +opie +psl +ssl/gnutls Wgetrc: /etc/wgetrc (system) Locale: /usr/share/locale Compile: gcc -DHAVE_CONFIG_H -DSYSTEM_WGETRC=\"/etc/wgetrc\" -DLOCALEDIR=\"/usr/share/locale\" -I. -I../lib -I../lib -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection Link: gcc -I/usr/include/p11-kit-1 -DHAVE_LIBGNUTLS -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lmetalink -lpcre2-8 -luuid -lidn2 -lnettle -lgnutls -lz -lpsl -L/usr/lib64 -lgpgme ftp-opie.o gnutls.o http-ntlm.o ../lib/libgnu.a Copyright (C) 2015 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://www.gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Originally written by Hrvoje Niksic <hniksic@xemacs.org>. Please send bug reports and questions to <bug-wget@gnu.org>.","title":"3.6 - Verify GNU wget"},{"location":"#37-verify-browser","text":"Reference(s): https://www.mozilla.org/ https://www.google.com/chrome/ Command(s): firefox --version google-chrome --version Example Output: Mozilla Firefox 80.0 Google Chrome 85.0.4183.83","title":"3.7 - Verify Browser"},{"location":"#38-verify-openssl","text":"Reference(s): https://www.openssl.org/ Command(s): openssl version Example Output: OpenSSL 1.1.1g FIPS 21 Apr 2020","title":"3.8 - Verify OpenSSL"},{"location":"#4-setup-environment-variables","text":"This step is most important. The other steps in this document will not work unless the bash shell environment is properly setup. There are many prerequisites for a successful installation of Azure Red Hat OpenShift. The necessary bash environment variables are required to execute the steps in this document. The environment variables must be exported. Before proceeding , please take your time ensuring the environment variable values are correct. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html","title":"4 - Setup Environment Variables"},{"location":"#41-unset-environment-variables","text":"Unsetting the ARO environment variables can help prevent issues when, or if they have changed. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done Example Output: unset ARO unset ARO_ADMINISTRATORS_GROUP_NAME unset ARO_APPLICATION_NAME unset ARO_CLUSTER_NAME unset ARO_DOMAIN_NAME unset ARO_LOCATION_NAME unset ARO_REDHAT_PULL_SECRET_DIR unset ARO_REDHAT_PULL_SECRET_FILE unset ARO_RESOURCE_GROUP_NAME unset ARO_SERVICE_PRINCIPAL_NAME unset ARO_SERVICE_PRINCIPAL_PASSWORD unset ARO_SUBDOMAIN_NAME unset ARO_SUBNET_AGW_ADDRESS_PREFIX unset ARO_SUBNET_AGW_NAME unset ARO_SUBNET_AGW_NSG_NAME unset ARO_SUBNET_DB_ADDRESS_PREFIX unset ARO_SUBNET_DB_NAME unset ARO_SUBNET_DB_NSG_NAME unset ARO_SUBNET_DMZ_ADDRESS_PREFIX unset ARO_SUBNET_DMZ_NAME unset ARO_SUBNET_DMZ_NSG_NAME unset ARO_SUBNET_MASTER_ADDRESS_PREFIX unset ARO_SUBNET_MASTER_NAME unset ARO_SUBNET_MASTER_NSG_NAME unset ARO_SUBNET_TRUSTED_ADDRESS_PREFIX unset ARO_SUBNET_TRUSTED_NAME unset ARO_SUBNET_TRUSTED_NSG_NAME unset ARO_SUBNET_VGW_ADDRESS_PREFIX unset ARO_SUBNET_VGW_NAME unset ARO_SUBNET_VGW_NSG_NAME unset ARO_SUBNET_WORKER_ADDRESS_PREFIX unset ARO_SUBNET_WORKER_NAME unset ARO_SUBNET_WORKER_NSG_NAME unset ARO_SUBSCRIPTION_ID unset ARO_SUBSCRIPTION_NAME unset ARO_TENANT_ID unset ARO_TENANT_NAME unset ARO_VGW_NAME unset ARO_VGW_PKI_BITS unset ARO_VGW_PKI_CLIENT unset ARO_VGW_PKI_CLIENT_CRT_FILE unset ARO_VGW_PKI_CLIENT_EXT_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE unset ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE unset ARO_VGW_PKI_CLIENT_NAME unset ARO_VGW_PKI_CLIENT_PFX_FILE unset ARO_VGW_PKI_CLIENT_REQ_FILE unset ARO_VGW_PKI_CLIENT_SERIAL_FILE unset ARO_VGW_PKI_DIR unset ARO_VGW_PKI_ROOT_CA_SERIAL_FILE unset ARO_VGW_PKI_ROOT_CRT_FILE unset ARO_VGW_PKI_ROOT_CRT_FILE_NAME unset ARO_VGW_PKI_ROOT_KEY_FILE unset ARO_VGW_PKI_ROOT_KEY_FILE_NAME unset ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE unset ARO_VGW_POOL_ADDRESS_PREFIX unset ARO_VGW_PUBLIC_ADDRESS_NAME unset ARO_VGW_REDUNDANCY unset ARO_VGW_SKU unset ARO_VGW_TYPE unset ARO_VM_JUMP_ADMIN_NAME unset ARO_VM_JUMP_IMAGE_MARKETPLACE unset ARO_VM_JUMP_IMAGE_URN unset ARO_VM_JUMP_NAME unset ARO_VM_JUMP_PUBLIC_ADDRESS_NAME unset ARO_VM_JUMP_SIZE unset ARO_VNET_ADDRESS_PREFIX unset ARO_VNET_NAME","title":"4.1 - Unset Environment Variables"},{"location":"#42-set-environment-variables","text":"Many bash shell environment variables are required. They are reused for multiple steps. It is recommended that the environment variables be maintained in a configuration file, i.e. ipm.env Maintaining the variables in a configuration file will make them easier to use and update. These are example values that should be changed for this installation. Reference(s): https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): cat \"ipm.env\" && source \"ipm.env\" Example Output: # NOTE: # # These variables may be set statically or dynamically. # # This example shows dynamic variables. In this case, the order of variables is important # because many values rely on the value of another variable. # # Please check, and double check the values. Each of these are required. export ARO=ipm export ARO_ADMINISTRATORS_GROUP_NAME=\"OpenShift Administrators\" export ARO_APPLICATION_NAME=${ARO}-app export ARO_CLUSTER_NAME=${ARO}-cluster export ARO_DOMAIN_NAME=mitaei.net export ARO_SUBDOMAIN_NAME=${ARO}.${ARO_DOMAIN_NAME} export ARO_LOCATION_NAME=eastus # region export ARO_REDHAT_PULL_SECRET_DIR=\"${PWD}/secrets\" export ARO_REDHAT_PULL_SECRET_FILE=\"${ARO_REDHAT_PULL_SECRET_DIR}/${ARO}-redhat-pull-secret.txt\" export ARO_RESOURCE_GROUP_NAME=\"${ARO}-${ARO_LOCATION_NAME}\" export ARO_SERVICE_PRINCIPAL_NAME=\"http://${ARO_APPLICATION_NAME}\" export ARO_SERVICE_PRINCIPAL_PASSWORD=\"S3rv1c3Pr1cip4lP4ssw0rd!\" export ARO_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) export ARO_SUBSCRIPTION_NAME=\"Azure subscription for mitaei\" export ARO_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) export ARO_TENANT_NAME=mitaei.net export ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 export ARO_VNET_NAME=${ARO}-vnet # ARO subnets: MASTER, WORKER export ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 export ARO_SUBNET_MASTER_NAME=${ARO_VNET_NAME}-master-subnet export ARO_SUBNET_MASTER_NSG_NAME=${ARO_SUBNET_MASTER_NAME}-nsg export ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 export ARO_SUBNET_WORKER_NAME=${ARO_VNET_NAME}-worker-subnet export ARO_SUBNET_WORKER_NSG_NAME=${ARO_SUBNET_WORKER_NAME}-nsg # non-ARO subnets AGW, DB, DMZ, TRUSTED, VPN (GatewaySubnet) export ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 export ARO_SUBNET_AGW_NAME=${ARO_VNET_NAME}-agw-subnet export ARO_SUBNET_AGW_NSG_NAME=${ARO_SUBNET_AGW_NAME}-nsg export ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 export ARO_SUBNET_DB_NAME=${ARO_VNET_NAME}-db-subnet export ARO_SUBNET_DB_NSG_NAME=${ARO_SUBNET_DB_NAME}-nsg export ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 export ARO_SUBNET_DMZ_NAME=${ARO_VNET_NAME}-dmz-subnet export ARO_SUBNET_DMZ_NSG_NAME=${ARO_SUBNET_DMZ_NAME}-nsg export ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 export ARO_SUBNET_TRUSTED_NAME=${ARO_VNET_NAME}-trusted-subnet export ARO_SUBNET_TRUSTED_NSG_NAME=${ARO_SUBNET_TRUSTED_NAME}-nsg export ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 export ARO_SUBNET_VGW_NAME=GatewaySubnet # this MUST be named GatewaySubnet export ARO_SUBNET_VGW_NSG_NAME=${ARO_SUBNET_VGW_NAME}-nsg # this can't be used? # VPN Gateway (P2S) export ARO_VGW_NAME=${ARO}-vpn export ARO_VGW_PKI_DIR=\"${PWD}/pki\" export ARO_VGW_PKI_BITS=2048 export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_PFX_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx\" export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_NAME}-root.serial\" export ARO_VGW_PKI_ROOT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_CRT_FILE_NAME}\" export ARO_VGW_PKI_ROOT_CRT_FILE_NAME=\"${ARO_VGW_NAME}-root.crt\" export ARO_VGW_PKI_ROOT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_ROOT_KEY_FILE_NAME}\" export ARO_VGW_PKI_ROOT_KEY_FILE_NAME=\"${ARO_VGW_NAME}-root.key\" export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=\"Pk1P4ssphr4s3!!\" export ARO_VGW_POOL_ADDRESS_PREFIX=172.16.11.0/24 export ARO_VGW_PUBLIC_ADDRESS_NAME=${ARO_VGW_NAME}-public-ip export ARO_VGW_REDUNDANCY=true # more costly; set to false for lower environments export ARO_VGW_SKU=\"VpnGw1\" # Not Redundant; reverse the order for redundant export ARO_VGW_SKU=\"VpnGw1AZ\" # Redundant; reverse the order for not redundant export ARO_VGW_TYPE=RouteBased # Additonal, non_ARO VMs export ARO_VM_JUMP_NAME=${ARO}-vm-jumpbox export ARO_VM_JUMP_ADMIN_NAME=${ARO_VM_JUMP_NAME}-admin export ARO_VM_JUMP_IMAGE_MARKETPLACE=true export ARO_VM_JUMP_IMAGE_URN=\"cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710\" #export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=${ARO_VM_JUMP_NAME}-public-ip export ARO_VM_JUMP_SIZE=\"Standard_B1ms\" # # arrays # # Microsoft account UPNs for the OpenShift Administrators export ARO_ADMINISTRATORS=() export ARO_ADMINISTRATORS+=(openshift-admin@mitaei.net) export ARO_ADMINISTRATORS+=(arun.babu@mitaei.net) export ARO_ADMINISTRATORS+=(joseph.tingiris@mitaei.net) export ARO_ADMINISTRATORS+=(sivaprasad.k@mitaei.net) # Microsoft Resource Providers needed for ARO export ARO_RESOURCE_PROVIDERS=() export ARO_RESOURCE_PROVIDERS+=(Microsoft.Compute) export ARO_RESOURCE_PROVIDERS+=(Microsoft.RedHatOpenShift) export ARO_RESOURCE_PROVIDERS+=(Microsoft.Storage) # Microsoft account UPNs for who will be made Azure Subscription Owners export ARO_SUBSCRIPTION_OWNERS=() export ARO_SUBSCRIPTION_OWNERS+=(christy.walsh@mitaei.net) export ARO_SUBSCRIPTION_OWNERS+=(joseph.tingiris@mitaei.net) # Microsoft VM Family Quotas that will be verified (to have enough vCPUs for ARO) export ARO_VERIFY_QUOTA_NAMES=() export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs')","title":"4.2 - Set Environment Variables"},{"location":"#43-verify-environment-variables","text":"Ensure the ARO variables are avaialble in the bash shell environment that you're working in. Reference(s): https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=ipm ARO_ADMINISTRATORS_GROUP_NAME=OpenShift Administrators ARO_APPLICATION_NAME=ipm-app ARO_CLUSTER_NAME=ipm-cluster ARO_DOMAIN_NAME=mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_REDHAT_PULL_SECRET_FILE=/home/jtingiris/prj/mit/aei/secrets/ipm-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=ipm-eastus ARO_SERVICE_PRINCIPAL_NAME=http://ipm-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBDOMAIN_NAME=ipm.mitaei.net ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=ipm-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=ipm-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=ipm-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=ipm-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=ipm-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=ipm-vnet-dmz-subnet-nsg ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=ipm-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=ipm-vnet-master-subnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=ipm-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=ipm-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=ipm-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=ipm-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=ipm-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.crt ARO_VGW_PKI_CLIENT_EXT_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=ipm-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-client-example.serial ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=/home/jtingiris/prj/mit/aei/pki/ipm-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=/home/jtingiris/prj/mit/aei/pki/ ARO_VGW_PKI_ROOT_CRT_FILE_NAME=ipm-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=/home/jtingiris/prj/mit/aei/pki/ ARO_VGW_PKI_ROOT_KEY_FILE_NAME=ipm-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VGW_PUBLIC_ADDRESS_NAME=ipm-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=ipm-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=ipm-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=ipm-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=ipm-vnet","title":"4.3 - Verify Environment Variables"},{"location":"#5-setup-required-directories","text":"This documentation provides commands that create files. To better organize the output files, the directories must exist or be created. Command(s): env | egrep \"ARO.*DIR\" Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki","title":"5 - Setup Required Directories"},{"location":"#51-create-required-directories","text":"Reference(s): https://man7.org/linux/man-pages/man1/mkdir.1.html Command(s): mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\"","title":"5.1 - Create Required Directories"},{"location":"#52-verify-required-directories","text":"Reference(s): https://man7.org/linux/man-pages/man1/ls.1.html Command(s): ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" Example Output: drwxrws---+ 3 jtingiris mit 4096 Sep 21 10:06 /home/jtingiris/prj/mit/aei/pki drwxrws---+ 2 jtingiris mit 4096 Sep 17 16:11 /home/jtingiris/prj/mit/aei/secrets","title":"5.2 - Verify Required Directories"},{"location":"#6-setup-azure-cli","text":"The Azure CLI is a Command Line Interface (CLI) used to create and manage Azure resources. The Azure CLI works with all Azure services. It is designed to more quickly work with Azure, with an emphasis on automation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest Command(s): env | egrep \"ARO.*DIR\" Example Output: ARO_REDHAT_PULL_SECRET_DIR=/home/jtingiris/prj/mit/aei/secrets ARO_VGW_PKI_DIR=/home/jtingiris/prj/mit/aei/pki","title":"6 - Setup Azure CLI"},{"location":"#61-install-azure-cli","text":"The Azure CLI is available to install on Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. To install the Azure CLI, please follow the link in the Reference(s) section of this topic. Reference(s): https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Command(s): az --version Example Output: azure-cli 2.12.0 core 2.12.0 telemetry 1.0.6 Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Your CLI is up-to-date. Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy","title":"6.1 - Install Azure CLI"},{"location":"#62-subscription-owner-login","text":"The Azure Subscription Owner must perform the remaining steps in this documentation. Reference(s): https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Command(s): az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net","title":"6.2 - Subscription Owner Login"},{"location":"#63-verify-azure-tenant","text":"One way to verify the Azure Tenant is to obtain the Tenant ID with az. Another way is to login to the Azure AAD portal. The Tenant ID must match what is in the environment configuration file. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_show https://aad.portal.azure.com/ Command(s): az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi Example Output: [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ]","title":"6.3 - Verify Azure Tenant"},{"location":"#64-set-default-subscription","text":"Set the default subscription that the ARO resources will be installed in. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_set Command(s): az account set -s \"${ARO_SUBSCRIPTION_NAME}\" Example Output: + success does not produce any output","title":"6.4 - Set Default Subscription"},{"location":"#65-verify-default-subscription","text":"The Azure CLI Default Subscription will be used to provision all ARO resources. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Command(s): az account list --query '[?isDefault == `true`]' Example Output: [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ]","title":"6.5 - Verify Default Subscription"},{"location":"#7-setup-subscription-owners","text":"There should be at least two (2) Subscription Owners. This step is optional, but recommended. It will use the ${ARO_SUBSCRIPTION_OWNERS} environment value and ensure all User Principal Names (UPNs) are added as Subscription Owners. Reference(s): https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner","title":"7 - Setup Subscription Owners"},{"location":"#71-create-subscription-owners","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create Command(s): for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"name\": \"c3649109-4f94-47cf-9c05-2677f6f1a9a8\", \"principalId\": \"52f7dd5d-ad08-4b40-878f-40686c51c24e\", \"principalName\": \"christy.walsh@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"name\": \"0e3fa58c-ed20-4ead-bc53-47578faf7b8e\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635\", \"roleDefinitionName\": \"Owner\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" }","title":"7.1 - Create Subscription Owners"},{"location":"#72-verify-subscription-owners","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Example Output: Principal Role Scope -------------------------- ------ --------------------------------------------------- christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"7.2 - Verify Subscription Owners"},{"location":"#8-verify-azure-subscription","text":"Uze az to verify Azure Subscription details. The subscription may also be manually verified via the Azure Portal Subscription blade. Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest Command(s): env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" Example Output: ARO_LOCATION_NAME=eastus ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_SUBSCRIPTION_OWNERS=christy.walsh@mitaei.net joseph.tingiris@mitaei.net ARO_VERIFY_QUOTA_NAMES=Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs","title":"8 - Verify Azure Subscription"},{"location":"#81-verify-subscription-name","text":"Verify the following configuration variables are valid: ${ARO_SUBSCRIPTION_NAME} Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade Command(s): az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi Example Output: Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ]","title":"8.1 - Verify Subscription Name"},{"location":"#82-verify-subscription-id","text":"Verify the following configuration variables are valid: ${ARO_SUBSCRIPTION_ID} Reference(s): https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-show Command(s): az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi Example Output: [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ]","title":"8.2 - Verify Subscription ID"},{"location":"#83-verify-subscription-location","text":"Verify the following configuration variables are valid: ${ARO_LOCATION_NAME} NOTE: Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable location for the installation. The location name will be used throughout this document. Reference(s): https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Command(s): az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi Example Output: Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US","title":"8.3 - Verify Subscription Location"},{"location":"#84-verify-subscription-limits","text":"Verify the following configuration variable is not empty: ${ARO_VERIFY_QUOTA_NAMES} An ARO cluster uses several Microsoft Azure components. It requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. The Azure subscription and service limits, quotas, and constraints may be insufficient to install ARO. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. It is wise to check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. ARO minimum limits are required for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html Command(s): if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi Example Output: + success does not produce any output","title":"8.4 - Verify Subscription Limits"},{"location":"#85-verify-subscription-quotas","text":"This step must be done manually. Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner must do this step. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Dv2 Series DSv3 Series To increase the quota limits, a support case must be opened. Microsoft will communicate directly to the person who requested the increase. An increase in the VM series quotas automatically increases the total regional vCPU limit by the same amount. Links to Microsoft's directions on how to request a quota increase for a specific subscription are provided in the references section of this topic. Verify subscription quotas for: Standard DSv3 Family vCPUs Standard Dv2 Family vCPUs Reference(s): https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests","title":"8.5 - Verify Subscription Quotas"},{"location":"#86-standard-dsv3-family-vcpus","text":"Ensure the quota \"limit\" is greater than 50. Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi Example Output: [ { \"currentValue\": \"0\", \"limit\": \"100\", \"localName\": \"Standard DSv3 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard DSv3 Family vCPUs\", \"value\": \"standardDSv3Family\" } } ]","title":"8.6 - Standard DSv3 Family vCPUs"},{"location":"#87-standard-dv2-family-vcpus","text":"Ensure the quota \"limit\" is greater than 50. Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi Example Output: [ { \"currentValue\": \"0\", \"limit\": \"100\", \"localName\": \"Standard Dv2 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard Dv2 Family vCPUs\", \"value\": \"standardDv2Family\" } } ]","title":"8.7 - Standard Dv2 Family vCPUs"},{"location":"#9-setup-openshift-administrators","text":"Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities. The details for how to use az to create users, groups, and add the necessary subscription roles is described below. Command(s): env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" Example Output: ARO_DOMAIN_NAME=mitaei.net ARO_ADMINISTRATORS=openshift-admin@mitaei.net arun.babu@mitaei.net joseph.tingiris@mitaei.net sivaprasad.k@mitaei.net","title":"9 - Setup OpenShift Administrators"},{"location":"#91-create-administrator-accounts","text":"This is a good time for the Global Administrator to create Microsoft accounts for the OpenShift Administrators. Ideally, the OpenShift Administrators would also have the Global Administrator role for the tenant. However, this is not always possible. If you are the Global Administrator then please take note that the OpenShift Administrators must have Microsoft accounts in the tenant , and their Microsoft accounts must have at least the Contributor and User Access Administrator roles for the Azure Subscription in which ARO is to be deployed. Creating users may be done with az , via the AAD portal, or [https://admin.microsoft.com]. NOTE: The openshift-admin user created is an example and should not be used. We strongly recommend using real names and individual accounts, not ficticous names or group accounts. Command(s): az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login Example Output: { \"accountEnabled\": true, \"ageGroup\": null, \"assignedLicenses\": [], \"assignedPlans\": [], \"city\": null, \"companyName\": null, \"consentProvidedForMinor\": null, \"country\": null, \"createdDateTime\": null, \"creationType\": null, \"deletionTimestamp\": null, \"department\": null, \"dirSyncEnabled\": null, \"displayName\": \"openshift-admin@mitaei.net\", \"employeeId\": null, \"facsimileTelephoneNumber\": null, \"givenName\": null, \"immutableId\": null, \"isCompromised\": null, \"jobTitle\": null, \"lastDirSyncTime\": null, \"legalAgeGroupClassification\": null, \"mail\": null, \"mailNickname\": \"openshift-admin\", \"mobile\": null, \"objectId\": \"8f9fc0bc-e694-435f-b0f8-1eb4c66caabb\", \"objectType\": \"User\", \"odata.metadata\": \"https://graph.windows.net/25fe96e7-85ec-4e6a-b93f-779b16ff751d/$metadata#directoryObjects/@Element\", \"odata.type\": \"Microsoft.DirectoryServices.User\", \"onPremisesDistinguishedName\": null, \"onPremisesSecurityIdentifier\": null, \"otherMails\": [], \"passwordPolicies\": null, \"passwordProfile\": { \"enforceChangePasswordPolicy\": false, \"forceChangePasswordNextLogin\": true, \"password\": null }, \"physicalDeliveryOfficeName\": null, \"postalCode\": null, \"preferredLanguage\": null, \"provisionedPlans\": [], \"provisioningErrors\": [], \"proxyAddresses\": [], \"refreshTokensValidFromDateTime\": \"2020-09-23T14:09:26.228763Z\", \"showInAddressList\": null, \"signInNames\": [], \"sipProxyAddress\": null, \"state\": null, \"streetAddress\": null, \"surname\": null, \"telephoneNumber\": null, \"thumbnailPhoto@odata.mediaEditLink\": \"directoryObjects/8f9fc0bc-e694-435f-b0f8-1eb4c66caabb/Microsoft.DirectoryServices.User/thumbnailPhoto\", \"usageLocation\": null, \"userIdentities\": [], \"userPrincipalName\": \"openshift-admin@mitaei.net\", \"userState\": null, \"userStateChangedOn\": null, \"userType\": \"Member\" }","title":"9.1 - Create Administrator Accounts"},{"location":"#92-verify-administrator-accounts","text":"Verify the OpenShift Administrator accounts listed in ${ARO_ADMINISTRATORS} exist. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done Example Output: [ { \"userPrincipalName\": \"openshift-admin@mitaei.net\" }, { \"principalId\": \"8f9fc0bc-e694-435f-b0f8-1eb4c66caabb\" } ] [ { \"userPrincipalName\": \"arun.babu@mitaei.net\" }, { \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\" } ] [ { \"userPrincipalName\": \"joseph.tingiris@mitaei.net\" }, { \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\" } ] [ { \"userPrincipalName\": \"sivaprasad.k@mitaei.net\" }, { \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\" } ]","title":"9.2 - Verify Administrator Accounts"},{"location":"#93-create-administrator-roles","text":"The Contributor and User Access Administrator subscription roles are required to administer ARO. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done Example Output: { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/af5625a2-869f-4b1f-af1e-c7dc3bd9fd29\", \"name\": \"af5625a2-869f-4b1f-af1e-c7dc3bd9fd29\", \"principalId\": \"8f9fc0bc-e694-435f-b0f8-1eb4c66caabb\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/c1488473-33f8-488e-8db5-2f39e2c8d74f\", \"name\": \"c1488473-33f8-488e-8db5-2f39e2c8d74f\", \"principalId\": \"8f9fc0bc-e694-435f-b0f8-1eb4c66caabb\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/8f458612-ca5f-4ff2-832a-d00e700975b0\", \"name\": \"8f458612-ca5f-4ff2-832a-d00e700975b0\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/7f1ba7da-c858-489f-a988-39123faa181f\", \"name\": \"7f1ba7da-c858-489f-a988-39123faa181f\", \"principalId\": \"4c3b0f6a-3e08-4d7e-9161-2a540bea4dc8\", \"principalName\": \"arun.babu@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/6f98e077-c161-453d-a903-b00acb9bd5f2\", \"name\": \"6f98e077-c161-453d-a903-b00acb9bd5f2\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"name\": \"91ea94dc-f9aa-486b-8c92-7c1911bced00\", \"principalId\": \"83525d38-8d7f-4476-81aa-14c46c4cb876\", \"principalName\": \"joseph.tingiris@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/1bf7b433-935b-4160-a634-43bd291739c8\", \"name\": \"1bf7b433-935b-4160-a634-43bd291739c8\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c\", \"roleDefinitionName\": \"Contributor\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" } { \"canDelegate\": null, \"condition\": null, \"conditionVersion\": null, \"description\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleAssignments/13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"name\": \"13f30fcc-49ed-45dd-b971-0566b2c3220b\", \"principalId\": \"26d953e1-003f-4f61-9e68-4f3a5216d8e9\", \"principalName\": \"sivaprasad.k@mitaei.net\", \"principalType\": \"User\", \"roleDefinitionId\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\", \"roleDefinitionName\": \"User Access Administrator\", \"scope\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942\", \"type\": \"Microsoft.Authorization/roleAssignments\" }","title":"9.3 - Create Administrator Roles"},{"location":"#94-verify-administrator-roles","text":"Verify all ${ARO_ADMINISTRATORS} have the Contributor and User Access Administrator subscription roles. Command(s): for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done Example Output: Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- openshift-admin@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 openshift-admin@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"9.4 - Verify Administrator Roles"},{"location":"#10-setup-resource-providers","text":"Make sure you are logged in to Azure via az az login and have the Contributor or Owner role. NOTE: These steps will fail with only the User Access Administrator role. An unauthorized message will be received. These steps will fail without the --wait flag. Dependent providers are automatically registered and they must be registered first. Reference(s): https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types Command(s): echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" Example Output: ARO_RESOURCE_PROVIDERS=Microsoft.Compute Microsoft.RedHatOpenShift Microsoft.Storage","title":"10 - Setup Resource Providers"},{"location":"#101-register-provider-microsoftcompute","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Compute --wait Example Output: + success does not produce any output","title":"10.1 - Register Provider Microsoft.Compute"},{"location":"#102-verify-provider-microsoftcompute","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Compute --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered","title":"10.2 - Verify Provider Microsoft.Compute"},{"location":"#103-register-provider-microsoftredhatopenshift","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.RedHatOpenShift --wait Example Output: + success does not produce any output","title":"10.3 - Register Provider Microsoft.RedHatOpenShift"},{"location":"#104-verify-provider-microsoftredhatopenshift","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.RedHatOpenShift --output table Example Output: Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered","title":"10.4 - Verify Provider Microsoft.RedHatOpenShift"},{"location":"#105-register-provider-microsoftstorage","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_register Command(s): az provider register -n Microsoft.Storage --wait Example Output: + success does not produce any output","title":"10.5 - Register Provider Microsoft.Storage"},{"location":"#106-verify-provider-microsoftstorage","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Command(s): az provider show --namespace Microsoft.Storage --output table Example Output: Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered","title":"10.6 - Verify Provider Microsoft.Storage"},{"location":"#11-setup-resource-group","text":"An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest Command(s): env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' Example Output: ARO_LOCATION_NAME=eastus ARO_RESOURCE_GROUP_NAME=ipm-eastus","title":"11 - Setup Resource Group"},{"location":"#111-create-resource-group","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Command(s): az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"11.1 - Create Resource Group"},{"location":"#112-verify-resource-group","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Command(s): az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"ipm-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"11.2 - Verify Resource Group"},{"location":"#12-setup-virtual-network","text":"An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. Reference(s): https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Command(s): env | grep ^ARO_VNET | sort -V Example Output: ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=ipm-vnet","title":"12 - Setup Virtual Network"},{"location":"#121-create-virtual-network","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-create https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x Command(s): az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_ADDRESS_PREFIX} Example Output: { \"newVNet\": { \"addressSpace\": { \"addressPrefixes\": [ \"10.11.0.0/21\" ] }, \"bgpCommunities\": null, \"ddosProtectionPlan\": null, \"dhcpOptions\": { \"dnsServers\": [] }, \"enableDdosProtection\": false, \"enableVmProtection\": false, \"etag\": \"W/\\\"070e6b93-8c8b-4c6a-84f9-231a20da9180\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ipm-eastus/providers/Microsoft.Network/virtualNetworks/ipm-vnet\", \"ipAllocations\": null, \"location\": \"eastus\", \"name\": \"ipm-vnet\", \"provisioningState\": \"Succeeded\", \"resourceGroup\": \"ipm-eastus\", \"resourceGuid\": \"71df59a1-9f16-450f-a6b5-282bacfe01bb\", \"subnets\": [], \"tags\": {}, \"type\": \"Microsoft.Network/virtualNetworks\", \"virtualNetworkPeerings\": [] } }","title":"12.1 - Create Virtual Network"},{"location":"#122-verify-virtual-network","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Command(s): az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --output table Example Output: EnableDdosProtection EnableVmProtection Location Name ProvisioningState ResourceGroup ResourceGuid ---------------------- -------------------- ---------- -------- ------------------- --------------- ------------------------------------ False False eastus ipm-vnet Succeeded ipm-eastus 71df59a1-9f16-450f-a6b5-282bacfe01bb","title":"12.2 - Verify Virtual Network"},{"location":"about/","text":"\u00a9 2020 Mastech InfoTrellis, Ltd. Authors Joseph Tingiris < joseph.tingiris@mastechinfotrellis.com > Arun Babu < arun.babu@mastechinfotrellis.com > SivaPrasad Konduru < sivaprasad.k@mastechinfotrellis.com >","title":"About"},{"location":"about/#2020-mastech-infotrellis-ltd","text":"","title":"&copy; 2020 Mastech InfoTrellis, Ltd."},{"location":"about/#authors","text":"Joseph Tingiris < joseph.tingiris@mastechinfotrellis.com > Arun Babu < arun.babu@mastechinfotrellis.com > SivaPrasad Konduru < sivaprasad.k@mastechinfotrellis.com >","title":"Authors"},{"location":"draft-aro-verify-aro/","text":"Step 1 - Setup Azure Tenant A tenant is Microsoft's representation of an organization. It's a dedicated instance of Azure Active Directory (AAD) that an organization or app developer receives when create a relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before you can install Azure Red Hat OpenShift (ARO), Microsoft accounts must exist and have appropriate access to an AAD Tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. If you are the Global Administrator of an existing tenant, go to step 2. References: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant Step 1.1 - Create a new Microsoft Account A Microsoft account represents a billing relationship. The account consists of a user identity, one or more subscriptions, and an associated set of resources. The person who creates the account is the administrators for all subscriptions created in that account. That person is also the default Service Administrator for the subscription(s) and, for Microsoft 365, possesses the Global Administrator role. The purpose of this step is to create a new Microsoft 365 (onmicrosoft.com) account, to establish a Global Administrator relationship for use with all Microsoft 365 services, including Azure. An Azure Active Directory Premium P1 license is required for Azure Red Hat OpenShift (ARO). Please note that this step does not mandate a purchase of a Microsoft 365 Business Premium license . This is simply one way to create a new tenant and become a Global Administrator. A license may be purchased now, or afterwards. Go to the Microsoft 365 for Business store. https://www.microsoft.com/en-us/microsoft-365/business/compare-all-microsoft-365-business-products Proceed to purchase at least one (1) Microsoft 365 Business Premium license. This will also include an Azure Active Directory (AAD) Premium P1 license, which is needed for Azure Red Hat OpenShift (ARO). The Microsoft 365 Business Premium provides an AAD P1 license, and other 365 services. If you do not wish to have all the 365 services, then a dedicated AAD Premium P1 (or better) may be purchased by a Billing or Global Administrator who has access to an existing tenant. Step 1.2 - Create the first Global Administrator The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Reset passwords for all users Add and manage domains References: https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide Step 1.3 - Verify Microsoft 365 Admin Center Access The Microsoft 365 admin center is built for IT teams as a simplified way to manage your Microsoft 365 services. The admin center provides a tailored experience based on the unique needs of your role or organization, improves efficiency for everyday tasks, and provides actionable insights that help you make data-driven decisions to deliver a better experience for your users. The Microsoft 365 admin center is the common entry point for all Microsoft 365 admins and can be accessed at https://admin.microsoft.com/ References: https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide Step 1.4 - Verify Azure Active Directory License To verify the license, go to the Azure Active Directory Overview: https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview References: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis Step 2 - Setup Azure Subscription An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required for these procedures. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. That is out of scope for this document. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators and Service Principals. Step 2.1 - Purchase New Azure Subscription The Microsoft account that purchases the Azure subscription will be the Subscription owner. References: https://azure.microsoft.com/ Step 3 - Setup Operating System & Required Tools The remaining procedures in this document depend on the following operating system and tools. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+) bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep Google Chrome or Firefox Step 3.1 - Verify Operating System Commands: uname -a Example Output: # uname -a Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux Step 3.2 - Verify bash Commands: bash --version Example Output: # bash --version GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Step 3.3 - Verify GNU awk Commands: awk --version Example Output: # awk --version GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/. Step 3.4 - Verify GNU coreutils References: https://www.gnu.org/software/coreutils/ Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: # base64 --version base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. # basename --version basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. # dirname --version dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. # sort --version sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. # head --version head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. # tail --version tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering. Step 3.5 - Verify GNU grep Command(s): grep --version egrep --version Example Output: # grep --version grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. # egrep --version grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. Step 3.6 - Verify Google Chrome or Firefix Commands: firefox --version google-chrome --version Example Output: # firefox --version Mozilla Firefox 80.0 # google-chrome --version Google Chrome 85.0.4183.83 Step 3.7 - Verify OpenSSL Commands: openssl version Example Output: # openssl version OpenSSL 1.1.1g FIPS 21 Apr 2020 Step 4 - Setup Required ARO Environment Variables There are many prerequisites for a successful installation of Azure Red Hat OpenShift. The necessary bash environment variables are required to execute the steps in this document. Before proceeding, please take your time ensuring the values are correct. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html Step 4.1 - Export Required ARO Environment Variables These bash environment variables are required must be exported. They are reused for multiple steps. These are example values that must be changed for your installation. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO='aro' export ARO_APPLICATION_NAME='aro-app' export ARO_CLUSTER_NAME='aro-cluster' export ARO_DOMAIN_NAME='aro.mitaei.net' export ARO_LOCATION_NAME='eastus' export ARO_REDHAT_PULL_SECRET='./secret/test-redhat-pull-secret.txt' export ARO_REDHAT_PULL_SECRET_FILE='./secret/aro-redhat-pull-secret.txt' export ARO_RESOURCE_GROUP_NAME='aro-eastus' export ARO_SERVICE_PRINCIPAL_NAME='http://aro-app' export ARO_SERVICE_PRINCIPAL_PASSWORD='S3rv1c3Pr1cip4lP4ssw0rd!' export ARO_SUBNET_AGW_ADDRESS_PREFIX='10.11.4.0/25' export ARO_SUBNET_AGW_NAME='aro-vnet-agw-subnet' export ARO_SUBNET_AGW_NSG_NAME='aro-vnet-agw-subnet-nsg' export ARO_SUBNET_DB_ADDRESS_PREFIX='10.11.4.128/25' export ARO_SUBNET_DB_NAME='aro-vnet-db-subnet' export ARO_SUBNET_DB_NSG_NAME='aro-vnet-db-subnet-nsg' export ARO_SUBNET_DMZ_ADDRESS_PREFIX='10.11.5.0/25' export ARO_SUBNET_DMZ_NAME='aro-vnet-dmz-subnet' export ARO_SUBNET_DMZ_NSG_NAME='aro-vnet-dmz-subnet-nsg' export ARO_SUBNET_GATEWAY_ADDRESS_PREFIX='10.11.6.0/25' export ARO_SUBNET_GATEWAY_NAME='GatewaySubnet' export ARO_SUBNET_GATEWAY_NSG_NAME='GatewaySubnet-nsg' export ARO_SUBNET_MASTER_ADDRESS_PREFIX='10.11.0.0/23' export ARO_SUBNET_MASTER_NAME='aro-vnet-master-subnet' export ARO_SUBNET_MASTER_NSG_NAME='aro-vnet-master-subnet-nsg' export ARO_SUBNET_TRUSTED_ADDRESS_PREFIX='10.11.5.128/25' export ARO_SUBNET_TRUSTED_NAME='aro-vnet-trusted-subnet' export ARO_SUBNET_TRUSTED_NSG_NAME='aro-vnet-trusted-subnet-nsg' export ARO_SUBNET_VGW_ADDRESS_PREFIX='10.11.6.0/25' export ARO_SUBNET_VGW_NAME='GatewaySubnet' export ARO_SUBNET_VGW_NSG_NAME='GatewaySubnet-nsg' export ARO_SUBNET_WORKER_ADDRESS_PREFIX='10.11.2.0/23' export ARO_SUBNET_WORKER_NAME='aro-vnet-worker-subnet' export ARO_SUBNET_WORKER_NSG_NAME='aro-vnet-worker-subnet-nsg' export ARO_SUBSCRIPTION_ID='12c7070f-83e5-453b-96d0-90770d2cf942' export ARO_SUBSCRIPTION_NAME='Azure subscription for mitaei' export ARO_TENANT_ID='25fe96e7-85ec-4e6a-b93f-779b16ff751d' export ARO_TENANT_NAME='mitaei.net' export ARO_VGW_NAME='aro-vpn' export ARO_VGW_PKI_BITS='2048' export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!3x4mpl3Cl13ntP4ssphr4s3!' export ARO_VGW_PKI_DIR='./pki' export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE='./pki/aro-vpn-root.serial' export ARO_VGW_PKI_ROOT_CRT_FILE='./pki/aro-vpn-root.crt' export ARO_VGW_PKI_ROOT_CRT_FILE_NAME='aro-vpn-root.crt' export ARO_VGW_PKI_ROOT_KEY_FILE='./pki/aro-vpn-root.key' export ARO_VGW_PKI_ROOT_KEY_FILE_NAME='aro-vpn-root.key' export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VGW_POOL_ADDRESS_PREFIX='172.16.11.0/24' export ARO_VGW_PUBLIC_ADDRESS_NAME='aro-vpn-public-ip' export ARO_VGW_REDUNDANCY='true' export ARO_VGW_SKU='VpnGw1AZ' export ARO_VGW_TYPE='RouteBased' export ARO_VM_JUMP_ADMIN_NAME='aro-vm-jumpbox-admin' export ARO_VM_JUMP_HOSTNAME='jumpbox' export ARO_VM_JUMP_IMAGE_MARKETPLACE='true' export ARO_VM_JUMP_IMAGE_URN='cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710' export ARO_VM_JUMP_NAME='aro-vm-jumpbox' export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME='aro-vm-jumpbox-public-ip' export ARO_VM_JUMP_SIZE='Standard_B1ms' export ARO_VNET_ADDRESS_PREFIX='10.11.0.0/21' export ARO_VNET_NAME='aro-vnet' export ARO_VPN_GATEWAY_NAME='test-vpn' export ARO_VPN_GATEWAY_PKI_CERTIFICATE='./pki/test-vpn.crt' export ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE='./pki/test-vpn.crt' export ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE_NAME='test-vpn.crt' export ARO_VPN_GATEWAY_PKI_KEY='./pki/test-vpn.key' export ARO_VPN_GATEWAY_PKI_KEY_FILE='./pki/test-vpn.key' export ARO_VPN_GATEWAY_PKI_KEY_FILE_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VPN_GATEWAY_PKI_KEY_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VPN_GATEWAY_PKI_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VPN_GATEWAY_POOL_ADDRESS_PREFIX='172.16.11.0/24' export ARO_VPN_GATEWAY_PRIVATE_ADDRESS_POOL_PREFIX='172.16.11.0/24' export ARO_VPN_GATEWAY_PUBLIC_ADDRESS_NAME='test-vpn-public-ip' export ARO_VPN_GATEWAY_REDUNDANCY='true' export ARO_VPN_GATEWAY_SKU='VpnGw1AZ' export ARO_VPN_GATEWAY_TYPE='RouteBased' export ARO_VPN_PUBLIC_ADDRESS_NAME='test-vpn-public-ip' export ARO_ADMINISTRATORS=(joseph.tingiris@mitaei.net arun.babu@mitaei.net sivaprasad.k@mitaei.net) export ARO_SUBSCRIPTION_OWNERS=(joseph.tingiris@mitaei.net christy.walsh@mitaei.net arun.babu@mitaei.net sivaprasad.k@mitaei.net) export ARO_RESOURCE_PROVIDERS=(Microsoft.RedHatOpenShift Microsoft.Compute Microsoft.Storage) export ARO_VERIFY_QUOTA_NAMEs=() export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') Step 4.2 - Verify Required ARO Environment Variables Ensure the ARO bash environment variables are globally available. References: https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=aro ARO_APPLICATION_NAME=aro-app ARO_CLUSTER_NAME=aro-cluster ARO_DOMAIN_NAME=aro.mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET=./secret/test-redhat-pull-secret.txt ARO_REDHAT_PULL_SECRET_FILE=./secret/aro-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=aro-eastus ARO_SERVICE_PRINCIPAL_NAME=http://aro-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=aro-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=aro-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=aro-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=aro-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=aro-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=aro-vnet-dmz-subnet-nsg ARO_SUBNET_GATEWAY_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_GATEWAY_NAME=GatewaySubnet ARO_SUBNET_GATEWAY_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=aro-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=aro-vnet-master-subnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=aro-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=aro-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=aro-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=aro-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=aro-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!3x4mpl3Cl13ntP4ssphr4s3! ARO_VGW_PKI_DIR=./pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=./pki/aro-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=./pki/aro-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_FILE_NAME=aro-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=./pki/aro-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_NAME=aro-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VGW_PUBLIC_ADDRESS_NAME=aro-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=aro-vm-jumpbox-admin ARO_VM_JUMP_HOSTNAME=jumpbox ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=aro-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=aro-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=aro-vnet ARO_VPN_GATEWAY_NAME=test-vpn ARO_VPN_GATEWAY_PKI_CERTIFICATE=./pki/test-vpn.crt ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE=./pki/test-vpn.crt ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE_NAME=test-vpn.crt ARO_VPN_GATEWAY_PKI_KEY=./pki/test-vpn.key ARO_VPN_GATEWAY_PKI_KEY_FILE=./pki/test-vpn.key ARO_VPN_GATEWAY_PKI_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VPN_GATEWAY_PKI_KEY_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VPN_GATEWAY_PKI_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VPN_GATEWAY_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VPN_GATEWAY_PRIVATE_ADDRESS_POOL_PREFIX=172.16.11.0/24 ARO_VPN_GATEWAY_PUBLIC_ADDRESS_NAME=test-vpn-public-ip ARO_VPN_GATEWAY_REDUNDANCY=true ARO_VPN_GATEWAY_SKU=VpnGw1AZ ARO_VPN_GATEWAY_TYPE=RouteBased ARO_VPN_PUBLIC_ADDRESS_NAME=test-vpn-public-ip Step 5 - Obtain Pull Secrets Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries. Step 5.1 - Obtain Red Hat Pull Secret A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. This step must be done manually. It is optional but recommended. Go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned Step 5.2 - Verify Red Hat Pull Secret Commands: ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: -rw-rw----. 1 jtingiris mit 2835 Sep 11 20:06 ./secret/aro-redhat-pull-secret.txt Step 6 - Setup Azure CLI The Azure command-line interface (Azure CLI) is a set of commands used to create and manage Azure resources. The Azure CLI is available across Azure services and is designed to get you working quickly with Azure, with an emphasis on automation. References: https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest Step 6.1 - Install Azure CLI The Azure CLI is available to install in Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. To install, please follow the link in the References section. References: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Commands: az --version Example Output: # az --version azure-cli 2.11.1 core 2.11.1 telemetry 1.0.5 * Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy Step 6.2 - Show Default Subscription References: https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Commands: az account list --query '[?isDefault == `true`]' Example Output: # az account list --query '[?isDefault == `true`]' [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ] Step 6.3 - Login as the Subscription Owner The Azure Subscription Owner must perform the following steps. References: https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Commands: az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net Step 7 - Setup Additional Subscription Owners This step is optional, but recommended. There should be at least two (2) Subscription Owners. References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create Step 7.1 - Verify Subscription Owners References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Example Output: # az role assignment list --role Owner --output table Principal Role Scope -------------------------- ------ --------------------------------------------------- sivaprasad.k@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Step 8 - Verify Azure Tenant Go to the Microsoft admin center and login with a Microsoft account that is the Global administrator. https://admin.microsoft.com/ A Global Administrator will have access to all portions of the admin center. Commands: az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' Example Output: # az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ] Step 9 - Verify Azure Subscription The Azure Subscription can also be verified by going to: https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade Step 9.1 - Verify Subscription Names References: https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list Commands: az account list --output table Example Output: # az account list --output table Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True # az account show --subscription \"12c7070f-83e5-453b-96d0-90770d2cf942\" --query \"[{subscription_name:name},{subscription_id:id}]\" [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ] Step 9.2 - Verify Subscription Location Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable regions for the installation. The region name will be used throughout this document. References: https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Commands: az account list-locations --query \\\"[?name=='${ARO_LOCATION_NAME}']\\\" --output table Example Output: # az account list-locations --query \"[?name=='eastus']\" --output table Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US Step 9.3 - Verify Subscription Limits The Azure Red Hat OpenShift (ARO) cluster uses several Microsoft Azure components, and the default Azure subscription and service limits, quotas, and constraints affect the ability to install ARO clusters. A default ARO cluster requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. If an existing Azure Subscription is used then check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. References: https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html ARO minimum limits are required for: Standard Dv2 Family vCPUs Standard DSv3 Family vCPUs Step 9.4 - Verify Subscription Quotas Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner should do this step. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Dv2 Series DSv3 Series An increase in the VM series quotas automatically increases the total regional vCPU limit by the same amount. Please use the links in the references of this section for Microsoft's directions on how to request a quota increase for a specific subscription. A support case will be opened, and Microsoft will communicate directly to the person who requested the increase. References: https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests Verify subscription quotas for: Standard Dv2 Family vCPUs Standard DSv3 Family vCPUs Step 9.5 - Verify Subscription Quota for Standard Dv2 Family vCPUs References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_list_usage Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" Example Output: # az vm list-usage --location eastus --query \"[?localName=='Standard Dv2 Family vCPUs']\" [ { \"currentValue\": \"0\", \"limit\": \"100\", \"localName\": \"Standard Dv2 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard Dv2 Family vCPUs\", \"value\": \"standardDv2Family\" } } ] Step 9.6 - Verify Subscription Quota for Standard DSv3 Family vCPUs References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_list_usage Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" Example Output: # az vm list-usage --location eastus --query \"[?localName=='Standard DSv3 Family vCPUs']\" [ { \"currentValue\": \"36\", \"limit\": \"100\", \"localName\": \"Standard DSv3 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard DSv3 Family vCPUs\", \"value\": \"standardDSv3Family\" } } ] Step 10 - Setup OpenShift Administrators Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities. Step 10.1 - Verify OpenShift Administrator Accounts Ensure the OpenShift Administrator accounts exist and have the appropriate subscription roles. References: https://docs.microsoft.com/en-us/cli/azure/ad/user?view=azure-cli-latest#az_ad_user_show Commands: for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query userPrincipalName --output tsv; done Example Output: # az ad user show --id joseph.tingiris@mitaei.net --query userPrincipalName --output tsv joseph.tingiris@mitaei.net # az ad user show --id arun.babu@mitaei.net --query userPrincipalName --output tsv arun.babu@mitaei.net # az ad user show --id sivaprasad.k@mitaei.net --query userPrincipalName --output tsv sivaprasad.k@mitaei.net Step 10.2 - Verify OpenShift Administrator Subscription Roles References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Commands: for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; echo; done Example Output: # az role assignment list --assignee joseph.tingiris@mitaei.net --output table Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 # az role assignment list --assignee arun.babu@mitaei.net --output table Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 # az role assignment list --assignee sivaprasad.k@mitaei.net --output table Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Step 11 - Setup Azure Resource Providers Make sure you are logged in to Azure via az (az login) with a Contributor or Owner role. This step will fail for OpenShift Admins with only the User Access Administrator. They will receive a message saying they do not have authorization. Step 11.1 - Verify Provider Microsoft.RedHatOpenShift References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.RedHatOpenShift --output table Example Output: # az provider show --namespace Microsoft.RedHatOpenShift --output table Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered Step 11.2 - Verify Provider Microsoft.Compute References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.Compute --output table Example Output: # az provider show --namespace Microsoft.Compute --output table Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered Step 11.3 - Verify Provider Microsoft.Storage References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.Storage --output table Example Output: # az provider show --namespace Microsoft.Storage --output table Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered Step 12 - Setup Resource Group An Azure resource group is a logical group in which Azure resources are deployed and managed. A resource group location must be specified. This location is where resource group metadata is stored, it is also where the Azure resources are hosted. References: https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Commands: az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: Step 12.1 - Verify Resource Group References: https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Commands: az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: # az group show --name aro-eastus { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"aro-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } Step 13 - Setup Virtual Network An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. References: https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Commands: env | grep ^ARO_VNET | sort Example Output: ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=aro-vnet Step 13.1 - Verify Virtual Network References: https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Commands: az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: # az network vnet show --resource-group aro-eastus --name aro-vnet --output table EnableDdosProtection EnableVmProtection Location Name ProvisioningState ResourceGroup ResourceGuid ---------------------- -------------------- ---------- -------- ------------------- --------------- ------------------------------------ False False eastus aro-vnet Succeeded aro-eastus 5e95b396-9ff5-443f-ac52-301b58b263f1 Step 14 - Setup Azure Red Hat OpenShift Subnets Azure Red Hat OpenShift clusters require a virtual network with two empty subnets, for the master and worker nodes. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. It is suggested the virtual network (vnet) prefix be /21 and each (master and worker) vnet subnet prefix be /23, which will allow for a total of 510 master nodes and 510 worker nodes. The additional subnets within the /21 prefix will be used for a VPN Gateway subnet and future growth. NOTE: In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher ; Please see the references in this section for more details._ References: https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Commands: env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort Example Output: ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=aro-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=aro-vnet-master-subnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=aro-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=aro-vnet-worker-subnet-nsg Step 14.1 - Verify Master Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-master-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.0.0/23 aro-vnet-master-subnet Enabled Disabled Succeeded aro-eastus Step 14.2 - Verify Worker Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-worker-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.2.0/23 aro-vnet-worker-subnet Enabled Enabled Succeeded aro-eastus Step 15 - Setup Additional Network Security Groups Azure Network Security Groups filter network traffic to and from Azure resources in an Azure virtual network. A Network Security Group contains security rules that allow/deny network traffic to/from several types of Azure resources. NOTE: The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. References: https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Commands: env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|GATEWAY' | sort Example Output: ARO_SUBNET_AGW_NSG_NAME=aro-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=aro-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=aro-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=aro-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg Step 15.1 - Verify Network Security Groups References: https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_show Commands: az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table Example Output: # az network nsg show --resource-group aro-eastus --name aro-vnet-agw-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus aro-vnet-agw-subnet-nsg Succeeded aro-eastus 3b720dab-4921-421b-b996-a50b681f89d2 # az network nsg show --resource-group aro-eastus --name aro-vnet-db-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ---------------------- ------------------- --------------- ------------------------------------ eastus aro-vnet-db-subnet-nsg Succeeded aro-eastus 9b55287f-fab2-4bc3-b057-b30b36e87846 # az network nsg show --resource-group aro-eastus --name aro-vnet-dmz-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus aro-vnet-dmz-subnet-nsg Succeeded aro-eastus c7553c67-3a70-41a2-bc2f-613ed23f0faa # az network nsg show --resource-group aro-eastus --name aro-vnet-trusted-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- --------------------------- ------------------- --------------- ------------------------------------ eastus aro-vnet-trusted-subnet-nsg Succeeded aro-eastus d24fbceb-dec5-4600-b5dc-84f1bfb3fa92 Step 16 - Setup Additional Network Security Group Rules Network security group security rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows a network security group to be stateful. References: https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Step 16.1 - Verify DMZ Network Security Group Rules References: https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_show # az network nsg show --resource-group aro-eastus --name aro-vnet-dmz-subnet-nsg --query securityRules --output table Protocol SourcePortRange DestinationPortRange SourceAddressPrefix DestinationAddressPrefix Access Priority Direction ProvisioningState Name ResourceGroup ---------- ----------------- ---------------------- --------------------- -------------------------- -------- ---------- ----------- ------------------- -------- --------------- Tcp * 22 * * Allow 1000 Inbound Succeeded AllowSSH aro-eastus Step 17 - Setup Additional Subnets Azure Red Hat OpenShift clusters require a virtual network with two empty subnets, for the master and worker nodes. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. It is suggested the virtual network (vnet) prefix be /21 and each (master and worker) vnet subnet prefix be /23, which will allow for a total of 510 master nodes and 510 worker nodes. NOTE: In 2018, Microsoft started automatically enabling Network Watcher when a new subnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher ; Please see the references in this section for more details._ References: https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Commands: env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|GATEWAY' | sort Example Output: ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=aro-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=aro-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=aro-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=aro-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=aro-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=aro-vnet-dmz-subnet-nsg ARO_SUBNET_GATEWAY_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_GATEWAY_NAME=GatewaySubnet ARO_SUBNET_GATEWAY_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=aro-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=aro-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg Step 17.1 - Verify Application Gateway Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-agw-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.4.0/25 aro-vnet-agw-subnet Enabled Enabled Succeeded aro-eastus Step 17.2 - Verify Database Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-db-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------ -------------------------------- ----------------------------------- ------------------- --------------- 10.11.4.128/25 aro-vnet-db-subnet Enabled Enabled Succeeded aro-eastus Step 17.3 - Verify DMZ Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-dmz-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.5.0/25 aro-vnet-dmz-subnet Enabled Enabled Succeeded aro-eastus Step 17.4 - Verify Trusted Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-trusted-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.5.128/25 aro-vnet-trusted-subnet Enabled Enabled Succeeded aro-eastus Step 18 - Setup Jump Server Virtual Machine A jump server, jump host or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example is managing a host in a DMZ from trusted networks or computers. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet, and it will be allowed to communicate with the other internal subnets. References: https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-cli-complete https://en.wikipedia.org/wiki/Jump_server https://en.wikipedia.org/wiki/DMZ_(computing) Commands: env | grep JUMP | sort Example Output: ARO_VM_JUMP_ADMIN_NAME=aro-vm-jumpbox-admin ARO_VM_JUMP_HOSTNAME=jumpbox ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=aro-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=aro-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms Step 18.1 - Verify Jump Server Public IP Address References: https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Commands: az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: # az network public-ip show --name aro-vm-jumpbox-public-ip --resource-group aro-eastus { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"f1c09679-d757-4cc3-9155-95b3ce4f9082\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Network/publicIPAddresses/aro-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": \"52.142.59.191\", \"ipConfiguration\": { \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Network/networkInterfaces/aro-vm-jumpbox-nic/ipConfigurations/ipconfig1\", \"name\": null, \"privateIpAddress\": null, \"privateIpAllocationMethod\": null, \"provisioningState\": null, \"publicIpAddress\": null, \"resourceGroup\": \"aro-eastus\", \"subnet\": null }, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"aro-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"aro-eastus\", \"resourceGuid\": \"84a25205-87c8-4234-b8ea-6dea48782e2c\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null } Step 18.2 - Verify Jump Server Virtual NIC A network interface enables an Azure Virtual Machine to communicate with internet, Azure, and on-premises resources. References: https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_show https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface Commands: az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table Example Output: # az network nic show --resource-group aro-eastus --name aro-vm-jumpbox-nic --output table EnableAcceleratedNetworking EnableIpForwarding Location MacAddress Name Primary ProvisioningState ResourceGroup ResourceGuid ----------------------------- -------------------- ---------- ----------------- ------------------ --------- ------------------- --------------- ------------------------------------ False False eastus 00-0D-3A-9D-48-E3 aro-vm-jumpbox-nic True Succeeded aro-eastus aa1f5850-250e-4317-9301-51d82f083573 Step 18.3 - Verify Jump Server Availability Set References: https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create Commands: az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table Example Output: # az vm availability-set show --resource-group aro-eastus --name aro-vm-jumpbox-as --output table Location Name PlatformFaultDomainCount PlatformUpdateDomainCount ResourceGroup ---------- ----------------- -------------------------- --------------------------- --------------- eastus aro-vm-jumpbox-as 2 5 aro-eastus Step 18.4 - Verify Jump Server Image Terms In this document, the image being used for the Jump Server is a free Azure Marketplace image. The terms must be accepted. The URN is: cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 References: https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_show https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cognosys.docker-ce-with-centos-8-0-free?tab=Overview Commands: az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Example Output: # az vm image terms show --urn cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Accepted Name Plan Product Publisher ---------- ------------------------------ ------------------------------ ------------------------------ ----------- True docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free cognosys Step 18.5 - Verify Jump Server Virtual Machine References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Commands: az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv Example Output: # az vm show --resource-group aro-eastus --name aro-vm-jumpbox { \"additionalCapabilities\": null, \"availabilitySet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Compute/availabilitySets/ARO-VM-JUMPBOX-AS\", \"resourceGroup\": \"aro-eastus\" }, \"billingProfile\": null, \"diagnosticsProfile\": null, \"evictionPolicy\": null, \"extensionsTimeBudget\": null, \"hardwareProfile\": { \"vmSize\": \"Standard_B1ms\" }, \"host\": null, \"hostGroup\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Compute/virtualMachines/aro-vm-jumpbox\", \"identity\": null, \"instanceView\": null, \"licenseType\": null, \"location\": \"eastus\", \"name\": \"aro-vm-jumpbox\", \"networkProfile\": { \"networkInterfaces\": [ { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Network/networkInterfaces/aro-vm-jumpbox-nic\", \"primary\": true, \"resourceGroup\": \"aro-eastus\" } ] }, \"osProfile\": { \"adminPassword\": null, \"adminUsername\": \"jtingiris\", \"allowExtensionOperations\": true, \"computerName\": \"aro-vm-jumpbox\", \"customData\": null, \"linuxConfiguration\": { \"disablePasswordAuthentication\": true, \"patchSettings\": { \"patchMode\": \"ImageDefault\" }, \"provisionVmAgent\": true, \"ssh\": { \"publicKeys\": [ { \"keyData\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDec9G5K26hxFj+Ha0gQChwhSW4fT6mlZrb0066h+moGMJKMJ2YiHMaNMUULFT8SkJch4KYjQfqgJE8YnSGRHPzmUWwF/v7AwcozIlwralduUdYNIScDnzaFCBa55pLQwCWIN7zXFCdtEG935XwaV+A+tOgokiGvGXMAUj/Dz0A5ClIhbD/i3dr2AFKuuSwMGpFc1EqZDh72ZsYTcDaZT5hhPPUCUyTqOfEJuWQYeE3DAuA1EoI2tmBQWNl2S1jtdHa/69BBAmA6t0MZXuMKpk0udzQjw/d6b64hKYHDDlfxaTEBnt1Vbd8Rv5bxJSI1y2QgCutRZwVa/dt1X71fwpAq4yr0H8JCrabKrIumgqyZ6VQyCTVu3AXZ3E/yMQmJhLK2RvPHrHp8DedZ3su62zvU9aUACyd6b89R6S4eYOmIE+nNG/M/yqS2Ru3GPUalsQXE5/auCsg6rPetxMNoEbZz5qTfJUfq3Xx61WQuLrAsyvEiIiM5rrgA/FhYbthxKKacYr0b6oi6HQW6KQ3JnPMm/QF2UxDxoNOG+NHi2UBfgiXLEHZQ3YnkS4QkB9aCK4YJyOJ5I/34gAGcUIPQ8nkUSky7btjsQlHNB6pHPI+8Xd2SntRmfgBwJwOUS+LqjK4OCCpkqUTSopXQ8vL8L/e2gw+8QIdTYe47/P0IG5zVQ== jtingiris@jt\\n\", \"path\": \"/home/jtingiris/.ssh/authorized_keys\" } ] } }, \"requireGuestProvisionSignal\": true, \"secrets\": [], \"windowsConfiguration\": null }, \"plan\": { \"name\": \"docker-ce-with-centos-8-0-free\", \"product\": \"docker-ce-with-centos-8-0-free\", \"promotionCode\": null, \"publisher\": \"cognosys\" }, \"priority\": null, \"provisioningState\": \"Succeeded\", \"proximityPlacementGroup\": null, \"resourceGroup\": \"aro-eastus\", \"resources\": null, \"securityProfile\": null, \"storageProfile\": { \"dataDisks\": [], \"imageReference\": { \"exactVersion\": \"1.2019.0710\", \"id\": null, \"offer\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"sku\": \"docker-ce-with-centos-8-0-free\", \"version\": \"1.2019.0710\" }, \"osDisk\": { \"caching\": \"ReadWrite\", \"createOption\": \"FromImage\", \"diffDiskSettings\": null, \"diskSizeGb\": 30, \"encryptionSettings\": null, \"image\": null, \"managedDisk\": { \"diskEncryptionSet\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ARO-EASTUS/providers/Microsoft.Compute/disks/aro-vm-jumpbox_OsDisk_1_73c04cb3c9cf4f199a33973a95cae54a\", \"resourceGroup\": \"ARO-EASTUS\", \"storageAccountType\": \"Premium_LRS\" }, \"name\": \"aro-vm-jumpbox_OsDisk_1_73c04cb3c9cf4f199a33973a95cae54a\", \"osType\": \"Linux\", \"vhd\": null, \"writeAcceleratorEnabled\": null } }, \"tags\": {}, \"type\": \"Microsoft.Compute/virtualMachines\", \"virtualMachineScaleSet\": null, \"vmId\": \"25d7a15d-3b82-4509-981c-895b99079a4e\", \"zones\": null } # az vm show -d -g aro-eastus -n aro-vm-jumpbox --query publicIps -o tsv 52.142.59.191 Step 18.6 - Login to Jump Server Virtual Machine References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Commands: export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} 'hostname && uptime' Example Output: 52.142.59.191 Step 19 - Setup VPN Gateway A VPN gateway is a specific type of virtual network gateway that is used to send encrypted traffic between an Azure virtual network and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. References: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://docs.microsoft.com/en-us/azure/vpn-gateway/create-routebased-vpn-gateway-cli Step 19.1 - Verify VPN Gateway Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name GatewaySubnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.6.0/25 GatewaySubnet Enabled Enabled Succeeded aro-eastus Step 19.2 - Verify VPN Gateway Public IP Address References: https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: # az network public-ip show --name aro-vpn-public-ip --resource-group aro-eastus --output table Name ResourceGroup Location Zones Address AddressVersion AllocationMethod IdleTimeoutInMinutes ProvisioningState ----------------- --------------- ---------- ------- ------------ ---------------- ------------------ ---------------------- ------------------- aro-vpn-public-ip aro-eastus eastus 1 20.55.20.169 IPv4 Static 4 Succeeded Step 19.3 - Verify VPN Gateway References: https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: # az network vnet-gateway show --name aro-vpn --resource-group aro-eastus --output table ActiveActive EnableBgp EnablePrivateIpAddress GatewayType Location Name ProvisioningState ResourceGroup ResourceGuid VpnGatewayGeneration VpnType -------------- ----------- ------------------------ ------------- ---------- ------- ------------------- --------------- ------------------------------------ ---------------------- ---------- False False False Vpn eastus aro-vpn Succeeded aro-eastus 477216e3-d63e-4071-91ec-6d05cef30626 Generation1 RouteBased Step 20 - Setup VPN Gateway Certificate Authentication When using the native VPN Gateway Azure Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. References: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal Step 20.1 - Verify VPN Gateway Root Key References: https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE Example Output: # openssl rsa -in ./pki/aro-vpn-root.key -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE && echo ./pki/aro-vpn-root.key OK || echo ./pki/aro-vpn-root.key FAILED ``` Can't open ./pki/aro-vpn-root.key for reading, No such file or directory 140076994533184:error:02001002:system library:fopen:No such file or directory:crypto/bio/bss_file.c:69:fopen('./pki/aro-vpn-root.key','r') 140076994533184:error:2006D080:BIO routines:BIO_new_file:no such file:crypto/bio/bss_file.c:76: unable to load Private Key aborting ... failed to verify vpn root key","title":"Step 1 - Setup Azure Tenant"},{"location":"draft-aro-verify-aro/#step-1-setup-azure-tenant","text":"A tenant is Microsoft's representation of an organization. It's a dedicated instance of Azure Active Directory (AAD) that an organization or app developer receives when create a relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before you can install Azure Red Hat OpenShift (ARO), Microsoft accounts must exist and have appropriate access to an AAD Tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. If you are the Global Administrator of an existing tenant, go to step 2. References: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant","title":"Step 1 - Setup Azure Tenant"},{"location":"draft-aro-verify-aro/#step-11-create-a-new-microsoft-account","text":"A Microsoft account represents a billing relationship. The account consists of a user identity, one or more subscriptions, and an associated set of resources. The person who creates the account is the administrators for all subscriptions created in that account. That person is also the default Service Administrator for the subscription(s) and, for Microsoft 365, possesses the Global Administrator role. The purpose of this step is to create a new Microsoft 365 (onmicrosoft.com) account, to establish a Global Administrator relationship for use with all Microsoft 365 services, including Azure. An Azure Active Directory Premium P1 license is required for Azure Red Hat OpenShift (ARO). Please note that this step does not mandate a purchase of a Microsoft 365 Business Premium license . This is simply one way to create a new tenant and become a Global Administrator. A license may be purchased now, or afterwards. Go to the Microsoft 365 for Business store. https://www.microsoft.com/en-us/microsoft-365/business/compare-all-microsoft-365-business-products Proceed to purchase at least one (1) Microsoft 365 Business Premium license. This will also include an Azure Active Directory (AAD) Premium P1 license, which is needed for Azure Red Hat OpenShift (ARO). The Microsoft 365 Business Premium provides an AAD P1 license, and other 365 services. If you do not wish to have all the 365 services, then a dedicated AAD Premium P1 (or better) may be purchased by a Billing or Global Administrator who has access to an existing tenant.","title":"Step 1.1 - Create a new Microsoft Account"},{"location":"draft-aro-verify-aro/#step-12-create-the-first-global-administrator","text":"The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Reset passwords for all users Add and manage domains References: https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide","title":"Step 1.2 - Create the first Global Administrator"},{"location":"draft-aro-verify-aro/#step-13-verify-microsoft-365-admin-center-access","text":"The Microsoft 365 admin center is built for IT teams as a simplified way to manage your Microsoft 365 services. The admin center provides a tailored experience based on the unique needs of your role or organization, improves efficiency for everyday tasks, and provides actionable insights that help you make data-driven decisions to deliver a better experience for your users. The Microsoft 365 admin center is the common entry point for all Microsoft 365 admins and can be accessed at https://admin.microsoft.com/ References: https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide","title":"Step 1.3 - Verify Microsoft 365 Admin Center Access"},{"location":"draft-aro-verify-aro/#step-14-verify-azure-active-directory-license","text":"To verify the license, go to the Azure Active Directory Overview: https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview References: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis","title":"Step 1.4 - Verify Azure Active Directory License"},{"location":"draft-aro-verify-aro/#step-2-setup-azure-subscription","text":"An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required for these procedures. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. That is out of scope for this document. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators and Service Principals.","title":"Step 2 - Setup Azure Subscription"},{"location":"draft-aro-verify-aro/#step-21-purchase-new-azure-subscription","text":"The Microsoft account that purchases the Azure subscription will be the Subscription owner. References: https://azure.microsoft.com/","title":"Step 2.1 - Purchase New Azure Subscription"},{"location":"draft-aro-verify-aro/#step-3-setup-operating-system-required-tools","text":"The remaining procedures in this document depend on the following operating system and tools. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+) bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep Google Chrome or Firefox","title":"Step 3 - Setup Operating System &amp; Required Tools"},{"location":"draft-aro-verify-aro/#step-31-verify-operating-system","text":"Commands: uname -a Example Output: # uname -a Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux","title":"Step 3.1 - Verify Operating System"},{"location":"draft-aro-verify-aro/#step-32-verify-bash","text":"Commands: bash --version Example Output: # bash --version GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law.","title":"Step 3.2 - Verify bash"},{"location":"draft-aro-verify-aro/#step-33-verify-gnu-awk","text":"Commands: awk --version Example Output: # awk --version GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/.","title":"Step 3.3 - Verify GNU awk"},{"location":"draft-aro-verify-aro/#step-34-verify-gnu-coreutils","text":"References: https://www.gnu.org/software/coreutils/ Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: # base64 --version base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. # basename --version basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. # dirname --version dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. # sort --version sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. # head --version head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. # tail --version tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering.","title":"Step 3.4 - Verify GNU coreutils"},{"location":"draft-aro-verify-aro/#step-35-verify-gnu-grep","text":"Command(s): grep --version egrep --version Example Output: # grep --version grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. # egrep --version grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>.","title":"Step 3.5 - Verify GNU grep"},{"location":"draft-aro-verify-aro/#step-36-verify-google-chrome-or-firefix","text":"Commands: firefox --version google-chrome --version Example Output: # firefox --version Mozilla Firefox 80.0 # google-chrome --version Google Chrome 85.0.4183.83","title":"Step 3.6 - Verify Google Chrome or Firefix"},{"location":"draft-aro-verify-aro/#step-37-verify-openssl","text":"Commands: openssl version Example Output: # openssl version OpenSSL 1.1.1g FIPS 21 Apr 2020","title":"Step 3.7 - Verify OpenSSL"},{"location":"draft-aro-verify-aro/#step-4-setup-required-aro-environment-variables","text":"There are many prerequisites for a successful installation of Azure Red Hat OpenShift. The necessary bash environment variables are required to execute the steps in this document. Before proceeding, please take your time ensuring the values are correct. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html","title":"Step 4 - Setup Required ARO Environment Variables"},{"location":"draft-aro-verify-aro/#step-41-export-required-aro-environment-variables","text":"These bash environment variables are required must be exported. They are reused for multiple steps. These are example values that must be changed for your installation. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO='aro' export ARO_APPLICATION_NAME='aro-app' export ARO_CLUSTER_NAME='aro-cluster' export ARO_DOMAIN_NAME='aro.mitaei.net' export ARO_LOCATION_NAME='eastus' export ARO_REDHAT_PULL_SECRET='./secret/test-redhat-pull-secret.txt' export ARO_REDHAT_PULL_SECRET_FILE='./secret/aro-redhat-pull-secret.txt' export ARO_RESOURCE_GROUP_NAME='aro-eastus' export ARO_SERVICE_PRINCIPAL_NAME='http://aro-app' export ARO_SERVICE_PRINCIPAL_PASSWORD='S3rv1c3Pr1cip4lP4ssw0rd!' export ARO_SUBNET_AGW_ADDRESS_PREFIX='10.11.4.0/25' export ARO_SUBNET_AGW_NAME='aro-vnet-agw-subnet' export ARO_SUBNET_AGW_NSG_NAME='aro-vnet-agw-subnet-nsg' export ARO_SUBNET_DB_ADDRESS_PREFIX='10.11.4.128/25' export ARO_SUBNET_DB_NAME='aro-vnet-db-subnet' export ARO_SUBNET_DB_NSG_NAME='aro-vnet-db-subnet-nsg' export ARO_SUBNET_DMZ_ADDRESS_PREFIX='10.11.5.0/25' export ARO_SUBNET_DMZ_NAME='aro-vnet-dmz-subnet' export ARO_SUBNET_DMZ_NSG_NAME='aro-vnet-dmz-subnet-nsg' export ARO_SUBNET_GATEWAY_ADDRESS_PREFIX='10.11.6.0/25' export ARO_SUBNET_GATEWAY_NAME='GatewaySubnet' export ARO_SUBNET_GATEWAY_NSG_NAME='GatewaySubnet-nsg' export ARO_SUBNET_MASTER_ADDRESS_PREFIX='10.11.0.0/23' export ARO_SUBNET_MASTER_NAME='aro-vnet-master-subnet' export ARO_SUBNET_MASTER_NSG_NAME='aro-vnet-master-subnet-nsg' export ARO_SUBNET_TRUSTED_ADDRESS_PREFIX='10.11.5.128/25' export ARO_SUBNET_TRUSTED_NAME='aro-vnet-trusted-subnet' export ARO_SUBNET_TRUSTED_NSG_NAME='aro-vnet-trusted-subnet-nsg' export ARO_SUBNET_VGW_ADDRESS_PREFIX='10.11.6.0/25' export ARO_SUBNET_VGW_NAME='GatewaySubnet' export ARO_SUBNET_VGW_NSG_NAME='GatewaySubnet-nsg' export ARO_SUBNET_WORKER_ADDRESS_PREFIX='10.11.2.0/23' export ARO_SUBNET_WORKER_NAME='aro-vnet-worker-subnet' export ARO_SUBNET_WORKER_NSG_NAME='aro-vnet-worker-subnet-nsg' export ARO_SUBSCRIPTION_ID='12c7070f-83e5-453b-96d0-90770d2cf942' export ARO_SUBSCRIPTION_NAME='Azure subscription for mitaei' export ARO_TENANT_ID='25fe96e7-85ec-4e6a-b93f-779b16ff751d' export ARO_TENANT_NAME='mitaei.net' export ARO_VGW_NAME='aro-vpn' export ARO_VGW_PKI_BITS='2048' export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!3x4mpl3Cl13ntP4ssphr4s3!' export ARO_VGW_PKI_DIR='./pki' export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE='./pki/aro-vpn-root.serial' export ARO_VGW_PKI_ROOT_CRT_FILE='./pki/aro-vpn-root.crt' export ARO_VGW_PKI_ROOT_CRT_FILE_NAME='aro-vpn-root.crt' export ARO_VGW_PKI_ROOT_KEY_FILE='./pki/aro-vpn-root.key' export ARO_VGW_PKI_ROOT_KEY_FILE_NAME='aro-vpn-root.key' export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VGW_POOL_ADDRESS_PREFIX='172.16.11.0/24' export ARO_VGW_PUBLIC_ADDRESS_NAME='aro-vpn-public-ip' export ARO_VGW_REDUNDANCY='true' export ARO_VGW_SKU='VpnGw1AZ' export ARO_VGW_TYPE='RouteBased' export ARO_VM_JUMP_ADMIN_NAME='aro-vm-jumpbox-admin' export ARO_VM_JUMP_HOSTNAME='jumpbox' export ARO_VM_JUMP_IMAGE_MARKETPLACE='true' export ARO_VM_JUMP_IMAGE_URN='cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710' export ARO_VM_JUMP_NAME='aro-vm-jumpbox' export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME='aro-vm-jumpbox-public-ip' export ARO_VM_JUMP_SIZE='Standard_B1ms' export ARO_VNET_ADDRESS_PREFIX='10.11.0.0/21' export ARO_VNET_NAME='aro-vnet' export ARO_VPN_GATEWAY_NAME='test-vpn' export ARO_VPN_GATEWAY_PKI_CERTIFICATE='./pki/test-vpn.crt' export ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE='./pki/test-vpn.crt' export ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE_NAME='test-vpn.crt' export ARO_VPN_GATEWAY_PKI_KEY='./pki/test-vpn.key' export ARO_VPN_GATEWAY_PKI_KEY_FILE='./pki/test-vpn.key' export ARO_VPN_GATEWAY_PKI_KEY_FILE_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VPN_GATEWAY_PKI_KEY_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VPN_GATEWAY_PKI_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VPN_GATEWAY_POOL_ADDRESS_PREFIX='172.16.11.0/24' export ARO_VPN_GATEWAY_PRIVATE_ADDRESS_POOL_PREFIX='172.16.11.0/24' export ARO_VPN_GATEWAY_PUBLIC_ADDRESS_NAME='test-vpn-public-ip' export ARO_VPN_GATEWAY_REDUNDANCY='true' export ARO_VPN_GATEWAY_SKU='VpnGw1AZ' export ARO_VPN_GATEWAY_TYPE='RouteBased' export ARO_VPN_PUBLIC_ADDRESS_NAME='test-vpn-public-ip' export ARO_ADMINISTRATORS=(joseph.tingiris@mitaei.net arun.babu@mitaei.net sivaprasad.k@mitaei.net) export ARO_SUBSCRIPTION_OWNERS=(joseph.tingiris@mitaei.net christy.walsh@mitaei.net arun.babu@mitaei.net sivaprasad.k@mitaei.net) export ARO_RESOURCE_PROVIDERS=(Microsoft.RedHatOpenShift Microsoft.Compute Microsoft.Storage) export ARO_VERIFY_QUOTA_NAMEs=() export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs')","title":"Step 4.1 - Export Required ARO Environment Variables"},{"location":"draft-aro-verify-aro/#step-42-verify-required-aro-environment-variables","text":"Ensure the ARO bash environment variables are globally available. References: https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=aro ARO_APPLICATION_NAME=aro-app ARO_CLUSTER_NAME=aro-cluster ARO_DOMAIN_NAME=aro.mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET=./secret/test-redhat-pull-secret.txt ARO_REDHAT_PULL_SECRET_FILE=./secret/aro-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=aro-eastus ARO_SERVICE_PRINCIPAL_NAME=http://aro-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=aro-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=aro-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=aro-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=aro-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=aro-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=aro-vnet-dmz-subnet-nsg ARO_SUBNET_GATEWAY_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_GATEWAY_NAME=GatewaySubnet ARO_SUBNET_GATEWAY_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=aro-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=aro-vnet-master-subnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=aro-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=aro-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=aro-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=aro-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=aro-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!3x4mpl3Cl13ntP4ssphr4s3! ARO_VGW_PKI_DIR=./pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=./pki/aro-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=./pki/aro-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_FILE_NAME=aro-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=./pki/aro-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_NAME=aro-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VGW_PUBLIC_ADDRESS_NAME=aro-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=aro-vm-jumpbox-admin ARO_VM_JUMP_HOSTNAME=jumpbox ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=aro-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=aro-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=aro-vnet ARO_VPN_GATEWAY_NAME=test-vpn ARO_VPN_GATEWAY_PKI_CERTIFICATE=./pki/test-vpn.crt ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE=./pki/test-vpn.crt ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE_NAME=test-vpn.crt ARO_VPN_GATEWAY_PKI_KEY=./pki/test-vpn.key ARO_VPN_GATEWAY_PKI_KEY_FILE=./pki/test-vpn.key ARO_VPN_GATEWAY_PKI_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VPN_GATEWAY_PKI_KEY_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VPN_GATEWAY_PKI_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VPN_GATEWAY_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VPN_GATEWAY_PRIVATE_ADDRESS_POOL_PREFIX=172.16.11.0/24 ARO_VPN_GATEWAY_PUBLIC_ADDRESS_NAME=test-vpn-public-ip ARO_VPN_GATEWAY_REDUNDANCY=true ARO_VPN_GATEWAY_SKU=VpnGw1AZ ARO_VPN_GATEWAY_TYPE=RouteBased ARO_VPN_PUBLIC_ADDRESS_NAME=test-vpn-public-ip","title":"Step 4.2 - Verify Required ARO Environment Variables"},{"location":"draft-aro-verify-aro/#step-5-obtain-pull-secrets","text":"Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries.","title":"Step 5 - Obtain Pull Secrets"},{"location":"draft-aro-verify-aro/#step-51-obtain-red-hat-pull-secret","text":"A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. This step must be done manually. It is optional but recommended. Go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned","title":"Step 5.1 - Obtain Red Hat Pull Secret"},{"location":"draft-aro-verify-aro/#step-52-verify-red-hat-pull-secret","text":"Commands: ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: -rw-rw----. 1 jtingiris mit 2835 Sep 11 20:06 ./secret/aro-redhat-pull-secret.txt","title":"Step 5.2 - Verify Red Hat Pull Secret"},{"location":"draft-aro-verify-aro/#step-6-setup-azure-cli","text":"The Azure command-line interface (Azure CLI) is a set of commands used to create and manage Azure resources. The Azure CLI is available across Azure services and is designed to get you working quickly with Azure, with an emphasis on automation. References: https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest","title":"Step 6 - Setup Azure CLI"},{"location":"draft-aro-verify-aro/#step-61-install-azure-cli","text":"The Azure CLI is available to install in Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. To install, please follow the link in the References section. References: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Commands: az --version Example Output: # az --version azure-cli 2.11.1 core 2.11.1 telemetry 1.0.5 * Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy","title":"Step 6.1 - Install Azure CLI"},{"location":"draft-aro-verify-aro/#step-62-show-default-subscription","text":"References: https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Commands: az account list --query '[?isDefault == `true`]' Example Output: # az account list --query '[?isDefault == `true`]' [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ]","title":"Step 6.2 - Show Default Subscription"},{"location":"draft-aro-verify-aro/#step-63-login-as-the-subscription-owner","text":"The Azure Subscription Owner must perform the following steps. References: https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Commands: az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net","title":"Step 6.3 - Login as the Subscription Owner"},{"location":"draft-aro-verify-aro/#step-7-setup-additional-subscription-owners","text":"This step is optional, but recommended. There should be at least two (2) Subscription Owners. References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create","title":"Step 7 - Setup Additional Subscription Owners"},{"location":"draft-aro-verify-aro/#step-71-verify-subscription-owners","text":"References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Example Output: # az role assignment list --role Owner --output table Principal Role Scope -------------------------- ------ --------------------------------------------------- sivaprasad.k@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"Step 7.1 - Verify Subscription Owners"},{"location":"draft-aro-verify-aro/#step-8-verify-azure-tenant","text":"Go to the Microsoft admin center and login with a Microsoft account that is the Global administrator. https://admin.microsoft.com/ A Global Administrator will have access to all portions of the admin center. Commands: az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' Example Output: # az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ]","title":"Step 8 - Verify Azure Tenant"},{"location":"draft-aro-verify-aro/#step-9-verify-azure-subscription","text":"The Azure Subscription can also be verified by going to: https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade","title":"Step 9 - Verify Azure Subscription"},{"location":"draft-aro-verify-aro/#step-91-verify-subscription-names","text":"References: https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list Commands: az account list --output table Example Output: # az account list --output table Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True # az account show --subscription \"12c7070f-83e5-453b-96d0-90770d2cf942\" --query \"[{subscription_name:name},{subscription_id:id}]\" [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ]","title":"Step 9.1 - Verify Subscription Names"},{"location":"draft-aro-verify-aro/#step-92-verify-subscription-location","text":"Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable regions for the installation. The region name will be used throughout this document. References: https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Commands: az account list-locations --query \\\"[?name=='${ARO_LOCATION_NAME}']\\\" --output table Example Output: # az account list-locations --query \"[?name=='eastus']\" --output table Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US","title":"Step 9.2 - Verify Subscription Location"},{"location":"draft-aro-verify-aro/#step-93-verify-subscription-limits","text":"The Azure Red Hat OpenShift (ARO) cluster uses several Microsoft Azure components, and the default Azure subscription and service limits, quotas, and constraints affect the ability to install ARO clusters. A default ARO cluster requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. If an existing Azure Subscription is used then check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. References: https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html ARO minimum limits are required for: Standard Dv2 Family vCPUs Standard DSv3 Family vCPUs","title":"Step 9.3 - Verify Subscription Limits"},{"location":"draft-aro-verify-aro/#step-94-verify-subscription-quotas","text":"Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner should do this step. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Dv2 Series DSv3 Series An increase in the VM series quotas automatically increases the total regional vCPU limit by the same amount. Please use the links in the references of this section for Microsoft's directions on how to request a quota increase for a specific subscription. A support case will be opened, and Microsoft will communicate directly to the person who requested the increase. References: https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests Verify subscription quotas for: Standard Dv2 Family vCPUs Standard DSv3 Family vCPUs","title":"Step 9.4 - Verify Subscription Quotas"},{"location":"draft-aro-verify-aro/#step-95-verify-subscription-quota-for-standard-dv2-family-vcpus","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_list_usage Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" Example Output: # az vm list-usage --location eastus --query \"[?localName=='Standard Dv2 Family vCPUs']\" [ { \"currentValue\": \"0\", \"limit\": \"100\", \"localName\": \"Standard Dv2 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard Dv2 Family vCPUs\", \"value\": \"standardDv2Family\" } } ]","title":"Step 9.5 - Verify Subscription Quota for Standard Dv2 Family vCPUs"},{"location":"draft-aro-verify-aro/#step-96-verify-subscription-quota-for-standard-dsv3-family-vcpus","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_list_usage Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" Example Output: # az vm list-usage --location eastus --query \"[?localName=='Standard DSv3 Family vCPUs']\" [ { \"currentValue\": \"36\", \"limit\": \"100\", \"localName\": \"Standard DSv3 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard DSv3 Family vCPUs\", \"value\": \"standardDSv3Family\" } } ]","title":"Step 9.6 - Verify Subscription Quota for Standard DSv3 Family vCPUs"},{"location":"draft-aro-verify-aro/#step-10-setup-openshift-administrators","text":"Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities.","title":"Step 10 - Setup OpenShift Administrators"},{"location":"draft-aro-verify-aro/#step-101-verify-openshift-administrator-accounts","text":"Ensure the OpenShift Administrator accounts exist and have the appropriate subscription roles. References: https://docs.microsoft.com/en-us/cli/azure/ad/user?view=azure-cli-latest#az_ad_user_show Commands: for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query userPrincipalName --output tsv; done Example Output: # az ad user show --id joseph.tingiris@mitaei.net --query userPrincipalName --output tsv joseph.tingiris@mitaei.net # az ad user show --id arun.babu@mitaei.net --query userPrincipalName --output tsv arun.babu@mitaei.net # az ad user show --id sivaprasad.k@mitaei.net --query userPrincipalName --output tsv sivaprasad.k@mitaei.net","title":"Step 10.1 - Verify OpenShift Administrator Accounts"},{"location":"draft-aro-verify-aro/#step-102-verify-openshift-administrator-subscription-roles","text":"References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Commands: for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; echo; done Example Output: # az role assignment list --assignee joseph.tingiris@mitaei.net --output table Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 # az role assignment list --assignee arun.babu@mitaei.net --output table Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 # az role assignment list --assignee sivaprasad.k@mitaei.net --output table Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"Step 10.2 - Verify OpenShift Administrator Subscription Roles"},{"location":"draft-aro-verify-aro/#step-11-setup-azure-resource-providers","text":"Make sure you are logged in to Azure via az (az login) with a Contributor or Owner role. This step will fail for OpenShift Admins with only the User Access Administrator. They will receive a message saying they do not have authorization.","title":"Step 11 - Setup Azure Resource Providers"},{"location":"draft-aro-verify-aro/#step-111-verify-provider-microsoftredhatopenshift","text":"References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.RedHatOpenShift --output table Example Output: # az provider show --namespace Microsoft.RedHatOpenShift --output table Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered","title":"Step 11.1 - Verify Provider Microsoft.RedHatOpenShift"},{"location":"draft-aro-verify-aro/#step-112-verify-provider-microsoftcompute","text":"References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.Compute --output table Example Output: # az provider show --namespace Microsoft.Compute --output table Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered","title":"Step 11.2 - Verify Provider Microsoft.Compute"},{"location":"draft-aro-verify-aro/#step-113-verify-provider-microsoftstorage","text":"References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.Storage --output table Example Output: # az provider show --namespace Microsoft.Storage --output table Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered","title":"Step 11.3 - Verify Provider Microsoft.Storage"},{"location":"draft-aro-verify-aro/#step-12-setup-resource-group","text":"An Azure resource group is a logical group in which Azure resources are deployed and managed. A resource group location must be specified. This location is where resource group metadata is stored, it is also where the Azure resources are hosted. References: https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Commands: az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output:","title":"Step 12 - Setup Resource Group"},{"location":"draft-aro-verify-aro/#step-121-verify-resource-group","text":"References: https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Commands: az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: # az group show --name aro-eastus { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"aro-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"Step 12.1 - Verify Resource Group"},{"location":"draft-aro-verify-aro/#step-13-setup-virtual-network","text":"An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. References: https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Commands: env | grep ^ARO_VNET | sort Example Output: ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=aro-vnet","title":"Step 13 - Setup Virtual Network"},{"location":"draft-aro-verify-aro/#step-131-verify-virtual-network","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Commands: az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: # az network vnet show --resource-group aro-eastus --name aro-vnet --output table EnableDdosProtection EnableVmProtection Location Name ProvisioningState ResourceGroup ResourceGuid ---------------------- -------------------- ---------- -------- ------------------- --------------- ------------------------------------ False False eastus aro-vnet Succeeded aro-eastus 5e95b396-9ff5-443f-ac52-301b58b263f1","title":"Step 13.1 - Verify Virtual Network"},{"location":"draft-aro-verify-aro/#step-14-setup-azure-red-hat-openshift-subnets","text":"Azure Red Hat OpenShift clusters require a virtual network with two empty subnets, for the master and worker nodes. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. It is suggested the virtual network (vnet) prefix be /21 and each (master and worker) vnet subnet prefix be /23, which will allow for a total of 510 master nodes and 510 worker nodes. The additional subnets within the /21 prefix will be used for a VPN Gateway subnet and future growth. NOTE: In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher ; Please see the references in this section for more details._ References: https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Commands: env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort Example Output: ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=aro-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=aro-vnet-master-subnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=aro-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=aro-vnet-worker-subnet-nsg","title":"Step 14 - Setup Azure Red Hat OpenShift Subnets"},{"location":"draft-aro-verify-aro/#step-141-verify-master-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-master-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.0.0/23 aro-vnet-master-subnet Enabled Disabled Succeeded aro-eastus","title":"Step 14.1 - Verify Master Subnet"},{"location":"draft-aro-verify-aro/#step-142-verify-worker-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-worker-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ---------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.2.0/23 aro-vnet-worker-subnet Enabled Enabled Succeeded aro-eastus","title":"Step 14.2 - Verify Worker Subnet"},{"location":"draft-aro-verify-aro/#step-15-setup-additional-network-security-groups","text":"Azure Network Security Groups filter network traffic to and from Azure resources in an Azure virtual network. A Network Security Group contains security rules that allow/deny network traffic to/from several types of Azure resources. NOTE: The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. References: https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Commands: env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|GATEWAY' | sort Example Output: ARO_SUBNET_AGW_NSG_NAME=aro-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=aro-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=aro-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=aro-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg","title":"Step 15 - Setup Additional Network Security Groups"},{"location":"draft-aro-verify-aro/#step-151-verify-network-security-groups","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_show Commands: az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table Example Output: # az network nsg show --resource-group aro-eastus --name aro-vnet-agw-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus aro-vnet-agw-subnet-nsg Succeeded aro-eastus 3b720dab-4921-421b-b996-a50b681f89d2 # az network nsg show --resource-group aro-eastus --name aro-vnet-db-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ---------------------- ------------------- --------------- ------------------------------------ eastus aro-vnet-db-subnet-nsg Succeeded aro-eastus 9b55287f-fab2-4bc3-b057-b30b36e87846 # az network nsg show --resource-group aro-eastus --name aro-vnet-dmz-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus aro-vnet-dmz-subnet-nsg Succeeded aro-eastus c7553c67-3a70-41a2-bc2f-613ed23f0faa # az network nsg show --resource-group aro-eastus --name aro-vnet-trusted-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- --------------------------- ------------------- --------------- ------------------------------------ eastus aro-vnet-trusted-subnet-nsg Succeeded aro-eastus d24fbceb-dec5-4600-b5dc-84f1bfb3fa92","title":"Step 15.1 - Verify Network Security Groups"},{"location":"draft-aro-verify-aro/#step-16-setup-additional-network-security-group-rules","text":"Network security group security rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows a network security group to be stateful. References: https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview","title":"Step 16 - Setup Additional Network Security Group Rules"},{"location":"draft-aro-verify-aro/#step-161-verify-dmz-network-security-group-rules","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_show # az network nsg show --resource-group aro-eastus --name aro-vnet-dmz-subnet-nsg --query securityRules --output table Protocol SourcePortRange DestinationPortRange SourceAddressPrefix DestinationAddressPrefix Access Priority Direction ProvisioningState Name ResourceGroup ---------- ----------------- ---------------------- --------------------- -------------------------- -------- ---------- ----------- ------------------- -------- --------------- Tcp * 22 * * Allow 1000 Inbound Succeeded AllowSSH aro-eastus","title":"Step 16.1 - Verify DMZ Network Security Group Rules"},{"location":"draft-aro-verify-aro/#step-17-setup-additional-subnets","text":"Azure Red Hat OpenShift clusters require a virtual network with two empty subnets, for the master and worker nodes. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. It is suggested the virtual network (vnet) prefix be /21 and each (master and worker) vnet subnet prefix be /23, which will allow for a total of 510 master nodes and 510 worker nodes. NOTE: In 2018, Microsoft started automatically enabling Network Watcher when a new subnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher ; Please see the references in this section for more details._ References: https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Commands: env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|GATEWAY' | sort Example Output: ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=aro-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=aro-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=aro-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=aro-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=aro-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=aro-vnet-dmz-subnet-nsg ARO_SUBNET_GATEWAY_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_GATEWAY_NAME=GatewaySubnet ARO_SUBNET_GATEWAY_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=aro-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=aro-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg","title":"Step 17 - Setup Additional Subnets"},{"location":"draft-aro-verify-aro/#step-171-verify-application-gateway-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-agw-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.4.0/25 aro-vnet-agw-subnet Enabled Enabled Succeeded aro-eastus","title":"Step 17.1 - Verify Application Gateway Subnet"},{"location":"draft-aro-verify-aro/#step-172-verify-database-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-db-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------ -------------------------------- ----------------------------------- ------------------- --------------- 10.11.4.128/25 aro-vnet-db-subnet Enabled Enabled Succeeded aro-eastus","title":"Step 17.2 - Verify Database Subnet"},{"location":"draft-aro-verify-aro/#step-173-verify-dmz-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-dmz-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.5.0/25 aro-vnet-dmz-subnet Enabled Enabled Succeeded aro-eastus","title":"Step 17.3 - Verify DMZ Subnet"},{"location":"draft-aro-verify-aro/#step-174-verify-trusted-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name aro-vnet-trusted-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.5.128/25 aro-vnet-trusted-subnet Enabled Enabled Succeeded aro-eastus","title":"Step 17.4 - Verify Trusted Subnet"},{"location":"draft-aro-verify-aro/#step-18-setup-jump-server-virtual-machine","text":"A jump server, jump host or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example is managing a host in a DMZ from trusted networks or computers. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet, and it will be allowed to communicate with the other internal subnets. References: https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-cli-complete https://en.wikipedia.org/wiki/Jump_server https://en.wikipedia.org/wiki/DMZ_(computing) Commands: env | grep JUMP | sort Example Output: ARO_VM_JUMP_ADMIN_NAME=aro-vm-jumpbox-admin ARO_VM_JUMP_HOSTNAME=jumpbox ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=aro-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=aro-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms","title":"Step 18 - Setup Jump Server Virtual Machine"},{"location":"draft-aro-verify-aro/#step-181-verify-jump-server-public-ip-address","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Commands: az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: # az network public-ip show --name aro-vm-jumpbox-public-ip --resource-group aro-eastus { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"f1c09679-d757-4cc3-9155-95b3ce4f9082\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Network/publicIPAddresses/aro-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": \"52.142.59.191\", \"ipConfiguration\": { \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Network/networkInterfaces/aro-vm-jumpbox-nic/ipConfigurations/ipconfig1\", \"name\": null, \"privateIpAddress\": null, \"privateIpAllocationMethod\": null, \"provisioningState\": null, \"publicIpAddress\": null, \"resourceGroup\": \"aro-eastus\", \"subnet\": null }, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"aro-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"aro-eastus\", \"resourceGuid\": \"84a25205-87c8-4234-b8ea-6dea48782e2c\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null }","title":"Step 18.1 - Verify Jump Server Public IP Address"},{"location":"draft-aro-verify-aro/#step-182-verify-jump-server-virtual-nic","text":"A network interface enables an Azure Virtual Machine to communicate with internet, Azure, and on-premises resources. References: https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_show https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface Commands: az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table Example Output: # az network nic show --resource-group aro-eastus --name aro-vm-jumpbox-nic --output table EnableAcceleratedNetworking EnableIpForwarding Location MacAddress Name Primary ProvisioningState ResourceGroup ResourceGuid ----------------------------- -------------------- ---------- ----------------- ------------------ --------- ------------------- --------------- ------------------------------------ False False eastus 00-0D-3A-9D-48-E3 aro-vm-jumpbox-nic True Succeeded aro-eastus aa1f5850-250e-4317-9301-51d82f083573","title":"Step 18.2 - Verify Jump Server Virtual NIC"},{"location":"draft-aro-verify-aro/#step-183-verify-jump-server-availability-set","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create Commands: az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table Example Output: # az vm availability-set show --resource-group aro-eastus --name aro-vm-jumpbox-as --output table Location Name PlatformFaultDomainCount PlatformUpdateDomainCount ResourceGroup ---------- ----------------- -------------------------- --------------------------- --------------- eastus aro-vm-jumpbox-as 2 5 aro-eastus","title":"Step 18.3 - Verify Jump Server Availability Set"},{"location":"draft-aro-verify-aro/#step-184-verify-jump-server-image-terms","text":"In this document, the image being used for the Jump Server is a free Azure Marketplace image. The terms must be accepted. The URN is: cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 References: https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_show https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cognosys.docker-ce-with-centos-8-0-free?tab=Overview Commands: az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Example Output: # az vm image terms show --urn cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Accepted Name Plan Product Publisher ---------- ------------------------------ ------------------------------ ------------------------------ ----------- True docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free cognosys","title":"Step 18.4 - Verify Jump Server Image Terms"},{"location":"draft-aro-verify-aro/#step-185-verify-jump-server-virtual-machine","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Commands: az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv Example Output: # az vm show --resource-group aro-eastus --name aro-vm-jumpbox { \"additionalCapabilities\": null, \"availabilitySet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Compute/availabilitySets/ARO-VM-JUMPBOX-AS\", \"resourceGroup\": \"aro-eastus\" }, \"billingProfile\": null, \"diagnosticsProfile\": null, \"evictionPolicy\": null, \"extensionsTimeBudget\": null, \"hardwareProfile\": { \"vmSize\": \"Standard_B1ms\" }, \"host\": null, \"hostGroup\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Compute/virtualMachines/aro-vm-jumpbox\", \"identity\": null, \"instanceView\": null, \"licenseType\": null, \"location\": \"eastus\", \"name\": \"aro-vm-jumpbox\", \"networkProfile\": { \"networkInterfaces\": [ { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/aro-eastus/providers/Microsoft.Network/networkInterfaces/aro-vm-jumpbox-nic\", \"primary\": true, \"resourceGroup\": \"aro-eastus\" } ] }, \"osProfile\": { \"adminPassword\": null, \"adminUsername\": \"jtingiris\", \"allowExtensionOperations\": true, \"computerName\": \"aro-vm-jumpbox\", \"customData\": null, \"linuxConfiguration\": { \"disablePasswordAuthentication\": true, \"patchSettings\": { \"patchMode\": \"ImageDefault\" }, \"provisionVmAgent\": true, \"ssh\": { \"publicKeys\": [ { \"keyData\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDec9G5K26hxFj+Ha0gQChwhSW4fT6mlZrb0066h+moGMJKMJ2YiHMaNMUULFT8SkJch4KYjQfqgJE8YnSGRHPzmUWwF/v7AwcozIlwralduUdYNIScDnzaFCBa55pLQwCWIN7zXFCdtEG935XwaV+A+tOgokiGvGXMAUj/Dz0A5ClIhbD/i3dr2AFKuuSwMGpFc1EqZDh72ZsYTcDaZT5hhPPUCUyTqOfEJuWQYeE3DAuA1EoI2tmBQWNl2S1jtdHa/69BBAmA6t0MZXuMKpk0udzQjw/d6b64hKYHDDlfxaTEBnt1Vbd8Rv5bxJSI1y2QgCutRZwVa/dt1X71fwpAq4yr0H8JCrabKrIumgqyZ6VQyCTVu3AXZ3E/yMQmJhLK2RvPHrHp8DedZ3su62zvU9aUACyd6b89R6S4eYOmIE+nNG/M/yqS2Ru3GPUalsQXE5/auCsg6rPetxMNoEbZz5qTfJUfq3Xx61WQuLrAsyvEiIiM5rrgA/FhYbthxKKacYr0b6oi6HQW6KQ3JnPMm/QF2UxDxoNOG+NHi2UBfgiXLEHZQ3YnkS4QkB9aCK4YJyOJ5I/34gAGcUIPQ8nkUSky7btjsQlHNB6pHPI+8Xd2SntRmfgBwJwOUS+LqjK4OCCpkqUTSopXQ8vL8L/e2gw+8QIdTYe47/P0IG5zVQ== jtingiris@jt\\n\", \"path\": \"/home/jtingiris/.ssh/authorized_keys\" } ] } }, \"requireGuestProvisionSignal\": true, \"secrets\": [], \"windowsConfiguration\": null }, \"plan\": { \"name\": \"docker-ce-with-centos-8-0-free\", \"product\": \"docker-ce-with-centos-8-0-free\", \"promotionCode\": null, \"publisher\": \"cognosys\" }, \"priority\": null, \"provisioningState\": \"Succeeded\", \"proximityPlacementGroup\": null, \"resourceGroup\": \"aro-eastus\", \"resources\": null, \"securityProfile\": null, \"storageProfile\": { \"dataDisks\": [], \"imageReference\": { \"exactVersion\": \"1.2019.0710\", \"id\": null, \"offer\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"sku\": \"docker-ce-with-centos-8-0-free\", \"version\": \"1.2019.0710\" }, \"osDisk\": { \"caching\": \"ReadWrite\", \"createOption\": \"FromImage\", \"diffDiskSettings\": null, \"diskSizeGb\": 30, \"encryptionSettings\": null, \"image\": null, \"managedDisk\": { \"diskEncryptionSet\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/ARO-EASTUS/providers/Microsoft.Compute/disks/aro-vm-jumpbox_OsDisk_1_73c04cb3c9cf4f199a33973a95cae54a\", \"resourceGroup\": \"ARO-EASTUS\", \"storageAccountType\": \"Premium_LRS\" }, \"name\": \"aro-vm-jumpbox_OsDisk_1_73c04cb3c9cf4f199a33973a95cae54a\", \"osType\": \"Linux\", \"vhd\": null, \"writeAcceleratorEnabled\": null } }, \"tags\": {}, \"type\": \"Microsoft.Compute/virtualMachines\", \"virtualMachineScaleSet\": null, \"vmId\": \"25d7a15d-3b82-4509-981c-895b99079a4e\", \"zones\": null } # az vm show -d -g aro-eastus -n aro-vm-jumpbox --query publicIps -o tsv 52.142.59.191","title":"Step 18.5 - Verify Jump Server Virtual Machine"},{"location":"draft-aro-verify-aro/#step-186-login-to-jump-server-virtual-machine","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Commands: export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} 'hostname && uptime' Example Output: 52.142.59.191","title":"Step 18.6 - Login to Jump Server Virtual Machine"},{"location":"draft-aro-verify-aro/#step-19-setup-vpn-gateway","text":"A VPN gateway is a specific type of virtual network gateway that is used to send encrypted traffic between an Azure virtual network and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. References: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://docs.microsoft.com/en-us/azure/vpn-gateway/create-routebased-vpn-gateway-cli","title":"Step 19 - Setup VPN Gateway"},{"location":"draft-aro-verify-aro/#step-191-verify-vpn-gateway-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table Example Output: # az network vnet subnet show --resource-group aro-eastus --vnet-name aro-vnet --name GatewaySubnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.6.0/25 GatewaySubnet Enabled Enabled Succeeded aro-eastus","title":"Step 19.1 - Verify VPN Gateway Subnet"},{"location":"draft-aro-verify-aro/#step-192-verify-vpn-gateway-public-ip-address","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: # az network public-ip show --name aro-vpn-public-ip --resource-group aro-eastus --output table Name ResourceGroup Location Zones Address AddressVersion AllocationMethod IdleTimeoutInMinutes ProvisioningState ----------------- --------------- ---------- ------- ------------ ---------------- ------------------ ---------------------- ------------------- aro-vpn-public-ip aro-eastus eastus 1 20.55.20.169 IPv4 Static 4 Succeeded","title":"Step 19.2 - Verify VPN Gateway Public IP Address"},{"location":"draft-aro-verify-aro/#step-193-verify-vpn-gateway","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: # az network vnet-gateway show --name aro-vpn --resource-group aro-eastus --output table ActiveActive EnableBgp EnablePrivateIpAddress GatewayType Location Name ProvisioningState ResourceGroup ResourceGuid VpnGatewayGeneration VpnType -------------- ----------- ------------------------ ------------- ---------- ------- ------------------- --------------- ------------------------------------ ---------------------- ---------- False False False Vpn eastus aro-vpn Succeeded aro-eastus 477216e3-d63e-4071-91ec-6d05cef30626 Generation1 RouteBased","title":"Step 19.3 - Verify VPN Gateway"},{"location":"draft-aro-verify-aro/#step-20-setup-vpn-gateway-certificate-authentication","text":"When using the native VPN Gateway Azure Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. References: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal","title":"Step 20 - Setup VPN Gateway Certificate Authentication"},{"location":"draft-aro-verify-aro/#step-201-verify-vpn-gateway-root-key","text":"References: https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE Example Output: # openssl rsa -in ./pki/aro-vpn-root.key -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE && echo ./pki/aro-vpn-root.key OK || echo ./pki/aro-vpn-root.key FAILED ``` Can't open ./pki/aro-vpn-root.key for reading, No such file or directory 140076994533184:error:02001002:system library:fopen:No such file or directory:crypto/bio/bss_file.c:69:fopen('./pki/aro-vpn-root.key','r') 140076994533184:error:2006D080:BIO routines:BIO_new_file:no such file:crypto/bio/bss_file.c:76: unable to load Private Key aborting ... failed to verify vpn root key","title":"Step 20.1 - Verify VPN Gateway Root Key"},{"location":"draft-aro-verify-test/","text":"Azure Red Hat OpenShift for IBM Product Master [DRAFT] Sun 20 Sep 2020 11:24:22 PM EDT Introduction This document details the steps required to build Azure Red Hat OpenShift for IBM Product Master. Azure Red Hat OpenShift (ARO) Azure Red Hat OpenShift is a fully managed offering of Red Hat OpenShift running in Microsoft Azure. This service is jointly managed and supported by both Microsoft and Red Hat. To provide support, certain limitations apply. For more details, see the Azure Red Hat OpenShift Service documentation. Microsoft Azure Microsoft Azure is a comprehensive cloud computing service managed by Microsoft. It provides software as a service (SaaS), platform as a service (PaaS), and infrastructure as a service (IaaS). Red Hat OpenShift Container Platform (OCP) Red Hat's OpenShift Container Platform is a hybrid cloud, enterprise Kubernetes application platform. It is a platform as a service (Paas) built on Red Hat Enterprise Linux (RHEL), with Docker containers managed by Kubernetes. IBM Product Master (IPM) IBM Product Master provides trusted product information management (PIM) and collaborative master data management (MDM) capabilities. It creates an accurate and up-to-date repository of product and service information that can be used throughout organizations for strategic business initiatives References: https://azure.microsoft.com/ https://www.openshift.com/ https://www.docker.com/ https://kubernetes.io/ https://docs.microsoft.com/en-us/azure/openshift/openshift-faq https://docs.microsoft.com/en-us/azure/openshift/support-lifecycle https://www.ibm.com/products/product-master Step 1 - Setup Azure Tenant A tenant is Microsoft's representation of an organization. It's a dedicated instance of Azure Active Directory (AAD) that an organization or app developer receives when create a relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before you can install Azure Red Hat OpenShift (ARO), Microsoft accounts must exist and have appropriate access to an AAD Tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. If you are the Global Administrator of an existing tenant, go to step 2. References: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant Step 1.1 - Create a new Microsoft Account A Microsoft account represents a billing relationship. The account consists of a user identity, one or more subscriptions, and an associated set of resources. The person who creates the account is the administrators for all subscriptions created in that account. That person is also the default Service Administrator for the subscription(s) and, for Microsoft 365, possesses the Global Administrator role. The purpose of this step is to create a new Microsoft 365 (onmicrosoft.com) account, to establish a Global Administrator relationship for use with all Microsoft 365 services, including Azure. An Azure Active Directory Premium P1 license is required for Azure Red Hat OpenShift (ARO). Please note that this step does not mandate a purchase of a Microsoft 365 Business Premium license . This is simply one way to create a new tenant and become a Global Administrator. A license may be purchased now, or afterwards. Go to the Microsoft 365 for Business store. https://www.microsoft.com/en-us/microsoft-365/business/compare-all-microsoft-365-business-products Proceed to purchase at least one (1) Microsoft 365 Business Premium license. This will also include an Azure Active Directory (AAD) Premium P1 license, which is needed for Azure Red Hat OpenShift (ARO). The Microsoft 365 Business Premium provides an AAD P1 license, and other 365 services. If you do not wish to have all the 365 services, then a dedicated AAD Premium P1 (or better) may be purchased by a Billing or Global Administrator who has access to an existing tenant. Step 1.2 - Create the first Global Administrator The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Reset passwords for all users Add and manage domains References: https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide Step 1.3 - Verify Microsoft 365 Admin Center Access The Microsoft 365 admin center is built for IT teams as a simplified way to manage your Microsoft 365 services. The admin center provides a tailored experience based on the unique needs of your role or organization, improves efficiency for everyday tasks, and provides actionable insights that help you make data-driven decisions to deliver a better experience for your users. The Microsoft 365 admin center is the common entry point for all Microsoft 365 admins and can be accessed at https://admin.microsoft.com/ References: https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide Step 1.4 - Verify Azure Active Directory License To verify the license, go to the Azure Active Directory Overview: https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview References: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis Step 2 - Setup Azure Subscription An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required for these procedures. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. That is out of scope for this document. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators and Service Principals. Step 2.1 - Purchase New Azure Subscription The Microsoft account that purchases the Azure subscription will be the Subscription owner. References: https://azure.microsoft.com/ Step 3 - Setup Operating System & Required Tools The remaining procedures in this document depend on the following operating system and tools. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+ bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep Google Chrome or Firefox OpenSSL Step 3.1 - Verify Operating System Commands: uname -a Example Output: # uname -a Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux Step 3.2 - Verify bash Commands: bash --version Example Output: # bash --version GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Step 3.3 - Verify GNU awk Commands: awk --version Example Output: # awk --version GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/. Step 3.4 - Verify GNU coreutils References: https://www.gnu.org/software/coreutils/ Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: # base64 --version base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. # basename --version basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. # dirname --version dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. # sort --version sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. # head --version head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. # tail --version tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering. Step 3.5 - Verify GNU grep Command(s): grep --version egrep --version Example Output: # grep --version grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. # egrep --version grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. Step 3.6 - Verify Google Chrome or Firefix Commands: firefox --version google-chrome --version Example Output: # firefox --version Mozilla Firefox 80.0 # google-chrome --version Google Chrome 85.0.4183.83 Step 3.7 - Verify OpenSSL Commands: openssl version Example Output: # openssl version OpenSSL 1.1.1g FIPS 21 Apr 2020 Step 4 - Setup Required ARO Environment Variables There are many prerequisites for a successful installation of Azure Red Hat OpenShift. The necessary bash environment variables are required to execute the steps in this document. Before proceeding, please take your time ensuring the values are correct. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html Step 4.1 - Export Required ARO Environment Variables These bash environment variables are required must be exported. They are reused for multiple steps. These are example values that must be changed for your installation. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO='test' export ARO_APPLICATION_NAME='test-app' export ARO_CLUSTER_NAME='test-cluster' export ARO_DOMAIN_NAME='test.mitaei.net' export ARO_LOCATION_NAME='eastus' export ARO_REDHAT_PULL_SECRET_FILE='./secrets/test-redhat-pull-secret.txt' export ARO_RESOURCE_GROUP_NAME='test-eastus' export ARO_SERVICE_PRINCIPAL_NAME='http://test-app' export ARO_SERVICE_PRINCIPAL_PASSWORD='S3rv1c3Pr1cip4lP4ssw0rd!' export ARO_SUBNET_AGW_ADDRESS_PREFIX='10.11.4.0/25' export ARO_SUBNET_AGW_NAME='test-vnet-agw-subnet' export ARO_SUBNET_AGW_NSG_NAME='test-vnet-agw-subnet-nsg' export ARO_SUBNET_DB_ADDRESS_PREFIX='10.11.4.128/25' export ARO_SUBNET_DB_NAME='test-vnet-db-subnet' export ARO_SUBNET_DB_NSG_NAME='test-vnet-db-subnet-nsg' export ARO_SUBNET_DMZ_ADDRESS_PREFIX='10.11.5.0/25' export ARO_SUBNET_DMZ_NAME='test-vnet-dmz-subnet' export ARO_SUBNET_DMZ_NSG_NAME='test-vnet-dmz-subnet-nsg' export ARO_SUBNET_MASTER_ADDRESS_PREFIX='10.11.0.0/23' export ARO_SUBNET_MASTER_NAME='test-vnet-master-subnet' export ARO_SUBNET_MASTER_NSG_NAME='test-vnet-master-subnet-nsg' export ARO_SUBNET_TRUSTED_ADDRESS_PREFIX='10.11.5.128/25' export ARO_SUBNET_TRUSTED_NAME='test-vnet-trusted-subnet' export ARO_SUBNET_TRUSTED_NSG_NAME='test-vnet-trusted-subnet-nsg' export ARO_SUBNET_VGW_ADDRESS_PREFIX='10.11.6.0/25' export ARO_SUBNET_VGW_NAME='GatewaySubnet' export ARO_SUBNET_VGW_NSG_NAME='GatewaySubnet-nsg' export ARO_SUBNET_WORKER_ADDRESS_PREFIX='10.11.2.0/23' export ARO_SUBNET_WORKER_NAME='test-vnet-worker-subnet' export ARO_SUBNET_WORKER_NSG_NAME='test-vnet-worker-subnet-nsg' export ARO_SUBSCRIPTION_ID='12c7070f-83e5-453b-96d0-90770d2cf942' export ARO_SUBSCRIPTION_NAME='Azure subscription for mitaei' export ARO_TENANT_ID='25fe96e7-85ec-4e6a-b93f-779b16ff751d' export ARO_TENANT_NAME='mitaei.net' export ARO_VGW_NAME='test-vpn' export ARO_VGW_PKI_BITS='2048' export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_CRT_FILE='./pki/test-vpn-client-example.crt' export ARO_VGW_PKI_CLIENT_KEY_FILE='./pki/test-vpn-client-example.key' export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!example!' export ARO_VGW_PKI_CLIENT_NAME='test-vpn-client-example' export ARO_VGW_PKI_CLIENT_PFX_FILE='./pki/test-vpn-client-example.pfx' export ARO_VGW_PKI_CLIENT_REQ_FILE='./pki/test-vpn-client-example.req' export ARO_VGW_PKI_CLIENT_SERIAL_FILE='./pki/test-vpn-client-example.serial' export ARO_VGW_PKI_DIR='./pki' export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE='./pki/test-vpn-root.serial' export ARO_VGW_PKI_ROOT_CRT_FILE='./pki/test-vpn-root.crt' export ARO_VGW_PKI_ROOT_CRT_FILE_NAME='test-vpn-root.crt' export ARO_VGW_PKI_ROOT_KEY_FILE='./pki/test-vpn-root.key' export ARO_VGW_PKI_ROOT_KEY_FILE_NAME='test-vpn-root.key' export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VGW_POOL_ADDRESS_PREFIX='172.16.11.0/24' export ARO_VGW_PUBLIC_ADDRESS_NAME='test-vpn-public-ip' export ARO_VGW_REDUNDANCY='true' export ARO_VGW_SKU='VpnGw1AZ' export ARO_VGW_TYPE='RouteBased' export ARO_VM_JUMP_ADMIN_NAME='test-vm-jumpbox-admin' export ARO_VM_JUMP_IMAGE_MARKETPLACE='true' export ARO_VM_JUMP_IMAGE_URN='cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710' export ARO_VM_JUMP_NAME='test-vm-jumpbox' export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME='test-vm-jumpbox-public-ip' export ARO_VM_JUMP_SIZE='Standard_B1ms' export ARO_VNET_ADDRESS_PREFIX='10.11.0.0/21' export ARO_VNET_NAME='test-vnet' export ARO_VPN_GATEWAY_NAME='test-vpn' export ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE='./pki/test-vpn.crt' export ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE_NAME='test-vpn.crt' export ARO_VPN_GATEWAY_PKI_KEY_FILE='./pki/test-vpn.key' export ARO_VPN_GATEWAY_PKI_KEY_FILE_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VPN_GATEWAY_POOL_ADDRESS_PREFIX='172.16.11.0/24' export ARO_VPN_GATEWAY_PUBLIC_ADDRESS_NAME='test-vpn-public-ip' export ARO_VPN_GATEWAY_REDUNDANCY='true' export ARO_VPN_GATEWAY_SKU='VpnGw1AZ' export ARO_VPN_GATEWAY_TYPE='RouteBased' export ARO_ADMINISTRATORS=(joseph.tingiris@mitaei.net arun.babu@mitaei.net sivaprasad.k@mitaei.net) export ARO_SUBSCRIPTION_OWNERS=(joseph.tingiris@mitaei.net christy.walsh@mitaei.net arun.babu@mitaei.net sivaprasad.k@mitaei.net) export ARO_RESOURCE_PROVIDERS=(Microsoft.RedHatOpenShift Microsoft.Compute Microsoft.Storage) export ARO_VERIFY_QUOTA_NAMEs=() export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs') Step 4.2 - Verify Required ARO Environment Variables Ensure the ARO bash environment variables are globally available. References: https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=test ARO_APPLICATION_NAME=test-app ARO_CLUSTER_NAME=test-cluster ARO_DOMAIN_NAME=test.mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET_FILE=./secrets/test-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=test-eastus ARO_SERVICE_PRINCIPAL_NAME=http://test-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=test-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=test-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=test-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=test-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=test-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=test-vnet-dmz-subnet-nsg ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=test-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=test-vnet-master-subnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=test-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=test-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=test-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=test-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=test-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=./pki/test-vpn-client-example.crt ARO_VGW_PKI_CLIENT_KEY_FILE=./pki/test-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=test-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=./pki/test-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=./pki/test-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=./pki/test-vpn-client-example.serial ARO_VGW_PKI_DIR=./pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=./pki/test-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=./pki/test-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_FILE_NAME=test-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=./pki/test-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_NAME=test-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VGW_PUBLIC_ADDRESS_NAME=test-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=test-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=test-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=test-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=test-vnet ARO_VPN_GATEWAY_NAME=test-vpn ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE=./pki/test-vpn.crt ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE_NAME=test-vpn.crt ARO_VPN_GATEWAY_PKI_KEY_FILE=./pki/test-vpn.key ARO_VPN_GATEWAY_PKI_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VPN_GATEWAY_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VPN_GATEWAY_PUBLIC_ADDRESS_NAME=test-vpn-public-ip ARO_VPN_GATEWAY_REDUNDANCY=true ARO_VPN_GATEWAY_SKU=VpnGw1AZ ARO_VPN_GATEWAY_TYPE=RouteBased Step 5 - Obtain Pull Secrets Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries. Step 5.1 - Obtain Red Hat Pull Secret A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. This step must be done manually. It is optional but recommended. Go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned Step 5.2 - Verify Red Hat Pull Secret Commands: ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: -rw-rw----+ 1 jtingiris mit 2835 Sep 17 09:13 ./secrets/test-redhat-pull-secret.txt Step 6 - Setup Azure CLI The Azure command-line interface (Azure CLI) is a set of commands used to create and manage Azure resources. The Azure CLI is available across Azure services and is designed to get you working quickly with Azure, with an emphasis on automation. References: https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest Step 6.1 - Install Azure CLI The Azure CLI is available to install in Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. To install, please follow the link in the References section. References: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Commands: az --version Example Output: # az --version azure-cli 2.11.1 core 2.11.1 telemetry 1.0.5 * Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy Step 6.2 - Show Default Subscription References: https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Commands: az account list --query '[?isDefault == `true`]' Example Output: # az account list --query '[?isDefault == `true`]' [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ] Step 6.3 - Login as the Subscription Owner The Azure Subscription Owner must perform the following steps. References: https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Commands: az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net Step 7 - Setup Additional Subscription Owners This step is optional, but recommended. There should be at least two (2) Subscription Owners. References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create Step 7.1 - Verify Subscription Owners References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Example Output: # az role assignment list --role Owner --output table Principal Role Scope -------------------------- ------ --------------------------------------------------- sivaprasad.k@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Step 8 - Verify Azure Tenant Go to the Microsoft admin center and login with a Microsoft account that is the Global administrator. https://admin.microsoft.com/ A Global Administrator will have access to all portions of the admin center. Commands: az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' Example Output: # az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ] Step 9 - Verify Azure Subscription The Azure Subscription can also be verified by going to: https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade Step 9.1 - Verify Subscription Names References: https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list Commands: az account list --output table Example Output: # az account list --output table Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True # az account show --subscription \"12c7070f-83e5-453b-96d0-90770d2cf942\" --query \"[{subscription_name:name},{subscription_id:id}]\" [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ] Step 9.2 - Verify Subscription Location Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable regions for the installation. The region name will be used throughout this document. References: https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Commands: az account list-locations --query \\\"[?name=='${ARO_LOCATION_NAME}']\\\" --output table Example Output: # az account list-locations --query \"[?name=='eastus']\" --output table Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US Step 9.3 - Verify Subscription Limits The Azure Red Hat OpenShift (ARO) cluster uses several Microsoft Azure components, and the default Azure subscription and service limits, quotas, and constraints affect the ability to install ARO clusters. A default ARO cluster requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. If an existing Azure Subscription is used then check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. References: https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html ARO minimum limits are required for: Standard Dv2 Family vCPUs Standard DSv3 Family vCPUs Step 9.4 - Verify Subscription Quotas Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner should do this step. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Dv2 Series DSv3 Series An increase in the VM series quotas automatically increases the total regional vCPU limit by the same amount. Please use the links in the references of this section for Microsoft's directions on how to request a quota increase for a specific subscription. A support case will be opened, and Microsoft will communicate directly to the person who requested the increase. References: https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests Verify subscription quotas for: Standard Dv2 Family vCPUs Standard DSv3 Family vCPUs Step 9.5 - Verify Subscription Quota for Standard Dv2 Family vCPUs References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_list_usage Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" Example Output: # az vm list-usage --location eastus --query \"[?localName=='Standard Dv2 Family vCPUs']\" [ { \"currentValue\": \"0\", \"limit\": \"100\", \"localName\": \"Standard Dv2 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard Dv2 Family vCPUs\", \"value\": \"standardDv2Family\" } } ] Step 9.6 - Verify Subscription Quota for Standard DSv3 Family vCPUs References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_list_usage Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" Example Output: # az vm list-usage --location eastus --query \"[?localName=='Standard DSv3 Family vCPUs']\" [ { \"currentValue\": \"36\", \"limit\": \"100\", \"localName\": \"Standard DSv3 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard DSv3 Family vCPUs\", \"value\": \"standardDSv3Family\" } } ] Step 10 - Setup OpenShift Administrators Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities. Step 10.1 - Verify OpenShift Administrator Accounts Ensure the OpenShift Administrator accounts exist and have the appropriate subscription roles. References: https://docs.microsoft.com/en-us/cli/azure/ad/user?view=azure-cli-latest#az_ad_user_show Commands: for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query userPrincipalName --output tsv; done Example Output: # az ad user show --id joseph.tingiris@mitaei.net --query userPrincipalName --output tsv joseph.tingiris@mitaei.net # az ad user show --id arun.babu@mitaei.net --query userPrincipalName --output tsv arun.babu@mitaei.net # az ad user show --id sivaprasad.k@mitaei.net --query userPrincipalName --output tsv sivaprasad.k@mitaei.net Step 10.2 - Verify OpenShift Administrator Subscription Roles References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Commands: for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; echo; done Example Output: # az role assignment list --assignee joseph.tingiris@mitaei.net --output table Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 # az role assignment list --assignee arun.babu@mitaei.net --output table Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 # az role assignment list --assignee sivaprasad.k@mitaei.net --output table Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 Step 11 - Setup Azure Resource Providers Make sure you are logged in to Azure via az (az login) with a Contributor or Owner role. This step will fail for OpenShift Admins with only the User Access Administrator. They will receive a message saying they do not have authorization. Step 11.1 - Verify Provider Microsoft.RedHatOpenShift References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.RedHatOpenShift --output table Example Output: # az provider show --namespace Microsoft.RedHatOpenShift --output table Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered Step 11.2 - Verify Provider Microsoft.Compute References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.Compute --output table Example Output: # az provider show --namespace Microsoft.Compute --output table Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered Step 11.3 - Verify Provider Microsoft.Storage References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.Storage --output table Example Output: # az provider show --namespace Microsoft.Storage --output table Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered Step 12 - Setup Resource Group An Azure resource group is a logical group in which Azure resources are deployed and managed. A resource group location must be specified. This location is where resource group metadata is stored, it is also where the Azure resources are hosted. References: https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Commands: az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: Step 12.1 - Verify Resource Group References: https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Commands: az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: # az group show --name test-eastus { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"test-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } Step 13 - Setup Virtual Network An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. References: https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Commands: env | grep ^ARO_VNET | sort Example Output: ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=test-vnet Step 13.1 - Verify Virtual Network References: https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Commands: az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: # az network vnet show --resource-group test-eastus --name test-vnet --output table EnableDdosProtection EnableVmProtection Location Name ProvisioningState ResourceGroup ResourceGuid ---------------------- -------------------- ---------- --------- ------------------- --------------- ------------------------------------ False False eastus test-vnet Succeeded test-eastus 07635501-237e-4c71-89b0-573ccc270697 Step 14 - Setup Azure Red Hat OpenShift Subnets Azure Red Hat OpenShift clusters require a virtual network with two empty subnets, for the master and worker nodes. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. It is suggested the virtual network (vnet) prefix be /21 and each (master and worker) vnet subnet prefix be /23, which will allow for a total of 510 master nodes and 510 worker nodes. The additional subnets within the /21 prefix will be used for a VPN Gateway subnet and future growth. NOTE: In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher ; Please see the references in this section for more details._ References: https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Commands: env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort Example Output: ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=test-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=test-vnet-master-subnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=test-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=test-vnet-worker-subnet-nsg Step 14.1 - Verify Master Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-master-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.0.0/23 test-vnet-master-subnet Enabled Disabled Succeeded test-eastus Step 14.2 - Verify Worker Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-worker-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.2.0/23 test-vnet-worker-subnet Enabled Enabled Succeeded test-eastus Step 15 - Setup Additional Network Security Groups Azure Network Security Groups filter network traffic to and from Azure resources in an Azure virtual network. A Network Security Group contains security rules that allow/deny network traffic to/from several types of Azure resources. NOTE: The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. References: https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Commands: env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|GATEWAY' | sort Example Output: ARO_SUBNET_AGW_NSG_NAME=test-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=test-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=test-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=test-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg Step 15.1 - Verify Network Security Groups References: https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_show Commands: az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table Example Output: # az network nsg show --resource-group test-eastus --name test-vnet-agw-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ------------------------ ------------------- --------------- ------------------------------------ eastus test-vnet-agw-subnet-nsg Succeeded test-eastus 2099686c-df3e-4bea-b6bd-48b252b62e87 # az network nsg show --resource-group test-eastus --name test-vnet-db-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus test-vnet-db-subnet-nsg Succeeded test-eastus d31cbe87-00fc-4734-9d00-bfc78ef76a49 # az network nsg show --resource-group test-eastus --name test-vnet-dmz-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ------------------------ ------------------- --------------- ------------------------------------ eastus test-vnet-dmz-subnet-nsg Succeeded test-eastus 42853b6a-9f5e-44ac-a400-a926857ce16d # az network nsg show --resource-group test-eastus --name test-vnet-trusted-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ---------------------------- ------------------- --------------- ------------------------------------ eastus test-vnet-trusted-subnet-nsg Succeeded test-eastus 2596272f-0cba-4279-b4a3-81bbc9d0279a Step 16 - Setup Additional Network Security Group Rules Network security group security rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows a network security group to be stateful. References: https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Step 16.1 - Verify DMZ Network Security Group Rules References: https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_show # az network nsg show --resource-group test-eastus --name test-vnet-dmz-subnet-nsg --query securityRules --output table Protocol SourcePortRange DestinationPortRange SourceAddressPrefix DestinationAddressPrefix Access Priority Direction ProvisioningState Name ResourceGroup ---------- ----------------- ---------------------- --------------------- -------------------------- -------- ---------- ----------- ------------------- -------- --------------- Tcp * 22 * * Allow 1000 Inbound Succeeded AllowSSH test-eastus Step 17 - Setup Additional Subnets Azure Red Hat OpenShift clusters require a virtual network with two empty subnets, for the master and worker nodes. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. It is suggested the virtual network (vnet) prefix be /21 and each (master and worker) vnet subnet prefix be /23, which will allow for a total of 510 master nodes and 510 worker nodes. NOTE: In 2018, Microsoft started automatically enabling Network Watcher when a new subnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher ; Please see the references in this section for more details._ References: https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Commands: env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|GATEWAY' | sort Example Output: ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=test-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=test-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=test-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=test-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=test-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=test-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=test-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=test-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg Step 17.1 - Verify Application Gateway Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-agw-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- -------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.4.0/25 test-vnet-agw-subnet Enabled Enabled Succeeded test-eastus Step 17.2 - Verify Database Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-db-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.4.128/25 test-vnet-db-subnet Enabled Enabled Succeeded test-eastus Step 17.3 - Verify DMZ Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-dmz-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- -------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.5.0/25 test-vnet-dmz-subnet Enabled Enabled Succeeded test-eastus Step 17.4 - Verify Trusted Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-trusted-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------------ -------------------------------- ----------------------------------- ------------------- --------------- 10.11.5.128/25 test-vnet-trusted-subnet Enabled Enabled Succeeded test-eastus Step 18 - Setup Jump Server Virtual Machine A jump server, jump host or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example is managing a host in a DMZ from trusted networks or computers. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet, and it will be allowed to communicate with the other internal subnets. References: https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-cli-complete https://en.wikipedia.org/wiki/Jump_server https://en.wikipedia.org/wiki/DMZ_(computing) Commands: env | grep JUMP | sort Example Output: ARO_VM_JUMP_ADMIN_NAME=test-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=test-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=test-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms Step 18.1 - Verify Jump Server Public IP Address References: https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Commands: az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: # az network public-ip show --name test-vm-jumpbox-public-ip --resource-group test-eastus { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"897a5a29-3d93-419c-a2ef-707fd11614fe\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Network/publicIPAddresses/test-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": \"40.71.92.76\", \"ipConfiguration\": { \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Network/networkInterfaces/test-vm-jumpbox-nic/ipConfigurations/ipconfig1\", \"name\": null, \"privateIpAddress\": null, \"privateIpAllocationMethod\": null, \"provisioningState\": null, \"publicIpAddress\": null, \"resourceGroup\": \"test-eastus\", \"subnet\": null }, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"test-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"test-eastus\", \"resourceGuid\": \"e8355a50-19c1-47b0-bfbb-a719f6e0ee51\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null } Step 18.2 - Verify Jump Server Virtual NIC A network interface enables an Azure Virtual Machine to communicate with internet, Azure, and on-premises resources. References: https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_show https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface Commands: az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table Example Output: # az network nic show --resource-group test-eastus --name test-vm-jumpbox-nic --output table EnableAcceleratedNetworking EnableIpForwarding Location MacAddress Name Primary ProvisioningState ResourceGroup ResourceGuid ----------------------------- -------------------- ---------- ----------------- ------------------- --------- ------------------- --------------- ------------------------------------ False False eastus 00-0D-3A-12-B3-FC test-vm-jumpbox-nic True Succeeded test-eastus b642cd28-3d23-427a-82cc-7ba755438991 Step 18.3 - Verify Jump Server Availability Set References: https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create Commands: az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table Example Output: # az vm availability-set show --resource-group test-eastus --name test-vm-jumpbox-as --output table Location Name PlatformFaultDomainCount PlatformUpdateDomainCount ResourceGroup ---------- ------------------ -------------------------- --------------------------- --------------- eastus test-vm-jumpbox-as 2 5 test-eastus Step 18.4 - Verify Jump Server Image Terms In this document, the image being used for the Jump Server is a free Azure Marketplace image. The terms must be accepted. The URN is: cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 References: https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_show https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cognosys.docker-ce-with-centos-8-0-free?tab=Overview Commands: az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Example Output: # az vm image terms show --urn cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Accepted Name Plan Product Publisher ---------- ------------------------------ ------------------------------ ------------------------------ ----------- True docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free cognosys Step 18.5 - Verify Jump Server Virtual Machine References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Commands: az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv Example Output: # az vm show --resource-group test-eastus --name test-vm-jumpbox { \"additionalCapabilities\": null, \"availabilitySet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Compute/availabilitySets/TEST-VM-JUMPBOX-AS\", \"resourceGroup\": \"test-eastus\" }, \"billingProfile\": null, \"diagnosticsProfile\": null, \"evictionPolicy\": null, \"extensionsTimeBudget\": null, \"hardwareProfile\": { \"vmSize\": \"Standard_B1ms\" }, \"host\": null, \"hostGroup\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Compute/virtualMachines/test-vm-jumpbox\", \"identity\": null, \"instanceView\": null, \"licenseType\": null, \"location\": \"eastus\", \"name\": \"test-vm-jumpbox\", \"networkProfile\": { \"networkInterfaces\": [ { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Network/networkInterfaces/test-vm-jumpbox-nic\", \"primary\": true, \"resourceGroup\": \"test-eastus\" } ] }, \"osProfile\": { \"adminPassword\": null, \"adminUsername\": \"test-vm-jumpbox-admin\", \"allowExtensionOperations\": true, \"computerName\": \"test-vm-jumpbox\", \"customData\": null, \"linuxConfiguration\": { \"disablePasswordAuthentication\": true, \"patchSettings\": { \"patchMode\": \"ImageDefault\" }, \"provisionVmAgent\": true, \"ssh\": { \"publicKeys\": [ { \"keyData\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDec9G5K26hxFj+Ha0gQChwhSW4fT6mlZrb0066h+moGMJKMJ2YiHMaNMUULFT8SkJch4KYjQfqgJE8YnSGRHPzmUWwF/v7AwcozIlwralduUdYNIScDnzaFCBa55pLQwCWIN7zXFCdtEG935XwaV+A+tOgokiGvGXMAUj/Dz0A5ClIhbD/i3dr2AFKuuSwMGpFc1EqZDh72ZsYTcDaZT5hhPPUCUyTqOfEJuWQYeE3DAuA1EoI2tmBQWNl2S1jtdHa/69BBAmA6t0MZXuMKpk0udzQjw/d6b64hKYHDDlfxaTEBnt1Vbd8Rv5bxJSI1y2QgCutRZwVa/dt1X71fwpAq4yr0H8JCrabKrIumgqyZ6VQyCTVu3AXZ3E/yMQmJhLK2RvPHrHp8DedZ3su62zvU9aUACyd6b89R6S4eYOmIE+nNG/M/yqS2Ru3GPUalsQXE5/auCsg6rPetxMNoEbZz5qTfJUfq3Xx61WQuLrAsyvEiIiM5rrgA/FhYbthxKKacYr0b6oi6HQW6KQ3JnPMm/QF2UxDxoNOG+NHi2UBfgiXLEHZQ3YnkS4QkB9aCK4YJyOJ5I/34gAGcUIPQ8nkUSky7btjsQlHNB6pHPI+8Xd2SntRmfgBwJwOUS+LqjK4OCCpkqUTSopXQ8vL8L/e2gw+8QIdTYe47/P0IG5zVQ== jtingiris@jt\\n\", \"path\": \"/home/test-vm-jumpbox-admin/.ssh/authorized_keys\" } ] } }, \"requireGuestProvisionSignal\": true, \"secrets\": [], \"windowsConfiguration\": null }, \"plan\": { \"name\": \"docker-ce-with-centos-8-0-free\", \"product\": \"docker-ce-with-centos-8-0-free\", \"promotionCode\": null, \"publisher\": \"cognosys\" }, \"priority\": null, \"provisioningState\": \"Succeeded\", \"proximityPlacementGroup\": null, \"resourceGroup\": \"test-eastus\", \"resources\": null, \"securityProfile\": null, \"storageProfile\": { \"dataDisks\": [], \"imageReference\": { \"exactVersion\": \"1.2019.0710\", \"id\": null, \"offer\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"sku\": \"docker-ce-with-centos-8-0-free\", \"version\": \"1.2019.0710\" }, \"osDisk\": { \"caching\": \"ReadWrite\", \"createOption\": \"FromImage\", \"diffDiskSettings\": null, \"diskSizeGb\": 30, \"encryptionSettings\": null, \"image\": null, \"managedDisk\": { \"diskEncryptionSet\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/TEST-EASTUS/providers/Microsoft.Compute/disks/test-vm-jumpbox_OsDisk_1_d3cba19386b146898ff2ec6a13e92c61\", \"resourceGroup\": \"TEST-EASTUS\", \"storageAccountType\": \"Premium_LRS\" }, \"name\": \"test-vm-jumpbox_OsDisk_1_d3cba19386b146898ff2ec6a13e92c61\", \"osType\": \"Linux\", \"vhd\": null, \"writeAcceleratorEnabled\": null } }, \"tags\": {}, \"type\": \"Microsoft.Compute/virtualMachines\", \"virtualMachineScaleSet\": null, \"vmId\": \"1eaa170c-4f08-4383-a9a5-8aebd23b256c\", \"zones\": null } # az vm show -d -g test-eastus -n test-vm-jumpbox --query publicIps -o tsv 40.71.92.76 Step 18.6 - Login to Jump Server Virtual Machine References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Commands: export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} 'hostname && uptime' Example Output: 40.71.92.76 test-vm-jumpbox 03:26:23 up 3 days, 12:54, 0 users, load average: 0.02, 0.02, 0.00 Step 19 - Setup VPN Gateway A VPN gateway is a specific type of virtual network gateway that is used to send encrypted traffic between an Azure virtual network and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. References: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://docs.microsoft.com/en-us/azure/vpn-gateway/create-routebased-vpn-gateway-cli Step 19.1 - Verify VPN Gateway Subnet References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name GatewaySubnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.6.0/25 GatewaySubnet Enabled Enabled Succeeded test-eastus Step 19.2 - Verify VPN Gateway Public IP Address References: https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: # az network public-ip show --name test-vpn-public-ip --resource-group test-eastus --output table Name ResourceGroup Location Zones Address AddressVersion AllocationMethod IdleTimeoutInMinutes ProvisioningState ------------------ --------------- ---------- ------- ------------ ---------------- ------------------ ---------------------- ------------------- test-vpn-public-ip test-eastus eastus 1 52.146.16.51 IPv4 Static 4 Succeeded Step 19.3 - Verify VPN Gateway References: https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: # az network vnet-gateway show --name test-vpn --resource-group test-eastus --output table ActiveActive EnableBgp EnablePrivateIpAddress GatewayType Location Name ProvisioningState ResourceGroup ResourceGuid VpnGatewayGeneration VpnType -------------- ----------- ------------------------ ------------- ---------- -------- ------------------- --------------- ------------------------------------ ---------------------- ---------- False False False Vpn eastus test-vpn Succeeded test-eastus c3808606-15b0-4577-beac-5ef1ba033ff0 Generation1 RouteBased Step 20 - Setup VPN Gateway Certificate Authentication When using the native VPN Gateway Azure Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. References: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal Step 20.1 - Verify VPN Gateway Root Key References: https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE Example Output: # openssl rsa -in ./pki/test-vpn-root.key -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE && echo ./pki/test-vpn-root.key OK || echo ./pki/test-vpn-root.key FAILED Step 20.2 - Verify VPN Gateway Root Certificate References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text Example Output: # openssl x509 -in \"./pki/test-vpn-root.crt\" -noout -text Certificate: Data: Version: 3 (0x2) Serial Number: 0f:68:84:2f:5f:6a:b7:84:53:70:07:1f:db:99:f4:06:bf:fd:28:b0 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = test-vpn Validity Not Before: Sep 19 17:15:34 2020 GMT Not After : Sep 17 17:15:34 2030 GMT Subject: CN = test-vpn Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:b0:61:28:b2:55:89:7a:11:d2:33:0c:52:a8:bc: bd:5d:6b:6a:5f:ba:38:f8:e0:20:d3:ea:91:6c:bd: 21:f2:d3:70:80:32:70:2d:e0:bc:79:69:35:4a:aa: 41:2d:37:0f:eb:8a:be:3c:98:2b:2f:54:b0:3f:68: b6:0d:5e:6d:f1:0f:78:1f:bd:c4:45:9e:d2:03:2a: 20:e3:05:82:89:d6:b2:f1:cb:a2:4d:5d:61:0e:a4: 6d:34:b3:6e:7f:10:44:8c:7c:74:84:fe:8a:82:ed: 37:aa:c9:88:54:87:a3:22:5b:63:de:ad:f3:86:ad: 80:19:32:91:6e:94:51:14:25:c1:c3:df:fd:c0:d1: e6:b1:22:36:ac:5c:bb:98:f0:74:98:41:96:6e:c7: f8:76:9a:d7:a1:bb:48:11:1e:69:54:c9:2c:46:b1: 32:b0:c0:19:a6:33:9f:0c:71:f5:41:b7:4e:57:1e: 7e:42:33:d5:89:db:18:67:1c:e8:54:7b:50:b4:14: bf:78:17:c3:ef:11:b6:3f:a7:57:9f:f8:16:87:ff: 17:06:3c:c6:d7:d6:45:c2:0a:ec:99:d8:35:53:f7: a5:85:d0:b3:ae:ca:94:a2:b9:40:d6:35:1e:eb:a0: ec:4e:e6:0e:4d:5b:6f:94:af:48:b3:d1:06:5e:5b: c4:2f Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: C1:D4:7C:0F:FA:85:E6:D7:22:F0:BC:47:AC:4D:7A:BD:9E:42:58:88 X509v3 Authority Key Identifier: keyid:C1:D4:7C:0F:FA:85:E6:D7:22:F0:BC:47:AC:4D:7A:BD:9E:42:58:88 X509v3 Basic Constraints: critical CA:TRUE Signature Algorithm: sha256WithRSAEncryption 7f:72:23:7e:5c:65:f0:34:03:79:f6:0b:ae:a4:6d:06:77:b9: ef:c5:93:4c:1a:ed:70:45:a7:e0:42:33:b7:b8:7e:d5:95:7b: d0:22:85:c9:49:8a:26:5f:d6:b9:90:1a:2a:54:f7:d8:2d:4f: 56:93:9f:93:91:4f:c1:85:3e:0d:70:9b:5a:00:84:7b:13:3b: 47:d3:00:0f:2b:01:df:9c:cb:61:9a:c1:cd:b4:ed:f4:24:bc: 5f:66:d1:d0:8d:57:ee:ab:47:b8:b5:d6:6f:be:0d:b1:07:9e: 00:f5:a1:a2:b2:6e:f9:f6:b8:59:5a:13:64:a2:c3:6e:a5:ee: c3:8f:88:ce:5b:ea:0f:7b:3b:08:6f:dd:17:fe:00:d4:a7:6d: 66:78:30:80:95:0c:1b:c6:7f:b3:82:5a:cc:0d:39:74:b6:4c: 0c:da:af:fc:3a:79:cc:ab:06:22:2a:b8:68:97:27:4f:10:b4: 2f:43:c0:29:51:fa:7c:a2:92:0a:e6:6f:a7:d7:22:82:6a:b0: e4:77:c9:b8:ef:6e:57:75:f6:0b:e9:60:79:59:a0:1e:2b:e1: 1d:94:d4:3f:35:7f:24:35:a8:57:85:bb:98:33:85:a2:97:81: d8:c6:e9:99:26:52:af:fd:82:0f:56:64:8c:cf:ac:e1:41:46: 52:45:e5:6b Step 20.3 - Verify VPN Gateway Root Certificate Moduli This step verifies the modulus for the root certificate and key match. Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed. References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): echo -n \"md5sum for ./pki/test-vpn-root.key = \"; openssl rsa -noout -modulus -in \"./pki/test-vpn-root.key\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ./pki/test-vpn-root.crt = \"; openssl x509 -noout -modulus -in \"./pki/test-vpn-root.crt\" | md5sum Example Output: # echo -n \"md5sum for ./pki/test-vpn-root.key = \"; openssl rsa -noout -modulus -in \"./pki/test-vpn-root.key\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum md5sum for ./pki/test-vpn-root.key = d7a262d5c6023fc9cc0cf33feae2ca3d - # echo -n \"md5sum for ./pki/test-vpn-root.crt = \"; openssl x509 -noout -modulus -in \"./pki/test-vpn-root.crt\" | md5sum md5sum for ./pki/test-vpn-root.crt = d7a262d5c6023fc9cc0cf33feae2ca3d - Step 20.4 - Verify VPN Gateway Root Certificate Data References: https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_FILE_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_FILE_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_FILE_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi Example Output: found test-vpn root certificate name = test-vpn-root.crt verified test-vpn-root.crt exists as a root certificate name for test-vpn Step 21 - Setup VPN Client Certificates VPN Clients must present an X.509 version 3 certificate when connecting. Each user should have their own bundle of certificate files. This step outlines a procedure to create them with OpenSSL v1.1.1. It will need to be re-run for everyone who requires connectivity. The Azure VPN Gateway supports both IKEv2 (ipsec) and OpenVPN (ssl) client connections. Various VPN client software support these technologies. It is most convenient to distribute a PKCS#12 file to the user, so they can connect to the VPN Gateway and access the private Azure Red Hat OpenShift cluster. In cryptography, PKCS #12 defines an archive file format for storing many cryptography objects as a single file. PKCS#12 evolved from Microsoft's Personal Information Exchange (PFX) standard and is used to exchange public and private objects. It is commonly used to bundle a private key with its X.509 certificate or to bundle all the members of a chain of trust. The terms PKCS #12 (pkcs12) and PFX (pfx) are often used interchangeably. Successful execution of the commands in this step depends upon the previously created VPN Gateway Root Certificate files and exported environment variables. At minimum, these environment variables must be properly set beforehand: ARO_VGW_NAME ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE Successful completion of the following steps will produce six (6) files, in this order: VPN Client Key (.key) VPN Client Certificate Request (.req) VPN Client Certificate Extensions (.ext) VPN Client Certificate (.crt) VPN Client Certificate Serial (.serial) VPN Client Certificate Bundle (.pfx) The resulting PFX file is should be given to the user. References: https://en.wikipedia.org/wiki/X.509 https://en.wikipedia.org/wiki/PKCS_12 https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-vpn-client-install-azure-cert https://www.openssl.org/ Step 21.1 - Export VPN Client ARO Environment Variables These environment variables should be exported each time a new set of client certificate files are created. These are example values that must be changed for your installation. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' Example Output: - successfully setting enivronment variables does not produce any output Step 21.2 - Verify VPN Client ARO Environment Variables References: https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html Command(s): VERIFY_VARIABLES=(ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_NAME ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for VERIFY_VARIABLE in ${VERIFY_VARIABLES[@]}; do if [ \"${!VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR: Environment Variable ${VERIFY_VARIABLE} is NOT set\"; else echo \"${VERIFY_VARIABLE}=${!VERIFY_VARIABLE}\"; fi; done; unset VERIFY_VARIABLE Example Output: # VERIFY_VARIABLES=(ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_NAME ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) - successfully setting enivronment variables does not produce any output # for VERIFY_VARIABLE in ${VERIFY_VARIABLES[@]}; do if [ \"${!VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR: Environment Variable ${VERIFY_VARIABLE} is NOT set\"; aborting; else echo \"${VERIFY_VARIABLE}=${!VERIFY_VARIABLE}\"; fi; done; unset VERIFY_VARIABLE VERIFY_VARIABLES ARO_VGW_PKI_CLIENT_NAME=test-vpn-client-example ARO_VGW_PKI_CLIENT_EXT_FILE=./pki/test-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=./pki/test-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_REQ_FILE=./pki/test-vpn-client-example.req ARO_VGW_PKI_CLIENT_CRT_FILE=./pki/test-vpn-client-example.crt ARO_VGW_PKI_CLIENT_SERIAL_FILE=./pki/test-vpn-client-example.serial ARO_VGW_PKI_CLIENT_PFX_FILE=./pki/test-vpn-client-example.pfx ARO_VGW_NAME=test-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=./pki ARO_VGW_PKI_ROOT_KEY_FILE=./pki/test-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! Step 21.3 - Verify VPN Client Key References: https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE Example Output: # openssl rsa -in \"./pki/test-vpn-client-example.key\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE - no output produced when command is successful Step 21.4 - Verify VPN Client Certificate Request References: https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text Example Output: # openssl req -in \"./pki/test-vpn-client-example.req\" -noout -text Certificate Request: Data: Version: 1 (0x0) Subject: CN = test-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:c8:57:97:93:5e:12:f8:c1:3e:da:76:93:f0:7c: d9:f4:2e:06:72:29:5e:f3:34:de:38:f6:88:53:75: 33:b2:c4:0f:bb:0d:f2:4a:9c:11:bb:b1:a6:04:f5: 78:d0:c8:9b:d4:bd:0c:26:c8:77:1b:c3:21:23:9d: b9:56:19:3a:0f:d3:74:51:ca:b6:26:82:d1:38:dd: 40:3a:ae:d6:9d:c2:ce:ae:2c:cc:2f:94:a9:fc:c8: 09:43:94:c6:88:96:e8:bc:38:0c:0f:ab:25:c8:38: ee:90:3c:34:99:cf:eb:c4:7d:49:d3:a7:e7:83:82: 01:53:c2:cf:1b:16:bd:f0:0a:e3:8a:d7:9c:ca:01: 36:3c:19:a4:74:19:dd:bb:37:d4:67:dc:8a:92:b2: bf:3c:93:53:eb:21:0b:15:d1:00:45:67:36:f1:19: 68:a2:10:1b:5d:24:c6:13:f3:46:f3:99:43:53:c8: 0b:bf:b8:7f:ef:db:10:05:da:23:1e:23:8e:17:49: 1c:32:c3:cf:af:f9:55:54:27:1d:14:cb:90:34:63: f4:30:e9:8f:17:b8:94:81:03:e9:ad:b8:4b:ff:c1: b5:dc:08:57:96:3b:10:bc:53:89:61:10:3c:64:2b: 74:05:bf:df:23:0c:79:c9:e0:4b:01:48:8e:0d:33: b1:03 Exponent: 65537 (0x10001) Attributes: a0:00 Signature Algorithm: sha256WithRSAEncryption 6a:bb:28:6f:4d:bb:0a:7b:9b:54:b2:d0:ad:f7:26:16:d5:d6: 2a:9c:d0:3b:98:76:7c:a6:72:9a:02:33:5a:de:c0:c8:4e:6b: 0d:45:be:ca:fd:24:d4:20:d9:6e:05:fa:9f:81:b8:d0:fe:6e: 58:9d:c3:53:b1:06:f1:45:a9:42:e2:9e:4d:9b:05:94:16:83: 65:73:03:f7:ff:7d:18:ba:04:ec:9d:a0:b5:52:57:ec:2f:b7: 14:b3:cd:76:c1:6f:80:2f:06:d4:e2:1b:5c:3e:2a:00:cf:a6: dc:c4:03:76:50:76:21:d9:5f:c5:8e:1d:60:10:d0:ec:e5:c2: 32:ac:c9:53:04:88:fc:f3:5b:62:b2:fc:a8:93:64:29:be:98: a8:d3:24:ce:cf:a7:c7:fb:a3:6d:aa:ca:b7:38:72:2a:f7:4d: d0:14:4f:9a:01:63:74:6c:05:72:a0:fa:f7:5e:c0:d0:3b:7c: 45:b6:a1:ef:a0:23:5a:d0:07:bf:a9:8b:8f:92:9a:78:6a:2f: 11:01:2a:44:2e:9c:58:d9:31:2b:a3:fa:5c:b8:f1:a0:97:90: 58:35:35:fb:c5:a5:76:7d:09:6a:d1:39:38:c1:60:f7:7a:31: f7:93:3e:36:37:85:5e:9a:70:d3:50:d8:49:cc:3c:e9:b5:e3: a8:2d:d2:47 Step 21.5 - Verify VPN Client Certificate Extensions References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: # grep ^authorityKeyIdentifier=keyid,issuer \"./pki/test-vpn-client-example.ext\" && grep ^extendedKeyUsage=clientAuth \"./pki/test-vpn-client-example.ext\" authorityKeyIdentifier=keyid,issuer extendedKeyUsage=clientAuth Step 21.6 - Verify VPN Client Certificate References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text Example Output: # openssl x509 -in \"./pki/test-vpn-client-example.crt\" -noout -text Certificate: Data: Version: 1 (0x0) Serial Number: 51:a4:28:83:73:db:0a:ab:c3:9e:21:29:66:25:ef:b1:fb:a5:bc:14 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = test-vpn Validity Not Before: Sep 20 04:38:40 2020 GMT Not After : Sep 20 04:38:40 2023 GMT Subject: CN = test-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:c8:57:97:93:5e:12:f8:c1:3e:da:76:93:f0:7c: d9:f4:2e:06:72:29:5e:f3:34:de:38:f6:88:53:75: 33:b2:c4:0f:bb:0d:f2:4a:9c:11:bb:b1:a6:04:f5: 78:d0:c8:9b:d4:bd:0c:26:c8:77:1b:c3:21:23:9d: b9:56:19:3a:0f:d3:74:51:ca:b6:26:82:d1:38:dd: 40:3a:ae:d6:9d:c2:ce:ae:2c:cc:2f:94:a9:fc:c8: 09:43:94:c6:88:96:e8:bc:38:0c:0f:ab:25:c8:38: ee:90:3c:34:99:cf:eb:c4:7d:49:d3:a7:e7:83:82: 01:53:c2:cf:1b:16:bd:f0:0a:e3:8a:d7:9c:ca:01: 36:3c:19:a4:74:19:dd:bb:37:d4:67:dc:8a:92:b2: bf:3c:93:53:eb:21:0b:15:d1:00:45:67:36:f1:19: 68:a2:10:1b:5d:24:c6:13:f3:46:f3:99:43:53:c8: 0b:bf:b8:7f:ef:db:10:05:da:23:1e:23:8e:17:49: 1c:32:c3:cf:af:f9:55:54:27:1d:14:cb:90:34:63: f4:30:e9:8f:17:b8:94:81:03:e9:ad:b8:4b:ff:c1: b5:dc:08:57:96:3b:10:bc:53:89:61:10:3c:64:2b: 74:05:bf:df:23:0c:79:c9:e0:4b:01:48:8e:0d:33: b1:03 Exponent: 65537 (0x10001) Signature Algorithm: sha256WithRSAEncryption 43:e8:e3:f9:8c:19:47:0e:07:87:e2:58:b4:ab:a7:6b:09:19: ee:f6:d7:77:07:77:9a:39:ca:8d:93:2a:6c:29:eb:72:8d:8e: fd:a1:20:a5:20:36:4b:35:da:8a:5a:a9:3f:42:2d:e7:55:c6: e8:17:eb:df:c6:a5:9d:04:4a:ed:b2:7f:68:6b:1d:62:42:a9: c5:4b:c6:2c:dc:be:b6:99:fe:7d:8d:0c:82:17:d3:52:07:b5: 17:cc:4b:3a:1b:83:09:0f:eb:80:41:c4:9f:98:31:11:4f:88: 97:8f:7c:09:dd:bf:d5:50:31:20:cf:fa:21:6f:5a:e1:f6:b7: 26:bd:0f:f6:a2:63:08:1c:37:39:db:ed:ae:4c:a7:b6:0b:fd: ca:85:09:44:8f:c5:b8:12:12:f4:7a:bf:a8:54:13:b0:a3:3a: 80:a2:1f:11:1e:c5:96:a2:35:3c:70:6c:c6:8a:74:71:4a:20: 1f:76:14:5d:cf:6e:31:1f:39:ed:5a:66:f6:f9:9c:ae:7b:6f: 14:ec:3b:58:f2:7a:95:2d:68:f0:7b:83:56:1d:6c:9b:76:94: 5c:0a:1c:9b:c5:57:bd:89:2d:b1:35:ac:62:2e:b1:70:3e:e0: 2d:fa:51:46:b1:4b:7d:d2:ab:3b:43:a2:2b:9c:7a:99:53:e7: 39:63:43:e1 Step 21.7 - Verify VPN Client Certificate Moduli This step verifies the modulus for the client certificate, request, and key match. Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed. References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): echo -n \"md5sum for ./pki/test-vpn-client-example.key = \"; openssl rsa -noout -modulus -in \"./pki/test-vpn-client-example.key\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ./pki/test-vpn-client-example.crt = \"; openssl x509 -noout -modulus -in \"./pki/test-vpn-client-example.crt\" | md5sum echo -n \"md5sum for ./pki/test-vpn-client-example.req = \"; openssl req -noout -modulus -in \"./pki/test-vpn-client-example.req\" | md5sum Example Output: # echo -n \"md5sum for ./pki/test-vpn-client-example.key = \"; openssl rsa -noout -modulus -in \"./pki/test-vpn-client-example.key\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum md5sum for ./pki/test-vpn-client-example.key = f644adfa6fe3cca77bbbc830deaa8cd3 - # echo -n \"md5sum for ./pki/test-vpn-client-example.crt = \"; openssl x509 -noout -modulus -in \"./pki/test-vpn-client-example.crt\" | md5sum md5sum for ./pki/test-vpn-client-example.crt = f644adfa6fe3cca77bbbc830deaa8cd3 - # echo -n \"md5sum for ./pki/test-vpn-client-example.req = \"; openssl req -noout -modulus -in \"./pki/test-vpn-client-example.req\" | md5sum md5sum for ./pki/test-vpn-client-example.req = f644adfa6fe3cca77bbbc830deaa8cd3 - Step 21.8 - Verify VPN Client PFX References: https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text Example Output: # openssl x509 -in \"./pki/test-vpn-client-example.pfx\" -noout -text Bag Attributes localKeyID: 9F 0F F9 2F FF 3A B7 14 69 C5 C4 66 8D 14 F3 4C C7 AF F3 D7 subject=CN = test-vpn-client-example issuer=CN = test-vpn -----BEGIN CERTIFICATE----- MIIDKjCCAhKgAwIBAgIUUaQog3PbCqvDniEpZiXvsfulvBMwDQYJKoZIhvcNAQEL BQAwEzERMA8GA1UEAwwIdGVzdC12cG4wHhcNMjAwOTE5MTkxNjA1WhcNMjMwOTE5 MTkxNjA1WjAiMSAwHgYDVQQDDBd0ZXN0LXZwbi1jbGllbnQtZXhhbXBsZTCCASIw DQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALI83D0ALwUJIudLl8MEZVrT6rPE WgciZ7Jncx922lkXlqkIujSnSULY87H8Z2g6P6SlHHCAYu4O6+5v+ik23LrqkD+u X7O/+pQmnXFJWgXq0SF/CWWR74QAxMMdo/hj1ViVjrvt/P7UnwzHLY3fhFVglLAW deRSDSoAlbNjb4rejKBWjWoyyPPym9of75cFsWdGIMUc271Ou+77PX0kOk5NZvfS Tt75TpdpTeQmPrUFs+930KJUpBw51E3KipTHuBIN1oQaQVsb7c5oMPduxgJioB3R aQDVAznfAXgZc9bVSAbnr3guMR4ACGG5DvJ7B0rbZJ15vV8m57TaKr9E+W0CAwEA AaNnMGUwHwYDVR0jBBgwFoAUwdR8D/qF5tci8LxHrE16vZ5CWIgwCQYDVR0TBAIw ADATBgNVHSUEDDAKBggrBgEFBQcDAjAiBgNVHREEGzAZghd0ZXN0LXZwbi1jbGll bnQtZXhhbXBsZTANBgkqhkiG9w0BAQsFAAOCAQEAB+hGAQ9N/y/0UcNpoRKyD3vY pugUgLWQl/CxKf6moBWmB4mQfd+fwJXqSs1FOaouTASLdvjqNUVRGiXqr/V5pola k9GqgoblGX663wyOR8U7l6x/WjyplDBRjs3II/73xvt+lteJRVk4nP88TLVroagF w7tDax/r4gU6whJ8Vl8kTlkIvCa8lpiqzHpWnckeyHPZ4cZhDH/t52nk337eMefQ 3JhH98hfYX7CIn0lWwjo2O1WvNd5Tl6VJJLSD0uW6xJ6eZxEljsX+Qe+UI1Nlasy dF2u2ovM4c7R5Whpeupm7ein0ckCzqpb2zFFfqyQ3o9ON8Y2Hm0lh6SYL5zWOw== -----END CERTIFICATE----- Bag Attributes: <No Attributes> subject=CN = test-vpn issuer=CN = test-vpn -----BEGIN CERTIFICATE----- MIIDBzCCAe+gAwIBAgIUD2iEL19qt4RTcAcf25n0Br/9KLAwDQYJKoZIhvcNAQEL BQAwEzERMA8GA1UEAwwIdGVzdC12cG4wHhcNMjAwOTE5MTcxNTM0WhcNMzAwOTE3 MTcxNTM0WjATMREwDwYDVQQDDAh0ZXN0LXZwbjCCASIwDQYJKoZIhvcNAQEBBQAD ggEPADCCAQoCggEBALBhKLJViXoR0jMMUqi8vV1ral+6OPjgINPqkWy9IfLTcIAy cC3gvHlpNUqqQS03D+uKvjyYKy9UsD9otg1ebfEPeB+9xEWe0gMqIOMFgonWsvHL ok1dYQ6kbTSzbn8QRIx8dIT+ioLtN6rJiFSHoyJbY96t84atgBkykW6UURQlwcPf /cDR5rEiNqxcu5jwdJhBlm7H+Haa16G7SBEeaVTJLEaxMrDAGaYznwxx9UG3Tlce fkIz1YnbGGcc6FR7ULQUv3gXw+8Rtj+nV5/4Fof/FwY8xtfWRcIK7JnYNVP3pYXQ s67KlKK5QNY1Huug7E7mDk1bb5SvSLPRBl5bxC8CAwEAAaNTMFEwHQYDVR0OBBYE FMHUfA/6hebXIvC8R6xNer2eQliIMB8GA1UdIwQYMBaAFMHUfA/6hebXIvC8R6xN er2eQliIMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAH9yI35c ZfA0A3n2C66kbQZ3ue/Fk0wa7XBFp+BCM7e4ftWVe9AihclJiiZf1rmQGipU99gt T1aTn5ORT8GFPg1wm1oAhHsTO0fTAA8rAd+cy2Gawc207fQkvF9m0dCNV+6rR7i1 1m++DbEHngD1oaKybvn2uFlaE2Siw26l7sOPiM5b6g97Owhv3Rf+ANSnbWZ4MICV DBvGf7OCWswNOXS2TAzar/w6ecyrBiIquGiXJ08QtC9DwClR+nyikgrmb6fXIoJq sOR3ybjvbld19gvpYHlZoB4r4R2U1D81fyQ1qFeFu5gzhaKXgdjG6ZkmUq/9gg9W ZIzPrOFBRlJF5Ws= -----END CERTIFICATE-----","title":"Draft aro verify test"},{"location":"draft-aro-verify-test/#azure-red-hat-openshift-for-ibm-product-master-draft","text":"Sun 20 Sep 2020 11:24:22 PM EDT","title":"Azure Red Hat OpenShift for IBM Product Master [DRAFT]"},{"location":"draft-aro-verify-test/#introduction","text":"This document details the steps required to build Azure Red Hat OpenShift for IBM Product Master.","title":"Introduction"},{"location":"draft-aro-verify-test/#azure-red-hat-openshift-aro","text":"Azure Red Hat OpenShift is a fully managed offering of Red Hat OpenShift running in Microsoft Azure. This service is jointly managed and supported by both Microsoft and Red Hat. To provide support, certain limitations apply. For more details, see the Azure Red Hat OpenShift Service documentation.","title":"Azure Red Hat OpenShift (ARO)"},{"location":"draft-aro-verify-test/#microsoft-azure","text":"Microsoft Azure is a comprehensive cloud computing service managed by Microsoft. It provides software as a service (SaaS), platform as a service (PaaS), and infrastructure as a service (IaaS).","title":"Microsoft Azure"},{"location":"draft-aro-verify-test/#red-hat-openshift-container-platform-ocp","text":"Red Hat's OpenShift Container Platform is a hybrid cloud, enterprise Kubernetes application platform. It is a platform as a service (Paas) built on Red Hat Enterprise Linux (RHEL), with Docker containers managed by Kubernetes.","title":"Red Hat OpenShift Container Platform (OCP)"},{"location":"draft-aro-verify-test/#ibm-product-master-ipm","text":"IBM Product Master provides trusted product information management (PIM) and collaborative master data management (MDM) capabilities. It creates an accurate and up-to-date repository of product and service information that can be used throughout organizations for strategic business initiatives References: https://azure.microsoft.com/ https://www.openshift.com/ https://www.docker.com/ https://kubernetes.io/ https://docs.microsoft.com/en-us/azure/openshift/openshift-faq https://docs.microsoft.com/en-us/azure/openshift/support-lifecycle https://www.ibm.com/products/product-master","title":"IBM Product Master (IPM)"},{"location":"draft-aro-verify-test/#step-1-setup-azure-tenant","text":"A tenant is Microsoft's representation of an organization. It's a dedicated instance of Azure Active Directory (AAD) that an organization or app developer receives when create a relationship with Microsoft, like signing up for Azure, Microsoft Intune, or Microsoft 365. Before you can install Azure Red Hat OpenShift (ARO), Microsoft accounts must exist and have appropriate access to an AAD Tenant with an AAD Premium P1 License or better. A Global Administrator must be involved in the project. If you are the Global Administrator of an existing tenant, go to step 2. References: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-get-started-premium https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant","title":"Step 1 - Setup Azure Tenant"},{"location":"draft-aro-verify-test/#step-11-create-a-new-microsoft-account","text":"A Microsoft account represents a billing relationship. The account consists of a user identity, one or more subscriptions, and an associated set of resources. The person who creates the account is the administrators for all subscriptions created in that account. That person is also the default Service Administrator for the subscription(s) and, for Microsoft 365, possesses the Global Administrator role. The purpose of this step is to create a new Microsoft 365 (onmicrosoft.com) account, to establish a Global Administrator relationship for use with all Microsoft 365 services, including Azure. An Azure Active Directory Premium P1 license is required for Azure Red Hat OpenShift (ARO). Please note that this step does not mandate a purchase of a Microsoft 365 Business Premium license . This is simply one way to create a new tenant and become a Global Administrator. A license may be purchased now, or afterwards. Go to the Microsoft 365 for Business store. https://www.microsoft.com/en-us/microsoft-365/business/compare-all-microsoft-365-business-products Proceed to purchase at least one (1) Microsoft 365 Business Premium license. This will also include an Azure Active Directory (AAD) Premium P1 license, which is needed for Azure Red Hat OpenShift (ARO). The Microsoft 365 Business Premium provides an AAD P1 license, and other 365 services. If you do not wish to have all the 365 services, then a dedicated AAD Premium P1 (or better) may be purchased by a Billing or Global Administrator who has access to an existing tenant.","title":"Step 1.1 - Create a new Microsoft Account"},{"location":"draft-aro-verify-test/#step-12-create-the-first-global-administrator","text":"The person who signed up for Microsoft online services automatically becomes the first Global Administrator. Only global administrators can: Reset passwords for all users Add and manage domains References: https://docs.microsoft.com/en-us/microsoft-365/admin/add-users/about-admin-roles?view=o365-worldwide","title":"Step 1.2 - Create the first Global Administrator"},{"location":"draft-aro-verify-test/#step-13-verify-microsoft-365-admin-center-access","text":"The Microsoft 365 admin center is built for IT teams as a simplified way to manage your Microsoft 365 services. The admin center provides a tailored experience based on the unique needs of your role or organization, improves efficiency for everyday tasks, and provides actionable insights that help you make data-driven decisions to deliver a better experience for your users. The Microsoft 365 admin center is the common entry point for all Microsoft 365 admins and can be accessed at https://admin.microsoft.com/ References: https://docs.microsoft.com/en-us/microsoft-365/admin/admin-overview/about-the-admin-center?view=o365-worldwide","title":"Step 1.3 - Verify Microsoft 365 Admin Center Access"},{"location":"draft-aro-verify-test/#step-14-verify-azure-active-directory-license","text":"To verify the license, go to the Azure Active Directory Overview: https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview References: https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis","title":"Step 1.4 - Verify Azure Active Directory License"},{"location":"draft-aro-verify-test/#step-2-setup-azure-subscription","text":"An Azure subscription is a trust relationship with Azure Active Directory. A subscription trusts AAD to authenticate users, services, and devices. Azure subscriptions help organize access to Azure resources. They also help control how resource usage is reported, billed, and paid for. Each subscription can have a different billing and payment method. Every Azure service belongs to a subscription, and the subscription ID is required for these procedures. There are multiple choices when configuring Azure subscriptions. A tenant may have multiple Azure subscriptions that are paid via different payment methods. That is out of scope for this document. Here we will focus on a single tenant with a single subscription. A Global Administrator should do the following steps, become the Subscription Owner, and then assign the appropriate subscription roles to the OpenShift Administrators and Service Principals.","title":"Step 2 - Setup Azure Subscription"},{"location":"draft-aro-verify-test/#step-21-purchase-new-azure-subscription","text":"The Microsoft account that purchases the Azure subscription will be the Subscription owner. References: https://azure.microsoft.com/","title":"Step 2.1 - Purchase New Azure Subscription"},{"location":"draft-aro-verify-test/#step-3-setup-operating-system-required-tools","text":"The remaining procedures in this document depend on the following operating system and tools. Linux or Windows Subsystem for Linux CentOS 7+, Debian 9+, Fedora 31+, RHEL 7+, or Ubuntu 18+ bash GNU awk (gawk) GNU coreutils (sort, etc) GNU grep Google Chrome or Firefox OpenSSL","title":"Step 3 - Setup Operating System &amp; Required Tools"},{"location":"draft-aro-verify-test/#step-31-verify-operating-system","text":"Commands: uname -a Example Output: # uname -a Linux jt 5.7.17-200.fc32.x86_64 #1 SMP Fri Aug 21 15:23:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux","title":"Step 3.1 - Verify Operating System"},{"location":"draft-aro-verify-test/#step-32-verify-bash","text":"Commands: bash --version Example Output: # bash --version GNU bash, version 5.0.17(1)-release (x86_64-redhat-linux-gnu) Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html> This is free software; you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law.","title":"Step 3.2 - Verify bash"},{"location":"draft-aro-verify-test/#step-33-verify-gnu-awk","text":"Commands: awk --version Example Output: # awk --version GNU Awk 5.0.1, API: 3.0 (GNU MPFR 4.0.2-p9, GNU MP 6.1.2) Copyright (C) 1989, 1991-2019 Free Software Foundation. This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program. If not, see http://www.gnu.org/licenses/.","title":"Step 3.3 - Verify GNU awk"},{"location":"draft-aro-verify-test/#step-34-verify-gnu-coreutils","text":"References: https://www.gnu.org/software/coreutils/ Command(s): base64 --version basename --version dirname --version sort --version head --version tail --version Example Output: # base64 --version base64 (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Simon Josefsson. # basename --version basename (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie. # dirname --version dirname (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. # sort --version sort (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. # head --version head (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by David MacKenzie and Jim Meyering. # tail --version tail (GNU coreutils) 8.32 Copyright (C) 2020 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Paul Rubin, David MacKenzie, Ian Lance Taylor, and Jim Meyering.","title":"Step 3.4 - Verify GNU coreutils"},{"location":"draft-aro-verify-test/#step-35-verify-gnu-grep","text":"Command(s): grep --version egrep --version Example Output: # grep --version grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>. # egrep --version grep (GNU grep) 3.3 Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and others; see <https://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS>.","title":"Step 3.5 - Verify GNU grep"},{"location":"draft-aro-verify-test/#step-36-verify-google-chrome-or-firefix","text":"Commands: firefox --version google-chrome --version Example Output: # firefox --version Mozilla Firefox 80.0 # google-chrome --version Google Chrome 85.0.4183.83","title":"Step 3.6 - Verify Google Chrome or Firefix"},{"location":"draft-aro-verify-test/#step-37-verify-openssl","text":"Commands: openssl version Example Output: # openssl version OpenSSL 1.1.1g FIPS 21 Apr 2020","title":"Step 3.7 - Verify OpenSSL"},{"location":"draft-aro-verify-test/#step-4-setup-required-aro-environment-variables","text":"There are many prerequisites for a successful installation of Azure Red Hat OpenShift. The necessary bash environment variables are required to execute the steps in this document. Before proceeding, please take your time ensuring the values are correct. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html","title":"Step 4 - Setup Required ARO Environment Variables"},{"location":"draft-aro-verify-test/#step-41-export-required-aro-environment-variables","text":"These bash environment variables are required must be exported. They are reused for multiple steps. These are example values that must be changed for your installation. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO='test' export ARO_APPLICATION_NAME='test-app' export ARO_CLUSTER_NAME='test-cluster' export ARO_DOMAIN_NAME='test.mitaei.net' export ARO_LOCATION_NAME='eastus' export ARO_REDHAT_PULL_SECRET_FILE='./secrets/test-redhat-pull-secret.txt' export ARO_RESOURCE_GROUP_NAME='test-eastus' export ARO_SERVICE_PRINCIPAL_NAME='http://test-app' export ARO_SERVICE_PRINCIPAL_PASSWORD='S3rv1c3Pr1cip4lP4ssw0rd!' export ARO_SUBNET_AGW_ADDRESS_PREFIX='10.11.4.0/25' export ARO_SUBNET_AGW_NAME='test-vnet-agw-subnet' export ARO_SUBNET_AGW_NSG_NAME='test-vnet-agw-subnet-nsg' export ARO_SUBNET_DB_ADDRESS_PREFIX='10.11.4.128/25' export ARO_SUBNET_DB_NAME='test-vnet-db-subnet' export ARO_SUBNET_DB_NSG_NAME='test-vnet-db-subnet-nsg' export ARO_SUBNET_DMZ_ADDRESS_PREFIX='10.11.5.0/25' export ARO_SUBNET_DMZ_NAME='test-vnet-dmz-subnet' export ARO_SUBNET_DMZ_NSG_NAME='test-vnet-dmz-subnet-nsg' export ARO_SUBNET_MASTER_ADDRESS_PREFIX='10.11.0.0/23' export ARO_SUBNET_MASTER_NAME='test-vnet-master-subnet' export ARO_SUBNET_MASTER_NSG_NAME='test-vnet-master-subnet-nsg' export ARO_SUBNET_TRUSTED_ADDRESS_PREFIX='10.11.5.128/25' export ARO_SUBNET_TRUSTED_NAME='test-vnet-trusted-subnet' export ARO_SUBNET_TRUSTED_NSG_NAME='test-vnet-trusted-subnet-nsg' export ARO_SUBNET_VGW_ADDRESS_PREFIX='10.11.6.0/25' export ARO_SUBNET_VGW_NAME='GatewaySubnet' export ARO_SUBNET_VGW_NSG_NAME='GatewaySubnet-nsg' export ARO_SUBNET_WORKER_ADDRESS_PREFIX='10.11.2.0/23' export ARO_SUBNET_WORKER_NAME='test-vnet-worker-subnet' export ARO_SUBNET_WORKER_NSG_NAME='test-vnet-worker-subnet-nsg' export ARO_SUBSCRIPTION_ID='12c7070f-83e5-453b-96d0-90770d2cf942' export ARO_SUBSCRIPTION_NAME='Azure subscription for mitaei' export ARO_TENANT_ID='25fe96e7-85ec-4e6a-b93f-779b16ff751d' export ARO_TENANT_NAME='mitaei.net' export ARO_VGW_NAME='test-vpn' export ARO_VGW_PKI_BITS='2048' export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_CRT_FILE='./pki/test-vpn-client-example.crt' export ARO_VGW_PKI_CLIENT_KEY_FILE='./pki/test-vpn-client-example.key' export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!example!' export ARO_VGW_PKI_CLIENT_NAME='test-vpn-client-example' export ARO_VGW_PKI_CLIENT_PFX_FILE='./pki/test-vpn-client-example.pfx' export ARO_VGW_PKI_CLIENT_REQ_FILE='./pki/test-vpn-client-example.req' export ARO_VGW_PKI_CLIENT_SERIAL_FILE='./pki/test-vpn-client-example.serial' export ARO_VGW_PKI_DIR='./pki' export ARO_VGW_PKI_ROOT_CA_SERIAL_FILE='./pki/test-vpn-root.serial' export ARO_VGW_PKI_ROOT_CRT_FILE='./pki/test-vpn-root.crt' export ARO_VGW_PKI_ROOT_CRT_FILE_NAME='test-vpn-root.crt' export ARO_VGW_PKI_ROOT_KEY_FILE='./pki/test-vpn-root.key' export ARO_VGW_PKI_ROOT_KEY_FILE_NAME='test-vpn-root.key' export ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VGW_POOL_ADDRESS_PREFIX='172.16.11.0/24' export ARO_VGW_PUBLIC_ADDRESS_NAME='test-vpn-public-ip' export ARO_VGW_REDUNDANCY='true' export ARO_VGW_SKU='VpnGw1AZ' export ARO_VGW_TYPE='RouteBased' export ARO_VM_JUMP_ADMIN_NAME='test-vm-jumpbox-admin' export ARO_VM_JUMP_IMAGE_MARKETPLACE='true' export ARO_VM_JUMP_IMAGE_URN='cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710' export ARO_VM_JUMP_NAME='test-vm-jumpbox' export ARO_VM_JUMP_PUBLIC_ADDRESS_NAME='test-vm-jumpbox-public-ip' export ARO_VM_JUMP_SIZE='Standard_B1ms' export ARO_VNET_ADDRESS_PREFIX='10.11.0.0/21' export ARO_VNET_NAME='test-vnet' export ARO_VPN_GATEWAY_NAME='test-vpn' export ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE='./pki/test-vpn.crt' export ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE_NAME='test-vpn.crt' export ARO_VPN_GATEWAY_PKI_KEY_FILE='./pki/test-vpn.key' export ARO_VPN_GATEWAY_PKI_KEY_FILE_PASSPHRASE='Pk1P4ssphr4s3!!' export ARO_VPN_GATEWAY_POOL_ADDRESS_PREFIX='172.16.11.0/24' export ARO_VPN_GATEWAY_PUBLIC_ADDRESS_NAME='test-vpn-public-ip' export ARO_VPN_GATEWAY_REDUNDANCY='true' export ARO_VPN_GATEWAY_SKU='VpnGw1AZ' export ARO_VPN_GATEWAY_TYPE='RouteBased' export ARO_ADMINISTRATORS=(joseph.tingiris@mitaei.net arun.babu@mitaei.net sivaprasad.k@mitaei.net) export ARO_SUBSCRIPTION_OWNERS=(joseph.tingiris@mitaei.net christy.walsh@mitaei.net arun.babu@mitaei.net sivaprasad.k@mitaei.net) export ARO_RESOURCE_PROVIDERS=(Microsoft.RedHatOpenShift Microsoft.Compute Microsoft.Storage) export ARO_VERIFY_QUOTA_NAMEs=() export ARO_VERIFY_QUOTA_NAMES+=('Standard Dv2 Family vCPUs') export ARO_VERIFY_QUOTA_NAMES+=('Standard DSv3 Family vCPUs')","title":"Step 4.1 - Export Required ARO Environment Variables"},{"location":"draft-aro-verify-test/#step-42-verify-required-aro-environment-variables","text":"Ensure the ARO bash environment variables are globally available. References: https://man7.org/linux/man-pages/man1/env.1.html Command(s): env | grep ^ARO | sort -V Example Output: ARO=test ARO_APPLICATION_NAME=test-app ARO_CLUSTER_NAME=test-cluster ARO_DOMAIN_NAME=test.mitaei.net ARO_LOCATION_NAME=eastus ARO_REDHAT_PULL_SECRET_FILE=./secrets/test-redhat-pull-secret.txt ARO_RESOURCE_GROUP_NAME=test-eastus ARO_SERVICE_PRINCIPAL_NAME=http://test-app ARO_SERVICE_PRINCIPAL_PASSWORD=S3rv1c3Pr1cip4lP4ssw0rd! ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=test-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=test-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=test-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=test-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=test-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=test-vnet-dmz-subnet-nsg ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=test-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=test-vnet-master-subnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=test-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=test-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=test-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=test-vnet-worker-subnet-nsg ARO_SUBSCRIPTION_ID=12c7070f-83e5-453b-96d0-90770d2cf942 ARO_SUBSCRIPTION_NAME=Azure subscription for mitaei ARO_TENANT_ID=25fe96e7-85ec-4e6a-b93f-779b16ff751d ARO_TENANT_NAME=mitaei.net ARO_VGW_NAME=test-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_CLIENT=example ARO_VGW_PKI_CLIENT_CRT_FILE=./pki/test-vpn-client-example.crt ARO_VGW_PKI_CLIENT_KEY_FILE=./pki/test-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_NAME=test-vpn-client-example ARO_VGW_PKI_CLIENT_PFX_FILE=./pki/test-vpn-client-example.pfx ARO_VGW_PKI_CLIENT_REQ_FILE=./pki/test-vpn-client-example.req ARO_VGW_PKI_CLIENT_SERIAL_FILE=./pki/test-vpn-client-example.serial ARO_VGW_PKI_DIR=./pki ARO_VGW_PKI_ROOT_CA_SERIAL_FILE=./pki/test-vpn-root.serial ARO_VGW_PKI_ROOT_CRT_FILE=./pki/test-vpn-root.crt ARO_VGW_PKI_ROOT_CRT_FILE_NAME=test-vpn-root.crt ARO_VGW_PKI_ROOT_KEY_FILE=./pki/test-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_NAME=test-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VGW_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VGW_PUBLIC_ADDRESS_NAME=test-vpn-public-ip ARO_VGW_REDUNDANCY=true ARO_VGW_SKU=VpnGw1AZ ARO_VGW_TYPE=RouteBased ARO_VM_JUMP_ADMIN_NAME=test-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=test-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=test-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=test-vnet ARO_VPN_GATEWAY_NAME=test-vpn ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE=./pki/test-vpn.crt ARO_VPN_GATEWAY_PKI_CERTIFICATE_FILE_NAME=test-vpn.crt ARO_VPN_GATEWAY_PKI_KEY_FILE=./pki/test-vpn.key ARO_VPN_GATEWAY_PKI_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!! ARO_VPN_GATEWAY_POOL_ADDRESS_PREFIX=172.16.11.0/24 ARO_VPN_GATEWAY_PUBLIC_ADDRESS_NAME=test-vpn-public-ip ARO_VPN_GATEWAY_REDUNDANCY=true ARO_VPN_GATEWAY_SKU=VpnGw1AZ ARO_VPN_GATEWAY_TYPE=RouteBased","title":"Step 4.2 - Verify Required ARO Environment Variables"},{"location":"draft-aro-verify-test/#step-5-obtain-pull-secrets","text":"Pull secrets are required when referencing images across OpenShift Container Platform projects or from secured registries.","title":"Step 5 - Obtain Pull Secrets"},{"location":"draft-aro-verify-test/#step-51-obtain-red-hat-pull-secret","text":"A Red Hat pull secret enables access to Red Hat container registries that contain additional OpenShift content. This step must be done manually. It is optional but recommended. Go to the Red Hat OpenShift cluster manager portal: https://cloud.redhat.com/openshift/install/azure/aro-provisioned","title":"Step 5.1 - Obtain Red Hat Pull Secret"},{"location":"draft-aro-verify-test/#step-52-verify-red-hat-pull-secret","text":"Commands: ls -ld \"${ARO_REDHAT_PULL_SECRET_FILE}\" Example Output: -rw-rw----+ 1 jtingiris mit 2835 Sep 17 09:13 ./secrets/test-redhat-pull-secret.txt","title":"Step 5.2 - Verify Red Hat Pull Secret"},{"location":"draft-aro-verify-test/#step-6-setup-azure-cli","text":"The Azure command-line interface (Azure CLI) is a set of commands used to create and manage Azure resources. The Azure CLI is available across Azure services and is designed to get you working quickly with Azure, with an emphasis on automation. References: https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli?view=azure-cli-latest","title":"Step 6 - Setup Azure CLI"},{"location":"draft-aro-verify-test/#step-61-install-azure-cli","text":"The Azure CLI is available to install in Windows, macOS and Linux environments. It can also be run in a Docker container and Azure Cloud Shell. To install, please follow the link in the References section. References: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Commands: az --version Example Output: # az --version azure-cli 2.11.1 core 2.11.1 telemetry 1.0.5 * Extensions: resource-graph 1.1.0 aro 1.0.0 Python location '/usr/bin/python3' Extensions directory '/home/jtingiris/.azure/cliextensions' Python (Linux) 3.8.5 (default, Aug 12 2020, 00:00:00) [GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] Legal docs and information: aka.ms/AzureCliLegal Please let us know how we are doing: https://aka.ms/azureclihats and let us know if you're interested in trying out our newest features: https://aka.ms/CLIUXstudy","title":"Step 6.1 - Install Azure CLI"},{"location":"draft-aro-verify-test/#step-62-show-default-subscription","text":"References: https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_list Commands: az account list --query '[?isDefault == `true`]' Example Output: # az account list --query '[?isDefault == `true`]' [ { \"cloudName\": \"AzureCloud\", \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\", \"isDefault\": true, \"managedByTenants\": [], \"name\": \"Azure subscription for mitaei\", \"state\": \"Enabled\", \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\", \"user\": { \"name\": \"joseph.tingiris@mitaei.net\", \"type\": \"user\" } } ]","title":"Step 6.2 - Show Default Subscription"},{"location":"draft-aro-verify-test/#step-63-login-as-the-subscription-owner","text":"The Azure Subscription Owner must perform the following steps. References: https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest Commands: az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv Example Output: joseph.tingiris@mitaei.net","title":"Step 6.3 - Login as the Subscription Owner"},{"location":"draft-aro-verify-test/#step-7-setup-additional-subscription-owners","text":"This step is optional, but recommended. There should be at least two (2) Subscription Owners. References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_create","title":"Step 7 - Setup Additional Subscription Owners"},{"location":"draft-aro-verify-test/#step-71-verify-subscription-owners","text":"References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Command(s): az role assignment list --role Owner --output table Example Output: # az role assignment list --role Owner --output table Principal Role Scope -------------------------- ------ --------------------------------------------------- sivaprasad.k@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 christy.walsh@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"Step 7.1 - Verify Subscription Owners"},{"location":"draft-aro-verify-test/#step-8-verify-azure-tenant","text":"Go to the Microsoft admin center and login with a Microsoft account that is the Global administrator. https://admin.microsoft.com/ A Global Administrator will have access to all portions of the admin center. Commands: az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' Example Output: # az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ]","title":"Step 8 - Verify Azure Tenant"},{"location":"draft-aro-verify-test/#step-9-verify-azure-subscription","text":"The Azure Subscription can also be verified by going to: https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade","title":"Step 9 - Verify Azure Subscription"},{"location":"draft-aro-verify-test/#step-91-verify-subscription-names","text":"References: https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az-account-list Commands: az account list --output table Example Output: # az account list --output table Name CloudName SubscriptionId State IsDefault ----------------------------- ----------- ------------------------------------ ------- ----------- N/A(tenant level account) AzureCloud fe47e621-b8dd-44c8-ba00-c07e41e4b3d1 Enabled False N/A(tenant level account) AzureCloud 300a380f-b8d0-46c1-be0e-3b8e1af971b6 Enabled False AP_BASE AzureCloud 54f592d8-63d3-48f3-9f92-a15651f96255 Enabled False Azure subscription for mitaei AzureCloud 12c7070f-83e5-453b-96d0-90770d2cf942 Enabled True # az account show --subscription \"12c7070f-83e5-453b-96d0-90770d2cf942\" --query \"[{subscription_name:name},{subscription_id:id}]\" [ { \"subscription_name\": \"Azure subscription for mitaei\" }, { \"subscription_id\": \"12c7070f-83e5-453b-96d0-90770d2cf942\" } ]","title":"Step 9.1 - Verify Subscription Names"},{"location":"draft-aro-verify-test/#step-92-verify-subscription-location","text":"Azure Red Hat OpenShift is only available in certain Microsoft geographies, or locations. Please use the links in the references of this section to determine the most suitable regions for the installation. The region name will be used throughout this document. References: https://azure.microsoft.com/en-us/global-infrastructure/services/?products=openshift Commands: az account list-locations --query \\\"[?name=='${ARO_LOCATION_NAME}']\\\" --output table Example Output: # az account list-locations --query \"[?name=='eastus']\" --output table Name DisplayName RegionalDisplayName ------ ------------- --------------------- eastus East US (US) East US","title":"Step 9.2 - Verify Subscription Location"},{"location":"draft-aro-verify-test/#step-93-verify-subscription-limits","text":"The Azure Red Hat OpenShift (ARO) cluster uses several Microsoft Azure components, and the default Azure subscription and service limits, quotas, and constraints affect the ability to install ARO clusters. A default ARO cluster requires a minimum of 40 Total Regional vCPUs and 36 Standard DSv3 Family vCPUs. Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores. If an existing Azure Subscription is used then check the limits for the subscription type and if necessary, increase quota limits before the installation of an Azure OpenShift cluster. References: https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-name-rules https://docs.microsoft.com/en-us/azure/networking/check-usage-against-limits https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-list-usage https://docs.openshift.com/container-platform/4.5/installing/installing_azure/installing-azure-account.html ARO minimum limits are required for: Standard Dv2 Family vCPUs Standard DSv3 Family vCPUs","title":"Step 9.3 - Verify Subscription Limits"},{"location":"draft-aro-verify-test/#step-94-verify-subscription-quotas","text":"Requesting a quota increase can take 24-48 hours to complete. The Subscription Owner should do this step. Ensure the quota increase requests a minimum of 50 for the following VM families, 100 is preferred. Dv2 Series DSv3 Series An increase in the VM series quotas automatically increases the total regional vCPU limit by the same amount. Please use the links in the references of this section for Microsoft's directions on how to request a quota increase for a specific subscription. A support case will be opened, and Microsoft will communicate directly to the person who requested the increase. References: https://docs.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests https://docs.microsoft.com/en-us/azure/azure-portal/supportability/regional-quota-requests Verify subscription quotas for: Standard Dv2 Family vCPUs Standard DSv3 Family vCPUs","title":"Step 9.4 - Verify Subscription Quotas"},{"location":"draft-aro-verify-test/#step-95-verify-subscription-quota-for-standard-dv2-family-vcpus","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_list_usage Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" Example Output: # az vm list-usage --location eastus --query \"[?localName=='Standard Dv2 Family vCPUs']\" [ { \"currentValue\": \"0\", \"limit\": \"100\", \"localName\": \"Standard Dv2 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard Dv2 Family vCPUs\", \"value\": \"standardDv2Family\" } } ]","title":"Step 9.5 - Verify Subscription Quota for Standard Dv2 Family vCPUs"},{"location":"draft-aro-verify-test/#step-96-verify-subscription-quota-for-standard-dsv3-family-vcpus","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_list_usage Command(s): az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" Example Output: # az vm list-usage --location eastus --query \"[?localName=='Standard DSv3 Family vCPUs']\" [ { \"currentValue\": \"36\", \"limit\": \"100\", \"localName\": \"Standard DSv3 Family vCPUs\", \"name\": { \"localizedValue\": \"Standard DSv3 Family vCPUs\", \"value\": \"standardDSv3Family\" } } ]","title":"Step 9.6 - Verify Subscription Quota for Standard DSv3 Family vCPUs"},{"location":"draft-aro-verify-test/#step-10-setup-openshift-administrators","text":"Identify the people who will be responsible for administering the OpenShift cluster. These individuals will need Microsoft accounts and elevated roles and responsibilities.","title":"Step 10 - Setup OpenShift Administrators"},{"location":"draft-aro-verify-test/#step-101-verify-openshift-administrator-accounts","text":"Ensure the OpenShift Administrator accounts exist and have the appropriate subscription roles. References: https://docs.microsoft.com/en-us/cli/azure/ad/user?view=azure-cli-latest#az_ad_user_show Commands: for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query userPrincipalName --output tsv; done Example Output: # az ad user show --id joseph.tingiris@mitaei.net --query userPrincipalName --output tsv joseph.tingiris@mitaei.net # az ad user show --id arun.babu@mitaei.net --query userPrincipalName --output tsv arun.babu@mitaei.net # az ad user show --id sivaprasad.k@mitaei.net --query userPrincipalName --output tsv sivaprasad.k@mitaei.net","title":"Step 10.1 - Verify OpenShift Administrator Accounts"},{"location":"draft-aro-verify-test/#step-102-verify-openshift-administrator-subscription-roles","text":"References: https://docs.microsoft.com/en-us/cli/azure/role/assignment?view=azure-cli-latest#az_role_assignment_list Commands: for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; echo; done Example Output: # az role assignment list --assignee joseph.tingiris@mitaei.net --output table Principal Role Scope -------------------------- ------------------------- --------------------------------------------------- joseph.tingiris@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 joseph.tingiris@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 # az role assignment list --assignee arun.babu@mitaei.net --output table Principal Role Scope -------------------- ------------------------- --------------------------------------------------- arun.babu@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 arun.babu@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 # az role assignment list --assignee sivaprasad.k@mitaei.net --output table Principal Role Scope ----------------------- ------------------------- --------------------------------------------------- sivaprasad.k@mitaei.net User Access Administrator /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Owner /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942 sivaprasad.k@mitaei.net Contributor /subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942","title":"Step 10.2 - Verify OpenShift Administrator Subscription Roles"},{"location":"draft-aro-verify-test/#step-11-setup-azure-resource-providers","text":"Make sure you are logged in to Azure via az (az login) with a Contributor or Owner role. This step will fail for OpenShift Admins with only the User Access Administrator. They will receive a message saying they do not have authorization.","title":"Step 11 - Setup Azure Resource Providers"},{"location":"draft-aro-verify-test/#step-111-verify-provider-microsoftredhatopenshift","text":"References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.RedHatOpenShift --output table Example Output: # az provider show --namespace Microsoft.RedHatOpenShift --output table Namespace RegistrationPolicy RegistrationState ------------------------- -------------------- ------------------- Microsoft.RedHatOpenShift RegistrationRequired Registered","title":"Step 11.1 - Verify Provider Microsoft.RedHatOpenShift"},{"location":"draft-aro-verify-test/#step-112-verify-provider-microsoftcompute","text":"References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.Compute --output table Example Output: # az provider show --namespace Microsoft.Compute --output table Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Compute RegistrationRequired Registered","title":"Step 11.2 - Verify Provider Microsoft.Compute"},{"location":"draft-aro-verify-test/#step-113-verify-provider-microsoftstorage","text":"References: https://docs.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az_provider_show Commands: az provider show -n Microsoft.Storage --output table Example Output: # az provider show --namespace Microsoft.Storage --output table Namespace RegistrationPolicy RegistrationState ----------------- -------------------- ------------------- Microsoft.Storage RegistrationRequired Registered","title":"Step 11.3 - Verify Provider Microsoft.Storage"},{"location":"draft-aro-verify-test/#step-12-setup-resource-group","text":"An Azure resource group is a logical group in which Azure resources are deployed and managed. A resource group location must be specified. This location is where resource group metadata is stored, it is also where the Azure resources are hosted. References: https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Commands: az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output:","title":"Step 12 - Setup Resource Group"},{"location":"draft-aro-verify-test/#step-121-verify-resource-group","text":"References: https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Commands: az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: # az group show --name test-eastus { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"test-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"Step 12.1 - Verify Resource Group"},{"location":"draft-aro-verify-test/#step-13-setup-virtual-network","text":"An Azure Virtual Network (VNet) is the fundamental building block for private networks in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. VNet is similar to a traditional network that you'd operate in your own data center, but brings with it additional benefits of Azure's infrastructure such as scale, availability, and isolation. References: https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview Commands: env | grep ^ARO_VNET | sort Example Output: ARO_VNET_ADDRESS_PREFIX=10.11.0.0/21 ARO_VNET_NAME=test-vnet","title":"Step 13 - Setup Virtual Network"},{"location":"draft-aro-verify-test/#step-131-verify-virtual-network","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet?view=azure-cli-latest#az-network-vnet-show Commands: az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} Example Output: # az network vnet show --resource-group test-eastus --name test-vnet --output table EnableDdosProtection EnableVmProtection Location Name ProvisioningState ResourceGroup ResourceGuid ---------------------- -------------------- ---------- --------- ------------------- --------------- ------------------------------------ False False eastus test-vnet Succeeded test-eastus 07635501-237e-4c71-89b0-573ccc270697","title":"Step 13.1 - Verify Virtual Network"},{"location":"draft-aro-verify-test/#step-14-setup-azure-red-hat-openshift-subnets","text":"Azure Red Hat OpenShift clusters require a virtual network with two empty subnets, for the master and worker nodes. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. Additional subnets are needed for related virtual machines and a VPN. The VPN subnet must be named GatewaySubnet. It is suggested the virtual network (vnet) prefix be /21 and each (master and worker) vnet subnet prefix be /23, which will allow for a total of 510 master nodes and 510 worker nodes. The additional subnets within the /21 prefix will be used for a VPN Gateway subnet and future growth. NOTE: In 2018, Microsoft started automatically enabling Network Watcher when a new vnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher ; Please see the references in this section for more details._ References: https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Commands: env | grep ^ARO_SUBNET | egrep -e 'MASTER|WORKER' | sort Example Output: ARO_SUBNET_MASTER_ADDRESS_PREFIX=10.11.0.0/23 ARO_SUBNET_MASTER_NAME=test-vnet-master-subnet ARO_SUBNET_MASTER_NSG_NAME=test-vnet-master-subnet-nsg ARO_SUBNET_WORKER_ADDRESS_PREFIX=10.11.2.0/23 ARO_SUBNET_WORKER_NAME=test-vnet-worker-subnet ARO_SUBNET_WORKER_NSG_NAME=test-vnet-worker-subnet-nsg","title":"Step 14 - Setup Azure Red Hat OpenShift Subnets"},{"location":"draft-aro-verify-test/#step-141-verify-master-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_MASTER_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-master-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.0.0/23 test-vnet-master-subnet Enabled Disabled Succeeded test-eastus","title":"Step 14.1 - Verify Master Subnet"},{"location":"draft-aro-verify-test/#step-142-verify-worker-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_WORKER_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-worker-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ----------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.2.0/23 test-vnet-worker-subnet Enabled Enabled Succeeded test-eastus","title":"Step 14.2 - Verify Worker Subnet"},{"location":"draft-aro-verify-test/#step-15-setup-additional-network-security-groups","text":"Azure Network Security Groups filter network traffic to and from Azure resources in an Azure virtual network. A Network Security Group contains security rules that allow/deny network traffic to/from several types of Azure resources. NOTE: The Network Security Groups for the Master & Worker subnets will be automatically created when ARO is setup. The Network Security Group for the GatewaySubnet will be created when the VPN Gateway is setup. References: https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview Commands: env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|GATEWAY' | sort Example Output: ARO_SUBNET_AGW_NSG_NAME=test-vnet-agw-subnet-nsg ARO_SUBNET_DB_NSG_NAME=test-vnet-db-subnet-nsg ARO_SUBNET_DMZ_NSG_NAME=test-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_NSG_NAME=test-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg","title":"Step 15 - Setup Additional Network Security Groups"},{"location":"draft-aro-verify-test/#step-151-verify-network-security-groups","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest#az_network_nsg_show Commands: az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_AGW_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DB_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_DMZ_NSG_NAME} --output table az network nsg show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_SUBNET_TRUSTED_NSG_NAME} --output table Example Output: # az network nsg show --resource-group test-eastus --name test-vnet-agw-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ------------------------ ------------------- --------------- ------------------------------------ eastus test-vnet-agw-subnet-nsg Succeeded test-eastus 2099686c-df3e-4bea-b6bd-48b252b62e87 # az network nsg show --resource-group test-eastus --name test-vnet-db-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ----------------------- ------------------- --------------- ------------------------------------ eastus test-vnet-db-subnet-nsg Succeeded test-eastus d31cbe87-00fc-4734-9d00-bfc78ef76a49 # az network nsg show --resource-group test-eastus --name test-vnet-dmz-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ------------------------ ------------------- --------------- ------------------------------------ eastus test-vnet-dmz-subnet-nsg Succeeded test-eastus 42853b6a-9f5e-44ac-a400-a926857ce16d # az network nsg show --resource-group test-eastus --name test-vnet-trusted-subnet-nsg --output table Location Name ProvisioningState ResourceGroup ResourceGuid ---------- ---------------------------- ------------------- --------------- ------------------------------------ eastus test-vnet-trusted-subnet-nsg Succeeded test-eastus 2596272f-0cba-4279-b4a3-81bbc9d0279a","title":"Step 15.1 - Verify Network Security Groups"},{"location":"draft-aro-verify-test/#step-16-setup-additional-network-security-group-rules","text":"Network security group security rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows a network security group to be stateful. References: https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview","title":"Step 16 - Setup Additional Network Security Group Rules"},{"location":"draft-aro-verify-test/#step-161-verify-dmz-network-security-group-rules","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az_network_nsg_rule_show # az network nsg show --resource-group test-eastus --name test-vnet-dmz-subnet-nsg --query securityRules --output table Protocol SourcePortRange DestinationPortRange SourceAddressPrefix DestinationAddressPrefix Access Priority Direction ProvisioningState Name ResourceGroup ---------- ----------------- ---------------------- --------------------- -------------------------- -------- ---------- ----------- ------------------- -------- --------------- Tcp * 22 * * Allow 1000 Inbound Succeeded AllowSSH test-eastus","title":"Step 16.1 - Verify DMZ Network Security Group Rules"},{"location":"draft-aro-verify-test/#step-17-setup-additional-subnets","text":"Azure Red Hat OpenShift clusters require a virtual network with two empty subnets, for the master and worker nodes. The networks must be in the same resource group. The network numbers should be IPv4 RFC1918 compliant and prefixed. It is suggested the virtual network (vnet) prefix be /21 and each (master and worker) vnet subnet prefix be /23, which will allow for a total of 510 master nodes and 510 worker nodes. NOTE: In 2018, Microsoft started automatically enabling Network Watcher when a new subnet is created. There is not strictly required for ARO and there is an additional cost associated. This will be seen as a new resource group named NetworkWatcherRG and a new vnet named NetworkWatercher ; Please see the references in this section for more details._ References: https://docs.microsoft.com/en-us/azure/openshift/howto-create-private-cluster-4x https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview https://azure.microsoft.com/en-us/updates/azure-network-watcher-will-be-enabled-by-default-for-subscriptions-containing-virtual-networks/ https://azure.microsoft.com/en-us/pricing/details/network-watcher/ https://tools.ietf.org/html/rfc1918 Commands: env | egrep -e 'ARO_SUBNET(.*)NSG' | egrep -ve 'MASTER|WORKER|GATEWAY' | sort Example Output: ARO_SUBNET_AGW_ADDRESS_PREFIX=10.11.4.0/25 ARO_SUBNET_AGW_NAME=test-vnet-agw-subnet ARO_SUBNET_AGW_NSG_NAME=test-vnet-agw-subnet-nsg ARO_SUBNET_DB_ADDRESS_PREFIX=10.11.4.128/25 ARO_SUBNET_DB_NAME=test-vnet-db-subnet ARO_SUBNET_DB_NSG_NAME=test-vnet-db-subnet-nsg ARO_SUBNET_DMZ_ADDRESS_PREFIX=10.11.5.0/25 ARO_SUBNET_DMZ_NAME=test-vnet-dmz-subnet ARO_SUBNET_DMZ_NSG_NAME=test-vnet-dmz-subnet-nsg ARO_SUBNET_TRUSTED_ADDRESS_PREFIX=10.11.5.128/25 ARO_SUBNET_TRUSTED_NAME=test-vnet-trusted-subnet ARO_SUBNET_TRUSTED_NSG_NAME=test-vnet-trusted-subnet-nsg ARO_SUBNET_VGW_ADDRESS_PREFIX=10.11.6.0/25 ARO_SUBNET_VGW_NAME=GatewaySubnet ARO_SUBNET_VGW_NSG_NAME=GatewaySubnet-nsg","title":"Step 17 - Setup Additional Subnets"},{"location":"draft-aro-verify-test/#step-171-verify-application-gateway-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_AGW_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-agw-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- -------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.4.0/25 test-vnet-agw-subnet Enabled Enabled Succeeded test-eastus","title":"Step 17.1 - Verify Application Gateway Subnet"},{"location":"draft-aro-verify-test/#step-172-verify-database-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DB_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-db-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.4.128/25 test-vnet-db-subnet Enabled Enabled Succeeded test-eastus","title":"Step 17.2 - Verify Database Subnet"},{"location":"draft-aro-verify-test/#step-173-verify-dmz-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_DMZ_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-dmz-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- -------------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.5.0/25 test-vnet-dmz-subnet Enabled Enabled Succeeded test-eastus","title":"Step 17.3 - Verify DMZ Subnet"},{"location":"draft-aro-verify-test/#step-174-verify-trusted-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Commands: az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_TRUSTED_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name test-vnet-trusted-subnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------------------ -------------------------------- ----------------------------------- ------------------- --------------- 10.11.5.128/25 test-vnet-trusted-subnet Enabled Enabled Succeeded test-eastus","title":"Step 17.4 - Verify Trusted Subnet"},{"location":"draft-aro-verify-test/#step-18-setup-jump-server-virtual-machine","text":"A jump server, jump host or jump box is a system on a network used to access and manage devices in a separate security zone. A jump server is a hardened and monitored device that spans two dissimilar security zones and provides a controlled means of access between them. The most common example is managing a host in a DMZ from trusted networks or computers. All hosts within the DMZ may be prevented from connecting to the internal network by the Network Security Group (firewall) that separates them, unless the Network Security Group (firewall) permits the connection. In the following steps, the jump server (jumpbox) will be put on the DMZ subnet, with tcp port 22 opened from the Internet, and it will be allowed to communicate with the other internal subnets. References: https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-cli-complete https://en.wikipedia.org/wiki/Jump_server https://en.wikipedia.org/wiki/DMZ_(computing) Commands: env | grep JUMP | sort Example Output: ARO_VM_JUMP_ADMIN_NAME=test-vm-jumpbox-admin ARO_VM_JUMP_IMAGE_MARKETPLACE=true ARO_VM_JUMP_IMAGE_URN=cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 ARO_VM_JUMP_NAME=test-vm-jumpbox ARO_VM_JUMP_PUBLIC_ADDRESS_NAME=test-vm-jumpbox-public-ip ARO_VM_JUMP_SIZE=Standard_B1ms","title":"Step 18 - Setup Jump Server Virtual Machine"},{"location":"draft-aro-verify-test/#step-181-verify-jump-server-public-ip-address","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Commands: az network public-ip show --name ${ARO_VM_JUMP_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} Example Output: # az network public-ip show --name test-vm-jumpbox-public-ip --resource-group test-eastus { \"ddosSettings\": null, \"dnsSettings\": null, \"etag\": \"W/\\\"897a5a29-3d93-419c-a2ef-707fd11614fe\\\"\", \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Network/publicIPAddresses/test-vm-jumpbox-public-ip\", \"idleTimeoutInMinutes\": 4, \"ipAddress\": \"40.71.92.76\", \"ipConfiguration\": { \"etag\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Network/networkInterfaces/test-vm-jumpbox-nic/ipConfigurations/ipconfig1\", \"name\": null, \"privateIpAddress\": null, \"privateIpAllocationMethod\": null, \"provisioningState\": null, \"publicIpAddress\": null, \"resourceGroup\": \"test-eastus\", \"subnet\": null }, \"ipTags\": [], \"location\": \"eastus\", \"name\": \"test-vm-jumpbox-public-ip\", \"provisioningState\": \"Succeeded\", \"publicIpAddressVersion\": \"IPv4\", \"publicIpAllocationMethod\": \"Dynamic\", \"publicIpPrefix\": null, \"resourceGroup\": \"test-eastus\", \"resourceGuid\": \"e8355a50-19c1-47b0-bfbb-a719f6e0ee51\", \"sku\": { \"name\": \"Basic\" }, \"tags\": null, \"type\": \"Microsoft.Network/publicIPAddresses\", \"zones\": null }","title":"Step 18.1 - Verify Jump Server Public IP Address"},{"location":"draft-aro-verify-test/#step-182-verify-jump-server-virtual-nic","text":"A network interface enables an Azure Virtual Machine to communicate with internet, Azure, and on-premises resources. References: https://docs.microsoft.com/en-us/cli/azure/network/nic?view=azure-cli-latest#az_network_nic_show https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface Commands: az network nic show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-nic --output table Example Output: # az network nic show --resource-group test-eastus --name test-vm-jumpbox-nic --output table EnableAcceleratedNetworking EnableIpForwarding Location MacAddress Name Primary ProvisioningState ResourceGroup ResourceGuid ----------------------------- -------------------- ---------- ----------------- ------------------- --------- ------------------- --------------- ------------------------------------ False False eastus 00-0D-3A-12-B3-FC test-vm-jumpbox-nic True Succeeded test-eastus b642cd28-3d23-427a-82cc-7ba755438991","title":"Step 18.2 - Verify Jump Server Virtual NIC"},{"location":"draft-aro-verify-test/#step-183-verify-jump-server-availability-set","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create Commands: az vm availability-set show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME}-as --output table Example Output: # az vm availability-set show --resource-group test-eastus --name test-vm-jumpbox-as --output table Location Name PlatformFaultDomainCount PlatformUpdateDomainCount ResourceGroup ---------- ------------------ -------------------------- --------------------------- --------------- eastus test-vm-jumpbox-as 2 5 test-eastus","title":"Step 18.3 - Verify Jump Server Availability Set"},{"location":"draft-aro-verify-test/#step-184-verify-jump-server-image-terms","text":"In this document, the image being used for the Jump Server is a free Azure Marketplace image. The terms must be accepted. The URN is: cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 References: https://docs.microsoft.com/en-us/cli/azure/vm/image/terms?view=azure-cli-latest#az_vm_image_terms_show https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cognosys.docker-ce-with-centos-8-0-free?tab=Overview Commands: az vm image terms show --urn ${ARO_VM_JUMP_IMAGE_URN} --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Example Output: # az vm image terms show --urn cognosys:docker-ce-with-centos-8-0-free:docker-ce-with-centos-8-0-free:1.2019.0710 --query '[{accepted:accepted, name:name, plan:plan, product:product, publisher:publisher, type:type}]' --output table Accepted Name Plan Product Publisher ---------- ------------------------------ ------------------------------ ------------------------------ ----------- True docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free docker-ce-with-centos-8-0-free cognosys","title":"Step 18.4 - Verify Jump Server Image Terms"},{"location":"draft-aro-verify-test/#step-185-verify-jump-server-virtual-machine","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Commands: az vm show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VM_JUMP_NAME} az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv Example Output: # az vm show --resource-group test-eastus --name test-vm-jumpbox { \"additionalCapabilities\": null, \"availabilitySet\": { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Compute/availabilitySets/TEST-VM-JUMPBOX-AS\", \"resourceGroup\": \"test-eastus\" }, \"billingProfile\": null, \"diagnosticsProfile\": null, \"evictionPolicy\": null, \"extensionsTimeBudget\": null, \"hardwareProfile\": { \"vmSize\": \"Standard_B1ms\" }, \"host\": null, \"hostGroup\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Compute/virtualMachines/test-vm-jumpbox\", \"identity\": null, \"instanceView\": null, \"licenseType\": null, \"location\": \"eastus\", \"name\": \"test-vm-jumpbox\", \"networkProfile\": { \"networkInterfaces\": [ { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus/providers/Microsoft.Network/networkInterfaces/test-vm-jumpbox-nic\", \"primary\": true, \"resourceGroup\": \"test-eastus\" } ] }, \"osProfile\": { \"adminPassword\": null, \"adminUsername\": \"test-vm-jumpbox-admin\", \"allowExtensionOperations\": true, \"computerName\": \"test-vm-jumpbox\", \"customData\": null, \"linuxConfiguration\": { \"disablePasswordAuthentication\": true, \"patchSettings\": { \"patchMode\": \"ImageDefault\" }, \"provisionVmAgent\": true, \"ssh\": { \"publicKeys\": [ { \"keyData\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDec9G5K26hxFj+Ha0gQChwhSW4fT6mlZrb0066h+moGMJKMJ2YiHMaNMUULFT8SkJch4KYjQfqgJE8YnSGRHPzmUWwF/v7AwcozIlwralduUdYNIScDnzaFCBa55pLQwCWIN7zXFCdtEG935XwaV+A+tOgokiGvGXMAUj/Dz0A5ClIhbD/i3dr2AFKuuSwMGpFc1EqZDh72ZsYTcDaZT5hhPPUCUyTqOfEJuWQYeE3DAuA1EoI2tmBQWNl2S1jtdHa/69BBAmA6t0MZXuMKpk0udzQjw/d6b64hKYHDDlfxaTEBnt1Vbd8Rv5bxJSI1y2QgCutRZwVa/dt1X71fwpAq4yr0H8JCrabKrIumgqyZ6VQyCTVu3AXZ3E/yMQmJhLK2RvPHrHp8DedZ3su62zvU9aUACyd6b89R6S4eYOmIE+nNG/M/yqS2Ru3GPUalsQXE5/auCsg6rPetxMNoEbZz5qTfJUfq3Xx61WQuLrAsyvEiIiM5rrgA/FhYbthxKKacYr0b6oi6HQW6KQ3JnPMm/QF2UxDxoNOG+NHi2UBfgiXLEHZQ3YnkS4QkB9aCK4YJyOJ5I/34gAGcUIPQ8nkUSky7btjsQlHNB6pHPI+8Xd2SntRmfgBwJwOUS+LqjK4OCCpkqUTSopXQ8vL8L/e2gw+8QIdTYe47/P0IG5zVQ== jtingiris@jt\\n\", \"path\": \"/home/test-vm-jumpbox-admin/.ssh/authorized_keys\" } ] } }, \"requireGuestProvisionSignal\": true, \"secrets\": [], \"windowsConfiguration\": null }, \"plan\": { \"name\": \"docker-ce-with-centos-8-0-free\", \"product\": \"docker-ce-with-centos-8-0-free\", \"promotionCode\": null, \"publisher\": \"cognosys\" }, \"priority\": null, \"provisioningState\": \"Succeeded\", \"proximityPlacementGroup\": null, \"resourceGroup\": \"test-eastus\", \"resources\": null, \"securityProfile\": null, \"storageProfile\": { \"dataDisks\": [], \"imageReference\": { \"exactVersion\": \"1.2019.0710\", \"id\": null, \"offer\": \"docker-ce-with-centos-8-0-free\", \"publisher\": \"cognosys\", \"sku\": \"docker-ce-with-centos-8-0-free\", \"version\": \"1.2019.0710\" }, \"osDisk\": { \"caching\": \"ReadWrite\", \"createOption\": \"FromImage\", \"diffDiskSettings\": null, \"diskSizeGb\": 30, \"encryptionSettings\": null, \"image\": null, \"managedDisk\": { \"diskEncryptionSet\": null, \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/TEST-EASTUS/providers/Microsoft.Compute/disks/test-vm-jumpbox_OsDisk_1_d3cba19386b146898ff2ec6a13e92c61\", \"resourceGroup\": \"TEST-EASTUS\", \"storageAccountType\": \"Premium_LRS\" }, \"name\": \"test-vm-jumpbox_OsDisk_1_d3cba19386b146898ff2ec6a13e92c61\", \"osType\": \"Linux\", \"vhd\": null, \"writeAcceleratorEnabled\": null } }, \"tags\": {}, \"type\": \"Microsoft.Compute/virtualMachines\", \"virtualMachineScaleSet\": null, \"vmId\": \"1eaa170c-4f08-4383-a9a5-8aebd23b256c\", \"zones\": null } # az vm show -d -g test-eastus -n test-vm-jumpbox --query publicIps -o tsv 40.71.92.76","title":"Step 18.5 - Verify Jump Server Virtual Machine"},{"location":"draft-aro-verify-test/#step-186-login-to-jump-server-virtual-machine","text":"References: https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az_vm_show Commands: export ARO_VM_JUMP_IP=$(az vm show -d -g ${ARO_RESOURCE_GROUP_NAME} -n ${ARO_VM_JUMP_NAME} --query publicIps -o tsv) echo \"${ARO_VM_JUMP_IP}\" ssh -i ~/.ssh/id_rsa.pub ${ARO_VM_JUMP_ADMIN_NAME}@${ARO_VM_JUMP_IP} 'hostname && uptime' Example Output: 40.71.92.76 test-vm-jumpbox 03:26:23 up 3 days, 12:54, 0 users, load average: 0.02, 0.02, 0.00","title":"Step 18.6 - Login to Jump Server Virtual Machine"},{"location":"draft-aro-verify-test/#step-19-setup-vpn-gateway","text":"A VPN gateway is a specific type of virtual network gateway that is used to send encrypted traffic between an Azure virtual network and a remote location, over the public Internet. This document will focus on creating the newer, Resrouce Manager deployment model with Azure certificate authentication. References: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal https://docs.microsoft.com/en-us/azure/vpn-gateway/create-routebased-vpn-gateway-cli","title":"Step 19 - Setup VPN Gateway"},{"location":"draft-aro-verify-test/#step-191-verify-vpn-gateway-subnet","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet/subnet?view=azure-cli-latest#az-network-vnet-subnet-show Command(s): az network vnet subnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --vnet-name ${ARO_VNET_NAME} --name ${ARO_SUBNET_VGW_NAME} --output table Example Output: # az network vnet subnet show --resource-group test-eastus --vnet-name test-vnet --name GatewaySubnet --output table AddressPrefix Name PrivateEndpointNetworkPolicies PrivateLinkServiceNetworkPolicies ProvisioningState ResourceGroup --------------- ------------- -------------------------------- ----------------------------------- ------------------- --------------- 10.11.6.0/25 GatewaySubnet Enabled Enabled Succeeded test-eastus","title":"Step 19.1 - Verify VPN Gateway Subnet"},{"location":"draft-aro-verify-test/#step-192-verify-vpn-gateway-public-ip-address","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/public-ip?view=azure-cli-latest#az_network_public_ip_show Command(s): az network public-ip show --name ${ARO_VGW_PUBLIC_ADDRESS_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: # az network public-ip show --name test-vpn-public-ip --resource-group test-eastus --output table Name ResourceGroup Location Zones Address AddressVersion AllocationMethod IdleTimeoutInMinutes ProvisioningState ------------------ --------------- ---------- ------- ------------ ---------------- ------------------ ---------------------- ------------------- test-vpn-public-ip test-eastus eastus 1 52.146.16.51 IPv4 Static 4 Succeeded","title":"Step 19.2 - Verify VPN Gateway Public IP Address"},{"location":"draft-aro-verify-test/#step-193-verify-vpn-gateway","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --output table Example Output: # az network vnet-gateway show --name test-vpn --resource-group test-eastus --output table ActiveActive EnableBgp EnablePrivateIpAddress GatewayType Location Name ProvisioningState ResourceGroup ResourceGuid VpnGatewayGeneration VpnType -------------- ----------- ------------------------ ------------- ---------- -------- ------------------- --------------- ------------------------------------ ---------------------- ---------- False False False Vpn eastus test-vpn Succeeded test-eastus c3808606-15b0-4577-beac-5ef1ba033ff0 Generation1 RouteBased","title":"Step 19.3 - Verify VPN Gateway"},{"location":"draft-aro-verify-test/#step-20-setup-vpn-gateway-certificate-authentication","text":"When using the native VPN Gateway Azure Certificate Authentication, a client certificate is used to authenticate the connecting user. Client certificates are generated from a trusted Root Certificate and then installed on each client computer. The validation of the Client Certificate is performed by the VPN Gateway and happens during establishment of the point-to-site (P2S) VPN connection. References: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal","title":"Step 20 - Setup VPN Gateway Certificate Authentication"},{"location":"draft-aro-verify-test/#step-201-verify-vpn-gateway-root-key","text":"References: https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in ${ARO_VGW_PKI_ROOT_KEY_FILE} -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE Example Output: # openssl rsa -in ./pki/test-vpn-root.key -noout -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE && echo ./pki/test-vpn-root.key OK || echo ./pki/test-vpn-root.key FAILED","title":"Step 20.1 - Verify VPN Gateway Root Key"},{"location":"draft-aro-verify-test/#step-202-verify-vpn-gateway-root-certificate","text":"References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_ROOT_CRT_FILE}\" -noout -text Example Output: # openssl x509 -in \"./pki/test-vpn-root.crt\" -noout -text Certificate: Data: Version: 3 (0x2) Serial Number: 0f:68:84:2f:5f:6a:b7:84:53:70:07:1f:db:99:f4:06:bf:fd:28:b0 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = test-vpn Validity Not Before: Sep 19 17:15:34 2020 GMT Not After : Sep 17 17:15:34 2030 GMT Subject: CN = test-vpn Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:b0:61:28:b2:55:89:7a:11:d2:33:0c:52:a8:bc: bd:5d:6b:6a:5f:ba:38:f8:e0:20:d3:ea:91:6c:bd: 21:f2:d3:70:80:32:70:2d:e0:bc:79:69:35:4a:aa: 41:2d:37:0f:eb:8a:be:3c:98:2b:2f:54:b0:3f:68: b6:0d:5e:6d:f1:0f:78:1f:bd:c4:45:9e:d2:03:2a: 20:e3:05:82:89:d6:b2:f1:cb:a2:4d:5d:61:0e:a4: 6d:34:b3:6e:7f:10:44:8c:7c:74:84:fe:8a:82:ed: 37:aa:c9:88:54:87:a3:22:5b:63:de:ad:f3:86:ad: 80:19:32:91:6e:94:51:14:25:c1:c3:df:fd:c0:d1: e6:b1:22:36:ac:5c:bb:98:f0:74:98:41:96:6e:c7: f8:76:9a:d7:a1:bb:48:11:1e:69:54:c9:2c:46:b1: 32:b0:c0:19:a6:33:9f:0c:71:f5:41:b7:4e:57:1e: 7e:42:33:d5:89:db:18:67:1c:e8:54:7b:50:b4:14: bf:78:17:c3:ef:11:b6:3f:a7:57:9f:f8:16:87:ff: 17:06:3c:c6:d7:d6:45:c2:0a:ec:99:d8:35:53:f7: a5:85:d0:b3:ae:ca:94:a2:b9:40:d6:35:1e:eb:a0: ec:4e:e6:0e:4d:5b:6f:94:af:48:b3:d1:06:5e:5b: c4:2f Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: C1:D4:7C:0F:FA:85:E6:D7:22:F0:BC:47:AC:4D:7A:BD:9E:42:58:88 X509v3 Authority Key Identifier: keyid:C1:D4:7C:0F:FA:85:E6:D7:22:F0:BC:47:AC:4D:7A:BD:9E:42:58:88 X509v3 Basic Constraints: critical CA:TRUE Signature Algorithm: sha256WithRSAEncryption 7f:72:23:7e:5c:65:f0:34:03:79:f6:0b:ae:a4:6d:06:77:b9: ef:c5:93:4c:1a:ed:70:45:a7:e0:42:33:b7:b8:7e:d5:95:7b: d0:22:85:c9:49:8a:26:5f:d6:b9:90:1a:2a:54:f7:d8:2d:4f: 56:93:9f:93:91:4f:c1:85:3e:0d:70:9b:5a:00:84:7b:13:3b: 47:d3:00:0f:2b:01:df:9c:cb:61:9a:c1:cd:b4:ed:f4:24:bc: 5f:66:d1:d0:8d:57:ee:ab:47:b8:b5:d6:6f:be:0d:b1:07:9e: 00:f5:a1:a2:b2:6e:f9:f6:b8:59:5a:13:64:a2:c3:6e:a5:ee: c3:8f:88:ce:5b:ea:0f:7b:3b:08:6f:dd:17:fe:00:d4:a7:6d: 66:78:30:80:95:0c:1b:c6:7f:b3:82:5a:cc:0d:39:74:b6:4c: 0c:da:af:fc:3a:79:cc:ab:06:22:2a:b8:68:97:27:4f:10:b4: 2f:43:c0:29:51:fa:7c:a2:92:0a:e6:6f:a7:d7:22:82:6a:b0: e4:77:c9:b8:ef:6e:57:75:f6:0b:e9:60:79:59:a0:1e:2b:e1: 1d:94:d4:3f:35:7f:24:35:a8:57:85:bb:98:33:85:a2:97:81: d8:c6:e9:99:26:52:af:fd:82:0f:56:64:8c:cf:ac:e1:41:46: 52:45:e5:6b","title":"Step 20.2 - Verify VPN Gateway Root Certificate"},{"location":"draft-aro-verify-test/#step-203-verify-vpn-gateway-root-certificate-moduli","text":"This step verifies the modulus for the root certificate and key match. Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed. References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): echo -n \"md5sum for ./pki/test-vpn-root.key = \"; openssl rsa -noout -modulus -in \"./pki/test-vpn-root.key\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ./pki/test-vpn-root.crt = \"; openssl x509 -noout -modulus -in \"./pki/test-vpn-root.crt\" | md5sum Example Output: # echo -n \"md5sum for ./pki/test-vpn-root.key = \"; openssl rsa -noout -modulus -in \"./pki/test-vpn-root.key\" -passin env:ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE | md5sum md5sum for ./pki/test-vpn-root.key = d7a262d5c6023fc9cc0cf33feae2ca3d - # echo -n \"md5sum for ./pki/test-vpn-root.crt = \"; openssl x509 -noout -modulus -in \"./pki/test-vpn-root.crt\" | md5sum md5sum for ./pki/test-vpn-root.crt = d7a262d5c6023fc9cc0cf33feae2ca3d -","title":"Step 20.3 - Verify VPN Gateway Root Certificate Moduli"},{"location":"draft-aro-verify-test/#step-204-verify-vpn-gateway-root-certificate-data","text":"References: https://docs.microsoft.com/en-us/cli/azure/network/vnet-gateway?view=azure-cli-latest#az_network_vnet_gateway_show Command(s): AZ_UPLOAD_OK=false; while read AZ_VERIFY_CERTIFICATE_NAME; do echo \"found ${ARO_VGW_NAME} root certificate name = ${AZ_VERIFY_CERTIFICATE_NAME}\"; if [ \"${AZ_VERIFY_CERTIFICATE_NAME}\" == \"${ARO_VGW_PKI_ROOT_CRT_FILE_NAME}\" ]; then AZ_UPLOAD_OK=true; fi; done <<< \"$(az network vnet-gateway show --name ${ARO_VGW_NAME} --resource-group ${ARO_RESOURCE_GROUP_NAME} --query vpnClientConfiguration.vpnClientRootCertificates[].[name] --output tsv)\"; if ${AZ_UPLOAD_OK}; then echo \"verified ${ARO_VGW_PKI_ROOT_CRT_FILE_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; else echo \"failed to verify ${ARO_VGW_PKI_ROOT_CRT_FILE_NAME} exists as a root certificate name for ${ARO_VGW_NAME}\"; fi Example Output: found test-vpn root certificate name = test-vpn-root.crt verified test-vpn-root.crt exists as a root certificate name for test-vpn","title":"Step 20.4 - Verify VPN Gateway Root Certificate Data"},{"location":"draft-aro-verify-test/#step-21-setup-vpn-client-certificates","text":"VPN Clients must present an X.509 version 3 certificate when connecting. Each user should have their own bundle of certificate files. This step outlines a procedure to create them with OpenSSL v1.1.1. It will need to be re-run for everyone who requires connectivity. The Azure VPN Gateway supports both IKEv2 (ipsec) and OpenVPN (ssl) client connections. Various VPN client software support these technologies. It is most convenient to distribute a PKCS#12 file to the user, so they can connect to the VPN Gateway and access the private Azure Red Hat OpenShift cluster. In cryptography, PKCS #12 defines an archive file format for storing many cryptography objects as a single file. PKCS#12 evolved from Microsoft's Personal Information Exchange (PFX) standard and is used to exchange public and private objects. It is commonly used to bundle a private key with its X.509 certificate or to bundle all the members of a chain of trust. The terms PKCS #12 (pkcs12) and PFX (pfx) are often used interchangeably. Successful execution of the commands in this step depends upon the previously created VPN Gateway Root Certificate files and exported environment variables. At minimum, these environment variables must be properly set beforehand: ARO_VGW_NAME ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE Successful completion of the following steps will produce six (6) files, in this order: VPN Client Key (.key) VPN Client Certificate Request (.req) VPN Client Certificate Extensions (.ext) VPN Client Certificate (.crt) VPN Client Certificate Serial (.serial) VPN Client Certificate Bundle (.pfx) The resulting PFX file is should be given to the user. References: https://en.wikipedia.org/wiki/X.509 https://en.wikipedia.org/wiki/PKCS_12 https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-vpn-client-install-azure-cert https://www.openssl.org/","title":"Step 21 - Setup VPN Client Certificates"},{"location":"draft-aro-verify-test/#step-211-export-vpn-client-aro-environment-variables","text":"These environment variables should be exported each time a new set of client certificate files are created. These are example values that must be changed for your installation. References: https://www.gnu.org/software/bash/manual/html_node/Environment.html Command(s): export ARO_VGW_PKI_CLIENT='example' export ARO_VGW_PKI_CLIENT_NAME=\"${ARO_VGW_NAME}-client-${ARO_VGW_PKI_CLIENT}\" export ARO_VGW_PKI_CLIENT_EXT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.ext\" export ARO_VGW_PKI_CLIENT_KEY_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.key\" export ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE='!'\"${ARO_VGW_PKI_CLIENT}\"'!' export ARO_VGW_PKI_CLIENT_REQ_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.req\" export ARO_VGW_PKI_CLIENT_CRT_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.crt\" export ARO_VGW_PKI_CLIENT_SERIAL_FILE=\"${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.serial\" export ARO_VGW_PKI_CLIENT_PFX_FILE='${ARO_VGW_PKI_DIR}/${ARO_VGW_PKI_CLIENT_NAME}.pfx' Example Output: - successfully setting enivronment variables does not produce any output","title":"Step 21.1 - Export VPN Client ARO Environment Variables"},{"location":"draft-aro-verify-test/#step-212-verify-vpn-client-aro-environment-variables","text":"References: https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html Command(s): VERIFY_VARIABLES=(ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_NAME ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) for VERIFY_VARIABLE in ${VERIFY_VARIABLES[@]}; do if [ \"${!VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR: Environment Variable ${VERIFY_VARIABLE} is NOT set\"; else echo \"${VERIFY_VARIABLE}=${!VERIFY_VARIABLE}\"; fi; done; unset VERIFY_VARIABLE Example Output: # VERIFY_VARIABLES=(ARO_VGW_PKI_CLIENT_NAME ARO_VGW_PKI_CLIENT_EXT_FILE ARO_VGW_PKI_CLIENT_KEY_FILE ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE ARO_VGW_PKI_CLIENT_REQ_FILE ARO_VGW_PKI_CLIENT_CRT_FILE ARO_VGW_PKI_CLIENT_SERIAL_FILE ARO_VGW_PKI_CLIENT_PFX_FILE ARO_VGW_NAME ARO_VGW_PKI_BITS ARO_VGW_PKI_DIR ARO_VGW_PKI_ROOT_KEY_FILE ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE) - successfully setting enivronment variables does not produce any output # for VERIFY_VARIABLE in ${VERIFY_VARIABLES[@]}; do if [ \"${!VERIFY_VARIABLE}\" == \"\" ]; then echo \"ERROR: Environment Variable ${VERIFY_VARIABLE} is NOT set\"; aborting; else echo \"${VERIFY_VARIABLE}=${!VERIFY_VARIABLE}\"; fi; done; unset VERIFY_VARIABLE VERIFY_VARIABLES ARO_VGW_PKI_CLIENT_NAME=test-vpn-client-example ARO_VGW_PKI_CLIENT_EXT_FILE=./pki/test-vpn-client-example.ext ARO_VGW_PKI_CLIENT_KEY_FILE=./pki/test-vpn-client-example.key ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE=!example! ARO_VGW_PKI_CLIENT_REQ_FILE=./pki/test-vpn-client-example.req ARO_VGW_PKI_CLIENT_CRT_FILE=./pki/test-vpn-client-example.crt ARO_VGW_PKI_CLIENT_SERIAL_FILE=./pki/test-vpn-client-example.serial ARO_VGW_PKI_CLIENT_PFX_FILE=./pki/test-vpn-client-example.pfx ARO_VGW_NAME=test-vpn ARO_VGW_PKI_BITS=2048 ARO_VGW_PKI_DIR=./pki ARO_VGW_PKI_ROOT_KEY_FILE=./pki/test-vpn-root.key ARO_VGW_PKI_ROOT_KEY_FILE_PASSPHRASE=Pk1P4ssphr4s3!!","title":"Step 21.2 - Verify VPN Client ARO Environment Variables"},{"location":"draft-aro-verify-test/#step-213-verify-vpn-client-key","text":"References: https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): openssl rsa -in \"${ARO_VGW_PKI_CLIENT_KEY_FILE}\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE Example Output: # openssl rsa -in \"./pki/test-vpn-client-example.key\" -noout -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE - no output produced when command is successful","title":"Step 21.3 - Verify VPN Client Key"},{"location":"draft-aro-verify-test/#step-214-verify-vpn-client-certificate-request","text":"References: https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html Command(s): openssl req -in \"${ARO_VGW_PKI_CLIENT_REQ_FILE}\" -noout -text Example Output: # openssl req -in \"./pki/test-vpn-client-example.req\" -noout -text Certificate Request: Data: Version: 1 (0x0) Subject: CN = test-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:c8:57:97:93:5e:12:f8:c1:3e:da:76:93:f0:7c: d9:f4:2e:06:72:29:5e:f3:34:de:38:f6:88:53:75: 33:b2:c4:0f:bb:0d:f2:4a:9c:11:bb:b1:a6:04:f5: 78:d0:c8:9b:d4:bd:0c:26:c8:77:1b:c3:21:23:9d: b9:56:19:3a:0f:d3:74:51:ca:b6:26:82:d1:38:dd: 40:3a:ae:d6:9d:c2:ce:ae:2c:cc:2f:94:a9:fc:c8: 09:43:94:c6:88:96:e8:bc:38:0c:0f:ab:25:c8:38: ee:90:3c:34:99:cf:eb:c4:7d:49:d3:a7:e7:83:82: 01:53:c2:cf:1b:16:bd:f0:0a:e3:8a:d7:9c:ca:01: 36:3c:19:a4:74:19:dd:bb:37:d4:67:dc:8a:92:b2: bf:3c:93:53:eb:21:0b:15:d1:00:45:67:36:f1:19: 68:a2:10:1b:5d:24:c6:13:f3:46:f3:99:43:53:c8: 0b:bf:b8:7f:ef:db:10:05:da:23:1e:23:8e:17:49: 1c:32:c3:cf:af:f9:55:54:27:1d:14:cb:90:34:63: f4:30:e9:8f:17:b8:94:81:03:e9:ad:b8:4b:ff:c1: b5:dc:08:57:96:3b:10:bc:53:89:61:10:3c:64:2b: 74:05:bf:df:23:0c:79:c9:e0:4b:01:48:8e:0d:33: b1:03 Exponent: 65537 (0x10001) Attributes: a0:00 Signature Algorithm: sha256WithRSAEncryption 6a:bb:28:6f:4d:bb:0a:7b:9b:54:b2:d0:ad:f7:26:16:d5:d6: 2a:9c:d0:3b:98:76:7c:a6:72:9a:02:33:5a:de:c0:c8:4e:6b: 0d:45:be:ca:fd:24:d4:20:d9:6e:05:fa:9f:81:b8:d0:fe:6e: 58:9d:c3:53:b1:06:f1:45:a9:42:e2:9e:4d:9b:05:94:16:83: 65:73:03:f7:ff:7d:18:ba:04:ec:9d:a0:b5:52:57:ec:2f:b7: 14:b3:cd:76:c1:6f:80:2f:06:d4:e2:1b:5c:3e:2a:00:cf:a6: dc:c4:03:76:50:76:21:d9:5f:c5:8e:1d:60:10:d0:ec:e5:c2: 32:ac:c9:53:04:88:fc:f3:5b:62:b2:fc:a8:93:64:29:be:98: a8:d3:24:ce:cf:a7:c7:fb:a3:6d:aa:ca:b7:38:72:2a:f7:4d: d0:14:4f:9a:01:63:74:6c:05:72:a0:fa:f7:5e:c0:d0:3b:7c: 45:b6:a1:ef:a0:23:5a:d0:07:bf:a9:8b:8f:92:9a:78:6a:2f: 11:01:2a:44:2e:9c:58:d9:31:2b:a3:fa:5c:b8:f1:a0:97:90: 58:35:35:fb:c5:a5:76:7d:09:6a:d1:39:38:c1:60:f7:7a:31: f7:93:3e:36:37:85:5e:9a:70:d3:50:d8:49:cc:3c:e9:b5:e3: a8:2d:d2:47","title":"Step 21.4 - Verify VPN Client Certificate Request"},{"location":"draft-aro-verify-test/#step-215-verify-vpn-client-certificate-extensions","text":"References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): grep ^authorityKeyIdentifier=keyid,issuer \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" && grep ^extendedKeyUsage=clientAuth \"${ARO_VGW_PKI_CLIENT_EXT_FILE}\" Example Output: # grep ^authorityKeyIdentifier=keyid,issuer \"./pki/test-vpn-client-example.ext\" && grep ^extendedKeyUsage=clientAuth \"./pki/test-vpn-client-example.ext\" authorityKeyIdentifier=keyid,issuer extendedKeyUsage=clientAuth","title":"Step 21.5 - Verify VPN Client Certificate Extensions"},{"location":"draft-aro-verify-test/#step-216-verify-vpn-client-certificate","text":"References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_CRT_FILE}\" -noout -text Example Output: # openssl x509 -in \"./pki/test-vpn-client-example.crt\" -noout -text Certificate: Data: Version: 1 (0x0) Serial Number: 51:a4:28:83:73:db:0a:ab:c3:9e:21:29:66:25:ef:b1:fb:a5:bc:14 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = test-vpn Validity Not Before: Sep 20 04:38:40 2020 GMT Not After : Sep 20 04:38:40 2023 GMT Subject: CN = test-vpn-client-example Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:c8:57:97:93:5e:12:f8:c1:3e:da:76:93:f0:7c: d9:f4:2e:06:72:29:5e:f3:34:de:38:f6:88:53:75: 33:b2:c4:0f:bb:0d:f2:4a:9c:11:bb:b1:a6:04:f5: 78:d0:c8:9b:d4:bd:0c:26:c8:77:1b:c3:21:23:9d: b9:56:19:3a:0f:d3:74:51:ca:b6:26:82:d1:38:dd: 40:3a:ae:d6:9d:c2:ce:ae:2c:cc:2f:94:a9:fc:c8: 09:43:94:c6:88:96:e8:bc:38:0c:0f:ab:25:c8:38: ee:90:3c:34:99:cf:eb:c4:7d:49:d3:a7:e7:83:82: 01:53:c2:cf:1b:16:bd:f0:0a:e3:8a:d7:9c:ca:01: 36:3c:19:a4:74:19:dd:bb:37:d4:67:dc:8a:92:b2: bf:3c:93:53:eb:21:0b:15:d1:00:45:67:36:f1:19: 68:a2:10:1b:5d:24:c6:13:f3:46:f3:99:43:53:c8: 0b:bf:b8:7f:ef:db:10:05:da:23:1e:23:8e:17:49: 1c:32:c3:cf:af:f9:55:54:27:1d:14:cb:90:34:63: f4:30:e9:8f:17:b8:94:81:03:e9:ad:b8:4b:ff:c1: b5:dc:08:57:96:3b:10:bc:53:89:61:10:3c:64:2b: 74:05:bf:df:23:0c:79:c9:e0:4b:01:48:8e:0d:33: b1:03 Exponent: 65537 (0x10001) Signature Algorithm: sha256WithRSAEncryption 43:e8:e3:f9:8c:19:47:0e:07:87:e2:58:b4:ab:a7:6b:09:19: ee:f6:d7:77:07:77:9a:39:ca:8d:93:2a:6c:29:eb:72:8d:8e: fd:a1:20:a5:20:36:4b:35:da:8a:5a:a9:3f:42:2d:e7:55:c6: e8:17:eb:df:c6:a5:9d:04:4a:ed:b2:7f:68:6b:1d:62:42:a9: c5:4b:c6:2c:dc:be:b6:99:fe:7d:8d:0c:82:17:d3:52:07:b5: 17:cc:4b:3a:1b:83:09:0f:eb:80:41:c4:9f:98:31:11:4f:88: 97:8f:7c:09:dd:bf:d5:50:31:20:cf:fa:21:6f:5a:e1:f6:b7: 26:bd:0f:f6:a2:63:08:1c:37:39:db:ed:ae:4c:a7:b6:0b:fd: ca:85:09:44:8f:c5:b8:12:12:f4:7a:bf:a8:54:13:b0:a3:3a: 80:a2:1f:11:1e:c5:96:a2:35:3c:70:6c:c6:8a:74:71:4a:20: 1f:76:14:5d:cf:6e:31:1f:39:ed:5a:66:f6:f9:9c:ae:7b:6f: 14:ec:3b:58:f2:7a:95:2d:68:f0:7b:83:56:1d:6c:9b:76:94: 5c:0a:1c:9b:c5:57:bd:89:2d:b1:35:ac:62:2e:b1:70:3e:e0: 2d:fa:51:46:b1:4b:7d:d2:ab:3b:43:a2:2b:9c:7a:99:53:e7: 39:63:43:e1","title":"Step 21.6 - Verify VPN Client Certificate"},{"location":"draft-aro-verify-test/#step-217-verify-vpn-client-certificate-moduli","text":"This step verifies the modulus for the client certificate, request, and key match. Mismatched moduli will prevent a successful connection to the VPN Gateway. If the md5sums are different, then do not proceed. References: https://www.openssl.org/docs/man1.1.1/man1/openssl-x509.html https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html https://www.openssl.org/docs/man1.1.1/man1/openssl-rsa.html Command(s): echo -n \"md5sum for ./pki/test-vpn-client-example.key = \"; openssl rsa -noout -modulus -in \"./pki/test-vpn-client-example.key\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum echo -n \"md5sum for ./pki/test-vpn-client-example.crt = \"; openssl x509 -noout -modulus -in \"./pki/test-vpn-client-example.crt\" | md5sum echo -n \"md5sum for ./pki/test-vpn-client-example.req = \"; openssl req -noout -modulus -in \"./pki/test-vpn-client-example.req\" | md5sum Example Output: # echo -n \"md5sum for ./pki/test-vpn-client-example.key = \"; openssl rsa -noout -modulus -in \"./pki/test-vpn-client-example.key\" -passin env:ARO_VGW_PKI_CLIENT_KEY_FILE_PASSPHRASE | md5sum md5sum for ./pki/test-vpn-client-example.key = f644adfa6fe3cca77bbbc830deaa8cd3 - # echo -n \"md5sum for ./pki/test-vpn-client-example.crt = \"; openssl x509 -noout -modulus -in \"./pki/test-vpn-client-example.crt\" | md5sum md5sum for ./pki/test-vpn-client-example.crt = f644adfa6fe3cca77bbbc830deaa8cd3 - # echo -n \"md5sum for ./pki/test-vpn-client-example.req = \"; openssl req -noout -modulus -in \"./pki/test-vpn-client-example.req\" | md5sum md5sum for ./pki/test-vpn-client-example.req = f644adfa6fe3cca77bbbc830deaa8cd3 -","title":"Step 21.7 - Verify VPN Client Certificate Moduli"},{"location":"draft-aro-verify-test/#step-218-verify-vpn-client-pfx","text":"References: https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html Command(s): openssl x509 -in \"${ARO_VGW_PKI_CLIENT_PFX_FILE}\" -noout -text Example Output: # openssl x509 -in \"./pki/test-vpn-client-example.pfx\" -noout -text Bag Attributes localKeyID: 9F 0F F9 2F FF 3A B7 14 69 C5 C4 66 8D 14 F3 4C C7 AF F3 D7 subject=CN = test-vpn-client-example issuer=CN = test-vpn -----BEGIN CERTIFICATE----- MIIDKjCCAhKgAwIBAgIUUaQog3PbCqvDniEpZiXvsfulvBMwDQYJKoZIhvcNAQEL BQAwEzERMA8GA1UEAwwIdGVzdC12cG4wHhcNMjAwOTE5MTkxNjA1WhcNMjMwOTE5 MTkxNjA1WjAiMSAwHgYDVQQDDBd0ZXN0LXZwbi1jbGllbnQtZXhhbXBsZTCCASIw DQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALI83D0ALwUJIudLl8MEZVrT6rPE WgciZ7Jncx922lkXlqkIujSnSULY87H8Z2g6P6SlHHCAYu4O6+5v+ik23LrqkD+u X7O/+pQmnXFJWgXq0SF/CWWR74QAxMMdo/hj1ViVjrvt/P7UnwzHLY3fhFVglLAW deRSDSoAlbNjb4rejKBWjWoyyPPym9of75cFsWdGIMUc271Ou+77PX0kOk5NZvfS Tt75TpdpTeQmPrUFs+930KJUpBw51E3KipTHuBIN1oQaQVsb7c5oMPduxgJioB3R aQDVAznfAXgZc9bVSAbnr3guMR4ACGG5DvJ7B0rbZJ15vV8m57TaKr9E+W0CAwEA AaNnMGUwHwYDVR0jBBgwFoAUwdR8D/qF5tci8LxHrE16vZ5CWIgwCQYDVR0TBAIw ADATBgNVHSUEDDAKBggrBgEFBQcDAjAiBgNVHREEGzAZghd0ZXN0LXZwbi1jbGll bnQtZXhhbXBsZTANBgkqhkiG9w0BAQsFAAOCAQEAB+hGAQ9N/y/0UcNpoRKyD3vY pugUgLWQl/CxKf6moBWmB4mQfd+fwJXqSs1FOaouTASLdvjqNUVRGiXqr/V5pola k9GqgoblGX663wyOR8U7l6x/WjyplDBRjs3II/73xvt+lteJRVk4nP88TLVroagF w7tDax/r4gU6whJ8Vl8kTlkIvCa8lpiqzHpWnckeyHPZ4cZhDH/t52nk337eMefQ 3JhH98hfYX7CIn0lWwjo2O1WvNd5Tl6VJJLSD0uW6xJ6eZxEljsX+Qe+UI1Nlasy dF2u2ovM4c7R5Whpeupm7ein0ckCzqpb2zFFfqyQ3o9ON8Y2Hm0lh6SYL5zWOw== -----END CERTIFICATE----- Bag Attributes: <No Attributes> subject=CN = test-vpn issuer=CN = test-vpn -----BEGIN CERTIFICATE----- MIIDBzCCAe+gAwIBAgIUD2iEL19qt4RTcAcf25n0Br/9KLAwDQYJKoZIhvcNAQEL BQAwEzERMA8GA1UEAwwIdGVzdC12cG4wHhcNMjAwOTE5MTcxNTM0WhcNMzAwOTE3 MTcxNTM0WjATMREwDwYDVQQDDAh0ZXN0LXZwbjCCASIwDQYJKoZIhvcNAQEBBQAD ggEPADCCAQoCggEBALBhKLJViXoR0jMMUqi8vV1ral+6OPjgINPqkWy9IfLTcIAy cC3gvHlpNUqqQS03D+uKvjyYKy9UsD9otg1ebfEPeB+9xEWe0gMqIOMFgonWsvHL ok1dYQ6kbTSzbn8QRIx8dIT+ioLtN6rJiFSHoyJbY96t84atgBkykW6UURQlwcPf /cDR5rEiNqxcu5jwdJhBlm7H+Haa16G7SBEeaVTJLEaxMrDAGaYznwxx9UG3Tlce fkIz1YnbGGcc6FR7ULQUv3gXw+8Rtj+nV5/4Fof/FwY8xtfWRcIK7JnYNVP3pYXQ s67KlKK5QNY1Huug7E7mDk1bb5SvSLPRBl5bxC8CAwEAAaNTMFEwHQYDVR0OBBYE FMHUfA/6hebXIvC8R6xNer2eQliIMB8GA1UdIwQYMBaAFMHUfA/6hebXIvC8R6xN er2eQliIMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAH9yI35c ZfA0A3n2C66kbQZ3ue/Fk0wa7XBFp+BCM7e4ftWVe9AihclJiiZf1rmQGipU99gt T1aTn5ORT8GFPg1wm1oAhHsTO0fTAA8rAd+cy2Gawc207fQkvF9m0dCNV+6rR7i1 1m++DbEHngD1oaKybvn2uFlaE2Siw26l7sOPiM5b6g97Owhv3Rf+ANSnbWZ4MICV DBvGf7OCWswNOXS2TAzar/w6ecyrBiIquGiXJ08QtC9DwClR+nyikgrmb6fXIoJq sOR3ybjvbld19gvpYHlZoB4r4R2U1D81fyQ1qFeFu5gzhaKXgdjG6ZkmUq/9gg9W ZIzPrOFBRlJF5Ws= -----END CERTIFICATE-----","title":"Step 21.8 - Verify VPN Client PFX"},{"location":"test/","text":"9 - Verify Azure Tenant One way to verify the Azure Tenant is to obtain the Tenant ID with az. The Tenant ID should match what is in the environment configuration file. Reference(s): https://aad.portal.azure.com/ Command(s): az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi Example Output: [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ]","title":"Test"},{"location":"test/#9-verify-azure-tenant","text":"One way to verify the Azure Tenant is to obtain the Tenant ID with az. The Tenant ID should match what is in the environment configuration file. Reference(s): https://aad.portal.azure.com/ Command(s): az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi Example Output: [ { \"tenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" }, { \"homeTenantId\": \"25fe96e7-85ec-4e6a-b93f-779b16ff751d\" } ]","title":"9 - Verify Azure Tenant"},{"location":"tldr/","text":"Too Long; Didn't Read 1 - Setup Azure Tenant 1.1 - Create Microsoft Account 1.2 - Create Global Administrator 1.3 - Verify Admin Center Access 1.4 - Verify AAD License 2 - Setup Azure Subscription 2.1 - Create Azure Subscription 3 - Setup Linux Operating System 3.1 - Verify Operating System uname -a 3.2 - Verify GNU bash bash --version 3.3 - Verify GNU awk awk --version 3.4 - Verify GNU coreutils base64 --version basename --version dirname --version sort --version head --version tail --version 3.5 - Verify GNU grep egrep --version 3.6 - Verify GNU wget wget --version 3.7 - Verify Browser firefox --version google-chrome --version 3.8 - Verify OpenSSL openssl version 4 - Setup Environment Variables 4.1 - Unset Environment Variables for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done 4.2 - Set Environment Variables cat \"ipm.env\" && source \"ipm.env\" 4.3 - Verify Environment Variables env | grep ^ARO | sort -V 5 - Setup Required Directories env | egrep \"ARO.*DIR\" 5.1 - Create Required Directories mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\" 6 - Setup Azure CLI env | egrep \"ARO.*DIR\" 6.1 - Install Azure CLI az --version 6.2 - Subscription Owner Login az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv 6.3 - Verify Azure Tenant az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi 6.4 - Set Default Subscription az account set -s \"${ARO_SUBSCRIPTION_NAME}\" 6.5 - Verify Default Subscription az account list --query '[?isDefault == `true`]' 7 - Setup Subscription Owners 7.1 - Create Subscription Owners for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done 7.2 - Verify Subscription Owners az role assignment list --role Owner --output table 8 - Verify Azure Subscription env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" 8.1 - Verify Subscription Name az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi 8.2 - Verify Subscription ID az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi 8.3 - Verify Subscription Location az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi 8.4 - Verify Subscription Limits if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi 8.5 - Verify Subscription Quotas 8.6 - Standard DSv3 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 8.7 - Standard Dv2 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 9 - Setup OpenShift Administrators env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" 9.1 - Create Administrator Accounts az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login 9.2 - Verify Administrator Accounts for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done 9.3 - Create Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done 9.4 - Verify Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done 10 - Setup Resource Providers echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" 10.1 - Register Provider Microsoft.Compute az provider register -n Microsoft.Compute --wait 10.2 - Verify Provider Microsoft.Compute az provider show --namespace Microsoft.Compute --output table 10.3 - Register Provider Microsoft.RedHatOpenShift az provider register -n Microsoft.RedHatOpenShift --wait 10.4 - Verify Provider Microsoft.RedHatOpenShift az provider show --namespace Microsoft.RedHatOpenShift --output table 10.5 - Register Provider Microsoft.Storage az provider register -n Microsoft.Storage --wait 10.6 - Verify Provider Microsoft.Storage az provider show --namespace Microsoft.Storage --output table 11 - Setup Resource Group env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' 11.1 - Create Resource Group az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} 11.2 - Verify Resource Group az group show --name ${ARO_RESOURCE_GROUP_NAME} 12 - Setup Virtual Network env | grep ^ARO_VNET | sort -V 12.1 - Create Virtual Network az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_ADDRESS_PREFIX} 12.2 - Verify Virtual Network az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --output table","title":"TL;DR"},{"location":"tldr/#too-long-didnt-read","text":"","title":"Too Long; Didn't Read"},{"location":"tldr/#1-setup-azure-tenant","text":"1.1 - Create Microsoft Account 1.2 - Create Global Administrator 1.3 - Verify Admin Center Access 1.4 - Verify AAD License","title":"1 - Setup Azure Tenant"},{"location":"tldr/#2-setup-azure-subscription","text":"2.1 - Create Azure Subscription","title":"2 - Setup Azure Subscription"},{"location":"tldr/#3-setup-linux-operating-system","text":"3.1 - Verify Operating System uname -a 3.2 - Verify GNU bash bash --version 3.3 - Verify GNU awk awk --version 3.4 - Verify GNU coreutils base64 --version basename --version dirname --version sort --version head --version tail --version 3.5 - Verify GNU grep egrep --version 3.6 - Verify GNU wget wget --version 3.7 - Verify Browser firefox --version google-chrome --version 3.8 - Verify OpenSSL openssl version","title":"3 - Setup Linux Operating System"},{"location":"tldr/#4-setup-environment-variables","text":"4.1 - Unset Environment Variables for ARO in $(env | grep ^ARO | awk -F= \"{print \\$1}\" | sort -V); do echo unset $ARO; unset $ARO; done 4.2 - Set Environment Variables cat \"ipm.env\" && source \"ipm.env\" 4.3 - Verify Environment Variables env | grep ^ARO | sort -V","title":"4 - Setup Environment Variables"},{"location":"tldr/#5-setup-required-directories","text":"env | egrep \"ARO.*DIR\" 5.1 - Create Required Directories mkdir -p \"${ARO_VGW_PKI_DIR}\" mkdir -p \"${ARO_REDHAT_PULL_SECRET_DIR}\" 5.2 - Verify Required Directories ls -ld \"${ARO_VGW_PKI_DIR}\" ls -ld \"${ARO_REDHAT_PULL_SECRET_DIR}\"","title":"5 - Setup Required Directories"},{"location":"tldr/#6-setup-azure-cli","text":"env | egrep \"ARO.*DIR\" 6.1 - Install Azure CLI az --version 6.2 - Subscription Owner Login az login export AZ_USER=$(az account show --query 'user.name' --output tsv) az role assignment list --role Owner --query \"[?principalName=='${AZ_USER}'].principalName\" --output tsv 6.3 - Verify Azure Tenant az account show --query '[{tenantId:tenantId}, {homeTenantId:homeTenantId}]' export AZ_TENANT_ID=$(az account show --query 'tenantId' --output tsv 2> /dev/null) if [ \"${ARO_TENANT_ID}\" != \"${AZ_TENANT_ID}\" ];then; echo \"ERROR! ARO_TENANT_ID (${ARO_TENANT_ID}) does not match this tenant id (${AZ_TENANT_ID})\"; fi 6.4 - Set Default Subscription az account set -s \"${ARO_SUBSCRIPTION_NAME}\" 6.5 - Verify Default Subscription az account list --query '[?isDefault == `true`]'","title":"6 - Setup Azure CLI"},{"location":"tldr/#7-setup-subscription-owners","text":"7.1 - Create Subscription Owners for ARO_SUBSCRIPTION_OWNER in ${ARO_SUBSCRIPTION_OWNERS[@]}; do az role assignment create --assignee ${ARO_SUBSCRIPTION_OWNER} --role Owner; done 7.2 - Verify Subscription Owners az role assignment list --role Owner --output table","title":"7 - Setup Subscription Owners"},{"location":"tldr/#8-verify-azure-subscription","text":"env | egrep -e '^ARO_SUBSCRIPTION_NAME|^ARO_SUBSCRIPTION_ID|^ARO_TENANT_ID|^ARO_LOCATION_NAME' echo \"ARO_SUBSCRIPTION_OWNERS=${ARO_SUBSCRIPTION_OWNERS[@]}\" echo \"ARO_VERIFY_QUOTA_NAMES=${ARO_VERIFY_QUOTA_NAMES[@]}\" 8.1 - Verify Subscription Name az account list --output table az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_NAME=$(az account show --query 'name' --output tsv) if [ \"${AZ_SUBSCRIPTION_NAME}\" != \"${ARO_SUBSCRIPTION_NAME}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_NAME}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_NAME}\\\"\"; fi 8.2 - Verify Subscription ID az account show --subscription \"${ARO_SUBSCRIPTION_ID}\" --query \"[{subscription_name:name},{subscription_id:id}]\" export AZ_SUBSCRIPTION_ID=$(az account show --query 'id' --output tsv 2> /dev/null) if [ \"${AZ_SUBSCRIPTION_ID}\" != \"${ARO_SUBSCRIPTION_ID}\" ]; then echo \"ERROR! az subscription name \\\"${AZ_SUBSCRIPTION_ID}\\\" does not match aro subscription name \\\"${ARO_SUBSCRIPTION_ID}\\\"\"; fi 8.3 - Verify Subscription Location az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}']\" --output table export AZ_LOCATION_NAME=$(az account list-locations --query \"[?name=='${ARO_LOCATION_NAME}'].name\" --output tsv) if [ \"${AZ_LOCATION_NAME}\" != \"${ARO_LOCATION_NAME}\" ]; then echo \"ERROR! az location name \\\"${AZ_LOCATION_NAME}\\\" does not match aro location name \\\"${ARO_LOCATION_NAME}\\\"\"; fi 8.4 - Verify Subscription Limits if [ \"${ARO_VERIFY_QUOTA_NAMES}\" == \"\" ]; then echo \"WARNING! ARO_VERIFY_QUOTA_NAMES is not set\"; fi 8.5 - Verify Subscription Quotas 8.6 - Standard DSv3 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard DSv3 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard DSv3 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi 8.7 - Standard Dv2 Family vCPUs az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs']\" export AZ_VERIFY_QUOTA_LIMIT=$(az vm list-usage --location ${ARO_LOCATION_NAME} --query \"[?localName=='Standard Dv2 Family vCPUs'].limit\" --output tsv) if [ \"${AZ_VERIFY_QUOTA_LIMIT}\" == \"\" ] || [ ${AZ_VERIFY_QUOTA_LIMIT} -lt 50 ]; then echo \"ERROR! Quota limit for \"Standard Dv2 Family vCPUs\" is too low! Open a support case with Microsoft.\"; fi","title":"8 - Verify Azure Subscription"},{"location":"tldr/#9-setup-openshift-administrators","text":"env | egrep -e '^ARO_DOMAIN_NAME' echo \"ARO_ADMINISTRATORS=${ARO_ADMINISTRATORS[@]}\" 9.1 - Create Administrator Accounts az ad user create --display-name openshift-admin@mitaei.net --user-principal-name openshift-admin@mitaei.net --password \"DIl3*lks)-${ARO}-r4d0m!\" --force-change-password-next-login 9.2 - Verify Administrator Accounts for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az ad user show --id ${ARO_ADMINISTRATOR} --query '[{userPrincipalName:userPrincipalName}, {principalId:objectId}]'; if [ $? -ne 0 ]; then echo \"WARNING! ${ADMINISTRATOR} aad account was not found\"; fi; done 9.3 - Create Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"Contributor\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign Contributor role to ${ARO_ADMINISTRATOR}\"; fi; done for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment create --assignee ${ARO_ADMINISTRATOR} --role \"User Access Administrator\"; if [ $? -ne 0 ]; then echo \"ERROR! could not assign User Access Administrator role to ${ARO_ADMINISTRATOR}\"; fi; done 9.4 - Verify Administrator Roles for ARO_ADMINISTRATOR in ${ARO_ADMINISTRATORS[@]}; do az role assignment list --assignee ${ARO_ADMINISTRATOR} --output table; if [ $? -ne 0 ]; then echo \"ERROR! failed retrieving subscription roles for \\\"${ADMINISTRATOR}\\\"\"; fi; echo; done","title":"9 - Setup OpenShift Administrators"},{"location":"tldr/#10-setup-resource-providers","text":"echo \"ARO_RESOURCE_PROVIDERS=${ARO_RESOURCE_PROVIDERS[@]}\" 10.1 - Register Provider Microsoft.Compute az provider register -n Microsoft.Compute --wait 10.2 - Verify Provider Microsoft.Compute az provider show --namespace Microsoft.Compute --output table 10.3 - Register Provider Microsoft.RedHatOpenShift az provider register -n Microsoft.RedHatOpenShift --wait 10.4 - Verify Provider Microsoft.RedHatOpenShift az provider show --namespace Microsoft.RedHatOpenShift --output table 10.5 - Register Provider Microsoft.Storage az provider register -n Microsoft.Storage --wait 10.6 - Verify Provider Microsoft.Storage az provider show --namespace Microsoft.Storage --output table","title":"10 - Setup Resource Providers"},{"location":"tldr/#11-setup-resource-group","text":"env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' 11.1 - Create Resource Group az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} 11.2 - Verify Resource Group az group show --name ${ARO_RESOURCE_GROUP_NAME}","title":"11 - Setup Resource Group"},{"location":"tldr/#12-setup-virtual-network","text":"env | grep ^ARO_VNET | sort -V 12.1 - Create Virtual Network az network vnet create --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --address-prefixes ${ARO_VNET_ADDRESS_PREFIX} 12.2 - Verify Virtual Network az network vnet show --resource-group ${ARO_RESOURCE_GROUP_NAME} --name ${ARO_VNET_NAME} --output table","title":"12 - Setup Virtual Network"},{"location":"wip/","text":"11 - Setup Resource Group An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest Command(s): env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' Example Output: ARO_LOCATION_NAME=eastus ARO_RESOURCE_GROUP_NAME=test-eastus 11.1 - Create Resource Group Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Command(s): az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"test-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" } 11.2 - Verify Resource Group Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Command(s): az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"test-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"WIP"},{"location":"wip/#11-setup-resource-group","text":"An Azure resource group is a logical group in which Azure resources are deployed and managed. To create ARO resources, a resource group location must be specified. This is where the physical datacenter is located, where resource group metadata is stored, and where the Azure resources are hosted. Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest Command(s): env | egrep '^ARO_RESOURCE_GROUP_NAME|^ARO_LOCATION_NAME' Example Output: ARO_LOCATION_NAME=eastus ARO_RESOURCE_GROUP_NAME=test-eastus","title":"11 - Setup Resource Group"},{"location":"wip/#111-create-resource-group","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create Command(s): az group create --name ${ARO_RESOURCE_GROUP_NAME} --location ${ARO_LOCATION_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"test-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"11.1 - Create Resource Group"},{"location":"wip/#112-verify-resource-group","text":"Reference(s): https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-show Command(s): az group show --name ${ARO_RESOURCE_GROUP_NAME} Example Output: { \"id\": \"/subscriptions/12c7070f-83e5-453b-96d0-90770d2cf942/resourceGroups/test-eastus\", \"location\": \"eastus\", \"managedBy\": null, \"name\": \"test-eastus\", \"properties\": { \"provisioningState\": \"Succeeded\" }, \"tags\": null, \"type\": \"Microsoft.Resources/resourceGroups\" }","title":"11.2 - Verify Resource Group"}]}